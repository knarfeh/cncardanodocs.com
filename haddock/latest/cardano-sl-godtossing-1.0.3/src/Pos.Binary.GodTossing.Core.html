<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Serialization of core types from GodTossing SSC.</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">GodTossing</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span>
</span><a name="line-4"></a><span>       </span><span class="hs-special">(</span><span>
</span><a name="line-5"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashSet</span><span>                  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HS</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bi</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Decoder</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Encoding</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">decodeListLen</span><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>                                                </span><span class="hs-identifier hs-var">encodeListLen</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">enforceSize</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">matchSize</span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span><span>             </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span class="hs-operator">.</span><span class="hs-identifier">Configuration</span><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasConfiguration</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span class="hs-operator">.</span><span class="hs-identifier">Vss</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">VssCertificate</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">VssCertificatesMap</span><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>                                                </span><span class="hs-identifier hs-var">mkVssCertificatesMap</span><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>                                                </span><span class="hs-identifier hs-var">recreateVssCertificate</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">PublicKey</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Ssc.GodTossing.Core.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">GodTossing</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Ssc.GodTossing.Core.Types.html#Commitment"><span class="hs-identifier hs-type">Commitment</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#CommitmentsMap"><span class="hs-identifier hs-type">CommitmentsMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>                                                </span><a href="Pos.Ssc.GodTossing.Core.Types.html#GtPayload"><span class="hs-identifier hs-type">GtPayload</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#GtProof"><span class="hs-identifier hs-type">GtProof</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>                                                </span><a href="Pos.Ssc.GodTossing.Core.Types.html#Opening"><span class="hs-identifier hs-type">Opening</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#SignedCommitment"><span class="hs-identifier hs-type">SignedCommitment</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>                                                </span><a href="Pos.Ssc.GodTossing.Core.Types.html#mkCommitmentsMap"><span class="hs-identifier hs-var">mkCommitmentsMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">allDistinct</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Bi</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#Commitment"><span class="hs-identifier hs-type">Commitment</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-25"></a><span>  </span><a name="local-8214565720323793801"><span class="hs-identifier">encode</span></a><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#Commitment"><span class="hs-identifier hs-var">Commitment</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">encodeListLen</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679293657"><span class="hs-identifier hs-var">commShares</span></a><span>
</span><a name="line-26"></a><span>                                          </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679293656"><span class="hs-identifier hs-var">commProof</span></a><span>
</span><a name="line-27"></a><span>  </span><a name="local-8214565720323793800"><span class="hs-identifier">decode</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-28"></a><span>    </span><span class="hs-identifier hs-var">enforceSize</span><span> </span><span class="hs-string">&quot;Commitment&quot;</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-29"></a><span>    </span><a name="local-6989586621679293658"><a href="#local-6989586621679293658"><span class="hs-identifier">commShares</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">decode</span><span>
</span><a name="line-30"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679293658"><span class="hs-identifier hs-var">commShares</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;decode@Commitment: no shares&quot;</span><span>
</span><a name="line-31"></a><span>    </span><a name="local-6989586621679293659"><a href="#local-6989586621679293659"><span class="hs-identifier">commProof</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">decode</span><span>
</span><a name="line-32"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#Commitment"><span class="hs-identifier hs-var">Commitment</span></a><span> </span><a href="#local-6989586621679293659"><span class="hs-identifier hs-var">commProof</span></a><span> </span><a href="#local-6989586621679293658"><span class="hs-identifier hs-var">commShares</span></a><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Bi</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#CommitmentsMap"><span class="hs-identifier hs-type">CommitmentsMap</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-35"></a><span>  </span><a name="local-8214565720323793801"><span class="hs-identifier">encode</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Binary.GodTossing.Core.html#encodeCommitments"><span class="hs-identifier hs-var">encodeCommitments</span></a><span>
</span><a name="line-36"></a><span>  </span><a name="local-8214565720323793800"><span class="hs-identifier">decode</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Binary.GodTossing.Core.html#decodeCommitments"><span class="hs-identifier hs-var">decodeCommitments</span></a><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">HasConfiguration</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bi</span><span> </span><span class="hs-identifier hs-type">VssCertificate</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-39"></a><span>  </span><a name="local-8214565720323793801"><span class="hs-identifier">encode</span></a><span> </span><a name="local-6989586621679293649"><a href="#local-6989586621679293649"><span class="hs-identifier">vssCert</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">encodeListLen</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">vcVssKey</span><span> </span><a href="#local-6989586621679293649"><span class="hs-identifier hs-var">vssCert</span></a><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>                                   </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">vcExpiryEpoch</span><span> </span><a href="#local-6989586621679293649"><span class="hs-identifier hs-var">vssCert</span></a><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>                                   </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">vcSignature</span><span> </span><a href="#local-6989586621679293649"><span class="hs-identifier hs-var">vssCert</span></a><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>                                   </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">vcSigningKey</span><span> </span><a href="#local-6989586621679293649"><span class="hs-identifier hs-var">vssCert</span></a><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span>  </span><a name="local-8214565720323793800"><span class="hs-identifier">decode</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-44"></a><span>    </span><span class="hs-identifier hs-var">enforceSize</span><span> </span><span class="hs-string">&quot;VssCertificate&quot;</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-45"></a><span>    </span><a name="local-6989586621679293650"><a href="#local-6989586621679293650"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">decode</span><span>
</span><a name="line-46"></a><span>    </span><a name="local-6989586621679293651"><a href="#local-6989586621679293651"><span class="hs-identifier">epo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">decode</span><span>
</span><a name="line-47"></a><span>    </span><a name="local-6989586621679293652"><a href="#local-6989586621679293652"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">decode</span><span>
</span><a name="line-48"></a><span>    </span><a name="local-6989586621679293653"><a href="#local-6989586621679293653"><span class="hs-identifier">sky</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">decode</span><span>
</span><a name="line-49"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">recreateVssCertificate</span><span> </span><a href="#local-6989586621679293650"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621679293651"><span class="hs-identifier hs-var">epo</span></a><span> </span><a href="#local-6989586621679293652"><span class="hs-identifier hs-var">sig</span></a><span> </span><a href="#local-6989586621679293653"><span class="hs-identifier hs-var">sky</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-50"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679293654"><a href="#local-6989586621679293654"><span class="hs-identifier">e</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><a href="#local-6989586621679293654"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-51"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679293655"><a href="#local-6989586621679293655"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679293655"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Bi</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#Opening"><span class="hs-identifier hs-type">Opening</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-54"></a><span>  </span><a name="local-8214565720323793801"><span class="hs-identifier">encode</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">getOpening</span><span>
</span><a name="line-55"></a><span>  </span><a name="local-8214565720323793800"><span class="hs-identifier">decode</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#Opening"><span class="hs-identifier hs-var">Opening</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">decode</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">HasConfiguration</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bi</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#GtPayload"><span class="hs-identifier hs-type">GtPayload</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-58"></a><span>  </span><a name="local-8214565720323793801"><span class="hs-identifier">encode</span></a><span> </span><a name="local-6989586621679293639"><a href="#local-6989586621679293639"><span class="hs-identifier">input</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679293639"><span class="hs-identifier hs-var">input</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-59"></a><span>    </span><a href="Pos.Ssc.GodTossing.Core.Types.html#CommitmentsPayload"><span class="hs-identifier hs-var">CommitmentsPayload</span></a><span> </span><a name="local-6989586621679293640"><a href="#local-6989586621679293640"><span class="hs-identifier">cmap</span></a></a><span> </span><a name="local-6989586621679293641"><a href="#local-6989586621679293641"><span class="hs-identifier">vss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-60"></a><span>        </span><span class="hs-identifier hs-var">encodeListLen</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-61"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679293640"><span class="hs-identifier hs-var">cmap</span></a><span>
</span><a name="line-63"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Pos.Binary.GodTossing.Core.html#encodeVssCertificates"><span class="hs-identifier hs-var">encodeVssCertificates</span></a><span> </span><a href="#local-6989586621679293641"><span class="hs-identifier hs-var">vss</span></a><span>
</span><a name="line-64"></a><span>    </span><a href="Pos.Ssc.GodTossing.Core.Types.html#OpeningsPayload"><span class="hs-identifier hs-var">OpeningsPayload</span></a><span> </span><a name="local-6989586621679293642"><a href="#local-6989586621679293642"><span class="hs-identifier">omap</span></a></a><span> </span><a name="local-6989586621679293643"><a href="#local-6989586621679293643"><span class="hs-identifier">vss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-65"></a><span>        </span><span class="hs-identifier hs-var">encodeListLen</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-66"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679293642"><span class="hs-identifier hs-var">omap</span></a><span>
</span><a name="line-68"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Pos.Binary.GodTossing.Core.html#encodeVssCertificates"><span class="hs-identifier hs-var">encodeVssCertificates</span></a><span> </span><a href="#local-6989586621679293643"><span class="hs-identifier hs-var">vss</span></a><span>
</span><a name="line-69"></a><span>    </span><a href="Pos.Ssc.GodTossing.Core.Types.html#SharesPayload"><span class="hs-identifier hs-var">SharesPayload</span></a><span> </span><a name="local-6989586621679293644"><a href="#local-6989586621679293644"><span class="hs-identifier">smap</span></a></a><span> </span><a name="local-6989586621679293645"><a href="#local-6989586621679293645"><span class="hs-identifier">vss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-70"></a><span>        </span><span class="hs-identifier hs-var">encodeListLen</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-71"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-special">(</span><span class="hs-number">2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679293644"><span class="hs-identifier hs-var">smap</span></a><span>
</span><a name="line-73"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Pos.Binary.GodTossing.Core.html#encodeVssCertificates"><span class="hs-identifier hs-var">encodeVssCertificates</span></a><span> </span><a href="#local-6989586621679293645"><span class="hs-identifier hs-var">vss</span></a><span>
</span><a name="line-74"></a><span>    </span><a href="Pos.Ssc.GodTossing.Core.Types.html#CertificatesPayload"><span class="hs-identifier hs-var">CertificatesPayload</span></a><span> </span><a name="local-6989586621679293646"><a href="#local-6989586621679293646"><span class="hs-identifier">vss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-75"></a><span>        </span><span class="hs-identifier hs-var">encodeListLen</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-76"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-special">(</span><span class="hs-number">3</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Pos.Binary.GodTossing.Core.html#encodeVssCertificates"><span class="hs-identifier hs-var">encodeVssCertificates</span></a><span> </span><a href="#local-6989586621679293646"><span class="hs-identifier hs-var">vss</span></a><span>
</span><a name="line-78"></a><span>  </span><a name="local-8214565720323793800"><span class="hs-identifier">decode</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-79"></a><span>    </span><a name="local-6989586621679293647"><a href="#local-6989586621679293647"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">decodeListLen</span><span>
</span><a name="line-80"></a><span>    </span><a name="local-6989586621679293648"><a href="#local-6989586621679293648"><span class="hs-identifier">tag</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">decode</span><span> </span><span class="hs-glyph">@</span><span class="hs-identifier hs-type">Word8</span><span>
</span><a name="line-81"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679293648"><span class="hs-identifier hs-var">tag</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-82"></a><span>      </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-83"></a><span>        </span><span class="hs-identifier hs-var">matchSize</span><span> </span><a href="#local-6989586621679293647"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-string">&quot;GtPayload.CommitmentsPayload&quot;</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-84"></a><span>        </span><span class="hs-identifier hs-var">liftM2</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#CommitmentsPayload"><span class="hs-identifier hs-var">CommitmentsPayload</span></a><span> </span><span class="hs-identifier hs-var">decode</span><span> </span><a href="Pos.Binary.GodTossing.Core.html#decodeVssCertificates"><span class="hs-identifier hs-var">decodeVssCertificates</span></a><span>
</span><a name="line-85"></a><span>      </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-86"></a><span>        </span><span class="hs-identifier hs-var">matchSize</span><span> </span><a href="#local-6989586621679293647"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-string">&quot;GtPayload.OpeningsPayload&quot;</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-87"></a><span>        </span><span class="hs-identifier hs-var">liftM2</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#OpeningsPayload"><span class="hs-identifier hs-var">OpeningsPayload</span></a><span> </span><span class="hs-identifier hs-var">decode</span><span> </span><a href="Pos.Binary.GodTossing.Core.html#decodeVssCertificates"><span class="hs-identifier hs-var">decodeVssCertificates</span></a><span>
</span><a name="line-88"></a><span>      </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-89"></a><span>        </span><span class="hs-identifier hs-var">matchSize</span><span> </span><a href="#local-6989586621679293647"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-string">&quot;GtPayload.SharesPayload&quot;</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-90"></a><span>        </span><span class="hs-identifier hs-var">liftM2</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#SharesPayload"><span class="hs-identifier hs-var">SharesPayload</span></a><span> </span><span class="hs-identifier hs-var">decode</span><span> </span><a href="Pos.Binary.GodTossing.Core.html#decodeVssCertificates"><span class="hs-identifier hs-var">decodeVssCertificates</span></a><span>
</span><a name="line-91"></a><span>      </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-92"></a><span>        </span><span class="hs-identifier hs-var">matchSize</span><span> </span><a href="#local-6989586621679293647"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-string">&quot;GtPayload.CertificatesPayload&quot;</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-93"></a><span>        </span><a href="Pos.Ssc.GodTossing.Core.Types.html#CertificatesPayload"><span class="hs-identifier hs-var">CertificatesPayload</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pos.Binary.GodTossing.Core.html#decodeVssCertificates"><span class="hs-identifier hs-var">decodeVssCertificates</span></a><span>
</span><a name="line-94"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;decode@GtPayload: invalid tag: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679293648"><span class="hs-identifier hs-var">tag</span></a><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Bi</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#GtProof"><span class="hs-identifier hs-type">GtProof</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-97"></a><span>  </span><a name="local-8214565720323793801"><span class="hs-identifier">encode</span></a><span> </span><a name="local-6989586621679293629"><a href="#local-6989586621679293629"><span class="hs-identifier">input</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679293629"><span class="hs-identifier hs-var">input</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-98"></a><span>    </span><a href="Pos.Ssc.GodTossing.Core.Types.html#CommitmentsProof"><span class="hs-identifier hs-var">CommitmentsProof</span></a><span>  </span><a name="local-6989586621679293630"><a href="#local-6989586621679293630"><span class="hs-identifier">cmap</span></a></a><span> </span><a name="local-6989586621679293631"><a href="#local-6989586621679293631"><span class="hs-identifier">vss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">encodeListLen</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>                                                  </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679293630"><span class="hs-identifier hs-var">cmap</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679293631"><span class="hs-identifier hs-var">vss</span></a><span>
</span><a name="line-100"></a><span>    </span><a href="Pos.Ssc.GodTossing.Core.Types.html#OpeningsProof"><span class="hs-identifier hs-var">OpeningsProof</span></a><span>     </span><a name="local-6989586621679293632"><a href="#local-6989586621679293632"><span class="hs-identifier">omap</span></a></a><span> </span><a name="local-6989586621679293633"><a href="#local-6989586621679293633"><span class="hs-identifier">vss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">encodeListLen</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>                                                  </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679293632"><span class="hs-identifier hs-var">omap</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679293633"><span class="hs-identifier hs-var">vss</span></a><span>
</span><a name="line-102"></a><span>    </span><a href="Pos.Ssc.GodTossing.Core.Types.html#SharesProof"><span class="hs-identifier hs-var">SharesProof</span></a><span>       </span><a name="local-6989586621679293634"><a href="#local-6989586621679293634"><span class="hs-identifier">smap</span></a></a><span> </span><a name="local-6989586621679293635"><a href="#local-6989586621679293635"><span class="hs-identifier">vss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">encodeListLen</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-special">(</span><span class="hs-number">2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>                                                  </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679293634"><span class="hs-identifier hs-var">smap</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679293635"><span class="hs-identifier hs-var">vss</span></a><span>
</span><a name="line-104"></a><span>    </span><a href="Pos.Ssc.GodTossing.Core.Types.html#CertificatesProof"><span class="hs-identifier hs-var">CertificatesProof</span></a><span> </span><a name="local-6989586621679293636"><a href="#local-6989586621679293636"><span class="hs-identifier">vss</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">encodeListLen</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-special">(</span><span class="hs-number">3</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>                                                  </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679293636"><span class="hs-identifier hs-var">vss</span></a><span>
</span><a name="line-106"></a><span>  </span><a name="local-8214565720323793800"><span class="hs-identifier">decode</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-107"></a><span>    </span><a name="local-6989586621679293637"><a href="#local-6989586621679293637"><span class="hs-identifier">len</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">decodeListLen</span><span>
</span><a name="line-108"></a><span>    </span><a name="local-6989586621679293638"><a href="#local-6989586621679293638"><span class="hs-identifier">tag</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">decode</span><span> </span><span class="hs-glyph">@</span><span class="hs-identifier hs-type">Word8</span><span>
</span><a name="line-109"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679293638"><span class="hs-identifier hs-var">tag</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-110"></a><span>      </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-111"></a><span>        </span><span class="hs-identifier hs-var">matchSize</span><span> </span><a href="#local-6989586621679293637"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-string">&quot;GtProof.CommitmentsProof&quot;</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-112"></a><span>        </span><a href="Pos.Ssc.GodTossing.Core.Types.html#CommitmentsProof"><span class="hs-identifier hs-var">CommitmentsProof</span></a><span>  </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">decode</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">decode</span><span>
</span><a name="line-113"></a><span>      </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-114"></a><span>        </span><span class="hs-identifier hs-var">matchSize</span><span> </span><a href="#local-6989586621679293637"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-string">&quot;GtProof.OpeningsProof&quot;</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-115"></a><span>        </span><a href="Pos.Ssc.GodTossing.Core.Types.html#OpeningsProof"><span class="hs-identifier hs-var">OpeningsProof</span></a><span>     </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">decode</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">decode</span><span>
</span><a name="line-116"></a><span>      </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-117"></a><span>        </span><span class="hs-identifier hs-var">matchSize</span><span> </span><a href="#local-6989586621679293637"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-string">&quot;GtProof.SharesProof&quot;</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-118"></a><span>        </span><a href="Pos.Ssc.GodTossing.Core.Types.html#SharesProof"><span class="hs-identifier hs-var">SharesProof</span></a><span>       </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">decode</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">decode</span><span>
</span><a name="line-119"></a><span>      </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-120"></a><span>        </span><span class="hs-identifier hs-var">matchSize</span><span> </span><a href="#local-6989586621679293637"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-string">&quot;GtProof.CertificatesProof&quot;</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-121"></a><span>        </span><a href="Pos.Ssc.GodTossing.Core.Types.html#CertificatesProof"><span class="hs-identifier hs-var">CertificatesProof</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">decode</span><span>
</span><a name="line-122"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;decode@GtProof: invalid tag: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679293638"><span class="hs-identifier hs-var">tag</span></a><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-125"></a><span class="hs-comment">-- Maps encoding/decoding</span><span>
</span><a name="line-126"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-comment">{-
'VssCertificatesMap' and 'CommitmentsMap' are simply sets of values, indexed
by stakeholder id *for performance only*; the invariant is that the key
(stakeholder id) corresponds to the key stored in the value. This means that
the keys are redundant and putting them into encoded data is bad for two
reasons:

  * it takes more space
  * we have to do an extra invariant check after decoding

Instead, we serialize those maps as sets, and we make sure to check that
there are no values with duplicate stakeholder ids.
-}</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-identifier">encodeVssCertificates</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasConfiguration</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">VssCertificatesMap</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Encoding</span><span>
</span><a name="line-143"></a><a name="encodeVssCertificates"><a href="Pos.Binary.GodTossing.Core.html#encodeVssCertificates"><span class="hs-identifier">encodeVssCertificates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-identifier">decodeVssCertificates</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasConfiguration</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Decoder</span><span> </span><a href="#local-6989586621679293532"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-identifier hs-type">VssCertificatesMap</span><span>
</span><a name="line-146"></a><a name="decodeVssCertificates"><a href="Pos.Binary.GodTossing.Core.html#decodeVssCertificates"><span class="hs-identifier">decodeVssCertificates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-147"></a><span>    </span><a name="local-6989586621679293533"><a href="#local-6989586621679293533"><span class="hs-identifier">certs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">decode</span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-type">HashSet</span><span> </span><span class="hs-identifier hs-type">VssCertificate</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>    </span><span class="hs-comment">-- if the attacker creates two certs that are different but have the same</span><span>
</span><a name="line-149"></a><span>    </span><span class="hs-comment">-- 'vcSigningKey', it's bad because then we lose canonicity (only one</span><span>
</span><a name="line-150"></a><span>    </span><span class="hs-comment">-- cert will be present in resulting map and the attacker can set the</span><span>
</span><a name="line-151"></a><span>    </span><span class="hs-comment">-- other cert to be anything at all)</span><span>
</span><a name="line-152"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">allDistinct</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">vcSigningKey</span><span> </span><a href="#local-6989586621679293533"><span class="hs-identifier hs-var">certs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-153"></a><span>        </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;decodeVssCertificates: two certs have the same signing key&quot;</span><span>
</span><a name="line-154"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVssCertificatesMap</span><span> </span><a href="#local-6989586621679293533"><span class="hs-identifier hs-var">certs</span></a><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-identifier">encodeCommitments</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#CommitmentsMap"><span class="hs-identifier hs-type">CommitmentsMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Encoding</span><span>
</span><a name="line-157"></a><a name="encodeCommitments"><a href="Pos.Binary.GodTossing.Core.html#encodeCommitments"><span class="hs-identifier">encodeCommitments</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-identifier">decodeCommitments</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Decoder</span><span> </span><a href="#local-6989586621679292680"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#CommitmentsMap"><span class="hs-identifier hs-type">CommitmentsMap</span></a><span>
</span><a name="line-160"></a><a name="decodeCommitments"><a href="Pos.Binary.GodTossing.Core.html#decodeCommitments"><span class="hs-identifier">decodeCommitments</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-161"></a><span>    </span><a name="local-6989586621679293586"><a href="#local-6989586621679293586"><span class="hs-identifier">comms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">decode</span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-type">HashSet</span><span> </span><a href="Pos.Ssc.GodTossing.Core.Types.html#SignedCommitment"><span class="hs-identifier hs-type">SignedCommitment</span></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">allDistinct</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">view</span><span> </span><span class="hs-identifier hs-var">_1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679293586"><span class="hs-identifier hs-var">comms</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PublicKey</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-163"></a><span>        </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;decodeCommitments: two commitments have the same signing key&quot;</span><span>
</span><a name="line-164"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="Pos.Ssc.GodTossing.Core.Types.html#mkCommitmentsMap"><span class="hs-identifier hs-var">mkCommitmentsMap</span></a><span> </span><a href="#local-6989586621679293586"><span class="hs-identifier hs-var">comms</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a></pre></body></html>