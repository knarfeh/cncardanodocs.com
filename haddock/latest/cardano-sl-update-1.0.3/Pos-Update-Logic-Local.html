<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Pos.Update.Logic.Local</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Pos-Update-Logic-Local.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Pos.Update.Logic.Local.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">cardano-sl-update-1.0.3: Cardano SL - update</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Pos.Update.Logic.Local</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Proposals</a></li><li><a href="#g:2">Votes</a></li><li><a href="#g:3">Normalization</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Logic of local data processing in Update System.</p></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><a href="#v:isProposalNeeded">isProposalNeeded</a> :: (MonadReader ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a> ctx <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a>, <a href="../base-4.9.1.0/Control-Monad-IO-Class.html#t:MonadIO">MonadIO</a> m) =&gt; <a href="Pos-Update-Core-Types.html#t:UpId">UpId</a> -&gt; m <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a></li><li class="src short"><a href="#v:getLocalProposalNVotes">getLocalProposalNVotes</a> :: (MonadReader ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a> ctx <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a>, <a href="../base-4.9.1.0/Control-Monad-IO-Class.html#t:MonadIO">MonadIO</a> m) =&gt; <a href="Pos-Update-Core-Types.html#t:UpId">UpId</a> -&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> (<a href="Pos-Update-Core-Types.html#t:UpdateProposal">UpdateProposal</a>, [<a href="Pos-Update-Core-Types.html#t:UpdateVote">UpdateVote</a>]))</li><li class="src short"><a href="#v:processProposal">processProposal</a> :: (USLocalLogicModeWithLock ctx m, <a href="../cardano-sl-infra-1.0.3/Pos-Reporting-Methods.html#t:MonadReporting">MonadReporting</a> ctx m) =&gt; <a href="Pos-Update-Core-Types.html#t:UpdateProposal">UpdateProposal</a> -&gt; m (<a href="../base-4.9.1.0/Data-Either.html#t:Either">Either</a> <a href="Pos-Update-Poll-Failure.html#t:PollVerFailure">PollVerFailure</a> ())</li><li class="src short"><a href="#v:isVoteNeeded">isVoteNeeded</a> :: USLocalLogicMode ctx m =&gt; <a href="Pos-Update-Core-Types.html#t:UpId">UpId</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Crypto-Signing-Types-Signing.html#t:PublicKey">PublicKey</a> -&gt; <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a> -&gt; m <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a></li><li class="src short"><a href="#v:getLocalVote">getLocalVote</a> :: (MonadReader ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a> ctx <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a>, <a href="../base-4.9.1.0/Control-Monad-IO-Class.html#t:MonadIO">MonadIO</a> m) =&gt; <a href="Pos-Update-Core-Types.html#t:UpId">UpId</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Crypto-Signing-Types-Signing.html#t:PublicKey">PublicKey</a> -&gt; <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a> -&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="Pos-Update-Core-Types.html#t:UpdateVote">UpdateVote</a>)</li><li class="src short"><a href="#v:processVote">processVote</a> :: (USLocalLogicModeWithLock ctx m, <a href="../cardano-sl-infra-1.0.3/Pos-Reporting-Methods.html#t:MonadReporting">MonadReporting</a> ctx m) =&gt; <a href="Pos-Update-Core-Types.html#t:UpdateVote">UpdateVote</a> -&gt; m (<a href="../base-4.9.1.0/Data-Either.html#t:Either">Either</a> <a href="Pos-Update-Poll-Failure.html#t:PollVerFailure">PollVerFailure</a> ())</li><li class="src short"><a href="#v:usNormalize">usNormalize</a> :: USLocalLogicMode ctx m =&gt; m ()</li><li class="src short"><a href="#v:processNewSlot">processNewSlot</a> :: USLocalLogicModeWithLock ctx m =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:SlotId">SlotId</a> -&gt; m ()</li><li class="src short"><a href="#v:usPreparePayload">usPreparePayload</a> :: USLocalLogicMode ctx m =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:SlotId">SlotId</a> -&gt; m <a href="Pos-Update-Core-Types.html#t:UpdatePayload">UpdatePayload</a></li><li class="src short"><a href="#v:clearUSMemPool">clearUSMemPool</a> :: (MonadReader ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a> ctx <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a>, <a href="../base-4.9.1.0/Control-Monad-IO-Class.html#t:MonadIO">MonadIO</a> m) =&gt; m ()</li></ul></div><div id="interface"><h1 id="g:1">Proposals</h1><div class="top"><p class="src"><a id="v:isProposalNeeded" class="def">isProposalNeeded</a> :: (MonadReader ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a> ctx <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a>, <a href="../base-4.9.1.0/Control-Monad-IO-Class.html#t:MonadIO">MonadIO</a> m) =&gt; <a href="Pos-Update-Core-Types.html#t:UpId">UpId</a> -&gt; m <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a> <a href="src/Pos.Update.Logic.Local.html#isProposalNeeded" class="link">Source</a> <a href="#v:isProposalNeeded" class="selflink">#</a></p><div class="doc"><p>This function returns true if update proposal with given
 identifier should be requested.</p></div></div><div class="top"><p class="src"><a id="v:getLocalProposalNVotes" class="def">getLocalProposalNVotes</a> :: (MonadReader ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a> ctx <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a>, <a href="../base-4.9.1.0/Control-Monad-IO-Class.html#t:MonadIO">MonadIO</a> m) =&gt; <a href="Pos-Update-Core-Types.html#t:UpId">UpId</a> -&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> (<a href="Pos-Update-Core-Types.html#t:UpdateProposal">UpdateProposal</a>, [<a href="Pos-Update-Core-Types.html#t:UpdateVote">UpdateVote</a>])) <a href="src/Pos.Update.Logic.Local.html#getLocalProposalNVotes" class="link">Source</a> <a href="#v:getLocalProposalNVotes" class="selflink">#</a></p><div class="doc"><p>Get update proposal with given id if it is known.</p></div></div><div class="top"><p class="src"><a id="v:processProposal" class="def">processProposal</a> :: (USLocalLogicModeWithLock ctx m, <a href="../cardano-sl-infra-1.0.3/Pos-Reporting-Methods.html#t:MonadReporting">MonadReporting</a> ctx m) =&gt; <a href="Pos-Update-Core-Types.html#t:UpdateProposal">UpdateProposal</a> -&gt; m (<a href="../base-4.9.1.0/Data-Either.html#t:Either">Either</a> <a href="Pos-Update-Poll-Failure.html#t:PollVerFailure">PollVerFailure</a> ()) <a href="src/Pos.Update.Logic.Local.html#processProposal" class="link">Source</a> <a href="#v:processProposal" class="selflink">#</a></p><div class="doc"><p>Process proposal received from network, checking it against
 current state (global + local) and adding to local state if it's
 valid with respect to it.
 If proposal is added to store, 'Right ()' is returned.
 Otherwise 'Left err' is returned and <code>err</code> lets caller decide whether
 sender could be sure that error would happen.</p></div></div><h1 id="g:2">Votes</h1><div class="top"><p class="src"><a id="v:isVoteNeeded" class="def">isVoteNeeded</a> :: USLocalLogicMode ctx m =&gt; <a href="Pos-Update-Core-Types.html#t:UpId">UpId</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Crypto-Signing-Types-Signing.html#t:PublicKey">PublicKey</a> -&gt; <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a> -&gt; m <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a> <a href="src/Pos.Update.Logic.Local.html#isVoteNeeded" class="link">Source</a> <a href="#v:isVoteNeeded" class="selflink">#</a></p><div class="doc"><p>This function returns true if update vote proposal with given
 identifier issued by stakeholder with given PublicKey and with
 given decision should be requested.</p></div></div><div class="top"><p class="src"><a id="v:getLocalVote" class="def">getLocalVote</a> :: (MonadReader ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a> ctx <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a>, <a href="../base-4.9.1.0/Control-Monad-IO-Class.html#t:MonadIO">MonadIO</a> m) =&gt; <a href="Pos-Update-Core-Types.html#t:UpId">UpId</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Crypto-Signing-Types-Signing.html#t:PublicKey">PublicKey</a> -&gt; <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a> -&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="Pos-Update-Core-Types.html#t:UpdateVote">UpdateVote</a>) <a href="src/Pos.Update.Logic.Local.html#getLocalVote" class="link">Source</a> <a href="#v:getLocalVote" class="selflink">#</a></p><div class="doc"><p>Get update vote for proposal with given id from given issuer and
 with given decision if it is known.</p></div></div><div class="top"><p class="src"><a id="v:processVote" class="def">processVote</a> :: (USLocalLogicModeWithLock ctx m, <a href="../cardano-sl-infra-1.0.3/Pos-Reporting-Methods.html#t:MonadReporting">MonadReporting</a> ctx m) =&gt; <a href="Pos-Update-Core-Types.html#t:UpdateVote">UpdateVote</a> -&gt; m (<a href="../base-4.9.1.0/Data-Either.html#t:Either">Either</a> <a href="Pos-Update-Poll-Failure.html#t:PollVerFailure">PollVerFailure</a> ()) <a href="src/Pos.Update.Logic.Local.html#processVote" class="link">Source</a> <a href="#v:processVote" class="selflink">#</a></p><div class="doc"><p>Process vote received from network, checking it against
 current state (global + local) and adding to local state if it's
 valid with respect to it.
 If vote is added to store, 'Right ()' is returned.
 Otherwise 'Left err' is returned and <code>err</code> lets caller decide whether
 sender could be sure that error would happen.</p></div></div><h1 id="g:3">Normalization</h1><div class="top"><p class="src"><a id="v:usNormalize" class="def">usNormalize</a> :: USLocalLogicMode ctx m =&gt; m () <a href="src/Pos.Update.Logic.Local.html#usNormalize" class="link">Source</a> <a href="#v:usNormalize" class="selflink">#</a></p><div class="doc"><p>Remove local data from memory state to make it consistent with
 current GState.  This function assumes that GState is locked. It
 tries to leave as much data as possible. It assumes that
 <code>stateLock</code> is taken.</p></div></div><div class="top"><p class="src"><a id="v:processNewSlot" class="def">processNewSlot</a> :: USLocalLogicModeWithLock ctx m =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:SlotId">SlotId</a> -&gt; m () <a href="src/Pos.Update.Logic.Local.html#processNewSlot" class="link">Source</a> <a href="#v:processNewSlot" class="selflink">#</a></p><div class="doc"><p>Update memory state to make it correct for given slot.</p></div></div><div class="top"><p class="src"><a id="v:usPreparePayload" class="def">usPreparePayload</a> :: USLocalLogicMode ctx m =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:SlotId">SlotId</a> -&gt; m <a href="Pos-Update-Core-Types.html#t:UpdatePayload">UpdatePayload</a> <a href="src/Pos.Update.Logic.Local.html#usPreparePayload" class="link">Source</a> <a href="#v:usPreparePayload" class="selflink">#</a></p><div class="doc"><p>Prepare UpdatePayload for inclusion into new block with given
 SlotId based on given tip.  This function assumes that
 <code>stateLock</code> is taken and nobody can apply/rollback blocks in
 parallel or modify US mempool.  Sometimes payload can't be
 created. It can happen if we are trying to create block for slot
 which has already passed, for example. Or if we have different tip
 in mempool because normalization failed earlier.</p><p>If we can't obtain payload for block creation, we use empty
 payload, because it's important to create blocks for system
 maintenance (empty blocks are better than no blocks).</p></div></div><div class="top"><p class="src"><a id="v:clearUSMemPool" class="def">clearUSMemPool</a> :: (MonadReader ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a> ctx <a href="Pos-Update-Context.html#t:UpdateContext">UpdateContext</a>, <a href="../base-4.9.1.0/Control-Monad-IO-Class.html#t:MonadIO">MonadIO</a> m) =&gt; m () <a href="src/Pos.Update.Logic.Local.html#clearUSMemPool" class="link">Source</a> <a href="#v:clearUSMemPool" class="selflink">#</a></p></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.17.3</p></div></body></html>