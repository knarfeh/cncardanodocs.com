<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Pos.Block.Logic</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Pos-Block-Logic.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Pos.Block.Logic.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">cardano-sl-1.0.3: Cardano SL main implementation</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Pos.Block.Logic</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Internals</a></li><li><a href="#g:2">Constraints</a></li><li><a href="#g:3">Garbage</a></li><li><a href="#g:4">Common/Utils</a></li></ul></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><a href="#v:createGenesisBlockAndApply">createGenesisBlockAndApply</a> :: <span class="keyword">forall</span> ssc ctx m. (MonadCreateBlock ssc ctx m, <a href="Pos-Block-Logic.html#t:MonadBlockApply">MonadBlockApply</a> ssc ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="../cardano-sl-infra-1.0.3/Pos-StateLock.html#t:StateLock">StateLock</a> ctx <a href="../cardano-sl-infra-1.0.3/Pos-StateLock.html#t:StateLock">StateLock</a>, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="../cardano-sl-infra-1.0.3/Pos-StateLock.html#t:StateLockMetrics">StateLockMetrics</a> ctx <a href="../cardano-sl-infra-1.0.3/Pos-StateLock.html#t:StateLockMetrics">StateLockMetrics</a>) =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:EpochIndex">EpochIndex</a> -&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> (<a href="Pos-Block-Core.html#t:GenesisBlock">GenesisBlock</a> ssc))</li><li class="src short"><a href="#v:createMainBlockAndApply">createMainBlockAndApply</a> :: <span class="keyword">forall</span> ssc ctx m. (MonadCreateBlock ssc ctx m, <a href="Pos-Block-Logic.html#t:MonadBlockApply">MonadBlockApply</a> ssc ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens-39-">HasLens'</a> ctx <a href="../cardano-sl-infra-1.0.3/Pos-StateLock.html#t:StateLock">StateLock</a>, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens-39-">HasLens'</a> ctx <a href="../cardano-sl-infra-1.0.3/Pos-StateLock.html#t:StateLockMetrics">StateLockMetrics</a>) =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:SlotId">SlotId</a> -&gt; <a href="Pos-Delegation-Types.html#t:ProxySKBlockInfo">ProxySKBlockInfo</a> -&gt; m (<a href="../base-4.9.1.0/Data-Either.html#t:Either">Either</a> Text (<a href="Pos-Block-Core.html#t:MainBlock">MainBlock</a> ssc))</li><li class="src short"><a href="#v:createMainBlockInternal">createMainBlockInternal</a> :: <span class="keyword">forall</span> ssc ctx m. MonadCreateBlock ssc ctx m =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:SlotId">SlotId</a> -&gt; <a href="Pos-Delegation-Types.html#t:ProxySKBlockInfo">ProxySKBlockInfo</a> -&gt; m (<a href="../base-4.9.1.0/Data-Either.html#t:Either">Either</a> Text (<a href="Pos-Block-Core.html#t:MainBlock">MainBlock</a> ssc))</li><li class="src short"><span class="keyword">data</span> <a href="#t:RawPayload">RawPayload</a> ssc = <a href="#v:RawPayload">RawPayload</a> {<ul class="subs"><li><a href="#v:rpTxp">rpTxp</a> :: ![<a href="../cardano-sl-txp-1.0.3/Pos-Txp-Core-Types.html#t:TxAux">TxAux</a>]</li><li><a href="#v:rpSsc">rpSsc</a> :: !(<a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Types.html#t:SscPayload">SscPayload</a> ssc)</li><li><a href="#v:rpDlg">rpDlg</a> :: !<a href="Pos-Delegation-Types.html#t:DlgPayload">DlgPayload</a></li><li><a href="#v:rpUpdate">rpUpdate</a> :: !<a href="../cardano-sl-update-1.0.3/Pos-Update-Core-Types.html#t:UpdatePayload">UpdatePayload</a></li></ul>}</li><li class="src short"><a href="#v:createMainBlockPure">createMainBlockPure</a> :: <span class="keyword">forall</span> m ssc. (MonadError Text m, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Helpers.html#t:SscHelpersClass">SscHelpersClass</a> ssc, <a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-update-1.0.3/Pos-Update-Configuration.html#t:HasUpdateConfiguration">HasUpdateConfiguration</a>) =&gt; Byte -&gt; <a href="Pos-Block-Core.html#t:BlockHeader">BlockHeader</a> ssc -&gt; <a href="Pos-Delegation-Types.html#t:ProxySKBlockInfo">ProxySKBlockInfo</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:SlotId">SlotId</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Crypto-Signing-Types-Signing.html#t:SecretKey">SecretKey</a> -&gt; <a href="Pos-Block-Logic.html#t:RawPayload">RawPayload</a> ssc -&gt; m (<a href="Pos-Block-Core.html#t:MainBlock">MainBlock</a> ssc)</li><li class="src short"><span class="keyword">data</span> <a href="#t:ClassifyHeaderRes">ClassifyHeaderRes</a><ul class="subs"><li>= <a href="#v:CHContinues">CHContinues</a></li><li>| <a href="#v:CHAlternative">CHAlternative</a></li><li>| <a href="#v:CHUseless">CHUseless</a> !Text</li><li>| <a href="#v:CHInvalid">CHInvalid</a> !Text</li></ul></li><li class="src short"><a href="#v:classifyNewHeader">classifyNewHeader</a> :: <span class="keyword">forall</span> ctx ssc m. (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-infra-1.0.3/Pos-Slotting-Class.html#t:MonadSlots">MonadSlots</a> ctx m, <a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m) =&gt; <a href="Pos-Block-Core.html#t:BlockHeader">BlockHeader</a> ssc -&gt; m <a href="Pos-Block-Logic.html#t:ClassifyHeaderRes">ClassifyHeaderRes</a></li><li class="src short"><span class="keyword">data</span> <a href="#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc<ul class="subs"><li>= <a href="#v:CHsValid">CHsValid</a> (<a href="Pos-Block-Core.html#t:BlockHeader">BlockHeader</a> ssc)</li><li>| <a href="#v:CHsUseless">CHsUseless</a> !Text</li><li>| <a href="#v:CHsInvalid">CHsInvalid</a> !Text</li></ul></li><li class="src short"><a href="#v:classifyHeaders">classifyHeaders</a> :: <span class="keyword">forall</span> ctx ssc m. (<a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m, <a href="../cardano-sl-infra-1.0.3/Pos-Slotting-Class.html#t:MonadSlots">MonadSlots</a> ctx m, MonadCatch m, WithLogger m, <a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>) =&gt; <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Block-Core.html#t:BlockHeader">BlockHeader</a> ssc) -&gt; m (<a href="Pos-Block-Logic.html#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc)</li><li class="src short"><a href="#v:getHeadersFromManyTo">getHeadersFromManyTo</a> :: <span class="keyword">forall</span> ssc m. (<a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m, WithLogger m, MonadError Text m, <a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="Pos-Configuration.html#t:HasNodeConfiguration">HasNodeConfiguration</a>) =&gt; <a href="../base-4.9.1.0/Data-List-NonEmpty.html#t:NonEmpty">NonEmpty</a> <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; <a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m (<a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Block-Core.html#t:BlockHeader">BlockHeader</a> ssc))</li><li class="src short"><a href="#v:getHeadersOlderExp">getHeadersOlderExp</a> :: <span class="keyword">forall</span> ssc m. (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-db-1.0.3/Pos-DB-Class.html#t:MonadDBRead">MonadDBRead</a> m, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Helpers.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m (<a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>)</li><li class="src short"><a href="#v:getHeadersFromToIncl">getHeadersFromToIncl</a> :: <span class="keyword">forall</span> ssc m. (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-db-1.0.3/Pos-DB-Class.html#t:MonadDBRead">MonadDBRead</a> m, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Helpers.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> (<a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>))</li><li class="src short"><span class="keyword">type</span> <a href="#t:MonadBlockBase">MonadBlockBase</a> ssc ctx m = (<a href="Pos-Block-Slog.html#t:MonadSlogBase">MonadSlogBase</a> ssc ctx m, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Extra-Class.html#t:MonadSscMem">MonadSscMem</a> ssc ctx m, <a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m, <a href="Pos-DB-Block.html#t:MonadSscBlockDB">MonadSscBlockDB</a> ssc m, <a href="../cardano-sl-db-1.0.3/Pos-DB-Class.html#t:MonadGState">MonadGState</a> m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="../cardano-sl-lrc-1.0.3/Pos-Lrc-Context.html#t:LrcContext">LrcContext</a> ctx <a href="../cardano-sl-lrc-1.0.3/Pos-Lrc-Context.html#t:LrcContext">LrcContext</a>, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="Pos-Context.html#t:TxpGlobalSettings">TxpGlobalSettings</a> ctx <a href="Pos-Context.html#t:TxpGlobalSettings">TxpGlobalSettings</a>, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Storage.html#t:SscGStateClass">SscGStateClass</a> ssc, <a href="Pos-Delegation.html#t:MonadDelegation">MonadDelegation</a> ctx m, MonadRandom m, <a href="../cardano-sl-infra-1.0.3/Pos-Reporting-Methods.html#t:MonadReporting">MonadReporting</a> ctx m)</li><li class="src short"><span class="keyword">type</span> <a href="#t:MonadBlockVerify">MonadBlockVerify</a> ssc ctx m = <a href="Pos-Block-Logic.html#t:MonadBlockBase">MonadBlockBase</a> ssc ctx m</li><li class="src short"><span class="keyword">type</span> <a href="#t:MonadBlockApply">MonadBlockApply</a> ssc ctx m = (<a href="Pos-Block-Logic.html#t:MonadBlockBase">MonadBlockBase</a> ssc ctx m, <a href="Pos-Block-Slog.html#t:MonadSlogApply">MonadSlogApply</a> ssc ctx m, <a href="../cardano-sl-db-1.0.3/Pos-DB-Class.html#t:MonadDB">MonadDB</a> m, MonadMask m, <a href="Pos-Block-BListener.html#t:MonadBListener">MonadBListener</a> m, Mockable CurrentTime m)</li><li class="src short"><span class="keyword">type</span> <a href="#t:MonadMempoolNormalization">MonadMempoolNormalization</a> ssc ctx m = (<a href="Pos-Block-Slog.html#t:MonadSlogBase">MonadSlogBase</a> ssc ctx m, <a href="../cardano-sl-txp-1.0.3/Pos-Txp-MemState-Class.html#t:MonadTxpMem">MonadTxpMem</a> <a href="Pos-WorkMode-Class.html#t:TxpExtra_TMP">TxpExtra_TMP</a> ctx m, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-LocalData.html#t:SscLocalDataClass">SscLocalDataClass</a> ssc, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Extra-Class.html#t:MonadSscMem">MonadSscMem</a> ssc ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="../cardano-sl-lrc-1.0.3/Pos-Lrc-Context.html#t:LrcContext">LrcContext</a> ctx <a href="../cardano-sl-lrc-1.0.3/Pos-Lrc-Context.html#t:LrcContext">LrcContext</a>, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="../cardano-sl-update-1.0.3/Pos-Update-Context.html#t:UpdateContext">UpdateContext</a> ctx <a href="../cardano-sl-update-1.0.3/Pos-Update-Context.html#t:UpdateContext">UpdateContext</a>, <a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m, <a href="Pos-DB-Block.html#t:MonadSscBlockDB">MonadSscBlockDB</a> ssc m, <a href="../cardano-sl-db-1.0.3/Pos-DB-Class.html#t:MonadGState">MonadGState</a> m, <a href="../cardano-sl-infra-1.0.3/Pos-Reporting-Methods.html#t:MonadReporting">MonadReporting</a> ctx m, MonadRandom m, Mockable CurrentTime m)</li><li class="src short"><a href="#v:applyBlocksUnsafe">applyBlocksUnsafe</a> :: <span class="keyword">forall</span> ssc ctx m. <a href="Pos-Block-Logic.html#t:MonadBlockApply">MonadBlockApply</a> ssc ctx m =&gt; <a href="Pos-Block-Slog.html#t:ShouldCallBListener">ShouldCallBListener</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Block-Types.html#t:Blund">Blund</a> ssc) -&gt; <a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="../cardano-sl-update-1.0.3/Pos-Update-Poll-Types.html#t:PollModifier">PollModifier</a> -&gt; m ()</li><li class="src short"><a href="#v:normalizeMempool">normalizeMempool</a> :: <span class="keyword">forall</span> ssc ctx m. <a href="Pos-Block-Logic.html#t:MonadMempoolNormalization">MonadMempoolNormalization</a> ssc ctx m =&gt; m ()</li><li class="src short"><a href="#v:rollbackBlocksUnsafe">rollbackBlocksUnsafe</a> :: <span class="keyword">forall</span> ssc ctx m. <a href="Pos-Block-Logic.html#t:MonadBlockApply">MonadBlockApply</a> ssc ctx m =&gt; <a href="Pos-Block-Logic.html#t:BypassSecurityCheck">BypassSecurityCheck</a> -&gt; <a href="Pos-Block-Slog.html#t:ShouldCallBListener">ShouldCallBListener</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Block-Types.html#t:Blund">Blund</a> ssc) -&gt; m ()</li><li class="src short"><span class="keyword">newtype</span> <a href="#t:BypassSecurityCheck">BypassSecurityCheck</a> = <a href="#v:BypassSecurityCheck">BypassSecurityCheck</a> <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a></li><li class="src short"><a href="#v:toUpdateBlock">toUpdateBlock</a> :: <span class="keyword">forall</span> ssc. (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Helpers.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="Pos-Block-Core.html#t:Block">Block</a> ssc -&gt; <a href="../cardano-sl-update-1.0.3/Pos-Update-Core-Types.html#t:UpdateBlock">UpdateBlock</a></li><li class="src short"><a href="#v:toTxpBlock">toTxpBlock</a> :: <span class="keyword">forall</span> ssc. (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Helpers.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="Pos-Block-Core.html#t:Block">Block</a> ssc -&gt; <a href="../cardano-sl-txp-1.0.3/Pos-Txp-Settings-Global.html#t:TxpBlock">TxpBlock</a></li><li class="src short"><a href="#v:lcaWithMainChain">lcaWithMainChain</a> :: (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-db-1.0.3/Pos-DB-Class.html#t:MonadDBRead">MonadDBRead</a> m, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Helpers.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Block-Core.html#t:BlockHeader">BlockHeader</a> ssc) -&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>)</li><li class="src short"><a href="#v:needRecovery">needRecovery</a> :: <span class="keyword">forall</span> ctx ssc m. (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-infra-1.0.3/Pos-Slotting-Class.html#t:MonadSlots">MonadSlots</a> ctx m, <a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m) =&gt; m <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a></li><li class="src short"><a href="#v:calcChainQuality">calcChainQuality</a> :: <a href="../base-4.9.1.0/Prelude.html#t:Fractional">Fractional</a> res =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:BlockCount">BlockCount</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:FlatSlotId">FlatSlotId</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:FlatSlotId">FlatSlotId</a> -&gt; res</li><li class="src short"><a href="#v:calcChainQualityM">calcChainQualityM</a> :: (MonadReader ctx m, <a href="Pos-Block-Slog.html#t:HasSlogGState">HasSlogGState</a> ctx, <a href="../base-4.9.1.0/Control-Monad-IO-Class.html#t:MonadIO">MonadIO</a> m, MonadThrow m, WithLogger m, <a href="../base-4.9.1.0/Prelude.html#t:Fractional">Fractional</a> res, <a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>) =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:FlatSlotId">FlatSlotId</a> -&gt; m res</li><li class="src short"><a href="#v:calcOverallChainQuality">calcOverallChainQuality</a> :: <span class="keyword">forall</span> ssc ctx m res. (<a href="../base-4.9.1.0/Prelude.html#t:Fractional">Fractional</a> res, <a href="../cardano-sl-infra-1.0.3/Pos-Slotting-Class.html#t:MonadSlots">MonadSlots</a> ctx m, <a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m, <a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>) =&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> res)</li><li class="src short"><a href="#v:calcChainQualityFixedTime">calcChainQualityFixedTime</a> :: <span class="keyword">forall</span> ctx m res. (<a href="../base-4.9.1.0/Prelude.html#t:Fractional">Fractional</a> res, <a href="../cardano-sl-infra-1.0.3/Pos-Slotting-Class.html#t:MonadSlots">MonadSlots</a> ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="Pos-Block-Slog.html#t:HasSlogGState">HasSlogGState</a> ctx) =&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> res)</li><li class="src short">module <a href="Pos-Block-Logic-VAR.html">Pos.Block.Logic.VAR</a></li></ul></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:createGenesisBlockAndApply" class="def">createGenesisBlockAndApply</a> :: <span class="keyword">forall</span> ssc ctx m. (MonadCreateBlock ssc ctx m, <a href="Pos-Block-Logic.html#t:MonadBlockApply">MonadBlockApply</a> ssc ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="../cardano-sl-infra-1.0.3/Pos-StateLock.html#t:StateLock">StateLock</a> ctx <a href="../cardano-sl-infra-1.0.3/Pos-StateLock.html#t:StateLock">StateLock</a>, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="../cardano-sl-infra-1.0.3/Pos-StateLock.html#t:StateLockMetrics">StateLockMetrics</a> ctx <a href="../cardano-sl-infra-1.0.3/Pos-StateLock.html#t:StateLockMetrics">StateLockMetrics</a>) =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:EpochIndex">EpochIndex</a> -&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> (<a href="Pos-Block-Core.html#t:GenesisBlock">GenesisBlock</a> ssc)) <a href="src/Pos.Block.Logic.Creation.html#createGenesisBlockAndApply" class="link">Source</a> <a href="#v:createGenesisBlockAndApply" class="selflink">#</a></p><div class="doc"><p>Create genesis block if necessary and apply it.</p><p>We can <em>try</em> to create a genesis block at any moment. However, it
 only makes sense to do it if the following conditions are met:</p><p>&#8226; our tip is a <code><a href="Pos-Block-Core.html#t:MainBlock">MainBlock</a></code> and its epoch is less than the given
   epoch by one;
 &#8226; chain quality is at least 0.5. To be more precise, it means that
   there are at least <code>blkSecurityParam</code> blocks in the last
   <code>slotSecurityParam</code> slots. If this condition is violated, it means
   that we are either desynchronized/eclipsed/attacked or that
   important security assumption is violated globally.
   In the former case, it doesn't make sense to create a block.
   In the latter case, we want the system to stop completely, rather
   than running in insecure mode.</p></div></div><div class="top"><p class="src"><a id="v:createMainBlockAndApply" class="def">createMainBlockAndApply</a> :: <span class="keyword">forall</span> ssc ctx m. (MonadCreateBlock ssc ctx m, <a href="Pos-Block-Logic.html#t:MonadBlockApply">MonadBlockApply</a> ssc ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens-39-">HasLens'</a> ctx <a href="../cardano-sl-infra-1.0.3/Pos-StateLock.html#t:StateLock">StateLock</a>, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens-39-">HasLens'</a> ctx <a href="../cardano-sl-infra-1.0.3/Pos-StateLock.html#t:StateLockMetrics">StateLockMetrics</a>) =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:SlotId">SlotId</a> -&gt; <a href="Pos-Delegation-Types.html#t:ProxySKBlockInfo">ProxySKBlockInfo</a> -&gt; m (<a href="../base-4.9.1.0/Data-Either.html#t:Either">Either</a> Text (<a href="Pos-Block-Core.html#t:MainBlock">MainBlock</a> ssc)) <a href="src/Pos.Block.Logic.Creation.html#createMainBlockAndApply" class="link">Source</a> <a href="#v:createMainBlockAndApply" class="selflink">#</a></p><div class="doc"><p>Create a new main block on top of our tip if possible and apply it.
 Block can be created if:
 &#8226; our software is not obsolete (see <code><a href="../cardano-sl-update-1.0.3/Pos-Update-Logic-Global.html#v:usCanCreateBlock">usCanCreateBlock</a></code>);
 &#8226; our tip's slot is less than the slot for which we want to create a block;
 &#8226; there are at least <code>blkSecurityParam</code> blocks in the last
 <code>slotSecurityParam</code> slots prior to the given slot (i. e. chain quality
 is decent).</p><p>In theory we can create main block even if chain quality is
 bad. See documentation of <code>createGenesisBlock</code> which explains why
 we don't create blocks in such cases.</p></div></div><div class="top"><p class="src"><a id="v:createMainBlockInternal" class="def">createMainBlockInternal</a> :: <span class="keyword">forall</span> ssc ctx m. MonadCreateBlock ssc ctx m =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:SlotId">SlotId</a> -&gt; <a href="Pos-Delegation-Types.html#t:ProxySKBlockInfo">ProxySKBlockInfo</a> -&gt; m (<a href="../base-4.9.1.0/Data-Either.html#t:Either">Either</a> Text (<a href="Pos-Block-Core.html#t:MainBlock">MainBlock</a> ssc)) <a href="src/Pos.Block.Logic.Creation.html#createMainBlockInternal" class="link">Source</a> <a href="#v:createMainBlockInternal" class="selflink">#</a></p><div class="doc"><p>Create a new main block for the given slot on top of our
 tip. This function assumes that lock on block application is taken
 (hence <code>Internal</code> suffix). It doesn't apply or verify created
 block. It only checks whether a block can be created (see
 <code><a href="Pos-Block-Logic.html#v:createMainBlockAndApply">createMainBlockAndApply</a></code>) and creates it checks passes.</p></div></div><h1 id="g:1">Internals</h1><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:RawPayload" class="def">RawPayload</a> ssc <a href="src/Pos.Block.Logic.Creation.html#RawPayload" class="link">Source</a> <a href="#t:RawPayload" class="selflink">#</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:RawPayload" class="def">RawPayload</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:rpTxp" class="def">rpTxp</a> :: ![<a href="../cardano-sl-txp-1.0.3/Pos-Txp-Core-Types.html#t:TxAux">TxAux</a>]</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:rpSsc" class="def">rpSsc</a> :: !(<a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Types.html#t:SscPayload">SscPayload</a> ssc)</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:rpDlg" class="def">rpDlg</a> :: !<a href="Pos-Delegation-Types.html#t:DlgPayload">DlgPayload</a></dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:rpUpdate" class="def">rpUpdate</a> :: !<a href="../cardano-sl-update-1.0.3/Pos-Update-Core-Types.html#t:UpdatePayload">UpdatePayload</a></dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><a id="v:createMainBlockPure" class="def">createMainBlockPure</a> <a href="src/Pos.Block.Logic.Creation.html#createMainBlockPure" class="link">Source</a> <a href="#v:createMainBlockPure" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: (MonadError Text m, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Helpers.html#t:SscHelpersClass">SscHelpersClass</a> ssc, <a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-update-1.0.3/Pos-Update-Configuration.html#t:HasUpdateConfiguration">HasUpdateConfiguration</a>)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; Byte</td><td class="doc"><p>Block size limit (real max.value)</p></td></tr><tr><td class="src">-&gt; <a href="Pos-Block-Core.html#t:BlockHeader">BlockHeader</a> ssc</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href="Pos-Delegation-Types.html#t:ProxySKBlockInfo">ProxySKBlockInfo</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:SlotId">SlotId</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href="../cardano-sl-core-1.0.3/Pos-Crypto-Signing-Types-Signing.html#t:SecretKey">SecretKey</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href="Pos-Block-Logic.html#t:RawPayload">RawPayload</a> ssc</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; m (<a href="Pos-Block-Core.html#t:MainBlock">MainBlock</a> ssc)</td><td class="doc empty">&nbsp;</td></tr></table></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:ClassifyHeaderRes" class="def">ClassifyHeaderRes</a> <a href="src/Pos.Block.Logic.Header.html#ClassifyHeaderRes" class="link">Source</a> <a href="#t:ClassifyHeaderRes" class="selflink">#</a></p><div class="doc"><p>Result of single (new) header classification.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:CHContinues" class="def">CHContinues</a></td><td class="doc"><p>Header is direct continuation of main chain (i.e. its
 parent is our tip).</p></td></tr><tr><td class="src"><a id="v:CHAlternative" class="def">CHAlternative</a></td><td class="doc"><p>Header continues main or alternative chain, it's more
 difficult than tip.</p></td></tr><tr><td class="src"><a id="v:CHUseless" class="def">CHUseless</a> !Text</td><td class="doc"><p>Header is useless.</p></td></tr><tr><td class="src"><a id="v:CHInvalid" class="def">CHInvalid</a> !Text</td><td class="doc"><p>Header is invalid.</p></td></tr></table></div><div class="subs instances"><p id="control.i:ClassifyHeaderRes" class="caption collapser" onclick="toggleSection('i:ClassifyHeaderRes')">Instances</p><div id="section.i:ClassifyHeaderRes" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><span id="control.i:id:ClassifyHeaderRes:Show:1" class="instance expander" onclick="toggleSection('i:id:ClassifyHeaderRes:Show:1')"></span> <a href="../base-4.9.1.0/Text-Show.html#t:Show">Show</a> <a href="Pos-Block-Logic.html#t:ClassifyHeaderRes">ClassifyHeaderRes</a></span> <a href="src/Pos.Block.Logic.Header.html#line-62" class="link">Source</a> <a href="#t:ClassifyHeaderRes" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div id="section.i:id:ClassifyHeaderRes:Show:1" class="inst-details hide"><div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> :: <a href="../base-4.9.1.0/Data-Int.html#t:Int">Int</a> -&gt; <a href="Pos-Block-Logic.html#t:ClassifyHeaderRes">ClassifyHeaderRes</a> -&gt; <a href="../base-4.9.1.0/Text-Show.html#t:ShowS">ShowS</a> <a href="#v:showsPrec" class="selflink">#</a></p><p class="src"><a href="#v:show">show</a> :: <a href="Pos-Block-Logic.html#t:ClassifyHeaderRes">ClassifyHeaderRes</a> -&gt; <a href="../base-4.9.1.0/Data-String.html#t:String">String</a> <a href="#v:show" class="selflink">#</a></p><p class="src"><a href="#v:showList">showList</a> :: [<a href="Pos-Block-Logic.html#t:ClassifyHeaderRes">ClassifyHeaderRes</a>] -&gt; <a href="../base-4.9.1.0/Text-Show.html#t:ShowS">ShowS</a> <a href="#v:showList" class="selflink">#</a></p></div></div></td></tr></table></div></div></div><div class="top"><p class="src"><a id="v:classifyNewHeader" class="def">classifyNewHeader</a> :: <span class="keyword">forall</span> ctx ssc m. (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-infra-1.0.3/Pos-Slotting-Class.html#t:MonadSlots">MonadSlots</a> ctx m, <a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m) =&gt; <a href="Pos-Block-Core.html#t:BlockHeader">BlockHeader</a> ssc -&gt; m <a href="Pos-Block-Logic.html#t:ClassifyHeaderRes">ClassifyHeaderRes</a> <a href="src/Pos.Block.Logic.Header.html#classifyNewHeader" class="link">Source</a> <a href="#v:classifyNewHeader" class="selflink">#</a></p><div class="doc"><p>Classify new header announced by some node. Result is represented
 as ClassifyHeaderRes type.</p></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:ClassifyHeadersRes" class="def">ClassifyHeadersRes</a> ssc <a href="src/Pos.Block.Logic.Header.html#ClassifyHeadersRes" class="link">Source</a> <a href="#t:ClassifyHeadersRes" class="selflink">#</a></p><div class="doc"><p>Result of multiple headers classification.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:CHsValid" class="def">CHsValid</a> (<a href="Pos-Block-Core.html#t:BlockHeader">BlockHeader</a> ssc)</td><td class="doc"><p>Header list can be applied,
    LCA child attached.</p></td></tr><tr><td class="src"><a id="v:CHsUseless" class="def">CHsUseless</a> !Text</td><td class="doc"><p>Header is useless.</p></td></tr><tr><td class="src"><a id="v:CHsInvalid" class="def">CHsInvalid</a> !Text</td><td class="doc"><p>Header is invalid.</p></td></tr></table></div><div class="subs instances"><p id="control.i:ClassifyHeadersRes" class="caption collapser" onclick="toggleSection('i:ClassifyHeadersRes')">Instances</p><div id="section.i:ClassifyHeadersRes" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><span id="control.i:id:ClassifyHeadersRes:Show:1" class="instance expander" onclick="toggleSection('i:id:ClassifyHeadersRes:Show:1')"></span> <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Types.html#t:Ssc">Ssc</a> ssc =&gt; <a href="../base-4.9.1.0/Text-Show.html#t:Show">Show</a> (<a href="Pos-Block-Logic.html#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc)</span> <a href="src/Pos.Block.Logic.Header.html#line-141" class="link">Source</a> <a href="#t:ClassifyHeadersRes" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div id="section.i:id:ClassifyHeadersRes:Show:1" class="inst-details hide"><div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> :: <a href="../base-4.9.1.0/Data-Int.html#t:Int">Int</a> -&gt; <a href="Pos-Block-Logic.html#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc -&gt; <a href="../base-4.9.1.0/Text-Show.html#t:ShowS">ShowS</a> <a href="#v:showsPrec" class="selflink">#</a></p><p class="src"><a href="#v:show">show</a> :: <a href="Pos-Block-Logic.html#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc -&gt; <a href="../base-4.9.1.0/Data-String.html#t:String">String</a> <a href="#v:show" class="selflink">#</a></p><p class="src"><a href="#v:showList">showList</a> :: [<a href="Pos-Block-Logic.html#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc] -&gt; <a href="../base-4.9.1.0/Text-Show.html#t:ShowS">ShowS</a> <a href="#v:showList" class="selflink">#</a></p></div></div></td></tr></table></div></div></div><div class="top"><p class="src"><a id="v:classifyHeaders" class="def">classifyHeaders</a> :: <span class="keyword">forall</span> ctx ssc m. (<a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m, <a href="../cardano-sl-infra-1.0.3/Pos-Slotting-Class.html#t:MonadSlots">MonadSlots</a> ctx m, MonadCatch m, WithLogger m, <a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>) =&gt; <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Block-Core.html#t:BlockHeader">BlockHeader</a> ssc) -&gt; m (<a href="Pos-Block-Logic.html#t:ClassifyHeadersRes">ClassifyHeadersRes</a> ssc) <a href="src/Pos.Block.Logic.Header.html#classifyHeaders" class="link">Source</a> <a href="#v:classifyHeaders" class="selflink">#</a></p><div class="doc"><p>Classify headers received in response to <code>GetHeaders</code> message.</p><ul><li>If there are any errors in chain of headers, CHsInvalid is returned.</li><li>If chain of headers is a valid continuation or alternative branch,
    lca child is returned.</li><li>If chain of headers forks from our main chain too much, CHsUseless
    is returned, because paper suggests doing so.</li><li>CHsUseless is also returned if we aren't too far behind the current slot
    (i.e. if <code>needRecovery</code> is false) but the newest header in the list isn't
    from the current slot. See CSL-177.</li></ul></div></div><div class="top"><p class="src"><a id="v:getHeadersFromManyTo" class="def">getHeadersFromManyTo</a> <a href="src/Pos.Block.Logic.Header.html#getHeadersFromManyTo" class="link">Source</a> <a href="#v:getHeadersFromManyTo" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: (<a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m, WithLogger m, MonadError Text m, <a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="Pos-Configuration.html#t:HasNodeConfiguration">HasNodeConfiguration</a>)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; <a href="../base-4.9.1.0/Data-List-NonEmpty.html#t:NonEmpty">NonEmpty</a> <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a></td><td class="doc"><p>Checkpoints; not guaranteed to be
   in any particular order</p></td></tr><tr><td class="src">-&gt; <a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; m (<a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Block-Core.html#t:BlockHeader">BlockHeader</a> ssc))</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Given a set of checkpoints <code>c</code> to stop at and a terminating
 header hash <code>h</code>, we take <code>h</code> block (or tip if latter is <code>Nothing</code>)
 and fetch the blocks until one of checkpoints is encountered. In
 case we got deeper than <code><a href="Pos-Configuration.html#v:recoveryHeadersMessage">recoveryHeadersMessage</a></code>, we return
 <code><a href="Pos-Configuration.html#v:recoveryHeadersMessage">recoveryHeadersMessage</a></code> headers starting from the the newest
 checkpoint that's in our main chain to the newest ones.</p></div></div><div class="top"><p class="src"><a id="v:getHeadersOlderExp" class="def">getHeadersOlderExp</a> :: <span class="keyword">forall</span> ssc m. (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-db-1.0.3/Pos-DB-Class.html#t:MonadDBRead">MonadDBRead</a> m, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Helpers.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m (<a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>) <a href="src/Pos.Block.Logic.Header.html#getHeadersOlderExp" class="link">Source</a> <a href="#v:getHeadersOlderExp" class="selflink">#</a></p><div class="doc"><p>Given a starting point hash (we take tip if it's not in storage)
 it returns not more than <code><a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration-Protocol.html#v:blkSecurityParam">blkSecurityParam</a></code> blocks distributed
 exponentially base 2 relatively to the depth in the blockchain.</p></div></div><div class="top"><p class="src"><a id="v:getHeadersFromToIncl" class="def">getHeadersFromToIncl</a> :: <span class="keyword">forall</span> ssc m. (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-db-1.0.3/Pos-DB-Class.html#t:MonadDBRead">MonadDBRead</a> m, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Helpers.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a> -&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> (<a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>)) <a href="src/Pos.Block.Logic.Header.html#getHeadersFromToIncl" class="link">Source</a> <a href="#v:getHeadersFromToIncl" class="selflink">#</a></p><div class="doc"><p>Given <code>from</code> and <code>to</code> headers where <code>from</code> is older (not strict)
 than <code>to</code>, and valid chain in between can be found, headers in
 range <code>[from..to]</code> will be found.</p></div></div><h1 id="g:2">Constraints</h1><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:MonadBlockBase" class="def">MonadBlockBase</a> ssc ctx m = (<a href="Pos-Block-Slog.html#t:MonadSlogBase">MonadSlogBase</a> ssc ctx m, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Extra-Class.html#t:MonadSscMem">MonadSscMem</a> ssc ctx m, <a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m, <a href="Pos-DB-Block.html#t:MonadSscBlockDB">MonadSscBlockDB</a> ssc m, <a href="../cardano-sl-db-1.0.3/Pos-DB-Class.html#t:MonadGState">MonadGState</a> m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="../cardano-sl-lrc-1.0.3/Pos-Lrc-Context.html#t:LrcContext">LrcContext</a> ctx <a href="../cardano-sl-lrc-1.0.3/Pos-Lrc-Context.html#t:LrcContext">LrcContext</a>, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="Pos-Context.html#t:TxpGlobalSettings">TxpGlobalSettings</a> ctx <a href="Pos-Context.html#t:TxpGlobalSettings">TxpGlobalSettings</a>, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Storage.html#t:SscGStateClass">SscGStateClass</a> ssc, <a href="Pos-Delegation.html#t:MonadDelegation">MonadDelegation</a> ctx m, MonadRandom m, <a href="../cardano-sl-infra-1.0.3/Pos-Reporting-Methods.html#t:MonadReporting">MonadReporting</a> ctx m) <a href="src/Pos.Block.Logic.Internal.html#MonadBlockBase" class="link">Source</a> <a href="#t:MonadBlockBase" class="selflink">#</a></p><div class="doc"><p>Set of basic constraints used by high-level block processing.</p></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:MonadBlockVerify" class="def">MonadBlockVerify</a> ssc ctx m = <a href="Pos-Block-Logic.html#t:MonadBlockBase">MonadBlockBase</a> ssc ctx m <a href="src/Pos.Block.Logic.Internal.html#MonadBlockVerify" class="link">Source</a> <a href="#t:MonadBlockVerify" class="selflink">#</a></p><div class="doc"><p>Set of constraints necessary for high-level block verification.</p></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:MonadBlockApply" class="def">MonadBlockApply</a> ssc ctx m = (<a href="Pos-Block-Logic.html#t:MonadBlockBase">MonadBlockBase</a> ssc ctx m, <a href="Pos-Block-Slog.html#t:MonadSlogApply">MonadSlogApply</a> ssc ctx m, <a href="../cardano-sl-db-1.0.3/Pos-DB-Class.html#t:MonadDB">MonadDB</a> m, MonadMask m, <a href="Pos-Block-BListener.html#t:MonadBListener">MonadBListener</a> m, Mockable CurrentTime m) <a href="src/Pos.Block.Logic.Internal.html#MonadBlockApply" class="link">Source</a> <a href="#t:MonadBlockApply" class="selflink">#</a></p><div class="doc"><p>Set of constraints necessary to apply or rollback blocks at high-level.
 Also normalize mempool.</p></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:MonadMempoolNormalization" class="def">MonadMempoolNormalization</a> ssc ctx m = (<a href="Pos-Block-Slog.html#t:MonadSlogBase">MonadSlogBase</a> ssc ctx m, <a href="../cardano-sl-txp-1.0.3/Pos-Txp-MemState-Class.html#t:MonadTxpMem">MonadTxpMem</a> <a href="Pos-WorkMode-Class.html#t:TxpExtra_TMP">TxpExtra_TMP</a> ctx m, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-LocalData.html#t:SscLocalDataClass">SscLocalDataClass</a> ssc, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Extra-Class.html#t:MonadSscMem">MonadSscMem</a> ssc ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="../cardano-sl-lrc-1.0.3/Pos-Lrc-Context.html#t:LrcContext">LrcContext</a> ctx <a href="../cardano-sl-lrc-1.0.3/Pos-Lrc-Context.html#t:LrcContext">LrcContext</a>, <a href="../cardano-sl-core-1.0.3/Pos-Util-Util.html#t:HasLens">HasLens</a> <a href="../cardano-sl-update-1.0.3/Pos-Update-Context.html#t:UpdateContext">UpdateContext</a> ctx <a href="../cardano-sl-update-1.0.3/Pos-Update-Context.html#t:UpdateContext">UpdateContext</a>, <a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m, <a href="Pos-DB-Block.html#t:MonadSscBlockDB">MonadSscBlockDB</a> ssc m, <a href="../cardano-sl-db-1.0.3/Pos-DB-Class.html#t:MonadGState">MonadGState</a> m, <a href="../cardano-sl-infra-1.0.3/Pos-Reporting-Methods.html#t:MonadReporting">MonadReporting</a> ctx m, MonadRandom m, Mockable CurrentTime m) <a href="src/Pos.Block.Logic.Internal.html#MonadMempoolNormalization" class="link">Source</a> <a href="#t:MonadMempoolNormalization" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:applyBlocksUnsafe" class="def">applyBlocksUnsafe</a> :: <span class="keyword">forall</span> ssc ctx m. <a href="Pos-Block-Logic.html#t:MonadBlockApply">MonadBlockApply</a> ssc ctx m =&gt; <a href="Pos-Block-Slog.html#t:ShouldCallBListener">ShouldCallBListener</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Block-Types.html#t:Blund">Blund</a> ssc) -&gt; <a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="../cardano-sl-update-1.0.3/Pos-Update-Poll-Types.html#t:PollModifier">PollModifier</a> -&gt; m () <a href="src/Pos.Block.Logic.Internal.html#applyBlocksUnsafe" class="link">Source</a> <a href="#v:applyBlocksUnsafe" class="selflink">#</a></p><div class="doc"><p>Applies a definitely valid prefix of blocks. This function is unsafe,
 use it only if you understand what you're doing. That means you can break
 system guarantees.</p><p>Invariant: all blocks have the same epoch.</p></div></div><div class="top"><p class="src"><a id="v:normalizeMempool" class="def">normalizeMempool</a> :: <span class="keyword">forall</span> ssc ctx m. <a href="Pos-Block-Logic.html#t:MonadMempoolNormalization">MonadMempoolNormalization</a> ssc ctx m =&gt; m () <a href="src/Pos.Block.Logic.Internal.html#normalizeMempool" class="link">Source</a> <a href="#v:normalizeMempool" class="selflink">#</a></p><div class="doc"><p>Normalize mempool.</p></div></div><div class="top"><p class="src"><a id="v:rollbackBlocksUnsafe" class="def">rollbackBlocksUnsafe</a> <a href="src/Pos.Block.Logic.Internal.html#rollbackBlocksUnsafe" class="link">Source</a> <a href="#v:rollbackBlocksUnsafe" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="Pos-Block-Logic.html#t:MonadBlockApply">MonadBlockApply</a> ssc ctx m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; <a href="Pos-Block-Logic.html#t:BypassSecurityCheck">BypassSecurityCheck</a></td><td class="doc"><p>is rollback for more than k blocks allowed?</p></td></tr><tr><td class="src">-&gt; <a href="Pos-Block-Slog.html#t:ShouldCallBListener">ShouldCallBListener</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NewestFirst">NewestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Block-Types.html#t:Blund">Blund</a> ssc)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; m ()</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Rollback sequence of blocks, head-newest order expected with head being
 current tip. It's also assumed that lock on block db is taken already.</p></div></div><div class="top"><p class="src"><span class="keyword">newtype</span> <a id="t:BypassSecurityCheck" class="def">BypassSecurityCheck</a> <a href="src/Pos.Block.Slog.Logic.html#BypassSecurityCheck" class="link">Source</a> <a href="#t:BypassSecurityCheck" class="selflink">#</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:BypassSecurityCheck" class="def">BypassSecurityCheck</a> <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div><h1 id="g:3">Garbage</h1><div class="top"><p class="src"><a id="v:toUpdateBlock" class="def">toUpdateBlock</a> :: <span class="keyword">forall</span> ssc. (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Helpers.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="Pos-Block-Core.html#t:Block">Block</a> ssc -&gt; <a href="../cardano-sl-update-1.0.3/Pos-Update-Core-Types.html#t:UpdateBlock">UpdateBlock</a> <a href="src/Pos.Block.Logic.Internal.html#toUpdateBlock" class="link">Source</a> <a href="#v:toUpdateBlock" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:toTxpBlock" class="def">toTxpBlock</a> :: <span class="keyword">forall</span> ssc. (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Helpers.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="Pos-Block-Core.html#t:Block">Block</a> ssc -&gt; <a href="../cardano-sl-txp-1.0.3/Pos-Txp-Settings-Global.html#t:TxpBlock">TxpBlock</a> <a href="src/Pos.Block.Logic.Internal.html#toTxpBlock" class="link">Source</a> <a href="#v:toTxpBlock" class="selflink">#</a></p></div><h1 id="g:4">Common/Utils</h1><div class="top"><p class="src"><a id="v:lcaWithMainChain" class="def">lcaWithMainChain</a> :: (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-db-1.0.3/Pos-DB-Class.html#t:MonadDBRead">MonadDBRead</a> m, <a href="../cardano-sl-ssc-1.0.3/Pos-Ssc-Class-Helpers.html#t:SscHelpersClass">SscHelpersClass</a> ssc) =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:OldestFirst">OldestFirst</a> <a href="../cardano-sl-core-1.0.3/Pos-Util-Chrono.html#t:NE">NE</a> (<a href="Pos-Block-Core.html#t:BlockHeader">BlockHeader</a> ssc) -&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:HeaderHash">HeaderHash</a>) <a href="src/Pos.Block.Logic.Util.html#lcaWithMainChain" class="link">Source</a> <a href="#v:lcaWithMainChain" class="selflink">#</a></p><div class="doc"><p>Find LCA of headers list and main chain, including oldest
 header's parent hash. Iterates from newest to oldest until meets
 first header that's in main chain. O(n).</p></div></div><div class="top"><p class="src"><a id="v:needRecovery" class="def">needRecovery</a> :: <span class="keyword">forall</span> ctx ssc m. (<a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="../cardano-sl-infra-1.0.3/Pos-Slotting-Class.html#t:MonadSlots">MonadSlots</a> ctx m, <a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m) =&gt; m <a href="../base-4.9.1.0/Data-Bool.html#t:Bool">Bool</a> <a href="src/Pos.Block.Logic.Util.html#needRecovery" class="link">Source</a> <a href="#v:needRecovery" class="selflink">#</a></p><div class="doc"><p>The phrase &#8220;we're in recovery mode&#8221; is confusing because it can mean two
 different things:</p><ol><li>Last known block is more than K slots away from the current slot, or
    current slot isn't known.</li><li>We're actually in the process of requesting blocks because we have
    detected that #1 happened. (See <code>ncRecoveryHeader</code> and
    <code>recoveryInProgress</code>.)</li></ol><p>This function checks for #1. Note that even if we're doing recovery right
 now, <code><a href="Pos-Block-Logic.html#v:needRecovery">needRecovery</a></code> will still return <code><a href="../base-4.9.1.0/Data-Bool.html#v:True">True</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:calcChainQuality" class="def">calcChainQuality</a> :: <a href="../base-4.9.1.0/Prelude.html#t:Fractional">Fractional</a> res =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:BlockCount">BlockCount</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:FlatSlotId">FlatSlotId</a> -&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:FlatSlotId">FlatSlotId</a> -&gt; res <a href="src/Pos.Block.Logic.Util.html#calcChainQuality" class="link">Source</a> <a href="#v:calcChainQuality" class="selflink">#</a></p><div class="doc"><p>Calculate chain quality using slot of the block which has depth =
 <code>blocksCount</code> and another slot after that one for which we
 want to know chain quality.</p><p>See documentation of <code>chainQualityThreshold</code> to see why this
 function returns any <code><a href="../base-4.9.1.0/Prelude.html#t:Fractional">Fractional</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:calcChainQualityM" class="def">calcChainQualityM</a> :: (MonadReader ctx m, <a href="Pos-Block-Slog.html#t:HasSlogGState">HasSlogGState</a> ctx, <a href="../base-4.9.1.0/Control-Monad-IO-Class.html#t:MonadIO">MonadIO</a> m, MonadThrow m, WithLogger m, <a href="../base-4.9.1.0/Prelude.html#t:Fractional">Fractional</a> res, <a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>) =&gt; <a href="../cardano-sl-core-1.0.3/Pos-Core-Types.html#t:FlatSlotId">FlatSlotId</a> -&gt; m res <a href="src/Pos.Block.Logic.Util.html#calcChainQualityM" class="link">Source</a> <a href="#v:calcChainQualityM" class="selflink">#</a></p><div class="doc"><p>Version of <code><a href="Pos-Block-Logic.html#v:calcChainQuality">calcChainQuality</a></code> which takes last blocks' slots from
 the monadic context. It computes chain quality for last
 <code><a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration-Protocol.html#v:blkSecurityParam">blkSecurityParam</a></code> blocks.</p></div></div><div class="top"><p class="src"><a id="v:calcOverallChainQuality" class="def">calcOverallChainQuality</a> :: <span class="keyword">forall</span> ssc ctx m res. (<a href="../base-4.9.1.0/Prelude.html#t:Fractional">Fractional</a> res, <a href="../cardano-sl-infra-1.0.3/Pos-Slotting-Class.html#t:MonadSlots">MonadSlots</a> ctx m, <a href="Pos-DB-Block.html#t:MonadBlockDB">MonadBlockDB</a> ssc m, <a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>) =&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> res) <a href="src/Pos.Block.Logic.Util.html#calcOverallChainQuality" class="link">Source</a> <a href="#v:calcOverallChainQuality" class="selflink">#</a></p><div class="doc"><p>Calculate overall chain quality, i. e. number of main blocks
 divided by number of slots so far. Returns <code><a href="../base-4.9.1.0/Data-Maybe.html#v:Nothing">Nothing</a></code> if current
 slot is unknown.</p></div></div><div class="top"><p class="src"><a id="v:calcChainQualityFixedTime" class="def">calcChainQualityFixedTime</a> :: <span class="keyword">forall</span> ctx m res. (<a href="../base-4.9.1.0/Prelude.html#t:Fractional">Fractional</a> res, <a href="../cardano-sl-infra-1.0.3/Pos-Slotting-Class.html#t:MonadSlots">MonadSlots</a> ctx m, <a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration.html#t:HasConfiguration">HasConfiguration</a>, <a href="Pos-Block-Slog.html#t:HasSlogGState">HasSlogGState</a> ctx) =&gt; m (<a href="../base-4.9.1.0/Data-Maybe.html#t:Maybe">Maybe</a> res) <a href="src/Pos.Block.Logic.Util.html#calcChainQualityFixedTime" class="link">Source</a> <a href="#v:calcChainQualityFixedTime" class="selflink">#</a></p><div class="doc"><p>Calculate chain quality for approximately <code><a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration-Core.html#v:fixedTimeCQ">fixedTimeCQ</a></code>. Works
 only if the following conditions are met:</p><ol><li>At least <code><a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration-Core.html#v:fixedTimeCQ">fixedTimeCQ</a></code> passed since system start.</li><li>Block with depth <code><a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration-Protocol.html#v:blkSecurityParam">blkSecurityParam</a></code> was created more than
 <code><a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration-Core.html#v:fixedTimeCQ">fixedTimeCQ</a></code> ago. You should configure constants properly. For k =
 2160 <code><a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration-Core.html#v:fixedTimeCQ">fixedTimeCQ</a></code> can be even 12h. We want 1h, so it's not
 restrictive at all.</li><li>We are able to determine which slot started <code><a href="../cardano-sl-core-1.0.3/Pos-Core-Configuration-Core.html#v:fixedTimeCQ">fixedTimeCQ</a></code> ago.</li></ol></div></div><div class="top"><p class="src">module <a href="Pos-Block-Logic-VAR.html">Pos.Block.Logic.VAR</a></p></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.17.3</p></div></body></html>