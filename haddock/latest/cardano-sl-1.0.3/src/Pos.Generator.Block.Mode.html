<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP          #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DataKinds    #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">-- | Execution mode used by blockchain generator.</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Generator</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Mode</span><span>
</span><a name="line-8"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Pos.Generator.Block.Mode.html#MonadBlockGenBase"><span class="hs-identifier hs-type">MonadBlockGenBase</span></a><span>
</span><a name="line-9"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.Block.Mode.html#MonadBlockGen"><span class="hs-identifier hs-type">MonadBlockGen</span></a><span>
</span><a name="line-10"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.Block.Mode.html#BlockGenContext"><span class="hs-identifier hs-type">BlockGenContext</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.Block.Mode.html#BlockGenMode"><span class="hs-identifier hs-type">BlockGenMode</span></a><span>
</span><a name="line-12"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.Block.Mode.html#BlockGenRandMode"><span class="hs-identifier hs-type">BlockGenRandMode</span></a><span>
</span><a name="line-13"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.Block.Mode.html#mkBlockGenContext"><span class="hs-identifier hs-var">mkBlockGenContext</span></a><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.Block.Mode.html#usingPrimaryKey"><span class="hs-identifier hs-var">usingPrimaryKey</span></a><span>
</span><a name="line-16"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.Block.Mode.html#withCurrentSlot"><span class="hs-identifier hs-var">withCurrentSlot</span></a><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.Block.Mode.html#InitBlockGenContext"><span class="hs-identifier hs-type">InitBlockGenContext</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- useless</span><span>
</span><a name="line-19"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">makeLensesWith</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Catch</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Random</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RandT</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span class="hs-operator">.</span><span class="hs-identifier">Control</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadBaseControl</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Crypto</span><span class="hs-operator">.</span><span class="hs-identifier">Random</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Rand</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Mockable</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Catch</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Concurrently</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CurrentTime</span><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>                                              </span><span class="hs-identifier hs-type">Delay</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Mockables</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Promise</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Throw</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Wlog</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WithLogger</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logWarning</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.BListener.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">BListener</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Block.BListener.html#MonadBListener"><span class="hs-identifier hs-type">MonadBListener</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Block.BListener.html#onApplyBlocksStub"><span class="hs-identifier hs-var">onApplyBlocksStub</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>                                              </span><a href="Pos.Block.BListener.html#onRollbackBlocksStub"><span class="hs-identifier hs-var">onRollbackBlocksStub</span></a><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.Core.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span></a><span>              </span><span class="hs-special">(</span><a href="Pos.Block.Core.Union.Types.html#Block"><span class="hs-identifier hs-type">Block</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Block.Core.Union.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.Slog.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Slog</span></a><span>              </span><span class="hs-special">(</span><a href="Pos.Block.Slog.Types.html#HasSlogGState"><span class="hs-identifier hs-type">HasSlogGState</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>             </span><span class="hs-special">(</span><a href="Pos.Block.Types.html#Undo"><span class="hs-identifier hs-type">Undo</span></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Client.Txp.Addresses.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Client</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span><span class="hs-operator">.</span><span class="hs-identifier">Addresses</span></a><span>    </span><span class="hs-special">(</span><a href="Pos.Client.Txp.Addresses.html#MonadAddresses"><span class="hs-identifier hs-type">MonadAddresses</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Configuration.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Configuration</span></a><span>           </span><span class="hs-special">(</span><a href="Pos.Configuration.html#HasNodeConfiguration"><span class="hs-identifier hs-type">HasNodeConfiguration</span></a><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Address</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">GenesisWStakeholders</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>                                              </span><span class="hs-identifier hs-type">HasConfiguration</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasPrimaryKey</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>                                              </span><span class="hs-identifier hs-type">IsHeader</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SlotId</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Timestamp</span><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>                                              </span><span class="hs-identifier hs-var">epochOrSlotToSlot</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getEpochOrSlot</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SecretKey</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DBSum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadBlockDBGeneric</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>                                              </span><span class="hs-identifier hs-type">MonadBlockDBGenericWrite</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadDB</span><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>                                              </span><span class="hs-identifier hs-type">MonadDBRead</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DB</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.DB.Block.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span></a><span>                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BDB</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.DB.DB.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span></a><span>                   </span><span class="hs-special">(</span><a href="Pos.DB.DB.html#getTipHeader"><span class="hs-identifier hs-var">getTipHeader</span></a><span class="hs-special">,</span><span> </span><a href="Pos.DB.DB.html#gsAdoptedBVDataDefault"><span class="hs-identifier hs-var">gsAdoptedBVDataDefault</span></a><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Delegation.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Delegation</span></a><span>              </span><span class="hs-special">(</span><a href="Pos.Delegation.Class.html#DelegationVar"><span class="hs-identifier hs-type">DelegationVar</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.Common.html#mkDelegationVar"><span class="hs-identifier hs-var">mkDelegationVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reportFatalError</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Generator.Block.Param.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Generator</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Param</span></a><span>   </span><span class="hs-special">(</span><a href="Pos.Generator.Block.Param.html#BlockGenParams"><span class="hs-identifier hs-type">BlockGenParams</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.Block.Param.html#HasBlockGenParams"><span class="hs-identifier hs-type">HasBlockGenParams</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-53"></a><span>                                              </span><a href="Pos.Generator.Block.Param.html#HasTxGenParams"><span class="hs-identifier hs-type">HasTxGenParams</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.GState.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">GState</span></a><span>                  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GS</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Infra</span><span class="hs-operator">.</span><span class="hs-identifier">Configuration</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasInfraConfiguration</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">KnownPeers</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadFormatPeers</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Lrc.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Lrc</span></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LrcContext</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasNodeType</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NodeType</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Reporting</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasReportingContext</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ReportingContext</span><span class="hs-special">,</span><span>
</span><a name="line-60"></a><span>                                              </span><span class="hs-identifier hs-var">emptyReportingContext</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Slotting</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasSlottingVar</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadSlots</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>                                              </span><span class="hs-identifier hs-type">MonadSlotsData</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SlottingData</span><span class="hs-special">,</span><span>
</span><a name="line-63"></a><span>                                              </span><span class="hs-identifier hs-var">currentTimeSlottingSimple</span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscBlock</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">Extra</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscMemTag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SscState</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkSscState</span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Ssc.GodTossing.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">GodTossing</span></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscGodTossing</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">GodTossing</span><span class="hs-operator">.</span><span class="hs-identifier">Configuration</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasGtConfiguration</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Txp.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GenericTxpLocalData</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TxpGlobalSettings</span><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>                                              </span><span class="hs-identifier hs-type">TxpHolderTag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTxpLocalData</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Update</span><span class="hs-operator">.</span><span class="hs-identifier">Configuration</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasUpdateConfiguration</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Update</span><span class="hs-operator">.</span><span class="hs-identifier">Context</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-type">UpdateContext</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkUpdateContext</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasLens</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Some</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newInitFuture</span><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>                                              </span><span class="hs-identifier hs-var">postfixLFields</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.WorkMode.Class.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">WorkMode</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>          </span><span class="hs-special">(</span><a href="Pos.WorkMode.Class.html#TxpExtra_TMP"><span class="hs-identifier hs-type">TxpExtra_TMP</span></a><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span class="hs-cpp">#ifdef WITH_EXPLORER</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Explorer.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Explorer</span></a><span>                </span><span class="hs-special">(</span><a href="Pos.Explorer.Txp.Global.html#explorerTxpGlobalSettings"><span class="hs-identifier hs-var">explorerTxpGlobalSettings</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier">txpGlobalSettings</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">-- Remove this once there's no #ifdef-ed Pos.Txp import</span><span>
</span><a name="line-82"></a><span class="hs-pragma">{-# ANN module (&quot;HLint: ignore Use fewer imports&quot; :: Text) #-}</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- Constraint</span><span>
</span><a name="line-87"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-comment">-- | A set of constraints imposed on the base monad used for</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- arbitrary blockchain generation.</span><span>
</span><a name="line-91"></a><span class="hs-keyword">type</span><span> </span><a name="MonadBlockGenBase"><a href="Pos.Generator.Block.Mode.html#MonadBlockGenBase"><span class="hs-identifier">MonadBlockGenBase</span></a></a><span> </span><a name="local-6989586621681734486"><a href="#local-6989586621681734486"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-92"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">WithLogger</span><span> </span><a href="#local-6989586621681734486"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-93"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span> </span><a href="#local-6989586621681734486"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-94"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621681734486"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-95"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadBaseControl</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681734486"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-96"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFormatPeers</span><span> </span><a href="#local-6989586621681734486"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-97"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Mockables</span><span> </span><a href="#local-6989586621681734486"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-98"></a><span>           </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-type">CurrentTime</span><span>
</span><a name="line-99"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Async</span><span>
</span><a name="line-100"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Catch</span><span>
</span><a name="line-101"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Throw</span><span>
</span><a name="line-102"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Delay</span><span>
</span><a name="line-103"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Concurrently</span><span>
</span><a name="line-104"></a><span>           </span><span class="hs-special">]</span><span>
</span><a name="line-105"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Promise</span><span> </span><a href="#local-6989586621681734486"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- are you cereal boyz??1?</span><span>
</span><a name="line-106"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasConfiguration</span><span>
</span><a name="line-107"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasUpdateConfiguration</span><span>
</span><a name="line-108"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasInfraConfiguration</span><span>
</span><a name="line-109"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasGtConfiguration</span><span>
</span><a name="line-110"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Configuration.html#HasNodeConfiguration"><span class="hs-identifier hs-type">HasNodeConfiguration</span></a><span>
</span><a name="line-111"></a><span>       </span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-comment">-- | A set of constraints necessary for blockchain generation. All</span><span>
</span><a name="line-114"></a><span class="hs-comment">-- these constraints must be satistified by the generator's caller.</span><span>
</span><a name="line-115"></a><span class="hs-keyword">type</span><span> </span><a name="MonadBlockGen"><a href="Pos.Generator.Block.Mode.html#MonadBlockGen"><span class="hs-identifier">MonadBlockGen</span></a></a><span> </span><a name="local-6989586621681734484"><a href="#local-6989586621681734484"><span class="hs-identifier">ctx</span></a></a><span> </span><a name="local-6989586621681734485"><a href="#local-6989586621681734485"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-116"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="Pos.Generator.Block.Mode.html#MonadBlockGenBase"><span class="hs-identifier hs-type">MonadBlockGenBase</span></a><span> </span><a href="#local-6989586621681734485"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-117"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadReader</span><span> </span><a href="#local-6989586621681734484"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681734485"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-118"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.GState.Context.html#HasGStateContext"><span class="hs-identifier hs-type">GS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">HasGStateContext</span></a><span> </span><a href="#local-6989586621681734484"><span class="hs-identifier hs-type">ctx</span></a><span>
</span><a name="line-119"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasSlottingVar</span><span> </span><a href="#local-6989586621681734484"><span class="hs-identifier hs-type">ctx</span></a><span>
</span><a name="line-120"></a><span>       </span><span class="hs-comment">-- 'MonadRandom' for crypto.</span><span>
</span><a name="line-121"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Rand</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">MonadRandom</span><span> </span><a href="#local-6989586621681734485"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-122"></a><span>       </span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-125"></a><span class="hs-comment">-- Context</span><span>
</span><a name="line-126"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-comment">-- | Context used by blockchain generator.</span><span>
</span><a name="line-129"></a><span class="hs-keyword">data</span><span> </span><a name="BlockGenContext"><a href="Pos.Generator.Block.Mode.html#BlockGenContext"><span class="hs-identifier">BlockGenContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="BlockGenContext"><a href="Pos.Generator.Block.Mode.html#BlockGenContext"><span class="hs-identifier">BlockGenContext</span></a></a><span>
</span><a name="line-130"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="bgcPrimaryKey"><a href="Pos.Generator.Block.Mode.html#bgcPrimaryKey"><span class="hs-identifier">bgcPrimaryKey</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SecretKey</span><span>
</span><a name="line-131"></a><span>    </span><span class="hs-comment">-- ^ This field is lazy on purpose. Primary key used for block</span><span>
</span><a name="line-132"></a><span>    </span><span class="hs-comment">-- generation changes frequently. We don't define it initially and</span><span>
</span><a name="line-133"></a><span>    </span><span class="hs-comment">-- modify it using 'local' when we need it. Alternative solution</span><span>
</span><a name="line-134"></a><span>    </span><span class="hs-comment">-- would be to define a type w/o primary key and another one with</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-comment">-- primary key, but it would lead to enormous amount of</span><span>
</span><a name="line-136"></a><span>    </span><span class="hs-comment">-- boilerplate. Also it could be put into mutable reference, but</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-comment">-- it's complicated too.</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="bgcGState"><a href="Pos.Generator.Block.Mode.html#bgcGState"><span class="hs-identifier">bgcGState</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.GState.Context.html#GStateContext"><span class="hs-identifier hs-type">GS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">GStateContext</span></a><span>
</span><a name="line-139"></a><span>    </span><span class="hs-comment">-- ^ Currently we always use pure DB and assume it always fits in</span><span>
</span><a name="line-140"></a><span>    </span><span class="hs-comment">-- memory. It allows us to simply clone existing DB.</span><span>
</span><a name="line-141"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="bgcSystemStart"><a href="Pos.Generator.Block.Mode.html#bgcSystemStart"><span class="hs-identifier">bgcSystemStart</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Timestamp</span><span>
</span><a name="line-142"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="bgcParams"><a href="Pos.Generator.Block.Mode.html#bgcParams"><span class="hs-identifier">bgcParams</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Generator.Block.Param.html#BlockGenParams"><span class="hs-identifier hs-type">BlockGenParams</span></a><span>
</span><a name="line-143"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="bgcDelegation"><a href="Pos.Generator.Block.Mode.html#bgcDelegation"><span class="hs-identifier">bgcDelegation</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Delegation.Class.html#DelegationVar"><span class="hs-identifier hs-type">DelegationVar</span></a><span>
</span><a name="line-144"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="bgcGenStakeholders"><a href="Pos.Generator.Block.Mode.html#bgcGenStakeholders"><span class="hs-identifier">bgcGenStakeholders</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">GenesisWStakeholders</span><span>
</span><a name="line-145"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="bgcTxpMem"><a href="Pos.Generator.Block.Mode.html#bgcTxpMem"><span class="hs-identifier">bgcTxpMem</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">GenericTxpLocalData</span><span> </span><a href="Pos.WorkMode.Class.html#TxpExtra_TMP"><span class="hs-identifier hs-type">TxpExtra_TMP</span></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="bgcUpdateContext"><a href="Pos.Generator.Block.Mode.html#bgcUpdateContext"><span class="hs-identifier">bgcUpdateContext</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">UpdateContext</span><span>
</span><a name="line-147"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="bgcSscState"><a href="Pos.Generator.Block.Mode.html#bgcSscState"><span class="hs-identifier">bgcSscState</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscState</span><span> </span><span class="hs-identifier hs-type">SscGodTossing</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="bgcSlotId"><a href="Pos.Generator.Block.Mode.html#bgcSlotId"><span class="hs-identifier">bgcSlotId</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SlotId</span><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>    </span><span class="hs-comment">-- ^ During block generation we don't want to use real time, but</span><span>
</span><a name="line-150"></a><span>    </span><span class="hs-comment">-- rather want to set current slot (fake one) by ourselves.</span><span>
</span><a name="line-151"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="bgcTxpGlobalSettings"><a href="Pos.Generator.Block.Mode.html#bgcTxpGlobalSettings"><span class="hs-identifier">bgcTxpGlobalSettings</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">TxpGlobalSettings</span><span>
</span><a name="line-152"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="bgcReportingContext"><a href="Pos.Generator.Block.Mode.html#bgcReportingContext"><span class="hs-identifier">bgcReportingContext</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">ReportingContext</span><span>
</span><a name="line-153"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-identifier hs-var">makeLensesWith</span><span> </span><span class="hs-identifier hs-var">postfixLFields</span><span> </span><span class="hs-char">''BlockGenContext

-- | Execution mode for blockchain generation.
type BlockGenMode m = ReaderT BlockGenContext m

-- | Block generation mode with random
type BlockGenRandMode g m = RandT g (BlockGenMode m)

instance MonadThrow m =&gt; MonadThrow (RandT g m) where
    throwM = lift . throwM

----------------------------------------------------------------------------
-- Context creation
----------------------------------------------------------------------------

-- | Make new 'BlockGenContext' using data provided by 'MonadBlockGen'
-- context. Persistent data (DB) is cloned. Other mutable data is
-- recreated.
mkBlockGenContext
    :: forall ctx m.
       (MonadBlockGen ctx m, HasGtConfiguration, HasNodeConfiguration)
    =&gt; BlockGenParams
    -&gt; m BlockGenContext
mkBlockGenContext bgcParams@BlockGenParams{..} = do
    let bgcPrimaryKey = error &quot;bgcPrimaryKey was forced before being set&quot;
    bgcGState &lt;- if _bgpInplaceDB
                 then view GS.gStateContext
                 else GS.cloneGStateContext =&lt;&lt; view GS.gStateContext
    bgcSystemStart &lt;- view slottingTimestamp
    (initSlot, putInitSlot) &lt;- newInitFuture &quot;initSlot&quot;
    let bgcSlotId = Nothing
#ifdef WITH_EXPLORER
    let bgcTxpGlobalSettings = explorerTxpGlobalSettings
#else
    let bgcTxpGlobalSettings = txpGlobalSettings
#endif
    let bgcReportingContext = emptyReportingContext
    let bgcGenStakeholders = _bgpGenStakeholders
    let initCtx =
            InitBlockGenContext
                (bgcGState ^. GS.gscDB)
                bgcSystemStart
                (bgcGState ^. GS.gscSlottingVar)
                (bgcGState ^. GS.gscLrcContext)
                initSlot
    usingReaderT initCtx $ do
        tipEOS &lt;- getEpochOrSlot &lt;$&gt; getTipHeader @SscGodTossing
        putInitSlot (epochOrSlotToSlot tipEOS)
        bgcSscState &lt;- mkSscState @SscGodTossing
        bgcUpdateContext &lt;- mkUpdateContext
        bgcTxpMem &lt;- mkTxpLocalData
        bgcDelegation &lt;- mkDelegationVar @SscGodTossing
        return BlockGenContext {..}

data InitBlockGenContext = InitBlockGenContext
    { ibgcDB          :: !DBSum
    , ibgcSystemStart :: !Timestamp
    , ibgcSlottingVar :: !(TVar SlottingData)
    , ibgcLrcContext  :: !LrcContext
    , ibgcSlot        :: SlotId
    -- ^ All initialization will be done assuming the current slot is
    -- this one. It's lazy to be used with future.
    }

makeLensesWith postfixLFields ''InitBlockGenContext

type InitBlockGenMode m = ReaderT InitBlockGenContext m

instance HasLens DBSum InitBlockGenContext DBSum where
    lensOf = ibgcDB_L

instance HasLens LrcContext InitBlockGenContext LrcContext where
    lensOf = ibgcLrcContext_L

instance HasSlottingVar InitBlockGenContext where
    slottingTimestamp = ibgcSystemStart_L
    slottingVar = ibgcSlottingVar_L

instance MonadBlockGenBase m =&gt; MonadDBRead (InitBlockGenMode m) where
    dbGet = DB.dbGetSumDefault
    dbIterSource = DB.dbIterSourceSumDefault

instance MonadBlockGenBase m =&gt; MonadDB (InitBlockGenMode m) where
    dbPut = DB.dbPutSumDefault
    dbWriteBatch = DB.dbWriteBatchSumDefault
    dbDelete = DB.dbDeleteSumDefault

instance (HasGtConfiguration, MonadBlockGenBase m) =&gt;
    MonadBlockDBGeneric (BlockHeader SscGodTossing) (Block SscGodTossing) Undo (InitBlockGenMode m)
  where
    dbGetBlock = BDB.dbGetBlockSumDefault @SscGodTossing
    dbGetUndo = BDB.dbGetUndoSumDefault @SscGodTossing
    dbGetHeader = BDB.dbGetHeaderSumDefault @SscGodTossing

instance (MonadBlockGenBase m, MonadSlotsData ctx (InitBlockGenMode m))
      =&gt; MonadSlots ctx (InitBlockGenMode m)
  where
    getCurrentSlot           = Just &lt;$&gt; view ibgcSlot_L
    getCurrentSlotBlocking   = view ibgcSlot_L
    getCurrentSlotInaccurate = view ibgcSlot_L
    currentTimeSlotting      = do
        logWarning &quot;currentTimeSlotting is used in initialization&quot;
        currentTimeSlottingSimple

----------------------------------------------------------------------------
-- Boilerplate instances
----------------------------------------------------------------------------

instance GS.HasGStateContext BlockGenContext where
    gStateContext = bgcGState_L

instance HasLens BlockGenContext BlockGenContext BlockGenContext where
    lensOf = identity

instance HasBlockGenParams BlockGenContext where
    blockGenParams = bgcParams_L

instance HasTxGenParams BlockGenContext where
    txGenParams = bgcParams_L . txGenParams

instance HasSlottingVar BlockGenContext where
    slottingTimestamp = bgcSystemStart_L
    slottingVar = GS.gStateContext . GS.gscSlottingVar

instance HasLens GenesisWStakeholders BlockGenContext GenesisWStakeholders where
    lensOf = bgcGenStakeholders_L

instance HasLens DBSum BlockGenContext DBSum where
    lensOf = GS.gStateContext . GS.gscDB

instance HasLens UpdateContext BlockGenContext UpdateContext where
    lensOf = bgcUpdateContext_L

instance HasLens DelegationVar BlockGenContext DelegationVar where
    lensOf = bgcDelegation_L

instance HasLens LrcContext BlockGenContext LrcContext where
    lensOf = GS.gStateContext . GS.gscLrcContext

instance HasPrimaryKey BlockGenContext where
    primaryKey = bgcPrimaryKey_L

instance HasSlogGState BlockGenContext where
    slogGState = GS.gStateContext . GS.gscSlogGState

instance HasLens TxpHolderTag BlockGenContext (GenericTxpLocalData TxpExtra_TMP) where
    lensOf = bgcTxpMem_L

instance HasLens SscMemTag BlockGenContext (SscState SscGodTossing) where
    lensOf = bgcSscState_L

instance HasLens TxpGlobalSettings BlockGenContext TxpGlobalSettings where
    lensOf = bgcTxpGlobalSettings_L

instance HasReportingContext BlockGenContext where
    reportingContext = bgcReportingContext_L

-- Let's assume that block-gen is core node, though it shouldn't
-- really matter (needed for reporting, which is not used in block-gen
-- anyway).
instance HasNodeType BlockGenContext where
    getNodeType _ = NodeCore

instance MonadBlockGenBase m =&gt; MonadDBRead (BlockGenMode m) where
    dbGet = DB.dbGetSumDefault
    dbIterSource = DB.dbIterSourceSumDefault

instance MonadBlockGenBase m =&gt; MonadDB (BlockGenMode m) where
    dbPut = DB.dbPutSumDefault
    dbWriteBatch = DB.dbWriteBatchSumDefault
    dbDelete = DB.dbDeleteSumDefault

instance (HasGtConfiguration, MonadBlockGenBase m) =&gt;
    MonadBlockDBGeneric (BlockHeader SscGodTossing) (Block SscGodTossing) Undo (BlockGenMode m)
  where
    dbGetBlock = BDB.dbGetBlockSumDefault @SscGodTossing
    dbGetUndo = BDB.dbGetUndoSumDefault @SscGodTossing
    dbGetHeader = BDB.dbGetHeaderSumDefault @SscGodTossing

instance (HasGtConfiguration, MonadBlockGenBase m) =&gt;
    MonadBlockDBGeneric (Some IsHeader) (SscBlock SscGodTossing) () (BlockGenMode m)
  where
    dbGetBlock = BDB.dbGetBlockSscSumDefault @SscGodTossing
    dbGetUndo = BDB.dbGetUndoSscSumDefault @SscGodTossing
    dbGetHeader = BDB.dbGetHeaderSscSumDefault @SscGodTossing

instance (HasGtConfiguration, MonadBlockGenBase m) =&gt;
         MonadBlockDBGenericWrite (BlockHeader SscGodTossing) (Block SscGodTossing) Undo (BlockGenMode m) where
    dbPutBlund = BDB.dbPutBlundSumDefault

instance (MonadBlockGenBase m, MonadSlotsData ctx (BlockGenMode m))
      =&gt; MonadSlots ctx (BlockGenMode m)
  where
    getCurrentSlot = view bgcSlotId_L
    getCurrentSlotBlocking =
        view bgcSlotId_L &gt;&gt;= \case
            Nothing -&gt;
                reportFatalError
                    &quot;getCurrentSlotBlocking is used in generator when slot is unknown&quot;
            Just slot -&gt; pure slot
    getCurrentSlotInaccurate =
        reportFatalError
            &quot;It hardly makes sense to use 'getCurrentSlotInaccurate' during block generation&quot;
    currentTimeSlotting = currentTimeSlottingSimple

instance MonadBlockGenBase m =&gt; DB.MonadGState (BlockGenMode m) where
    gsAdoptedBVData = gsAdoptedBVDataDefault

instance MonadBlockGenBase m =&gt; MonadBListener (BlockGenMode m) where
    onApplyBlocks = onApplyBlocksStub
    onRollbackBlocks = onRollbackBlocksStub

instance Monad m =&gt; MonadAddresses (BlockGenMode m) where
    type AddrData (BlockGenMode m) = Address
    getNewAddress = pure

----------------------------------------------------------------------------
-- Utilities
----------------------------------------------------------------------------

usingPrimaryKey :: MonadReader BlockGenContext m =&gt; SecretKey -&gt; m a -&gt; m a
usingPrimaryKey sk = local (set primaryKey sk)

withCurrentSlot :: MonadReader BlockGenContext m =&gt; SlotId -&gt; m a -&gt; m a
withCurrentSlot slot = local (set bgcSlotId_L $ Just slot)
</span></pre></body></html>