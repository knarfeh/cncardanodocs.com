<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">-- | Delegation-related verify/apply/rollback part.</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Delegation</span><span class="hs-operator">.</span><span class="hs-identifier">Logic</span><span class="hs-operator">.</span><span class="hs-identifier">VAR</span><span>
</span><a name="line-7"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Pos.Delegation.Logic.VAR.html#dlgVerifyBlocks"><span class="hs-identifier hs-var">dlgVerifyBlocks</span></a><span>
</span><a name="line-8"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.VAR.html#dlgApplyBlocks"><span class="hs-identifier hs-var">dlgApplyBlocks</span></a><span>
</span><a name="line-9"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.VAR.html#dlgRollbackBlocks"><span class="hs-identifier hs-var">dlgRollbackBlocks</span></a><span>
</span><a name="line-10"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Logic.VAR.html#dlgNormalizeOnRollback"><span class="hs-identifier hs-var">dlgNormalizeOnRollback</span></a><span>
</span><a name="line-11"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeLenses</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">non</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">uses</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%=</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.=</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>                                               </span><span class="hs-special">(</span><span class="hs-operator hs-var">?=</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">_Wrapped</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Except</span><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">runExceptT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throwError</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashMap</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HM</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashSet</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HS</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">partition</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">\\</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Buildable</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Formatting</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bprint</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">build</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sformat</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Mockable</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CurrentTime</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Mockable</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listJson</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapJson</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Wlog</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WithLogger</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logDebug</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Binary.Communication.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Communication</span></a><span>     </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.Core.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span></a><span>               </span><span class="hs-special">(</span><a href="Pos.Block.Core.Union.Types.html#Block"><span class="hs-identifier hs-type">Block</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Block.Core.Main.Types.html#BlockSignature"><span class="hs-identifier hs-type">BlockSignature</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>                                               </span><a href="Pos.Block.Core.Main.Lens.html#mainBlockDlgPayload"><span class="hs-identifier hs-var">mainBlockDlgPayload</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Block.Core.Main.Lens.html#mainHeaderLeaderKey"><span class="hs-identifier hs-var">mainHeaderLeaderKey</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>                                               </span><a href="Pos.Block.Core.Main.Lens.html#mcdSignature"><span class="hs-identifier hs-var">mcdSignature</span></a><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>              </span><span class="hs-special">(</span><a href="Pos.Block.Types.html#Blund"><span class="hs-identifier hs-type">Blund</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Block.Types.html#Undo"><span class="hs-identifier hs-type">Undo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">undoDlg</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Context.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Context</span></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lrcActionOnEpochReason</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">EpochIndex</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasConfiguration</span><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>                                               </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">addressHash</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">epochIndexL</span><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>                                               </span><span class="hs-identifier hs-var">gbHeader</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">gbhConsensus</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">headerHash</span><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>                                               </span><span class="hs-identifier hs-var">prevBlockL</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ProxySecretKey</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ProxySignature</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>                                               </span><span class="hs-identifier hs-var">psigPsk</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">shortHashF</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DBError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DBMalformed</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadDBRead</span><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>                                               </span><span class="hs-identifier hs-type">SomeBatchOp</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span>                       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DB</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.DB.Block.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span></a><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DB</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.DB.DB.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span></a><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DB</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Delegation.Cede.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Delegation</span><span class="hs-operator">.</span><span class="hs-identifier">Cede</span></a><span>          </span><span class="hs-special">(</span><a href="Pos.Delegation.Cede.Types.html#CedeModifier"><span class="hs-identifier hs-type">CedeModifier</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Cede.Types.html#DlgEdgeAction"><span class="hs-identifier hs-type">DlgEdgeAction</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Cede.Holders.html#MapCede"><span class="hs-identifier hs-type">MapCede</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>                                               </span><a href="Pos.Delegation.Cede.Class.html#MonadCedeRead"><span class="hs-identifier hs-type">MonadCedeRead</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Cede.Class.html#getPsk"><span class="hs-identifier hs-var">getPsk</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>                                               </span><a href="Pos.Delegation.Cede.Logic.html#detectCycleOnAddition"><span class="hs-identifier hs-var">detectCycleOnAddition</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Cede.Types.html#dlgEdgeActionIssuer"><span class="hs-identifier hs-var">dlgEdgeActionIssuer</span></a><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>                                               </span><a href="Pos.Delegation.Cede.Logic.html#dlgReachesIssuance"><span class="hs-identifier hs-var">dlgReachesIssuance</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Cede.Holders.html#evalMapCede"><span class="hs-identifier hs-var">evalMapCede</span></a><span class="hs-special">,</span><span>
</span><a name="line-48"></a><span>                                               </span><a href="Pos.Delegation.Cede.Logic.html#getPskChain"><span class="hs-identifier hs-var">getPskChain</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Cede.Class.html#getPskPk"><span class="hs-identifier hs-var">getPskPk</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Cede.Class.html#modPsk"><span class="hs-identifier hs-var">modPsk</span></a><span class="hs-special">,</span><span>
</span><a name="line-49"></a><span>                                               </span><a href="Pos.Delegation.Cede.Types.html#pskToDlgEdgeAction"><span class="hs-identifier hs-var">pskToDlgEdgeAction</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Cede.Holders.html#runDBCede"><span class="hs-identifier hs-var">runDBCede</span></a><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Delegation.Class.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Delegation</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Delegation.Class.html#MonadDelegation"><span class="hs-identifier hs-type">MonadDelegation</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Class.html#dwProxySKPool"><span class="hs-identifier hs-var">dwProxySKPool</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Class.html#dwTip"><span class="hs-identifier hs-var">dwTip</span></a><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Delegation.Helpers.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Delegation</span><span class="hs-operator">.</span><span class="hs-identifier">Helpers</span></a><span>       </span><span class="hs-special">(</span><a href="Pos.Delegation.Helpers.html#isRevokePsk"><span class="hs-identifier hs-var">isRevokePsk</span></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Delegation.Logic.Common.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Delegation</span><span class="hs-operator">.</span><span class="hs-identifier">Logic</span><span class="hs-operator">.</span><span class="hs-identifier">Common</span></a><span>  </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.Common.html#DelegationError"><span class="hs-identifier hs-type">DelegationError</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-53"></a><span>                                               </span><a href="Pos.Delegation.Logic.Common.html#runDelegationStateAction"><span class="hs-identifier hs-var">runDelegationStateAction</span></a><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Delegation.Logic.Mempool.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Delegation</span><span class="hs-operator">.</span><span class="hs-identifier">Logic</span><span class="hs-operator">.</span><span class="hs-identifier">Mempool</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.Mempool.html#clearDlgMemPoolAction"><span class="hs-identifier hs-var">clearDlgMemPoolAction</span></a><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>                                               </span><a href="Pos.Delegation.Logic.Mempool.html#deleteFromDlgMemPool"><span class="hs-identifier hs-var">deleteFromDlgMemPool</span></a><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>                                               </span><a href="Pos.Delegation.Logic.Mempool.html#processProxySKHeavyInternal"><span class="hs-identifier hs-var">processProxySKHeavyInternal</span></a><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Delegation.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Delegation</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Delegation.Types.html#DlgPayload"><span class="hs-identifier hs-type">DlgPayload</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">getDlgPayload</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Delegation.Types.html#DlgUndo"><span class="hs-identifier hs-type">DlgUndo</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.GState.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">GState</span></a><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GS</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Lrc</span><span class="hs-operator">.</span><span class="hs-identifier">Context</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LrcContext</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.Lrc.DB.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Lrc</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span></a><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LrcDB</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Helpers</span><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscHelpersClass</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasLens'</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getKeys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">_neHead</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Chrono</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NE</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NewestFirst</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OldestFirst</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-comment">-- Copied from 'these' library.</span><span>
</span><a name="line-67"></a><span class="hs-keyword">data</span><span> </span><a name="These"><a href="Pos.Delegation.Logic.VAR.html#These"><span class="hs-identifier">These</span></a></a><span> </span><a name="local-6989586621680533181"><a href="#local-6989586621680533181"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680533182"><a href="#local-6989586621680533182"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="This"><a href="Pos.Delegation.Logic.VAR.html#This"><span class="hs-identifier">This</span></a></a><span> </span><a href="#local-6989586621680533181"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="That"><a href="Pos.Delegation.Logic.VAR.html#That"><span class="hs-identifier">That</span></a></a><span> </span><a href="#local-6989586621680533182"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="These"><a href="Pos.Delegation.Logic.VAR.html#These"><span class="hs-identifier">These</span></a></a><span> </span><a href="#local-6989586621680533181"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621680533182"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-68"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">B</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="#local-6989586621680533260"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">B</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="#local-6989586621680533261"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">B</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Buildable</span><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.VAR.html#These"><span class="hs-identifier hs-type">These</span></a><span> </span><a href="#local-6989586621680533260"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621680533261"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-71"></a><span>    </span><a name="local-8214565720323814995"><span class="hs-identifier">build</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.VAR.html#This"><span class="hs-identifier hs-var">This</span></a><span> </span><a name="local-6989586621680533262"><a href="#local-6989586621680533262"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;This {&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;}&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680533262"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-72"></a><span>    </span><span class="hs-identifier">build</span><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.VAR.html#That"><span class="hs-identifier hs-var">That</span></a><span> </span><a name="local-6989586621680533263"><a href="#local-6989586621680533263"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;That {&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;}&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680533263"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-73"></a><span>    </span><span class="hs-identifier">build</span><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.VAR.html#These"><span class="hs-identifier hs-var">These</span></a><span> </span><a name="local-6989586621680533264"><a href="#local-6989586621680533264"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680533265"><a href="#local-6989586621680533265"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;These {&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;, &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;}&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680533264"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621680533265"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-comment">-- u &#8594; (Maybe d&#8321;, Maybe d&#8322;): u changed delegate from d&#8321; (or didn't</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- have one) to d&#8322; (or revoked delegation). These a b &#8771; (Maybe a,</span><span>
</span><a name="line-77"></a><span class="hs-comment">-- Maybe b) w/o (Nothing,Nothing).</span><span>
</span><a name="line-78"></a><span class="hs-keyword">type</span><span> </span><a name="TransChangeset"><a href="Pos.Delegation.Logic.VAR.html#TransChangeset"><span class="hs-identifier">TransChangeset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">HashMap</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.VAR.html#These"><span class="hs-identifier hs-type">These</span></a><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-keyword">type</span><span> </span><a name="ReverseTrans"><a href="Pos.Delegation.Logic.VAR.html#ReverseTrans"><span class="hs-identifier">ReverseTrans</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">HashMap</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HashSet</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HashSet</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">-- WHENEVER YOU CHANGE THE FUNCTION, CHECK DOCUMENTATION CONSISTENCY! THANK YOU!</span><span>
</span><a name="line-82"></a><span class="hs-comment">--</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- Takes a set of dlg edge actions to apply and returns compensations</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- to dlgTrans and dlgTransRev parts of delegation db. Should be</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- executed under shared Gstate DB lock.</span><span>
</span><a name="line-86"></a><span class="hs-identifier">calculateTransCorrections</span><span>
</span><a name="line-87"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621680533185"><a href="#local-6989586621680533185"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-88"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadDBRead</span><span> </span><a href="#local-6989586621680533185"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">WithLogger</span><span> </span><a href="#local-6989586621680533185"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HashSet</span><span> </span><a href="Pos.Delegation.Cede.Types.html#DlgEdgeAction"><span class="hs-identifier hs-type">DlgEdgeAction</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680533185"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">SomeBatchOp</span><span>
</span><a name="line-90"></a><a name="calculateTransCorrections"><a href="Pos.Delegation.Logic.VAR.html#calculateTransCorrections"><span class="hs-identifier">calculateTransCorrections</span></a></a><span> </span><a name="local-6989586621680533186"><a href="#local-6989586621680533186"><span class="hs-identifier">eActions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-91"></a><span>    </span><span class="hs-comment">-- Get the changeset and convert it to transitive ops.</span><span>
</span><a name="line-92"></a><span>    </span><a name="local-6989586621680533242"><a href="#local-6989586621680533242"><span class="hs-identifier">changeset</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680533187"><span class="hs-identifier hs-var">transChangeset</span></a><span>
</span><a name="line-93"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680533243"><a href="#local-6989586621680533243"><span class="hs-identifier">toTransOp</span></a></a><span> </span><a name="local-6989586621680533244"><a href="#local-6989586621680533244"><span class="hs-identifier">iSId</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.VAR.html#This"><span class="hs-identifier hs-var">This</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Delegation.DB.html#DelTransitiveDlg"><span class="hs-identifier hs-var">GS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">DelTransitiveDlg</span></a><span> </span><a href="#local-6989586621680533244"><span class="hs-identifier hs-var">iSId</span></a><span>
</span><a name="line-94"></a><span>        </span><span class="hs-identifier">toTransOp</span><span> </span><a name="local-6989586621680533245"><a href="#local-6989586621680533245"><span class="hs-identifier">iSId</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.VAR.html#That"><span class="hs-identifier hs-var">That</span></a><span> </span><a name="local-6989586621680533246"><a href="#local-6989586621680533246"><span class="hs-identifier">dSId</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Delegation.DB.html#AddTransitiveDlg"><span class="hs-identifier hs-var">GS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">AddTransitiveDlg</span></a><span> </span><a href="#local-6989586621680533245"><span class="hs-identifier hs-var">iSId</span></a><span> </span><a href="#local-6989586621680533246"><span class="hs-identifier hs-var">dSId</span></a><span>
</span><a name="line-95"></a><span>        </span><span class="hs-identifier">toTransOp</span><span> </span><a name="local-6989586621680533247"><a href="#local-6989586621680533247"><span class="hs-identifier">iSId</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.VAR.html#These"><span class="hs-identifier hs-var">These</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680533248"><a href="#local-6989586621680533248"><span class="hs-identifier">dSId</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Delegation.DB.html#AddTransitiveDlg"><span class="hs-identifier hs-var">GS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">AddTransitiveDlg</span></a><span> </span><a href="#local-6989586621680533247"><span class="hs-identifier hs-var">iSId</span></a><span> </span><a href="#local-6989586621680533248"><span class="hs-identifier hs-var">dSId</span></a><span>
</span><a name="line-96"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680533249"><a href="#local-6989586621680533249"><span class="hs-identifier">transOps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="#local-6989586621680533243"><span class="hs-identifier hs-var">toTransOp</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621680533242"><span class="hs-identifier hs-var">changeset</span></a><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span>    </span><span class="hs-comment">-- Once we figure out this piece of code works like a charm we</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-comment">-- can delete this logging.</span><span>
</span><a name="line-100"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680533242"><span class="hs-identifier hs-var">changeset</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-101"></a><span>        </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Nonempty dlg trans changeset: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">mapJson</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-102"></a><span>        </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621680533242"><span class="hs-identifier hs-var">changeset</span></a><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span>    </span><span class="hs-comment">-- Bulid reverse transitive set and convert it to reverseTransOps</span><span>
</span><a name="line-105"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680533250"><a href="#local-6989586621680533250"><span class="hs-identifier">reverseTrans</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680533190"><span class="hs-identifier hs-var">buildReverseTrans</span></a><span> </span><a href="#local-6989586621680533242"><span class="hs-identifier hs-var">changeset</span></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">reverseTransIterStep</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-108"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HashSet</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HashSet</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680533185"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Pos.Delegation.DB.html#DelegationOp"><span class="hs-identifier hs-type">GS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">DelegationOp</span></a><span>
</span><a name="line-110"></a><span>        </span><a name="local-6989586621680533251"><a href="#local-6989586621680533251"><span class="hs-identifier">reverseTransIterStep</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680533252"><a href="#local-6989586621680533252"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680533253"><a href="#local-6989586621680533253"><span class="hs-identifier">ad</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680533254"><a href="#local-6989586621680533254"><span class="hs-identifier">dl</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-111"></a><span>            </span><a name="local-6989586621680533255"><a href="#local-6989586621680533255"><span class="hs-identifier">prev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Delegation.DB.html#getDlgTransitiveReverse"><span class="hs-identifier hs-var">GS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getDlgTransitiveReverse</span></a><span> </span><a href="#local-6989586621680533252"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-112"></a><span>            </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680533253"><span class="hs-identifier hs-var">ad</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">intersection</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680533254"><span class="hs-identifier hs-var">dl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DBMalformed</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-113"></a><span>                </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Couldn't build reverseOps: ad `intersect` dl is nonzero. &quot;</span><span class="hs-operator hs-var">%</span><span>
</span><a name="line-114"></a><span>                        </span><span class="hs-string">&quot;ad: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">listJson</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;, dl: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">listJson</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>                        </span><a href="#local-6989586621680533253"><span class="hs-identifier hs-var">ad</span></a><span> </span><a href="#local-6989586621680533254"><span class="hs-identifier hs-var">dl</span></a><span>
</span><a name="line-116"></a><span>            </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680533255"><span class="hs-identifier hs-var">prev</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680533254"><span class="hs-identifier hs-var">dl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-117"></a><span>                </span><span class="hs-identifier hs-var">DBMalformed</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-118"></a><span>                </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Couldn't build reverseOps: revtrans has &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">listJson</span><span class="hs-operator hs-var">%</span><span>
</span><a name="line-119"></a><span>                        </span><span class="hs-string">&quot;, while &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;trans says we should delete &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">listJson</span><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>                        </span><a href="#local-6989586621680533255"><span class="hs-identifier hs-var">prev</span></a><span> </span><a href="#local-6989586621680533254"><span class="hs-identifier hs-var">dl</span></a><span>
</span><a name="line-121"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Delegation.DB.html#SetTransitiveDlgRev"><span class="hs-identifier hs-var">GS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">SetTransitiveDlgRev</span></a><span> </span><a href="#local-6989586621680533252"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680533255"><span class="hs-identifier hs-var">prev</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">difference</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680533254"><span class="hs-identifier hs-var">dl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621680533253"><span class="hs-identifier hs-var">ad</span></a><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span>    </span><a name="local-6989586621680533256"><a href="#local-6989586621680533256"><span class="hs-identifier">reverseOps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621680533251"><span class="hs-identifier hs-var">reverseTransIterStep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621680533250"><span class="hs-identifier hs-var">reverseTrans</span></a><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">SomeBatchOp</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680533249"><span class="hs-identifier hs-var">transOps</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621680533256"><span class="hs-identifier hs-var">reverseOps</span></a><span>
</span><a name="line-125"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-comment">{-
    Get the transitive changeset.

    To scare the reader, we suggest the example. Imagine the following
    transformation (all arrows are oriented to the right). First graph
    G is one we store in DB. We apply the list of edgeActions {del DE,
    add CF} ~ F to it. Note that order of applying edgeActions
    matters, so we can't go incrementally building graph G' = G &#8746; F
    from G.

    A   F--G      A   F--G
     \             \ /
      C--D--E  &#8658;    C  D  E
     /             /
    B             B

    Let dlg_H(a) denote the transitive delegation relation, returning
    Nothing or Just dPk. Then we want to:
    1. Find affected users af = {uv &#8712; E(G) &#8746; E(F) | dlg_G(u) &#8800; dlg_G'(u)}
    2. Calculate new delegate set dlgnew = {(a,dlg_G'(a)), a &#8712; af}
    3. Zip dlgnew with old delegates (queried from DB).


    Step 1. Lemma. Let's call x-points XP the set issuers of
    edgeActions set from F. Then af is equal to union of all subtrees
    with root x &#8712; XP called U, calculated in graph G'.

    Proof.
    1. a &#8712; af &#8658; a &#8712; U. Delegate of a changed.
       * (Nothing &#8594; Just d) conversion, then we've added some av edge,
         v = d &#8744; dlg(v) = d, then a &#8712; U.
       * (Just d &#8594; Nothing) conversion, we removed direct edge av,
         v = d &#8744; dlg(v) = d, same.
       * (Just d&#8321; &#8594; Just d&#8322;), some edge e on path a &#8594;&#8594; d&#8321; was switched
         to another branch or deleted.
    2. a &#8712; U &#8658; a &#8712; af
       Just come up the tree to the first x &#8712; XP.
       * x = a, then we've just either changed or got new/removed
         old delegate.
       * x &#8800; a, same.

    So on step 1 it's sufficient to find U. See the code to understand
    how it's done using existent dlgTransRev mapping.


    Step 2. Let's use memoized tree traversal to compute dlgnew. For
    every a &#8712; af we'll come to the top of the tree until we see any
    marked value or reach the end.

    1. We've stuck to the end vertex d, which is delegate. Mark dlg(d)
    = Nothing,

    2. We're on u, next vertex is v, we know dlg(v). Set dlg(u) =
    dlg(v) and apply it to all the traversal chain before. If dlg(v) =
    Nothing, set dlg(u) = v instead.


    Step 3 is trivial.
    -}</span><span>
</span><a name="line-185"></a><span>    </span><span class="hs-identifier">transChangeset</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621680533185"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Pos.Delegation.Logic.VAR.html#TransChangeset"><span class="hs-identifier hs-type">TransChangeset</span></a><span>
</span><a name="line-186"></a><span>    </span><a name="local-6989586621680533187"><a href="#local-6989586621680533187"><span class="hs-identifier">transChangeset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-187"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">xPoints</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">]</span><span>
</span><a name="line-188"></a><span>            </span><a name="local-6989586621680533191"><a href="#local-6989586621680533191"><span class="hs-identifier">xPoints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Pos.Delegation.Cede.Types.html#dlgEdgeActionIssuer"><span class="hs-identifier hs-var">dlgEdgeActionIssuer</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621680533186"><span class="hs-identifier hs-var">eActions</span></a><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span>        </span><span class="hs-comment">-- Step 1.</span><span>
</span><a name="line-191"></a><span>        </span><a name="local-6989586621680533192"><a href="#local-6989586621680533192"><span class="hs-identifier">affected</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621680533188"><span class="hs-identifier hs-var">calculateLocalAf</span></a><span> </span><a href="#local-6989586621680533191"><span class="hs-identifier hs-var">xPoints</span></a><span>
</span><a name="line-192"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">af</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HashSet</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span>
</span><a name="line-193"></a><span>            </span><a name="local-6989586621680533193"><a href="#local-6989586621680533193"><span class="hs-identifier">af</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getKeys</span><span> </span><a href="#local-6989586621680533192"><span class="hs-identifier hs-var">affected</span></a><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span>        </span><span class="hs-comment">-- Step 2.</span><span>
</span><a name="line-196"></a><span>        </span><a name="local-6989586621680533194"><a href="#local-6989586621680533194"><span class="hs-identifier">dlgNew</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">execStateT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">for_</span><span> </span><a href="#local-6989586621680533193"><span class="hs-identifier hs-var">af</span></a><span> </span><a href="#local-6989586621680533189"><span class="hs-identifier hs-var">calculateDlgNew</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-197"></a><span>        </span><span class="hs-comment">-- Let's check that sizes of af and dlgNew match (they should).</span><span>
</span><a name="line-198"></a><span>        </span><span class="hs-comment">-- We'll need it to merge in (3).</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680533195"><a href="#local-6989586621680533195"><span class="hs-identifier">notResolved</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680533196"><a href="#local-6989586621680533196"><span class="hs-identifier">dlgKeys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getKeys</span><span> </span><a href="#local-6989586621680533194"><span class="hs-identifier hs-var">dlgNew</span></a><span>
</span><a name="line-200"></a><span>                          </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680533197"><a href="#local-6989586621680533197"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">member</span><span> </span><a href="#local-6989586621680533197"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621680533196"><span class="hs-identifier hs-var">dlgKeys</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621680533193"><span class="hs-identifier hs-var">af</span></a><span>
</span><a name="line-201"></a><span>        </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680533195"><span class="hs-identifier hs-var">notResolved</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DBMalformed</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-202"></a><span>            </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;transChangeset: dlgNew keys doesn't resolve some from af: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">listJson</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>                    </span><a href="#local-6989586621680533195"><span class="hs-identifier hs-var">notResolved</span></a><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span>        </span><span class="hs-comment">-- Step 3.</span><span>
</span><a name="line-206"></a><span>        </span><span class="hs-comment">-- Some unsafe functions (&#1095;&#1090;&#1086;&#1073;&#1099; &#1078;&#1080;&#1079;&#1085;&#1100; &#1084;&#1077;&#1076;&#1086;&#1084; &#1085;&#1077; &#1082;&#1072;&#1079;&#1072;&#1083;&#1072;&#1089;&#1100;)</span><span>
</span><a name="line-207"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680533198"><a href="#local-6989586621680533198"><span class="hs-identifier">lookupUnsafe</span></a></a><span> </span><a name="local-6989586621680533200"><a href="#local-6989586621680533200"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-208"></a><span>                </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;transChangeset shouldn't happen but happened: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><a href="#local-6989586621680533200"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-209"></a><span>                </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621680533200"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-210"></a><span>            </span><span class="hs-identifier">toTheseUnsafe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span>
</span><a name="line-211"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.VAR.html#These"><span class="hs-identifier hs-type">These</span></a><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span>
</span><a name="line-213"></a><span>            </span><a name="local-6989586621680533199"><a href="#local-6989586621680533199"><span class="hs-identifier">toTheseUnsafe</span></a></a><span> </span><a name="local-6989586621680533201"><a href="#local-6989586621680533201"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-214"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-215"></a><span>                    </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Tried to convert (N,N) to These with affected user: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><a href="#local-6989586621680533201"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-216"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680533202"><a href="#local-6989586621680533202"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.VAR.html#This"><span class="hs-identifier hs-var">This</span></a><span> </span><a href="#local-6989586621680533202"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-217"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680533203"><a href="#local-6989586621680533203"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.VAR.html#That"><span class="hs-identifier hs-var">That</span></a><span> </span><a href="#local-6989586621680533203"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-218"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680533204"><a href="#local-6989586621680533204"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680533205"><a href="#local-6989586621680533205"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.VAR.html#These"><span class="hs-identifier hs-var">These</span></a><span> </span><a href="#local-6989586621680533204"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621680533205"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-219"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680533206"><a href="#local-6989586621680533206"><span class="hs-identifier">dlgFin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">mapWithKey</span><span> </span><a href="#local-6989586621680533192"><span class="hs-identifier hs-var">affected</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680533207"><a href="#local-6989586621680533207"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680533208"><a href="#local-6989586621680533208"><span class="hs-identifier">dOld</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-220"></a><span>                         </span><a href="#local-6989586621680533199"><span class="hs-identifier hs-var">toTheseUnsafe</span></a><span> </span><a href="#local-6989586621680533207"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680533208"><span class="hs-identifier hs-var">dOld</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680533198"><span class="hs-identifier hs-var">lookupUnsafe</span></a><span> </span><a href="#local-6989586621680533207"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621680533194"><span class="hs-identifier hs-var">dlgNew</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680533206"><span class="hs-identifier hs-var">dlgFin</span></a><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span>    </span><span class="hs-comment">-- Returns map from affected subtree af in original/G to the</span><span>
</span><a name="line-225"></a><span>    </span><span class="hs-comment">-- common delegate of this subtree. Keys = af. All elems are</span><span>
</span><a name="line-226"></a><span>    </span><span class="hs-comment">-- similar and equal to dlg(sId).</span><span>
</span><a name="line-227"></a><span>    </span><span class="hs-identifier">calculateLocalAf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680533185"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HashMap</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>    </span><a name="local-6989586621680533188"><a href="#local-6989586621680533188"><span class="hs-identifier">calculateLocalAf</span></a></a><span> </span><a name="local-6989586621680533209"><a href="#local-6989586621680533209"><span class="hs-identifier">iSId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pos.Delegation.DB.html#getDlgTransitiveReverse"><span class="hs-identifier hs-var">GS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getDlgTransitiveReverse</span></a><span> </span><a href="#local-6989586621680533209"><span class="hs-identifier hs-var">iSId</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-229"></a><span>        </span><span class="hs-comment">-- We are intermediate/start of the chain, not the delegate.</span><span>
</span><a name="line-230"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.DB.html#getDlgTransitive"><span class="hs-identifier hs-var">GS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getDlgTransitive</span></a><span> </span><a href="#local-6989586621680533209"><span class="hs-identifier hs-var">iSId</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-231"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">singleton</span><span> </span><a href="#local-6989586621680533209"><span class="hs-identifier hs-var">iSId</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-232"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680533210"><a href="#local-6989586621680533210"><span class="hs-identifier">dSId</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-233"></a><span>                </span><span class="hs-comment">-- All i | i &#8594;&#8594; d in the G. We should leave only those who</span><span>
</span><a name="line-234"></a><span>                </span><span class="hs-comment">-- are equal or lower than iPk in the delegation chain.</span><span>
</span><a name="line-235"></a><span>                </span><a name="local-6989586621680533211"><a href="#local-6989586621680533211"><span class="hs-identifier">revIssuers</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Delegation.DB.html#getDlgTransitiveReverse"><span class="hs-identifier hs-var">GS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getDlgTransitiveReverse</span></a><span> </span><a href="#local-6989586621680533210"><span class="hs-identifier hs-var">dSId</span></a><span>
</span><a name="line-236"></a><span>                </span><span class="hs-comment">-- For these we'll find everyone who's upper (closer to</span><span>
</span><a name="line-237"></a><span>                </span><span class="hs-comment">-- root/delegate) and take a diff. If iSId = dSId, then it will</span><span>
</span><a name="line-238"></a><span>                </span><span class="hs-comment">-- return [].</span><span>
</span><a name="line-239"></a><span>                </span><a name="local-6989586621680533212"><a href="#local-6989586621680533212"><span class="hs-identifier">chain</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getKeys</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pos.Delegation.Cede.Holders.html#runDBCede"><span class="hs-identifier hs-var">runDBCede</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Cede.Logic.html#getPskChain"><span class="hs-identifier hs-var">getPskChain</span></a><span> </span><a href="#local-6989586621680533209"><span class="hs-identifier hs-var">iSId</span></a><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680533213"><a href="#local-6989586621680533213"><span class="hs-identifier">ret</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><a href="#local-6989586621680533209"><span class="hs-identifier hs-var">iSId</span></a><span>
</span><a name="line-241"></a><span>                        </span><span class="hs-special">(</span><a href="#local-6989586621680533211"><span class="hs-identifier hs-var">revIssuers</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">difference</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">addressHash</span><span> </span><a href="#local-6989586621680533212"><span class="hs-identifier hs-var">chain</span></a><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680533214"><a href="#local-6989586621680533214"><span class="hs-identifier">retHm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680533210"><span class="hs-identifier hs-var">dSId</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toMap</span><span> </span><a href="#local-6989586621680533213"><span class="hs-identifier hs-var">ret</span></a><span>
</span><a name="line-243"></a><span>                </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621680533214"><span class="hs-identifier hs-var">retHm</span></a><span>
</span><a name="line-244"></a><span>        </span><span class="hs-comment">-- We are delegate.</span><span>
</span><a name="line-245"></a><span>        </span><a name="local-6989586621680533215"><a href="#local-6989586621680533215"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680533209"><span class="hs-identifier hs-var">iSId</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680533209"><span class="hs-identifier hs-var">iSId</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680533215"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span>    </span><span class="hs-identifier">calculateDlgNew</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">StateT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HashMap</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680533185"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>    </span><a name="local-6989586621680533189"><a href="#local-6989586621680533189"><span class="hs-identifier">calculateDlgNew</span></a></a><span> </span><a name="local-6989586621680533216"><a href="#local-6989586621680533216"><span class="hs-identifier">iSId</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-249"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680533217"><a href="#local-6989586621680533217"><span class="hs-identifier">resolve</span></a></a><span> </span><a name="local-6989586621680533221"><a href="#local-6989586621680533221"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">addressHash</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">pskDelegatePk</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pos.Delegation.Cede.Class.html#getPsk"><span class="hs-identifier hs-var">getPsk</span></a><span> </span><a href="#local-6989586621680533221"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-250"></a><span>            </span><span class="hs-comment">-- Sets real new trans delegate in state, returns it to</span><span>
</span><a name="line-251"></a><span>            </span><span class="hs-comment">-- child. Makes different if we're delegate d -- we set</span><span>
</span><a name="line-252"></a><span>            </span><span class="hs-comment">-- Nothing, but return d.</span><span>
</span><a name="line-253"></a><span>            </span><a name="local-6989586621680533218"><a href="#local-6989586621680533218"><span class="hs-identifier">retCached</span></a></a><span> </span><a name="local-6989586621680533222"><a href="#local-6989586621680533222"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621680533223"><a href="#local-6989586621680533223"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">use</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><a href="#local-6989586621680533216"><span class="hs-identifier hs-var">iSId</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-254"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680533223"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-255"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680533224"><a href="#local-6989586621680533224"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621680533224"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-256"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621680533222"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span>            </span><span class="hs-identifier">loop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-259"></a><span>                    </span><a href="Pos.Delegation.Cede.Holders.html#MapCede"><span class="hs-identifier hs-type">MapCede</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StateT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HashMap</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680533185"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span>
</span><a name="line-260"></a><span>            </span><a name="local-6989586621680533219"><a href="#local-6989586621680533219"><span class="hs-identifier">loop</span></a></a><span> </span><a name="local-6989586621680533225"><a href="#local-6989586621680533225"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680533218"><span class="hs-identifier hs-var">retCached</span></a><span> </span><a href="#local-6989586621680533225"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680533217"><span class="hs-identifier hs-var">resolve</span></a><span> </span><a href="#local-6989586621680533225"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-261"></a><span>                </span><span class="hs-comment">-- There's no delegate = we are the delegate/end of the chain.</span><span>
</span><a name="line-262"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><a href="#local-6989586621680533225"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">?=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$&gt;</span><span> </span><a href="#local-6989586621680533225"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-263"></a><span>                </span><span class="hs-comment">-- Let's see what's up in the tree</span><span>
</span><a name="line-264"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680533226"><a href="#local-6989586621680533226"><span class="hs-identifier">dSId</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-265"></a><span>                    </span><a name="local-6989586621680533227"><a href="#local-6989586621680533227"><span class="hs-identifier">dNew</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680533219"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621680533226"><span class="hs-identifier hs-var">dSId</span></a><span>
</span><a name="line-266"></a><span>                    </span><span class="hs-identifier hs-var">at</span><span> </span><a href="#local-6989586621680533225"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">?=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680533227"><span class="hs-identifier hs-var">dNew</span></a><span>
</span><a name="line-267"></a><span>                    </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621680533227"><span class="hs-identifier hs-var">dNew</span></a><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span>            </span><span class="hs-identifier">eActionsHM</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Delegation.Cede.Types.html#CedeModifier"><span class="hs-identifier hs-type">CedeModifier</span></a><span>
</span><a name="line-270"></a><span>            </span><a name="local-6989586621680533220"><a href="#local-6989586621680533220"><span class="hs-identifier">eActionsHM</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-271"></a><span>                </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680533228"><a href="#local-6989586621680533228"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Cede.Types.html#dlgEdgeActionIssuer"><span class="hs-identifier hs-var">dlgEdgeActionIssuer</span></a><span> </span><a href="#local-6989586621680533228"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680533228"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-272"></a><span>                </span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621680533186"><span class="hs-identifier hs-var">eActions</span></a><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Delegation.Cede.Holders.html#evalMapCede"><span class="hs-identifier hs-var">evalMapCede</span></a><span> </span><a href="#local-6989586621680533220"><span class="hs-identifier hs-var">eActionsHM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680533219"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621680533216"><span class="hs-identifier hs-var">iSId</span></a><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span>    </span><span class="hs-comment">-- Given changeset, returns map d &#8594; (ad,dl), where ad is set of</span><span>
</span><a name="line-277"></a><span>    </span><span class="hs-comment">-- new issuers that delegate to d, while dl is set of issuers that</span><span>
</span><a name="line-278"></a><span>    </span><span class="hs-comment">-- switched from d to someone else (or to nobody).</span><span>
</span><a name="line-279"></a><span>    </span><span class="hs-identifier">buildReverseTrans</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Delegation.Logic.VAR.html#TransChangeset"><span class="hs-identifier hs-type">TransChangeset</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.VAR.html#ReverseTrans"><span class="hs-identifier hs-type">ReverseTrans</span></a><span>
</span><a name="line-280"></a><span>    </span><a name="local-6989586621680533190"><a href="#local-6989586621680533190"><span class="hs-identifier">buildReverseTrans</span></a></a><span> </span><a name="local-6989586621680533229"><a href="#local-6989586621680533229"><span class="hs-identifier">changeset</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-281"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680533230"><a href="#local-6989586621680533230"><span class="hs-identifier">ins</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span>
</span><a name="line-282"></a><span>            </span><span class="hs-identifier">foldFoo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Delegation.Logic.VAR.html#ReverseTrans"><span class="hs-identifier hs-type">ReverseTrans</span></a><span>
</span><a name="line-283"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span>
</span><a name="line-284"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.VAR.html#These"><span class="hs-identifier hs-type">These</span></a><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">)</span><span>
</span><a name="line-285"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Delegation.Logic.VAR.html#ReverseTrans"><span class="hs-identifier hs-type">ReverseTrans</span></a><span>
</span><a name="line-286"></a><span>            </span><a name="local-6989586621680533231"><a href="#local-6989586621680533231"><span class="hs-identifier">foldFoo</span></a></a><span> </span><a name="local-6989586621680533232"><a href="#local-6989586621680533232"><span class="hs-identifier">rev</span></a></a><span> </span><a name="local-6989586621680533233"><a href="#local-6989586621680533233"><span class="hs-identifier">iSId</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.VAR.html#This"><span class="hs-identifier hs-var">This</span></a><span> </span><a name="local-6989586621680533234"><a href="#local-6989586621680533234"><span class="hs-identifier">dSId</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680533232"><span class="hs-identifier hs-var">rev</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><a href="#local-6989586621680533234"><span class="hs-identifier hs-var">dSId</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">non</span><span> </span><span class="hs-identifier hs-var">mempty</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_2</span><span>
</span><a name="line-287"></a><span>                                                         </span><span class="hs-operator hs-var">%~</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680533230"><span class="hs-identifier hs-var">ins</span></a><span> </span><a href="#local-6989586621680533233"><span class="hs-identifier hs-var">iSId</span></a><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>            </span><span class="hs-identifier">foldFoo</span><span> </span><a name="local-6989586621680533235"><a href="#local-6989586621680533235"><span class="hs-identifier">rev</span></a></a><span> </span><a name="local-6989586621680533236"><a href="#local-6989586621680533236"><span class="hs-identifier">iSId</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.VAR.html#That"><span class="hs-identifier hs-var">That</span></a><span> </span><a name="local-6989586621680533237"><a href="#local-6989586621680533237"><span class="hs-identifier">dSId</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680533235"><span class="hs-identifier hs-var">rev</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><a href="#local-6989586621680533237"><span class="hs-identifier hs-var">dSId</span></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">non</span><span> </span><span class="hs-identifier hs-var">mempty</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_1</span><span>
</span><a name="line-289"></a><span>                                                         </span><span class="hs-operator hs-var">%~</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680533230"><span class="hs-identifier hs-var">ins</span></a><span> </span><a href="#local-6989586621680533236"><span class="hs-identifier hs-var">iSId</span></a><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>            </span><span class="hs-identifier">foldFoo</span><span> </span><a name="local-6989586621680533238"><a href="#local-6989586621680533238"><span class="hs-identifier">rev</span></a></a><span> </span><a name="local-6989586621680533239"><a href="#local-6989586621680533239"><span class="hs-identifier">iSId</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Delegation.Logic.VAR.html#These"><span class="hs-identifier hs-var">These</span></a><span> </span><a name="local-6989586621680533240"><a href="#local-6989586621680533240"><span class="hs-identifier">dSId1</span></a></a><span> </span><a name="local-6989586621680533241"><a href="#local-6989586621680533241"><span class="hs-identifier">dSId2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680533238"><span class="hs-identifier hs-var">rev</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><a href="#local-6989586621680533240"><span class="hs-identifier hs-var">dSId1</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">non</span><span> </span><span class="hs-identifier hs-var">mempty</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_2</span><span>
</span><a name="line-291"></a><span>                                                         </span><span class="hs-operator hs-var">%~</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680533230"><span class="hs-identifier hs-var">ins</span></a><span> </span><a href="#local-6989586621680533239"><span class="hs-identifier hs-var">iSId</span></a><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>                                                       </span><span class="hs-operator hs-var">&amp;</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><a href="#local-6989586621680533241"><span class="hs-identifier hs-var">dSId2</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">non</span><span> </span><span class="hs-identifier hs-var">mempty</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_1</span><span>
</span><a name="line-293"></a><span>                                                         </span><span class="hs-operator hs-var">%~</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680533230"><span class="hs-identifier hs-var">ins</span></a><span> </span><a href="#local-6989586621680533239"><span class="hs-identifier hs-var">iSId</span></a><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">foldlWithKey'</span><span> </span><a href="#local-6989586621680533231"><span class="hs-identifier hs-var">foldFoo</span></a><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span> </span><a href="#local-6989586621680533229"><span class="hs-identifier hs-var">changeset</span></a><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span class="hs-comment">-- This function returns identitifers of stakeholders who are no</span><span>
</span><a name="line-297"></a><span class="hs-comment">-- longer rich in the given epoch, but were rich in the previous one.</span><span>
</span><a name="line-298"></a><span class="hs-identifier">getNoLongerRichmen</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-299"></a><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621680533183"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-300"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621680533183"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-301"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadDBRead</span><span> </span><a href="#local-6989586621680533183"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-302"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadReader</span><span> </span><a href="#local-6989586621680533184"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621680533183"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-303"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasLens'</span><span> </span><a href="#local-6989586621680533184"><span class="hs-identifier hs-type">ctx</span></a><span> </span><span class="hs-identifier hs-type">LrcContext</span><span>
</span><a name="line-304"></a><span>       </span><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">EpochIndex</span><span>
</span><a name="line-306"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680533183"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">]</span><span>
</span><a name="line-307"></a><a name="getNoLongerRichmen"><a href="Pos.Delegation.Logic.VAR.html#getNoLongerRichmen"><span class="hs-identifier">getNoLongerRichmen</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EpochIndex</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-308"></a><span class="hs-identifier">getNoLongerRichmen</span><span> </span><a name="local-6989586621680533257"><a href="#local-6989586621680533257"><span class="hs-identifier">newEpoch</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-309"></a><span>    </span><span class="hs-special">(</span><span class="hs-operator hs-var">\\</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621680533258"><span class="hs-identifier hs-var">getRichmen</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680533257"><span class="hs-identifier hs-var">newEpoch</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621680533258"><span class="hs-identifier hs-var">getRichmen</span></a><span> </span><a href="#local-6989586621680533257"><span class="hs-identifier hs-var">newEpoch</span></a><span>
</span><a name="line-310"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-311"></a><span>    </span><a name="local-6989586621680533258"><a href="#local-6989586621680533258"><span class="hs-identifier">getRichmen</span></a></a><span> </span><a name="local-6989586621680533259"><a href="#local-6989586621680533259"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-312"></a><span>        </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-313"></a><span>        </span><span class="hs-identifier hs-var">lrcActionOnEpochReason</span><span> </span><a href="#local-6989586621680533259"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-string">&quot;getNoLongerRichmen&quot;</span><span> </span><a href="Pos.Lrc.DB.Richmen.html#getRichmenDlg"><span class="hs-identifier hs-var">LrcDB</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getRichmenDlg</span></a><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-comment">-- State needed for 'delegationVerifyBlocks'.</span><span>
</span><a name="line-316"></a><span class="hs-keyword">data</span><span> </span><a name="DlgVerState"><a href="Pos.Delegation.Logic.VAR.html#DlgVerState"><span class="hs-identifier">DlgVerState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="DlgVerState"><a href="Pos.Delegation.Logic.VAR.html#DlgVerState"><span class="hs-identifier">DlgVerState</span></a></a><span>
</span><a name="line-317"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="_dvCurEpoch"><a href="Pos.Delegation.Logic.VAR.html#_dvCurEpoch"><span class="hs-identifier">_dvCurEpoch</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">HashSet</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>      </span><span class="hs-comment">-- ^ Set of issuers that have already posted certificates this epoch</span><span>
</span><a name="line-319"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-char">''DlgVerState

-- | Verifies if blocks are correct relatively to the delegation logic
-- and returns a non-empty list of proxySKs needed for undoing
-- them. Predicate for correctness here is:
--
-- * Issuer can post only one cert per epoch
-- * For every new certificate issuer had enough stake at the
--   end of prev. epoch
-- * Delegation payload plus database state doesn't produce cycles.
--
-- It's assumed blocks are correct from 'Pos.Types.Block#verifyBlocks'
-- point of view.
dlgVerifyBlocks ::
       forall ssc ctx m.
       ( DB.MonadBlockDB ssc m
       , MonadIO m
       , MonadReader ctx m
       , HasLens' ctx LrcContext
       , HasConfiguration
       )
    =&gt; OldestFirst NE (Block ssc)
    -&gt; m (Either Text (OldestFirst NE DlgUndo))
dlgVerifyBlocks blocks = do
    _dvCurEpoch &lt;- GS.getThisEpochPostedKeys
    let initState = DlgVerState _dvCurEpoch
    (richmen :: HashSet StakeholderId) &lt;-
        lrcActionOnEpochReason
        headEpoch
        &quot;Delegation.Logic#delegationVerifyBlocks: there are no richmen for current epoch&quot;
        LrcDB.getRichmenDlg
    flip evalStateT initState . evalMapCede mempty . runExceptT $
        mapM (verifyBlock richmen) blocks
  where
    headEpoch = blocks ^. _Wrapped . _neHead . epochIndexL

    verifyBlock ::
        HashSet StakeholderId -&gt;
        Block ssc -&gt;
        ExceptT Text (MapCede (StateT DlgVerState m)) DlgUndo
    verifyBlock _ (Left genesisBlk) = do
        prevThisEpochPosted &lt;- use dvCurEpoch
        dvCurEpoch .= HS.empty
        let blkEpoch = genesisBlk ^. epochIndexL
        noLongerRichmen &lt;- lift $ lift $ getNoLongerRichmen blkEpoch
        deletedPSKs &lt;- catMaybes &lt;$&gt; mapM getPsk noLongerRichmen
        -- We should delete all certs for people who are not richmen.
        let delFromCede = modPsk . DlgEdgeDel . addressHash . pskIssuerPk
        mapM_ delFromCede deletedPSKs
        pure $ DlgUndo deletedPSKs prevThisEpochPosted
    verifyBlock richmen (Right blk) = do
        -- We assume here that issuers list doesn't contain
        -- duplicates (checked in payload construction).

        ------------- [Header] -------------

        -- Check 1: Issuer didn't delegate the right to issue to elseone.
        let h = blk ^. gbHeader
        let issuer = h ^. mainHeaderLeaderKey
        let sig = h ^. gbhConsensus ^. mcdSignature
        issuerPsk &lt;- getPskPk issuer
        whenJust issuerPsk $ \psk -&gt; case sig of
            (BlockSignature _) -&gt;
                throwError $
                sformat (&quot;issuer &quot;%build%&quot; has delegated issuance right, &quot;%
                         &quot;so he can't issue the block, psk: &quot;%build%&quot;, sig: &quot;%build)
                    issuer psk sig
            _ -&gt; pass

        -- Check 2: Check that if proxy sig is used, delegate indeed
        -- has right to issue the block. Signatures themselves are
        -- checked in the constructor, here we only verify they are
        -- related to slot leader. Self-signed proxySigs are forbidden
        -- on block construction level.
        case h ^. gbhConsensus ^. mcdSignature of
            (BlockPSignatureHeavy pSig) -&gt; do
                let psk = psigPsk pSig
                let delegate = pskDelegatePk psk
                canIssue &lt;- dlgReachesIssuance issuer delegate psk
                unless canIssue $ throwError $
                    sformat (&quot;heavy proxy signature's &quot;%build%&quot; &quot;%
                             &quot;related proxy cert can't be found/doesn't &quot;%
                             &quot;match the one in current allowed heavy psks set&quot;)
                            pSig
            (BlockPSignatureLight pSig) -&gt; do
                let pskIPk = pskIssuerPk (psigPsk pSig)
                unless (pskIPk == issuer) $ throwError $
                    sformat (&quot;light proxy signature's &quot;%build%&quot; issuer &quot;%
                             build%&quot; doesn't match block slot leader &quot;%build)
                            pSig pskIPk issuer
            _ -&gt; pass

        ------------- [Payload] -------------

        let proxySKs = getDlgPayload $ view mainBlockDlgPayload blk
            toIssuers = map pskIssuerPk
            allIssuers = toIssuers proxySKs
            allIssuersSt = map addressHash allIssuers
            (revokeIssuers, changeIssuers) =
                bimap toIssuers toIssuers $ partition isRevokePsk proxySKs

        -- Check 3: Issuers have enough money (though it's free to revoke).
        when (any (not . (`HS.member` richmen) . addressHash) changeIssuers) $
            throwError $ sformat (&quot;Block &quot;%build%&quot; contains psk issuers that &quot;%
                                  &quot;don't have enough stake&quot;)
                                 (headerHash blk)

        -- Check 4: No issuer has posted psk this epoch before.
        curEpoch &lt;- use dvCurEpoch
        when (any (`HS.member` curEpoch) allIssuersSt) $
            throwError $ sformat (&quot;Block &quot;%build%&quot; contains issuers that &quot;%
                                  &quot;have already published psk this epoch&quot;)
                                 (headerHash blk)

        -- Check 5: Every revoking psk indeed revokes previous
        -- non-revoking psk.
        revokePrevCerts &lt;- mapM (\x -&gt; (x,) &lt;$&gt; getPskPk x) revokeIssuers
        let dontHavePrevPsk = filter (isNothing . snd) revokePrevCerts
        unless (null dontHavePrevPsk) $
            throwError $
            sformat (&quot;Block &quot;%build%&quot; contains revoke certs that &quot;%
                     &quot;don't revoke anything: &quot;%listJson)
                     (headerHash blk) (map fst dontHavePrevPsk)

        -- Check 6: applying psks won't create a cycle.
        --
        -- Lemma 1: Removing edges from acyclic graph doesn't create cycles.
        --
        -- Lemma 2: Let G = (E&#8321;,V&#8321;) be acyclic graph and F = (E&#8322;,V&#8322;) another one,
        -- where E&#8321; &#8745; E&#8322; &#8800; &#8709; in general case. Then if G &#8746; F has a loop C, then
        -- &#8707; a &#8712; C such that a &#8712; E&#8322;.
        --
        -- Hence in order to check whether S=G&#8746;F has cycle, it's sufficient to
        -- validate that dfs won't re-visit any vertex, starting it on
        -- every s &#8712; E&#8322;.
        --
        -- In order to do it we should resolve with db, 'dvPskChanged' and
        -- 'proxySKs' together. So it's alright to first apply 'proxySKs'
        -- to 'dvPskChanged' and then perform the check.

        -- Collect rollback info, apply new psks
        changePrevCerts &lt;- mapM getPskPk changeIssuers
        let toRollback = catMaybes $ map snd revokePrevCerts &lt;&gt; changePrevCerts
        mapM_ (modPsk . pskToDlgEdgeAction) proxySKs

        -- Perform the check
        cyclePoints &lt;- catMaybes &lt;$&gt; mapM detectCycleOnAddition proxySKs
        unless (null cyclePoints) $
            throwError $
            sformat (&quot;Block &quot;%build%&quot; leads to psk cycles, at least in these certs: &quot;%listJson)
                    (headerHash blk)
                    (take 5 $ cyclePoints) -- should be enough

        dvCurEpoch %= HS.union (HS.fromList allIssuersSt)
        pure $ DlgUndo toRollback mempty

-- | Applies a sequence of definitely valid blocks to memory state and
-- returns batchops. It works correctly only in case blocks don't
-- cross over epoch. So genesis block is either absent or the head.
dlgApplyBlocks ::
       forall ssc ctx m.
       ( MonadDelegation ctx m
       , MonadIO m
       , MonadDBRead m
       , WithLogger m
       , MonadMask m
       , HasConfiguration
       , SscHelpersClass ssc
       )
    =&gt; OldestFirst NE (Blund ssc)
    -&gt; m (NonEmpty SomeBatchOp)
dlgApplyBlocks blunds = do
    tip &lt;- GS.getTip
    let assumedTip = blocks ^. _Wrapped . _neHead . prevBlockL
    when (tip /= assumedTip) $ throwM $
        DelegationCantApplyBlocks $
        sformat
        (&quot;Oldest block is based on tip &quot;%shortHashF%&quot;, but our tip is &quot;%shortHashF)
        assumedTip tip
    getOldestFirst &lt;$&gt; mapM applyBlock blunds
  where
    blocks = map fst blunds
    applyBlock :: Blund ssc -&gt; m SomeBatchOp
    applyBlock ((Left block), undoDlg -&gt; DlgUndo{..}) = do
        runDelegationStateAction $ do
            -- all possible psks candidates are now invalid because epoch changed
            clearDlgMemPoolAction
            dwTip .= headerHash block
        -- For genesis blocks, dlg undo is richmen that lost their stake.
        -- So we delete all these guys.
        let edgeActions = map (DlgEdgeDel . addressHash . pskIssuerPk) duPsks
        let edgeOp = SomeBatchOp $ map GS.PskFromEdgeAction edgeActions
        transCorrections &lt;- calculateTransCorrections $ HS.fromList edgeActions
        -- we also should delete all people who posted previous epoch
        let postedOp =
                SomeBatchOp $ map GS.DelPostedThisEpoch $
                HS.toList duPrevEpochPosted
        pure $ edgeOp &lt;&gt; transCorrections &lt;&gt; postedOp
    applyBlock ((Right block), _) = do
        -- for main blocks we can get psks directly from the block,
        -- though it's duplicated in the undo.
        let proxySKs = getDlgPayload $ view mainBlockDlgPayload block
            issuers = map pskIssuerPk proxySKs
            edgeActions = map pskToDlgEdgeAction proxySKs
        transCorrections &lt;- calculateTransCorrections $ HS.fromList edgeActions
        let batchOps = SomeBatchOp (map GS.PskFromEdgeAction edgeActions) &lt;&gt; transCorrections
        runDelegationStateAction $ do
            dwTip .= headerHash block
            forM_ issuers deleteFromDlgMemPool
        pure $ SomeBatchOp batchOps


-- | Rollbacks block list. Erases mempool of certificates. Better to
-- restore them after the rollback (see Txp#normalizeTxpLD). You can
-- rollback arbitrary number of blocks.
dlgRollbackBlocks
    :: forall ssc ctx m.
       ( MonadDelegation ctx m
       , DB.MonadBlockDB ssc m
       , WithLogger m
       )
    =&gt; NewestFirst NE (Blund ssc) -&gt; m (NonEmpty SomeBatchOp)
dlgRollbackBlocks blunds = do
    getNewestFirst &lt;$&gt; mapM rollbackBlund blunds
  where
    rollbackBlund :: Blund ssc -&gt; m SomeBatchOp
    rollbackBlund (Left _, undoDlg -&gt; DlgUndo{..}) =
        -- We should restore &quot;this epoch posted&quot; set to one from the undo
        pure $ SomeBatchOp $ map GS.AddPostedThisEpoch $ HS.toList duPrevEpochPosted
    rollbackBlund (Right block, undoDlg -&gt; DlgUndo{..}) = do
        let proxySKs = getDlgPayload $ view mainBlockDlgPayload block
            issuers = map pskIssuerPk proxySKs
            backDeleted = issuers \\ map pskIssuerPk duPsks
            edgeActions = map (DlgEdgeDel . addressHash) backDeleted
                       &lt;&gt; map DlgEdgeAdd duPsks
        transCorrections &lt;- calculateTransCorrections $ HS.fromList edgeActions
        let pskOp = SomeBatchOp (map GS.PskFromEdgeAction edgeActions) &lt;&gt; transCorrections
        -- we should also delete issuers from &quot;posted this epoch already&quot;
        let postedOp = SomeBatchOp $ map (GS.DelPostedThisEpoch . addressHash) issuers
        pure $ pskOp &lt;&gt; postedOp

-- | Normalizes the memory state after the rollback. Must be called
-- only when 'StateLock' is taken.
dlgNormalizeOnRollback ::
       forall ssc ctx m.
       ( MonadDelegation ctx m
       , DB.MonadBlockDB ssc m
       , DB.MonadGState m
       , MonadIO m
       , MonadMask m
       , HasLens' ctx LrcContext
       , Mockable CurrentTime m
       , HasConfiguration
       , SscHelpersClass ssc
       )
    =&gt; m ()
dlgNormalizeOnRollback = do
    tip &lt;- DB.getTipHeader @ssc
    oldPool &lt;- runDelegationStateAction $ do
        pool &lt;- uses dwProxySKPool toList
        dwProxySKPool .= mempty
        dwTip .= headerHash tip
        pure pool
    forM_ oldPool $ processProxySKHeavyInternal @ssc
</span></pre></body></html>