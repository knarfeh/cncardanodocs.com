<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-- | Server which deals with blocks processing.</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Retrieval</span><span>
</span><a name="line-6"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Pos.Block.Network.Retrieval.html#retrievalWorker"><span class="hs-identifier hs-var">retrievalWorker</span></a><span>
</span><a name="line-7"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">STM</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putTMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">swapTMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tryReadTBQueue</span><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>                                             </span><span class="hs-identifier hs-var">tryReadTMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tryTakeTMVar</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">to</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">_Wrapped</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Except</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExceptT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runExceptT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throwError</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">STM</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">retry</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span><span>         </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;|</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Set</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Ether</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasLens</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Formatting</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">build</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">builder</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sformat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stext</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Mockable</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">delay</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">handleAll</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Memory</span><span class="hs-operator">.</span><span class="hs-identifier">Units</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitBuilder</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listJson</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sec</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Wlog</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">logDebug</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logError</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logInfo</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logWarning</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">biSize</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Binary.Communication.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Communication</span></a><span>   </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.Core.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span></a><span>             </span><span class="hs-special">(</span><a href="Pos.Block.Core.Union.Types.html#Block"><span class="hs-identifier hs-type">Block</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Block.Core.Union.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Block.Core.Union.Misc.html#blockHeader"><span class="hs-identifier hs-var">blockHeader</span></a><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.Logic.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Logic</span></a><span>            </span><span class="hs-special">(</span><a href="Pos.Block.Logic.Header.html#ClassifyHeaderRes"><span class="hs-identifier hs-type">ClassifyHeaderRes</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Block.Logic.Header.html#classifyNewHeader"><span class="hs-identifier hs-var">classifyNewHeader</span></a><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.Network.Announce.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Announce</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Block.Network.Announce.html#announceBlockOuts"><span class="hs-identifier hs-var">announceBlockOuts</span></a><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.Network.Logic.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Logic</span></a><span>    </span><span class="hs-special">(</span><a href="Pos.Block.Network.Logic.html#BlockNetLogicException"><span class="hs-identifier hs-type">BlockNetLogicException</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Block.Network.Logic.html#DialogUnexpected"><span class="hs-identifier hs-var">DialogUnexpected</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>                                             </span><a href="Pos.Block.Network.Logic.html#MkHeadersRequestResult"><span class="hs-identifier hs-type">MkHeadersRequestResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Block.Network.Logic.html#handleBlocks"><span class="hs-identifier hs-var">handleBlocks</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>                                             </span><a href="Pos.Block.Network.Logic.html#mkBlocksRequest"><span class="hs-identifier hs-var">mkBlocksRequest</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Block.Network.Logic.html#mkHeadersRequest"><span class="hs-identifier hs-var">mkHeadersRequest</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>                                             </span><a href="Pos.Block.Network.Logic.html#requestHeaders"><span class="hs-identifier hs-var">requestHeaders</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Block.Network.Logic.html#triggerRecovery"><span class="hs-identifier hs-var">triggerRecovery</span></a><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.Network.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>    </span><span class="hs-special">(</span><a href="Pos.Block.Network.Types.html#MsgBlock"><span class="hs-identifier hs-type">MsgBlock</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Block.Network.Types.html#MsgGetBlocks"><span class="hs-identifier hs-type">MsgGetBlocks</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.RetrievalQueue.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">RetrievalQueue</span></a><span>   </span><span class="hs-special">(</span><a href="Pos.Block.RetrievalQueue.html#BlockRetrievalTask"><span class="hs-identifier hs-type">BlockRetrievalTask</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Communication.Limits.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Communication</span><span class="hs-operator">.</span><span class="hs-identifier">Limits</span></a><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">recvLimited</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Communication</span><span class="hs-operator">.</span><span class="hs-identifier">Protocol</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Conversation</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ConversationActions</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>                                             </span><span class="hs-identifier hs-type">EnqueueMsg</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MsgType</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutSpecs</span><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>                                             </span><span class="hs-identifier hs-type">SendActions</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">WorkerSpec</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">convH</span><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>                                             </span><span class="hs-identifier hs-var">toOutSpecs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">waitForConversations</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">worker</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Context.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Context</span></a><span>                </span><span class="hs-special">(</span><a href="Pos.Block.RetrievalQueue.html#BlockRetrievalQueueTag"><span class="hs-identifier hs-type">BlockRetrievalQueueTag</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Context.Context.html#ProgressHeaderTag"><span class="hs-identifier hs-type">ProgressHeaderTag</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>                                             </span><a href="Pos.Context.Context.html#RecoveryHeaderTag"><span class="hs-identifier hs-type">RecoveryHeaderTag</span></a><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasHeaderHash</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HeaderHash</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">difficultyL</span><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>                                             </span><span class="hs-identifier hs-var">isMoreDifficult</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">prevBlockL</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">shortHashF</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Reporting</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reportOrLogE</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reportOrLogW</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Shutdown</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">runIfNotShutdown</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscWorkersClass</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">_neHead</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">_neLast</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Chrono</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NE</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NewestFirst</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OldestFirst</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>                                             </span><span class="hs-identifier hs-var">_NewestFirst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">_OldestFirst</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.WorkMode.Class.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">WorkMode</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.WorkMode.Class.html#WorkMode"><span class="hs-identifier hs-type">WorkMode</span></a><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-identifier">retrievalWorker</span><span>
</span><a name="line-56"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621681353674"><a href="#local-6989586621681353674"><span class="hs-identifier">ssc</span></a></a><span> </span><a name="local-6989586621681353675"><a href="#local-6989586621681353675"><span class="hs-identifier">ctx</span></a></a><span> </span><a name="local-6989586621681353676"><a href="#local-6989586621681353676"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-57"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscWorkersClass</span><span> </span><a href="#local-6989586621681353674"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">,</span><span> </span><a href="Pos.WorkMode.Class.html#WorkMode"><span class="hs-identifier hs-type">WorkMode</span></a><span> </span><a href="#local-6989586621681353674"><span class="hs-identifier hs-type">ssc</span></a><span> </span><a href="#local-6989586621681353675"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681353676"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WorkerSpec</span><span> </span><a href="#local-6989586621681353676"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutSpecs</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><a name="retrievalWorker"><a href="Pos.Block.Network.Retrieval.html#retrievalWorker"><span class="hs-identifier">retrievalWorker</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">worker</span><span> </span><a href="#local-6989586621681353677"><span class="hs-identifier hs-var">outs</span></a><span> </span><a href="Pos.Block.Network.Retrieval.html#retrievalWorkerImpl"><span class="hs-identifier hs-var">retrievalWorkerImpl</span></a><span>
</span><a name="line-60"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-61"></a><span>    </span><a name="local-6989586621681353677"><a href="#local-6989586621681353677"><span class="hs-identifier">outs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Block.Network.Announce.html#announceBlockOuts"><span class="hs-identifier hs-var">announceBlockOuts</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-62"></a><span>           </span><span class="hs-identifier hs-var">toOutSpecs</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">convH</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="Pos.Block.Network.Types.html#MsgGetBlocks"><span class="hs-identifier hs-type">MsgGetBlocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><span class="hs-special">(</span><a href="Pos.Block.Network.Types.html#MsgBlock"><span class="hs-identifier hs-type">MsgBlock</span></a><span> </span><a href="#local-6989586621681353674"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>                      </span><span class="hs-special">]</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-comment">-- I really don't like join</span><span>
</span><a name="line-67"></a><span class="hs-pragma">{-# ANN retrievalWorkerImpl (&quot;HLint: ignore Use join&quot; :: Text) #-}</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">-- | Worker that queries blocks. It has two jobs:</span><span>
</span><a name="line-70"></a><span class="hs-comment">--</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- * If there are headers in 'BlockRetrievalQueue', this worker retrieves</span><span>
</span><a name="line-72"></a><span class="hs-comment">--   blocks according to that queue.</span><span>
</span><a name="line-73"></a><span class="hs-comment">--</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- * If recovery is in progress, this worker keeps recovery going by asking</span><span>
</span><a name="line-75"></a><span class="hs-comment">--   headers (and then switching to block retrieval on next loop iteration).</span><span>
</span><a name="line-76"></a><span class="hs-comment">--</span><span>
</span><a name="line-77"></a><span class="hs-comment">-- If both happen at the same time, 'BlockRetrievalQueue' takes precedence.</span><span>
</span><a name="line-78"></a><span class="hs-comment">--</span><span>
</span><a name="line-79"></a><span class="hs-identifier">retrievalWorkerImpl</span><span>
</span><a name="line-80"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621681353671"><a href="#local-6989586621681353671"><span class="hs-identifier">ssc</span></a></a><span> </span><a name="local-6989586621681353672"><a href="#local-6989586621681353672"><span class="hs-identifier">ctx</span></a></a><span> </span><a name="local-6989586621681353673"><a href="#local-6989586621681353673"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-81"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscWorkersClass</span><span> </span><a href="#local-6989586621681353671"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">,</span><span> </span><a href="Pos.WorkMode.Class.html#WorkMode"><span class="hs-identifier hs-type">WorkMode</span></a><span> </span><a href="#local-6989586621681353671"><span class="hs-identifier hs-type">ssc</span></a><span> </span><a href="#local-6989586621681353672"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681353673"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">SendActions</span><span> </span><a href="#local-6989586621681353673"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681353673"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><a name="retrievalWorkerImpl"><a href="Pos.Block.Network.Retrieval.html#retrievalWorkerImpl"><span class="hs-identifier">retrievalWorkerImpl</span></a></a><span> </span><span class="hs-identifier hs-var">SendActions</span><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-84"></a><span>    </span><span class="hs-identifier hs-var">handleAll</span><span> </span><a href="#local-6989586621681353683"><span class="hs-identifier hs-var">mainLoopE</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-85"></a><span>        </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;Starting retrievalWorker loop&quot;</span><span>
</span><a name="line-86"></a><span>        </span><a href="#local-6989586621681353682"><span class="hs-identifier hs-var">mainLoop</span></a><span>
</span><a name="line-87"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-88"></a><span>    </span><a name="local-6989586621681353682"><a href="#local-6989586621681353682"><span class="hs-identifier">mainLoop</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runIfNotShutdown</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-89"></a><span>        </span><a name="local-6989586621681353690"><a href="#local-6989586621681353690"><span class="hs-identifier">queue</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">view</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lensOf</span><span> </span><span class="hs-glyph">@</span><a href="Pos.Block.RetrievalQueue.html#BlockRetrievalQueueTag"><span class="hs-identifier hs-type">BlockRetrievalQueueTag</span></a><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>        </span><a name="local-6989586621681353691"><a href="#local-6989586621681353691"><span class="hs-identifier">recHeaderVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">view</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lensOf</span><span> </span><span class="hs-glyph">@</span><a href="Pos.Context.Context.html#RecoveryHeaderTag"><span class="hs-identifier hs-type">RecoveryHeaderTag</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>        </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;Waiting on the block queue or recovery header var&quot;</span><span>
</span><a name="line-92"></a><span>        </span><span class="hs-comment">-- Reading the queue is a priority, because it sets the recovery</span><span>
</span><a name="line-93"></a><span>        </span><span class="hs-comment">-- variable in case the header is classified as alternative. So if the</span><span>
</span><a name="line-94"></a><span>        </span><span class="hs-comment">-- queue contains lots of headers after a long delay, we'll first</span><span>
</span><a name="line-95"></a><span>        </span><span class="hs-comment">-- iterate over them and set recovery variable to the latest one, and</span><span>
</span><a name="line-96"></a><span>        </span><span class="hs-comment">-- only then we'll do recovery.</span><span>
</span><a name="line-97"></a><span>        </span><a name="local-6989586621681353698"><a href="#local-6989586621681353698"><span class="hs-identifier">thingToDoNext</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-98"></a><span>            </span><a name="local-6989586621681353692"><a href="#local-6989586621681353692"><span class="hs-identifier">mbQueuedHeadersChunk</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryReadTBQueue</span><span> </span><a href="#local-6989586621681353690"><span class="hs-identifier hs-var">queue</span></a><span>
</span><a name="line-99"></a><span>            </span><a name="local-6989586621681353693"><a href="#local-6989586621681353693"><span class="hs-identifier">mbRecHeader</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryReadTMVar</span><span> </span><a href="#local-6989586621681353691"><span class="hs-identifier hs-var">recHeaderVar</span></a><span>
</span><a name="line-100"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353692"><span class="hs-identifier hs-var">mbQueuedHeadersChunk</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681353693"><span class="hs-identifier hs-var">mbRecHeader</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-101"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">retry</span><span>
</span><a name="line-102"></a><span>                </span><span class="hs-comment">-- Dispatch the task</span><span>
</span><a name="line-103"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681353694"><a href="#local-6989586621681353694"><span class="hs-identifier">nodeId</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681353695"><a href="#local-6989586621681353695"><span class="hs-identifier">task</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-104"></a><span>                    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353684"><span class="hs-identifier hs-var">handleBlockRetrieval</span></a><span> </span><a href="#local-6989586621681353694"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><a href="#local-6989586621681353695"><span class="hs-identifier hs-var">task</span></a><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>                </span><span class="hs-comment">-- No tasks &amp; the recovery header is set =&gt; do the recovery</span><span>
</span><a name="line-106"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681353696"><a href="#local-6989586621681353696"><span class="hs-identifier">nodeId</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681353697"><a href="#local-6989586621681353697"><span class="hs-identifier">rHeader</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-107"></a><span>                    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353687"><span class="hs-identifier hs-var">handleRecoveryWithHandler</span></a><span> </span><a href="#local-6989586621681353696"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><a href="#local-6989586621681353697"><span class="hs-identifier hs-var">rHeader</span></a><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>        </span><a href="#local-6989586621681353698"><span class="hs-identifier hs-var">thingToDoNext</span></a><span>
</span><a name="line-109"></a><span>        </span><a href="#local-6989586621681353682"><span class="hs-identifier hs-var">mainLoop</span></a><span>
</span><a name="line-110"></a><span>    </span><a name="local-6989586621681353683"><a href="#local-6989586621681353683"><span class="hs-identifier">mainLoopE</span></a></a><span> </span><a name="local-6989586621681353699"><a href="#local-6989586621681353699"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-111"></a><span>        </span><span class="hs-comment">-- REPORT:ERROR 'reportOrLogE' in block retrieval worker.</span><span>
</span><a name="line-112"></a><span>        </span><span class="hs-identifier hs-var">reportOrLogE</span><span> </span><span class="hs-string">&quot;retrievalWorker mainLoopE: error caught &quot;</span><span> </span><a href="#local-6989586621681353699"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-113"></a><span>        </span><span class="hs-identifier hs-var">delay</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sec</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>        </span><a href="#local-6989586621681353682"><span class="hs-identifier hs-var">mainLoop</span></a><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-comment">-----------------</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span>    </span><span class="hs-comment">-- That's the first queue branch (task dispatching).</span><span>
</span><a name="line-119"></a><span>    </span><a name="local-6989586621681353684"><a href="#local-6989586621681353684"><span class="hs-identifier">handleBlockRetrieval</span></a></a><span> </span><a name="local-6989586621681353700"><a href="#local-6989586621681353700"><span class="hs-identifier">nodeId</span></a></a><span> </span><a href="Pos.Block.RetrievalQueue.html#BlockRetrievalTask"><span class="hs-identifier hs-var">BlockRetrievalTask</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-120"></a><span>        </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span>
</span><a name="line-121"></a><span>            </span><span class="hs-special">(</span><span class="hs-string">&quot;Block retrieval queue task received, nodeId=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span>
</span><a name="line-122"></a><span>             </span><span class="hs-string">&quot;, header=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;, continues=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>            </span><a href="#local-6989586621681353700"><span class="hs-identifier hs-var">nodeId</span></a><span>
</span><a name="line-124"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353701"><span class="hs-identifier hs-var">brtHeader</span></a><span class="hs-special">)</span><span>
</span><a name="line-125"></a><span>            </span><a href="#local-6989586621681353702"><span class="hs-identifier hs-var">brtContinues</span></a><span>
</span><a name="line-126"></a><span>        </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681353702"><span class="hs-identifier hs-var">brtContinues</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681353685"><span class="hs-identifier hs-var">handleContinues</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621681353686"><span class="hs-identifier hs-var">handleAlternative</span></a><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>            </span><a href="#local-6989586621681353700"><span class="hs-identifier hs-var">nodeId</span></a><span>
</span><a name="line-128"></a><span>            </span><a href="#local-6989586621681353701"><span class="hs-identifier hs-var">brtHeader</span></a><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span>    </span><span class="hs-comment">-- When we have a continuation of the chain, just try to get and apply it.</span><span>
</span><a name="line-131"></a><span>    </span><a name="local-6989586621681353685"><a href="#local-6989586621681353685"><span class="hs-identifier">handleContinues</span></a></a><span> </span><a name="local-6989586621681353703"><a href="#local-6989586621681353703"><span class="hs-identifier">nodeId</span></a></a><span> </span><a name="local-6989586621681353704"><a href="#local-6989586621681353704"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-132"></a><span>        </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;handleContinues: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><a href="#local-6989586621681353704"><span class="hs-identifier hs-var">header</span></a><span>
</span><a name="line-133"></a><span>        </span><a href="Pos.Block.Network.Retrieval.html#processContHeader"><span class="hs-identifier hs-var">processContHeader</span></a><span> </span><a href="#local-6989586621681353681"><span class="hs-identifier hs-var">enqueueMsg</span></a><span> </span><a href="#local-6989586621681353703"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><a href="#local-6989586621681353704"><span class="hs-identifier hs-var">header</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span>    </span><span class="hs-comment">-- When we have an alternative header, we should check whether it's actually</span><span>
</span><a name="line-136"></a><span>    </span><span class="hs-comment">-- recovery mode (server side should send us headers as a proof) and then</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-comment">-- enter recovery mode.</span><span>
</span><a name="line-138"></a><span>    </span><a name="local-6989586621681353686"><a href="#local-6989586621681353686"><span class="hs-identifier">handleAlternative</span></a></a><span> </span><a name="local-6989586621681353705"><a href="#local-6989586621681353705"><span class="hs-identifier">nodeId</span></a></a><span> </span><a name="local-6989586621681353706"><a href="#local-6989586621681353706"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-139"></a><span>        </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;handleAlternative: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><a href="#local-6989586621681353706"><span class="hs-identifier hs-var">header</span></a><span>
</span><a name="line-140"></a><span>        </span><a href="Pos.Block.Logic.Header.html#classifyNewHeader"><span class="hs-identifier hs-var">classifyNewHeader</span></a><span> </span><a href="#local-6989586621681353706"><span class="hs-identifier hs-var">header</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-141"></a><span>            </span><a href="Pos.Block.Logic.Header.html#CHInvalid"><span class="hs-identifier hs-var">CHInvalid</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-142"></a><span>                </span><span class="hs-identifier hs-var">logError</span><span> </span><span class="hs-string">&quot;handleAlternative: invalid header got into retrievalWorker queue&quot;</span><span>
</span><a name="line-143"></a><span>            </span><a href="Pos.Block.Logic.Header.html#CHUseless"><span class="hs-identifier hs-var">CHUseless</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-144"></a><span>                </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-145"></a><span>                </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;handleAlternative: header &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; became useless, ignoring it&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>                        </span><a href="#local-6989586621681353706"><span class="hs-identifier hs-var">header</span></a><span>
</span><a name="line-147"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-148"></a><span>                </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;handleAlternative: considering header for recovery mode&quot;</span><span>
</span><a name="line-149"></a><span>                </span><span class="hs-comment">-- CSL-1514</span><span>
</span><a name="line-150"></a><span>                </span><a href="Pos.Block.Network.Retrieval.html#updateRecoveryHeader"><span class="hs-identifier hs-var">updateRecoveryHeader</span></a><span> </span><a href="#local-6989586621681353705"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><a href="#local-6989586621681353706"><span class="hs-identifier hs-var">header</span></a><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span>    </span><span class="hs-comment">-----------------</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span>    </span><a name="local-6989586621681353687"><a href="#local-6989586621681353687"><span class="hs-identifier">handleRecoveryWithHandler</span></a></a><span> </span><a name="local-6989586621681353707"><a href="#local-6989586621681353707"><span class="hs-identifier">nodeId</span></a></a><span> </span><a name="local-6989586621681353708"><a href="#local-6989586621681353708"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-155"></a><span>        </span><span class="hs-identifier hs-var">handleAll</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353688"><span class="hs-identifier hs-var">handleRecoveryE</span></a><span> </span><a href="#local-6989586621681353707"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><a href="#local-6989586621681353708"><span class="hs-identifier hs-var">header</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-156"></a><span>        </span><a href="#local-6989586621681353689"><span class="hs-identifier hs-var">handleRecovery</span></a><span> </span><a href="#local-6989586621681353707"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><a href="#local-6989586621681353708"><span class="hs-identifier hs-var">header</span></a><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span>    </span><span class="hs-comment">-- We immediately drop recovery mode/header and request tips</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-comment">-- again.</span><span>
</span><a name="line-160"></a><span>    </span><a name="local-6989586621681353688"><a href="#local-6989586621681353688"><span class="hs-identifier">handleRecoveryE</span></a></a><span> </span><a name="local-6989586621681353709"><a href="#local-6989586621681353709"><span class="hs-identifier">nodeId</span></a></a><span> </span><a name="local-6989586621681353710"><a href="#local-6989586621681353710"><span class="hs-identifier">header</span></a></a><span> </span><a name="local-6989586621681353711"><a href="#local-6989586621681353711"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-161"></a><span>        </span><span class="hs-comment">-- REPORT:ERROR 'reportOrLogW' in block retrieval worker/recovery.</span><span>
</span><a name="line-162"></a><span>        </span><span class="hs-identifier hs-var">reportOrLogW</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sformat</span><span>
</span><a name="line-163"></a><span>            </span><span class="hs-special">(</span><span class="hs-string">&quot;handleRecoveryE: error handling nodeId=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;, header=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;: &quot;</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>            </span><a href="#local-6989586621681353709"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353710"><span class="hs-identifier hs-var">header</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353711"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-165"></a><span>        </span><a href="Pos.Block.Network.Retrieval.html#dropUpdateHeader"><span class="hs-identifier hs-var">dropUpdateHeader</span></a><span>
</span><a name="line-166"></a><span>        </span><a href="Pos.Block.Network.Retrieval.html#dropRecoveryHeaderAndRepeat"><span class="hs-identifier hs-var">dropRecoveryHeaderAndRepeat</span></a><span> </span><a href="#local-6989586621681353681"><span class="hs-identifier hs-var">enqueueMsg</span></a><span> </span><a href="#local-6989586621681353709"><span class="hs-identifier hs-var">nodeId</span></a><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span>    </span><span class="hs-comment">-- Recovery handling. We assume that header in the recovery variable is</span><span>
</span><a name="line-169"></a><span>    </span><span class="hs-comment">-- appropriate and just query headers/blocks.</span><span>
</span><a name="line-170"></a><span>    </span><a name="local-6989586621681353689"><a href="#local-6989586621681353689"><span class="hs-identifier">handleRecovery</span></a></a><span> </span><a name="local-6989586621681353712"><a href="#local-6989586621681353712"><span class="hs-identifier">nodeId</span></a></a><span> </span><a name="local-6989586621681353713"><a href="#local-6989586621681353713"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-171"></a><span>        </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;Block retrieval queue is empty and we're in recovery mode,\
                 \ so we will request more headers and blocks&quot;</span><span>
</span><a name="line-173"></a><span>        </span><a href="Pos.Block.Network.Logic.html#mkHeadersRequest"><span class="hs-identifier hs-var">mkHeadersRequest</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353713"><span class="hs-identifier hs-var">header</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-174"></a><span>            </span><a href="Pos.Block.Network.Logic.html#MhrrBlockAdopted"><span class="hs-identifier hs-var">MhrrBlockAdopted</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-175"></a><span>                </span><span class="hs-comment">-- How did we even got into recovery then?</span><span>
</span><a name="line-176"></a><span>                </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Block.Network.Logic.html#DialogUnexpected"><span class="hs-identifier hs-var">DialogUnexpected</span></a><span> </span><span class="hs-string">&quot;handleRecovery: got MhrrBlockAdopted&quot;</span><span>
</span><a name="line-177"></a><span>            </span><a href="Pos.Block.Network.Logic.html#MhrrWithCheckpoints"><span class="hs-identifier hs-var">MhrrWithCheckpoints</span></a><span> </span><a name="local-6989586621681353714"><a href="#local-6989586621681353714"><span class="hs-identifier">mgh</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-178"></a><span>                </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;handleRecovery: asking for headers&quot;</span><span>
</span><a name="line-179"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681353715"><a href="#local-6989586621681353715"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681353716"><a href="#local-6989586621681353716"><span class="hs-identifier">headers</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NewestFirst</span><span> </span><span class="hs-identifier hs-type">NE</span><span> </span><span class="hs-special">(</span><a href="Pos.Block.Core.Union.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a><span> </span><a href="#local-6989586621681353671"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-180"></a><span>                        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681353717"><a href="#local-6989586621681353717"><span class="hs-identifier">oldestHeader</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681353716"><span class="hs-identifier hs-var">headers</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">_NewestFirst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_neLast</span><span>
</span><a name="line-181"></a><span>                            </span><a name="local-6989586621681353718"><a href="#local-6989586621681353718"><span class="hs-identifier">newestHeader</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681353716"><span class="hs-identifier hs-var">headers</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">_NewestFirst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_neHead</span><span>
</span><a name="line-182"></a><span>                        </span><span class="hs-keyword">in</span><span> </span><a href="Pos.Block.Network.Retrieval.html#handleCHsValid"><span class="hs-identifier hs-var">handleCHsValid</span></a><span> </span><a href="#local-6989586621681353681"><span class="hs-identifier hs-var">enqueueMsg</span></a><span> </span><a href="#local-6989586621681353712"><span class="hs-identifier hs-var">nodeId</span></a><span>
</span><a name="line-183"></a><span>                                          </span><a href="#local-6989586621681353717"><span class="hs-identifier hs-var">oldestHeader</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353718"><span class="hs-identifier hs-var">newestHeader</span></a><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>                </span><span class="hs-comment">-- If it returns w/o exception then we're:</span><span>
</span><a name="line-185"></a><span>                </span><span class="hs-comment">--  * Either still in recovery mode</span><span>
</span><a name="line-186"></a><span>                </span><span class="hs-comment">--  * Or just exited it and recoverVar was taken.</span><span>
</span><a name="line-187"></a><span>                </span><a href="Pos.Block.Network.Retrieval.html#enqueueMsgSingle"><span class="hs-identifier hs-var">enqueueMsgSingle</span></a><span>
</span><a name="line-188"></a><span>                    </span><a href="#local-6989586621681353681"><span class="hs-identifier hs-var">enqueueMsg</span></a><span>
</span><a name="line-189"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MsgRequestBlockHeaders</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">singleton</span><span> </span><a href="#local-6989586621681353712"><span class="hs-identifier hs-var">nodeId</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Conversation</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Block.Network.Logic.html#requestHeaders"><span class="hs-identifier hs-var">requestHeaders</span></a><span> </span><a href="#local-6989586621681353715"><span class="hs-identifier hs-var">cont</span></a><span> </span><a href="#local-6989586621681353714"><span class="hs-identifier hs-var">mgh</span></a><span> </span><a href="#local-6989586621681353712"><span class="hs-identifier hs-var">nodeId</span></a><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-comment">-- | Result of attempt to update recovery header.</span><span>
</span><a name="line-193"></a><span class="hs-keyword">data</span><span> </span><a name="UpdateRecoveryResult"><a href="Pos.Block.Network.Retrieval.html#UpdateRecoveryResult"><span class="hs-identifier">UpdateRecoveryResult</span></a></a><span> </span><a name="local-6989586621681353640"><a href="#local-6989586621681353640"><span class="hs-identifier">ssc</span></a></a><span>
</span><a name="line-194"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="RecoveryStarted"><a href="Pos.Block.Network.Retrieval.html#RecoveryStarted"><span class="hs-identifier">RecoveryStarted</span></a></a><span> </span><span class="hs-identifier hs-type">NodeId</span><span> </span><span class="hs-special">(</span><a href="Pos.Block.Core.Union.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a><span> </span><a href="#local-6989586621681353640"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>      </span><span class="hs-comment">-- ^ Recovery header was absent, so we've set it.</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="RecoveryShifted"><a href="Pos.Block.Network.Retrieval.html#RecoveryShifted"><span class="hs-identifier">RecoveryShifted</span></a></a><span> </span><span class="hs-identifier hs-type">NodeId</span><span> </span><span class="hs-special">(</span><a href="Pos.Block.Core.Union.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a><span> </span><a href="#local-6989586621681353640"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span> </span><span class="hs-special">(</span><a href="Pos.Block.Core.Union.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a><span> </span><a href="#local-6989586621681353640"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>      </span><span class="hs-comment">-- ^ Header was present, but we've replaced it with another</span><span>
</span><a name="line-198"></a><span>      </span><span class="hs-comment">-- (more difficult) one.</span><span>
</span><a name="line-199"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="RecoveryContinued"><a href="Pos.Block.Network.Retrieval.html#RecoveryContinued"><span class="hs-identifier">RecoveryContinued</span></a></a><span> </span><span class="hs-identifier hs-type">NodeId</span><span> </span><span class="hs-special">(</span><a href="Pos.Block.Core.Union.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a><span> </span><a href="#local-6989586621681353640"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>      </span><span class="hs-comment">-- ^ Header is good, but is irrelevant, so recovery variable is</span><span>
</span><a name="line-201"></a><span>      </span><span class="hs-comment">-- unchanged.</span><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span class="hs-comment">-- | Be careful to run this in the same thread that ends recovery mode</span><span>
</span><a name="line-204"></a><span class="hs-comment">-- (or synchronise those threads with an MVar), otherwise a race</span><span>
</span><a name="line-205"></a><span class="hs-comment">-- condition can occur where we are caught in the recovery mode</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- indefinitely.</span><span>
</span><a name="line-207"></a><span class="hs-identifier">updateRecoveryHeader</span><span>
</span><a name="line-208"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Pos.WorkMode.Class.html#WorkMode"><span class="hs-identifier hs-type">WorkMode</span></a><span> </span><a href="#local-6989586621681353668"><span class="hs-identifier hs-type">ssc</span></a><span> </span><a href="#local-6989586621681353669"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681353670"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-209"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span>
</span><a name="line-210"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Block.Core.Union.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a><span> </span><a href="#local-6989586621681353668"><span class="hs-identifier hs-type">ssc</span></a><span>
</span><a name="line-211"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681353670"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><a name="updateRecoveryHeader"><a href="Pos.Block.Network.Retrieval.html#updateRecoveryHeader"><span class="hs-identifier">updateRecoveryHeader</span></a></a><span> </span><a name="local-6989586621681353719"><a href="#local-6989586621681353719"><span class="hs-identifier">nodeId</span></a></a><span> </span><a name="local-6989586621681353720"><a href="#local-6989586621681353720"><span class="hs-identifier">hdr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-213"></a><span>    </span><a name="local-6989586621681353721"><a href="#local-6989586621681353721"><span class="hs-identifier">recHeaderVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">view</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lensOf</span><span> </span><span class="hs-glyph">@</span><a href="Pos.Context.Context.html#RecoveryHeaderTag"><span class="hs-identifier hs-type">RecoveryHeaderTag</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>    </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;Updating recovery header...&quot;</span><span>
</span><a name="line-215"></a><span>    </span><a name="local-6989586621681353726"><a href="#local-6989586621681353726"><span class="hs-identifier">updated</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-216"></a><span>        </span><a name="local-6989586621681353722"><a href="#local-6989586621681353722"><span class="hs-identifier">mbRecHeader</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryReadTMVar</span><span> </span><a href="#local-6989586621681353721"><span class="hs-identifier hs-var">recHeaderVar</span></a><span>
</span><a name="line-217"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681353722"><span class="hs-identifier hs-var">mbRecHeader</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-218"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-219"></a><span>                </span><span class="hs-identifier hs-var">putTMVar</span><span> </span><a href="#local-6989586621681353721"><span class="hs-identifier hs-var">recHeaderVar</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353719"><span class="hs-identifier hs-var">nodeId</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681353720"><span class="hs-identifier hs-var">hdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Block.Network.Retrieval.html#RecoveryStarted"><span class="hs-identifier hs-var">RecoveryStarted</span></a><span> </span><a href="#local-6989586621681353719"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><a href="#local-6989586621681353720"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-221"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681353723"><a href="#local-6989586621681353723"><span class="hs-identifier">oldNodeId</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681353724"><a href="#local-6989586621681353724"><span class="hs-identifier">oldHdr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-222"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681353725"><a href="#local-6989586621681353725"><span class="hs-identifier">needUpdate</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681353720"><span class="hs-identifier hs-var">hdr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isMoreDifficult</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681353724"><span class="hs-identifier hs-var">oldHdr</span></a><span>
</span><a name="line-223"></a><span>                </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681353725"><span class="hs-identifier hs-var">needUpdate</span></a><span>
</span><a name="line-224"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">swapTMVar</span><span> </span><a href="#local-6989586621681353721"><span class="hs-identifier hs-var">recHeaderVar</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353719"><span class="hs-identifier hs-var">nodeId</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681353720"><span class="hs-identifier hs-var">hdr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$&gt;</span><span>
</span><a name="line-225"></a><span>                         </span><a href="Pos.Block.Network.Retrieval.html#RecoveryShifted"><span class="hs-identifier hs-var">RecoveryShifted</span></a><span> </span><a href="#local-6989586621681353723"><span class="hs-identifier hs-var">oldNodeId</span></a><span> </span><a href="#local-6989586621681353724"><span class="hs-identifier hs-var">oldHdr</span></a><span> </span><a href="#local-6989586621681353719"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><a href="#local-6989586621681353720"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-226"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Block.Network.Retrieval.html#RecoveryContinued"><span class="hs-identifier hs-var">RecoveryContinued</span></a><span> </span><a href="#local-6989586621681353723"><span class="hs-identifier hs-var">oldNodeId</span></a><span> </span><a href="#local-6989586621681353724"><span class="hs-identifier hs-var">oldHdr</span></a><span>
</span><a name="line-227"></a><span>    </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681353726"><span class="hs-identifier hs-var">updated</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-228"></a><span>        </span><a href="Pos.Block.Network.Retrieval.html#RecoveryStarted"><span class="hs-identifier hs-var">RecoveryStarted</span></a><span> </span><a name="local-6989586621681353727"><a href="#local-6989586621681353727"><span class="hs-identifier">rNodeId</span></a></a><span> </span><a name="local-6989586621681353728"><a href="#local-6989586621681353728"><span class="hs-identifier">rHeader</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">sformat</span><span>
</span><a name="line-229"></a><span>            </span><span class="hs-special">(</span><span class="hs-string">&quot;Recovery started with nodeId=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; and tip=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>            </span><a href="#local-6989586621681353727"><span class="hs-identifier hs-var">rNodeId</span></a><span>
</span><a name="line-231"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353728"><span class="hs-identifier hs-var">rHeader</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>        </span><a href="Pos.Block.Network.Retrieval.html#RecoveryShifted"><span class="hs-identifier hs-var">RecoveryShifted</span></a><span> </span><a name="local-6989586621681353729"><a href="#local-6989586621681353729"><span class="hs-identifier">rNodeId'</span></a></a><span> </span><a name="local-6989586621681353730"><a href="#local-6989586621681353730"><span class="hs-identifier">rHeader'</span></a></a><span> </span><a name="local-6989586621681353731"><a href="#local-6989586621681353731"><span class="hs-identifier">rNodeId</span></a></a><span> </span><a name="local-6989586621681353732"><a href="#local-6989586621681353732"><span class="hs-identifier">rHeader</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">sformat</span><span>
</span><a name="line-233"></a><span>            </span><span class="hs-special">(</span><span class="hs-string">&quot;Recovery shifted from nodeId=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; and tip=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span>
</span><a name="line-234"></a><span>             </span><span class="hs-string">&quot; to nodeId=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; and tip=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>            </span><a href="#local-6989586621681353729"><span class="hs-identifier hs-var">rNodeId'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353730"><span class="hs-identifier hs-var">rHeader'</span></a><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>            </span><a href="#local-6989586621681353731"><span class="hs-identifier hs-var">rNodeId</span></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353732"><span class="hs-identifier hs-var">rHeader</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>        </span><a href="Pos.Block.Network.Retrieval.html#RecoveryContinued"><span class="hs-identifier hs-var">RecoveryContinued</span></a><span> </span><a name="local-6989586621681353733"><a href="#local-6989586621681353733"><span class="hs-identifier">rNodeId</span></a></a><span> </span><a name="local-6989586621681353734"><a href="#local-6989586621681353734"><span class="hs-identifier">rHeader</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">sformat</span><span>
</span><a name="line-238"></a><span>            </span><span class="hs-special">(</span><span class="hs-string">&quot;Recovery continued with nodeId=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; and tip=&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>            </span><a href="#local-6989586621681353733"><span class="hs-identifier hs-var">rNodeId</span></a><span>
</span><a name="line-240"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353734"><span class="hs-identifier hs-var">rHeader</span></a><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span class="hs-identifier">dropUpdateHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.WorkMode.Class.html#WorkMode"><span class="hs-identifier hs-type">WorkMode</span></a><span> </span><a href="#local-6989586621681353665"><span class="hs-identifier hs-type">ssc</span></a><span> </span><a href="#local-6989586621681353666"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681353667"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621681353667"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-243"></a><a name="dropUpdateHeader"><a href="Pos.Block.Network.Retrieval.html#dropUpdateHeader"><span class="hs-identifier">dropUpdateHeader</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-244"></a><span>    </span><a name="local-6989586621681353735"><a href="#local-6989586621681353735"><span class="hs-identifier">progressHeaderVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">view</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lensOf</span><span> </span><span class="hs-glyph">@</span><a href="Pos.Context.Context.html#ProgressHeaderTag"><span class="hs-identifier hs-type">ProgressHeaderTag</span></a><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>    </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tryTakeTMVar</span><span> </span><a href="#local-6989586621681353735"><span class="hs-identifier hs-var">progressHeaderVar</span></a><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span class="hs-comment">-- | The returned 'Bool' signifies whether given peer was kicked and recovery</span><span>
</span><a name="line-248"></a><span class="hs-comment">-- was stopped.</span><span>
</span><a name="line-249"></a><span class="hs-comment">--</span><span>
</span><a name="line-250"></a><span class="hs-comment">-- NB. The reason @nodeId@ is passed is that we want to avoid a race</span><span>
</span><a name="line-251"></a><span class="hs-comment">-- condition. If you work with peer P and header H, after failure you want to</span><span>
</span><a name="line-252"></a><span class="hs-comment">-- drop communication with P; however, if at the same time a new block</span><span>
</span><a name="line-253"></a><span class="hs-comment">-- arrives and another thread replaces peer and header to (P2, H2), you want</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- to continue working with P2 and ignore the exception that happened with P.</span><span>
</span><a name="line-255"></a><span class="hs-comment">-- So, @nodeId@ is used to check that the peer wasn't replaced mid-execution.</span><span>
</span><a name="line-256"></a><span class="hs-identifier">dropRecoveryHeader</span><span>
</span><a name="line-257"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Pos.WorkMode.Class.html#WorkMode"><span class="hs-identifier hs-type">WorkMode</span></a><span> </span><a href="#local-6989586621681353662"><span class="hs-identifier hs-type">ssc</span></a><span> </span><a href="#local-6989586621681353663"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681353664"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-258"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span>
</span><a name="line-259"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681353664"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-260"></a><a name="dropRecoveryHeader"><a href="Pos.Block.Network.Retrieval.html#dropRecoveryHeader"><span class="hs-identifier">dropRecoveryHeader</span></a></a><span> </span><a name="local-6989586621681353736"><a href="#local-6989586621681353736"><span class="hs-identifier">nodeId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-261"></a><span>    </span><a name="local-6989586621681353737"><a href="#local-6989586621681353737"><span class="hs-identifier">recHeaderVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">view</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lensOf</span><span> </span><span class="hs-glyph">@</span><a href="Pos.Context.Context.html#RecoveryHeaderTag"><span class="hs-identifier hs-type">RecoveryHeaderTag</span></a><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681353741"><a href="#local-6989586621681353741"><span class="hs-identifier">kicked</span></a></a><span class="hs-special">,</span><a name="local-6989586621681353742"><a href="#local-6989586621681353742"><span class="hs-identifier">realPeer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-263"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681353738"><a href="#local-6989586621681353738"><span class="hs-identifier">processKick</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681353739"><a href="#local-6989586621681353739"><span class="hs-identifier">peer</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-264"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681353740"><a href="#local-6989586621681353740"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681353739"><span class="hs-identifier hs-var">peer</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621681353736"><span class="hs-identifier hs-var">nodeId</span></a><span>
</span><a name="line-265"></a><span>                </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681353740"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tryTakeTMVar</span><span> </span><a href="#local-6989586621681353737"><span class="hs-identifier hs-var">recHeaderVar</span></a><span>
</span><a name="line-266"></a><span>                </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353740"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681353739"><span class="hs-identifier hs-var">peer</span></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>        </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353738"><span class="hs-identifier hs-var">processKick</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">tryReadTMVar</span><span> </span><a href="#local-6989586621681353737"><span class="hs-identifier hs-var">recHeaderVar</span></a><span>
</span><a name="line-268"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681353741"><span class="hs-identifier hs-var">kicked</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">logWarning</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-269"></a><span>        </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Recovery mode communication dropped with peer &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353736"><span class="hs-identifier hs-var">nodeId</span></a><span>
</span><a name="line-270"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621681353741"><span class="hs-identifier hs-var">kicked</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-271"></a><span>        </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Recovery mode wasn't disabled: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-272"></a><span>                   </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-string">&quot;noth&quot;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681353742"><span class="hs-identifier hs-var">realPeer</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot; vs &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681353736"><span class="hs-identifier hs-var">nodeId</span></a><span>
</span><a name="line-273"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621681353741"><span class="hs-identifier hs-var">kicked</span></a><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span class="hs-comment">-- | Drops the recovery header and, if it was successful, queries the tips.</span><span>
</span><a name="line-276"></a><span class="hs-identifier">dropRecoveryHeaderAndRepeat</span><span>
</span><a name="line-277"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscWorkersClass</span><span> </span><a href="#local-6989586621681353659"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">,</span><span> </span><a href="Pos.WorkMode.Class.html#WorkMode"><span class="hs-identifier hs-type">WorkMode</span></a><span> </span><a href="#local-6989586621681353659"><span class="hs-identifier hs-type">ssc</span></a><span> </span><a href="#local-6989586621681353660"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681353661"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-278"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">EnqueueMsg</span><span> </span><a href="#local-6989586621681353661"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681353661"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-279"></a><a name="dropRecoveryHeaderAndRepeat"><a href="Pos.Block.Network.Retrieval.html#dropRecoveryHeaderAndRepeat"><span class="hs-identifier">dropRecoveryHeaderAndRepeat</span></a></a><span> </span><a name="local-6989586621681353743"><a href="#local-6989586621681353743"><span class="hs-identifier">enqueue</span></a></a><span> </span><a name="local-6989586621681353744"><a href="#local-6989586621681353744"><span class="hs-identifier">nodeId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-280"></a><span>    </span><a name="local-6989586621681353747"><a href="#local-6989586621681353747"><span class="hs-identifier">kicked</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Block.Network.Retrieval.html#dropRecoveryHeader"><span class="hs-identifier hs-var">dropRecoveryHeader</span></a><span> </span><a href="#local-6989586621681353744"><span class="hs-identifier hs-var">nodeId</span></a><span>
</span><a name="line-281"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681353747"><span class="hs-identifier hs-var">kicked</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681353745"><span class="hs-identifier hs-var">attemptRestartRecovery</span></a><span>
</span><a name="line-282"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-283"></a><span>    </span><a name="local-6989586621681353745"><a href="#local-6989586621681353745"><span class="hs-identifier">attemptRestartRecovery</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-284"></a><span>        </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;Attempting to restart recovery&quot;</span><span>
</span><a name="line-285"></a><span>        </span><span class="hs-identifier hs-var">delay</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sec</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-286"></a><span>        </span><span class="hs-identifier hs-var">handleAll</span><span> </span><a href="#local-6989586621681353746"><span class="hs-identifier hs-var">handleRecoveryTriggerE</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Block.Network.Logic.html#triggerRecovery"><span class="hs-identifier hs-var">triggerRecovery</span></a><span> </span><a href="#local-6989586621681353743"><span class="hs-identifier hs-var">enqueue</span></a><span>
</span><a name="line-287"></a><span>        </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;Attempting to restart recovery over&quot;</span><span>
</span><a name="line-288"></a><span>    </span><a name="local-6989586621681353746"><a href="#local-6989586621681353746"><span class="hs-identifier">handleRecoveryTriggerE</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-289"></a><span>        </span><span class="hs-comment">-- REPORT:ERROR 'reportOrLogE' somewhere in block retrieval.</span><span>
</span><a name="line-290"></a><span>        </span><span class="hs-identifier hs-var">reportOrLogE</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Exception happened while trying to trigger &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-291"></a><span>                       </span><span class="hs-string">&quot;recovery inside dropRecoveryHeaderAndRepeat: &quot;</span><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-comment">-- | Process header that was thought to be continuation. If it's not</span><span>
</span><a name="line-294"></a><span class="hs-comment">-- now, it is discarded.</span><span>
</span><a name="line-295"></a><span class="hs-identifier">processContHeader</span><span>
</span><a name="line-296"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscWorkersClass</span><span> </span><a href="#local-6989586621681353656"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">,</span><span> </span><a href="Pos.WorkMode.Class.html#WorkMode"><span class="hs-identifier hs-type">WorkMode</span></a><span> </span><a href="#local-6989586621681353656"><span class="hs-identifier hs-type">ssc</span></a><span> </span><a href="#local-6989586621681353657"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681353658"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">EnqueueMsg</span><span> </span><a href="#local-6989586621681353658"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-298"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span>
</span><a name="line-299"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Block.Core.Union.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a><span> </span><a href="#local-6989586621681353656"><span class="hs-identifier hs-type">ssc</span></a><span>
</span><a name="line-300"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681353658"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-301"></a><a name="processContHeader"><a href="Pos.Block.Network.Retrieval.html#processContHeader"><span class="hs-identifier">processContHeader</span></a></a><span> </span><a name="local-6989586621681353748"><a href="#local-6989586621681353748"><span class="hs-identifier">enqueue</span></a></a><span> </span><a name="local-6989586621681353749"><a href="#local-6989586621681353749"><span class="hs-identifier">nodeId</span></a></a><span> </span><a name="local-6989586621681353750"><a href="#local-6989586621681353750"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-302"></a><span>    </span><a name="local-6989586621681353751"><a href="#local-6989586621681353751"><span class="hs-identifier">classificationRes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Block.Logic.Header.html#classifyNewHeader"><span class="hs-identifier hs-var">classifyNewHeader</span></a><span> </span><a href="#local-6989586621681353750"><span class="hs-identifier hs-var">header</span></a><span>
</span><a name="line-303"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681353751"><span class="hs-identifier hs-var">classificationRes</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-304"></a><span>        </span><a href="Pos.Block.Logic.Header.html#CHContinues"><span class="hs-identifier hs-var">CHContinues</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Block.Network.Retrieval.html#handleCHsValid"><span class="hs-identifier hs-var">handleCHsValid</span></a><span> </span><a href="#local-6989586621681353748"><span class="hs-identifier hs-var">enqueue</span></a><span> </span><a href="#local-6989586621681353749"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><a href="#local-6989586621681353750"><span class="hs-identifier hs-var">header</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353750"><span class="hs-identifier hs-var">header</span></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>        </span><a name="local-6989586621681353752"><a href="#local-6989586621681353752"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-306"></a><span>            </span><span class="hs-string">&quot;processContHeader: expected header to &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-307"></a><span>             </span><span class="hs-string">&quot;be continuation, but it's &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681353752"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span class="hs-comment">-- Returns only if blocks were successfully downloaded and</span><span>
</span><a name="line-310"></a><span class="hs-comment">-- processed. Throws exception if something goes wrong.</span><span>
</span><a name="line-311"></a><span class="hs-identifier">handleCHsValid</span><span>
</span><a name="line-312"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621681353653"><a href="#local-6989586621681353653"><span class="hs-identifier">ssc</span></a></a><span> </span><a name="local-6989586621681353654"><a href="#local-6989586621681353654"><span class="hs-identifier">ctx</span></a></a><span> </span><a name="local-6989586621681353655"><a href="#local-6989586621681353655"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-313"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscWorkersClass</span><span> </span><a href="#local-6989586621681353653"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">,</span><span> </span><a href="Pos.WorkMode.Class.html#WorkMode"><span class="hs-identifier hs-type">WorkMode</span></a><span> </span><a href="#local-6989586621681353653"><span class="hs-identifier hs-type">ssc</span></a><span> </span><a href="#local-6989586621681353654"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681353655"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">EnqueueMsg</span><span> </span><a href="#local-6989586621681353655"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-315"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span>
</span><a name="line-316"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Block.Core.Union.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a><span> </span><a href="#local-6989586621681353653"><span class="hs-identifier hs-type">ssc</span></a><span>
</span><a name="line-317"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HeaderHash</span><span>
</span><a name="line-318"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681353655"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-319"></a><a name="handleCHsValid"><a href="Pos.Block.Network.Retrieval.html#handleCHsValid"><span class="hs-identifier">handleCHsValid</span></a></a><span> </span><a name="local-6989586621681353753"><a href="#local-6989586621681353753"><span class="hs-identifier">enqueue</span></a></a><span> </span><a name="local-6989586621681353754"><a href="#local-6989586621681353754"><span class="hs-identifier">nodeId</span></a></a><span> </span><a name="local-6989586621681353755"><a href="#local-6989586621681353755"><span class="hs-identifier">lcaChild</span></a></a><span> </span><a name="local-6989586621681353756"><a href="#local-6989586621681353756"><span class="hs-identifier">newestHash</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-320"></a><span>    </span><span class="hs-comment">-- The conversation will attempt to retrieve the necessary blocks and apply</span><span>
</span><a name="line-321"></a><span>    </span><span class="hs-comment">-- them. Each one gives a 'Bool' where 'True' means that a recovery was</span><span>
</span><a name="line-322"></a><span>    </span><span class="hs-comment">-- completed (depends upon the state of the recovery-mode TMVar).</span><span>
</span><a name="line-323"></a><span>    </span><a href="Pos.Block.Network.Retrieval.html#enqueueMsgSingle"><span class="hs-identifier hs-var">enqueueMsgSingle</span></a><span> </span><a href="#local-6989586621681353753"><span class="hs-identifier hs-var">enqueue</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MsgRequestBlocks</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">singleton</span><span> </span><a href="#local-6989586621681353754"><span class="hs-identifier hs-var">nodeId</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Conversation</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-324"></a><span>      </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621681353757"><a href="#local-6989586621681353757"><span class="hs-identifier">conv</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ConversationActions</span><span> </span><a href="Pos.Block.Network.Types.html#MsgGetBlocks"><span class="hs-identifier hs-type">MsgGetBlocks</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Block.Network.Types.html#MsgBlock"><span class="hs-identifier hs-type">MsgBlock</span></a><span> </span><a href="#local-6989586621681353653"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353655"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-325"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681353758"><a href="#local-6989586621681353758"><span class="hs-identifier">lcaChildHash</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353755"><span class="hs-identifier hs-var">lcaChild</span></a><span>
</span><a name="line-326"></a><span>        </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Requesting blocks from &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shortHashF</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; to &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shortHashF</span><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>                           </span><a href="#local-6989586621681353758"><span class="hs-identifier hs-var">lcaChildHash</span></a><span>
</span><a name="line-328"></a><span>                           </span><a href="#local-6989586621681353756"><span class="hs-identifier hs-var">newestHash</span></a><span>
</span><a name="line-329"></a><span>        </span><span class="hs-identifier">send</span><span> </span><a href="#local-6989586621681353757"><span class="hs-identifier hs-var">conv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Block.Network.Logic.html#mkBlocksRequest"><span class="hs-identifier hs-var">mkBlocksRequest</span></a><span> </span><a href="#local-6989586621681353758"><span class="hs-identifier hs-var">lcaChildHash</span></a><span> </span><a href="#local-6989586621681353756"><span class="hs-identifier hs-var">newestHash</span></a><span>
</span><a name="line-330"></a><span>        </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;Requested blocks, waiting for the response&quot;</span><span>
</span><a name="line-331"></a><span>        </span><a name="local-6989586621681353759"><a href="#local-6989586621681353759"><span class="hs-identifier">chainE</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">runExceptT</span><span> </span><span class="hs-special">(</span><a href="Pos.Block.Network.Retrieval.html#retrieveBlocks"><span class="hs-identifier hs-var">retrieveBlocks</span></a><span> </span><a href="#local-6989586621681353757"><span class="hs-identifier hs-var">conv</span></a><span> </span><a href="#local-6989586621681353755"><span class="hs-identifier hs-var">lcaChild</span></a><span> </span><a href="#local-6989586621681353756"><span class="hs-identifier hs-var">newestHash</span></a><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>        </span><a name="local-6989586621681353760"><a href="#local-6989586621681353760"><span class="hs-identifier">recHeaderVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">view</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lensOf</span><span> </span><span class="hs-glyph">@</span><a href="Pos.Context.Context.html#RecoveryHeaderTag"><span class="hs-identifier hs-type">RecoveryHeaderTag</span></a><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681353759"><span class="hs-identifier hs-var">chainE</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-334"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621681353761"><a href="#local-6989586621681353761"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-335"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681353762"><a href="#local-6989586621681353762"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Error retrieving blocks from &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shortHashF</span><span class="hs-operator hs-var">%</span><span>
</span><a name="line-336"></a><span>                                   </span><span class="hs-string">&quot; to &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shortHashF</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; from peer &quot;</span><span class="hs-operator hs-var">%</span><span>
</span><a name="line-337"></a><span>                                   </span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">stext</span><span class="hs-special">)</span><span>
</span><a name="line-338"></a><span>                                  </span><a href="#local-6989586621681353758"><span class="hs-identifier hs-var">lcaChildHash</span></a><span> </span><a href="#local-6989586621681353756"><span class="hs-identifier hs-var">newestHash</span></a><span> </span><a href="#local-6989586621681353754"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><a href="#local-6989586621681353761"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-339"></a><span>                </span><span class="hs-identifier hs-var">logWarning</span><span> </span><a href="#local-6989586621681353762"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-340"></a><span>                </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Block.Network.Logic.html#DialogUnexpected"><span class="hs-identifier hs-var">DialogUnexpected</span></a><span> </span><a href="#local-6989586621681353762"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-341"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681353763"><a href="#local-6989586621681353763"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-342"></a><span>                </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span>
</span><a name="line-343"></a><span>                    </span><span class="hs-special">(</span><span class="hs-string">&quot;Retrieved &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">int</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; blocks of total size &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">builder</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">listJson</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>                    </span><span class="hs-special">(</span><a href="#local-6989586621681353763"><span class="hs-identifier hs-var">blocks</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">_OldestFirst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">to</span><span> </span><span class="hs-identifier hs-var">NE</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitBuilder</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">biSize</span><span> </span><a href="#local-6989586621681353763"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">headerHash</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">view</span><span> </span><a href="Pos.Block.Core.Union.Misc.html#blockHeader"><span class="hs-identifier hs-var">blockHeader</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353763"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span>                </span><a href="Pos.Block.Network.Logic.html#handleBlocks"><span class="hs-identifier hs-var">handleBlocks</span></a><span> </span><a href="#local-6989586621681353754"><span class="hs-identifier hs-var">nodeId</span></a><span> </span><a href="#local-6989586621681353763"><span class="hs-identifier hs-var">blocks</span></a><span> </span><a href="#local-6989586621681353753"><span class="hs-identifier hs-var">enqueue</span></a><span>
</span><a name="line-348"></a><span>                </span><a href="Pos.Block.Network.Retrieval.html#dropUpdateHeader"><span class="hs-identifier hs-var">dropUpdateHeader</span></a><span>
</span><a name="line-349"></a><span>                </span><span class="hs-comment">-- If we've downloaded any block with bigger</span><span>
</span><a name="line-350"></a><span>                </span><span class="hs-comment">-- difficulty than ncrecoveryheader, we're</span><span>
</span><a name="line-351"></a><span>                </span><span class="hs-comment">-- gracefully exiting recovery mode.</span><span>
</span><a name="line-352"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681353764"><a href="#local-6989586621681353764"><span class="hs-identifier">isMoreDifficultThan</span></a></a><span> </span><a name="local-6989586621681353765"><a href="#local-6989586621681353765"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621681353766"><a href="#local-6989586621681353766"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681353765"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">difficultyL</span><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621681353766"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">difficultyL</span><span>
</span><a name="line-353"></a><span>                </span><a name="local-6989586621681353768"><a href="#local-6989586621681353768"><span class="hs-identifier">exitedRecovery</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tryReadTMVar</span><span> </span><a href="#local-6989586621681353760"><span class="hs-identifier hs-var">recHeaderVar</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-354"></a><span>                    </span><span class="hs-comment">-- We're not in recovery mode? That must be ok.</span><span>
</span><a name="line-355"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-356"></a><span>                    </span><span class="hs-comment">-- If we're in recovery mode we should exit it if</span><span>
</span><a name="line-357"></a><span>                    </span><span class="hs-comment">-- any block is more difficult than one in</span><span>
</span><a name="line-358"></a><span>                    </span><span class="hs-comment">-- recHeader.</span><span>
</span><a name="line-359"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681353767"><a href="#local-6989586621681353767"><span class="hs-identifier">rHeader</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-360"></a><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="#local-6989586621681353764"><span class="hs-identifier hs-var">isMoreDifficultThan</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621681353767"><span class="hs-identifier hs-var">rHeader</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353763"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-361"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">tryTakeTMVar</span><span> </span><a href="#local-6989586621681353760"><span class="hs-identifier hs-var">recHeaderVar</span></a><span>
</span><a name="line-362"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-363"></a><span>                </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681353768"><span class="hs-identifier hs-var">exitedRecovery</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-364"></a><span>                    </span><span class="hs-identifier hs-var">logInfo</span><span> </span><span class="hs-string">&quot;Recovery mode exited gracefully on receiving block we needed&quot;</span><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span class="hs-identifier">retrieveBlocks</span><span>
</span><a name="line-367"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscWorkersClass</span><span> </span><a href="#local-6989586621681353650"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">,</span><span> </span><a href="Pos.WorkMode.Class.html#WorkMode"><span class="hs-identifier hs-type">WorkMode</span></a><span> </span><a href="#local-6989586621681353650"><span class="hs-identifier hs-type">ssc</span></a><span> </span><a href="#local-6989586621681353651"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681353652"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">ConversationActions</span><span> </span><a href="Pos.Block.Network.Types.html#MsgGetBlocks"><span class="hs-identifier hs-type">MsgGetBlocks</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Block.Network.Types.html#MsgBlock"><span class="hs-identifier hs-type">MsgBlock</span></a><span> </span><a href="#local-6989586621681353650"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353652"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-369"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Block.Core.Union.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a><span> </span><a href="#local-6989586621681353650"><span class="hs-identifier hs-type">ssc</span></a><span>
</span><a name="line-370"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HeaderHash</span><span>
</span><a name="line-371"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExceptT</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><a href="#local-6989586621681353652"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OldestFirst</span><span> </span><span class="hs-identifier hs-type">NE</span><span> </span><span class="hs-special">(</span><a href="Pos.Block.Core.Union.Types.html#Block"><span class="hs-identifier hs-type">Block</span></a><span> </span><a href="#local-6989586621681353650"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-372"></a><a name="retrieveBlocks"><a href="Pos.Block.Network.Retrieval.html#retrieveBlocks"><span class="hs-identifier">retrieveBlocks</span></a></a><span> </span><a name="local-6989586621681353769"><a href="#local-6989586621681353769"><span class="hs-identifier">conv</span></a></a><span> </span><a name="local-6989586621681353770"><a href="#local-6989586621681353770"><span class="hs-identifier">lcaChild</span></a></a><span> </span><a name="local-6989586621681353771"><a href="#local-6989586621681353771"><span class="hs-identifier">endH</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-373"></a><span>    </span><a name="local-6989586621681353772"><a href="#local-6989586621681353772"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Block.Network.Retrieval.html#retrieveBlocks%27"><span class="hs-identifier hs-var">retrieveBlocks'</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621681353769"><span class="hs-identifier hs-var">conv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353770"><span class="hs-identifier hs-var">lcaChild</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">prevBlockL</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353771"><span class="hs-identifier hs-var">endH</span></a><span>
</span><a name="line-374"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681353773"><a href="#local-6989586621681353773"><span class="hs-identifier">b0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681353772"><span class="hs-identifier hs-var">blocks</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">_OldestFirst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">_neHead</span><span>
</span><a name="line-375"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353773"><span class="hs-identifier hs-var">b0</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353770"><span class="hs-identifier hs-var">lcaChild</span></a><span>
</span><a name="line-376"></a><span>       </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621681353772"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-377"></a><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span>
</span><a name="line-378"></a><span>                </span><span class="hs-special">(</span><span class="hs-string">&quot;First block of chain is &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span>
</span><a name="line-379"></a><span>                 </span><span class="hs-string">&quot; instead of expected &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>                </span><span class="hs-special">(</span><a href="#local-6989586621681353773"><span class="hs-identifier hs-var">b0</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Pos.Block.Core.Union.Misc.html#blockHeader"><span class="hs-identifier hs-var">blockHeader</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353770"><span class="hs-identifier hs-var">lcaChild</span></a><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-identifier">retrieveBlocks'</span><span>
</span><a name="line-384"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscWorkersClass</span><span> </span><a href="#local-6989586621681353647"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">,</span><span> </span><a href="Pos.WorkMode.Class.html#WorkMode"><span class="hs-identifier hs-type">WorkMode</span></a><span> </span><a href="#local-6989586621681353647"><span class="hs-identifier hs-type">ssc</span></a><span> </span><a href="#local-6989586621681353648"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681353649"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-385"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>        </span><span class="hs-comment">-- ^ Index of block we're requesting</span><span>
</span><a name="line-386"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConversationActions</span><span> </span><a href="Pos.Block.Network.Types.html#MsgGetBlocks"><span class="hs-identifier hs-type">MsgGetBlocks</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Block.Network.Types.html#MsgBlock"><span class="hs-identifier hs-type">MsgBlock</span></a><span> </span><a href="#local-6989586621681353647"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353649"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-387"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HeaderHash</span><span> </span><span class="hs-comment">-- ^ We're expecting a child of this block</span><span>
</span><a name="line-388"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HeaderHash</span><span> </span><span class="hs-comment">-- ^ Block at which to stop</span><span>
</span><a name="line-389"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExceptT</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><a href="#local-6989586621681353649"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OldestFirst</span><span> </span><span class="hs-identifier hs-type">NE</span><span> </span><span class="hs-special">(</span><a href="Pos.Block.Core.Union.Types.html#Block"><span class="hs-identifier hs-type">Block</span></a><span> </span><a href="#local-6989586621681353647"><span class="hs-identifier hs-type">ssc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-390"></a><a name="retrieveBlocks%27"><a href="Pos.Block.Network.Retrieval.html#retrieveBlocks%27"><span class="hs-identifier">retrieveBlocks'</span></a></a><span> </span><a name="local-6989586621681353774"><a href="#local-6989586621681353774"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621681353775"><a href="#local-6989586621681353775"><span class="hs-identifier">conv</span></a></a><span> </span><a name="local-6989586621681353776"><a href="#local-6989586621681353776"><span class="hs-identifier">prevH</span></a></a><span> </span><a name="local-6989586621681353777"><a href="#local-6989586621681353777"><span class="hs-identifier">endH</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">recvLimited</span><span> </span><a href="#local-6989586621681353775"><span class="hs-identifier hs-var">conv</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-391"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-392"></a><span>        </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Failed to receive block #&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">int</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353774"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-393"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Pos.Block.Network.Types.html#MsgNoBlock"><span class="hs-identifier hs-var">MsgNoBlock</span></a><span> </span><a name="local-6989586621681353778"><a href="#local-6989586621681353778"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-394"></a><span>        </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Server failed to return block #&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">int</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">stext</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353774"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621681353778"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-395"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Pos.Block.Network.Types.html#MsgBlock"><span class="hs-identifier hs-var">MsgBlock</span></a><span> </span><a name="local-6989586621681353779"><a href="#local-6989586621681353779"><span class="hs-identifier">block</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-396"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681353780"><a href="#local-6989586621681353780"><span class="hs-identifier">prevH'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681353779"><span class="hs-identifier hs-var">block</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><span class="hs-identifier hs-var">prevBlockL</span><span>
</span><a name="line-397"></a><span>            </span><a name="local-6989586621681353781"><a href="#local-6989586621681353781"><span class="hs-identifier">curH</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">headerHash</span><span> </span><a href="#local-6989586621681353779"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-398"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353780"><span class="hs-identifier hs-var">prevH'</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621681353776"><span class="hs-identifier hs-var">prevH</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-399"></a><span>            </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span>
</span><a name="line-400"></a><span>                </span><span class="hs-special">(</span><span class="hs-string">&quot;Received block #&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">int</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; with prev hash &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shortHashF</span><span class="hs-operator hs-var">%</span><span>
</span><a name="line-401"></a><span>                 </span><span class="hs-string">&quot; while &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shortHashF</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; was expected: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-special">)</span><span>
</span><a name="line-402"></a><span>                </span><a href="#local-6989586621681353774"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621681353780"><span class="hs-identifier hs-var">prevH'</span></a><span> </span><a href="#local-6989586621681353776"><span class="hs-identifier hs-var">prevH</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353779"><span class="hs-identifier hs-var">block</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Pos.Block.Core.Union.Misc.html#blockHeader"><span class="hs-identifier hs-var">blockHeader</span></a><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>        </span><a name="local-6989586621681353782"><a href="#local-6989586621681353782"><span class="hs-identifier">progressHeaderVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">view</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lensOf</span><span> </span><span class="hs-glyph">@</span><a href="Pos.Context.Context.html#ProgressHeaderTag"><span class="hs-identifier hs-type">ProgressHeaderTag</span></a><span class="hs-special">)</span><span>
</span><a name="line-404"></a><span>        </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tryTakeTMVar</span><span> </span><a href="#local-6989586621681353782"><span class="hs-identifier hs-var">progressHeaderVar</span></a><span>
</span><a name="line-405"></a><span>                        </span><span class="hs-identifier hs-var">putTMVar</span><span> </span><a href="#local-6989586621681353782"><span class="hs-identifier hs-var">progressHeaderVar</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681353779"><span class="hs-identifier hs-var">block</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Pos.Block.Core.Union.Misc.html#blockHeader"><span class="hs-identifier hs-var">blockHeader</span></a><span>
</span><a name="line-406"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681353781"><span class="hs-identifier hs-var">curH</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621681353777"><span class="hs-identifier hs-var">endH</span></a><span>
</span><a name="line-407"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">one</span><span> </span><a href="#local-6989586621681353779"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-408"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">over</span><span> </span><span class="hs-identifier hs-var">_Wrapped</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353779"><span class="hs-identifier hs-var">block</span></a><span> </span><span class="hs-operator hs-var">&lt;|</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pos.Block.Network.Retrieval.html#retrieveBlocks%27"><span class="hs-identifier hs-var">retrieveBlocks'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353774"><span class="hs-identifier hs-var">i</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681353775"><span class="hs-identifier hs-var">conv</span></a><span> </span><a href="#local-6989586621681353781"><span class="hs-identifier hs-var">curH</span></a><span> </span><a href="#local-6989586621681353777"><span class="hs-identifier hs-var">endH</span></a><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-411"></a><span class="hs-comment">-- Networking</span><span>
</span><a name="line-412"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-413"></a><span>
</span><a name="line-414"></a><span class="hs-comment">-- | Expects sending message to exactly one node. Receives result or</span><span>
</span><a name="line-415"></a><span class="hs-comment">-- fails if no result was obtained (no nodes available, timeout, etc).</span><span>
</span><a name="line-416"></a><span class="hs-identifier">enqueueMsgSingle</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-417"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621681353641"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-418"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353642"><span class="hs-identifier hs-type">t2</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353643"><span class="hs-identifier hs-type">t1</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681353644"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><a href="#local-6989586621681353645"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681353641"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681353641"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621681353646"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681353642"><span class="hs-identifier hs-type">t2</span></a><span>
</span><a name="line-420"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681353645"><span class="hs-identifier hs-type">x</span></a><span>
</span><a name="line-421"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681353641"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621681353646"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-422"></a><a name="enqueueMsgSingle"><a href="Pos.Block.Network.Retrieval.html#enqueueMsgSingle"><span class="hs-identifier">enqueueMsgSingle</span></a></a><span> </span><a name="local-6989586621681353783"><a href="#local-6989586621681353783"><span class="hs-identifier">enqueue</span></a></a><span> </span><a name="local-6989586621681353784"><a href="#local-6989586621681353784"><span class="hs-identifier">msg</span></a></a><span> </span><a name="local-6989586621681353785"><a href="#local-6989586621681353785"><span class="hs-identifier">conv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-423"></a><span>    </span><a name="local-6989586621681353786"><a href="#local-6989586621681353786"><span class="hs-identifier">results</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681353783"><span class="hs-identifier hs-var">enqueue</span></a><span> </span><a href="#local-6989586621681353784"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">one</span><span> </span><a href="#local-6989586621681353785"><span class="hs-identifier hs-var">conv</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span>
</span><a name="line-424"></a><span>               </span><span class="hs-identifier hs-var">waitForConversations</span><span>
</span><a name="line-425"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621681353786"><span class="hs-identifier hs-var">results</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-426"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>      </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Block.Network.Logic.html#DialogUnexpected"><span class="hs-identifier hs-var">DialogUnexpected</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-427"></a><span>            </span><span class="hs-string">&quot;enqueueMsgSingle: contacted no peers&quot;</span><span>
</span><a name="line-428"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Block.Network.Logic.html#DialogUnexpected"><span class="hs-identifier hs-var">DialogUnexpected</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-429"></a><span>            </span><span class="hs-string">&quot;enqueueMsgSingle: contacted more than one peers, probably internal error&quot;</span><span>
</span><a name="line-430"></a><span>        </span><span class="hs-special">[</span><a name="local-6989586621681353787"><a href="#local-6989586621681353787"><span class="hs-identifier">x</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621681353787"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-431"></a></pre></body></html>