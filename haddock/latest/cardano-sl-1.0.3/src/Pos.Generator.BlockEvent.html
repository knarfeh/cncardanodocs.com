<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DeriveFoldable #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveFunctor  #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes     #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Generator</span><span class="hs-operator">.</span><span class="hs-identifier">BlockEvent</span><span>
</span><a name="line-6"></a><span>       </span><span class="hs-special">(</span><span>
</span><a name="line-7"></a><span>       </span><span class="hs-comment">-- * Block apply</span><span>
</span><a name="line-8"></a><span>         </span><a href="Pos.Generator.BlockEvent.html#BlockApplyResult"><span class="hs-identifier hs-type">BlockApplyResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-9"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockEventApply%27"><span class="hs-identifier hs-type">BlockEventApply'</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockEventApply"><span class="hs-identifier hs-type">BlockEventApply</span></a><span>
</span><a name="line-11"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#beaInput"><span class="hs-identifier hs-var">beaInput</span></a><span>
</span><a name="line-12"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#beaOutValid"><span class="hs-identifier hs-var">beaOutValid</span></a><span>
</span><a name="line-13"></a><span>       </span><span class="hs-comment">-- * Block rollback</span><span>
</span><a name="line-14"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockRollbackResult"><span class="hs-identifier hs-type">BlockRollbackResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockRollbackFailure"><span class="hs-identifier hs-type">BlockRollbackFailure</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockEventRollback%27"><span class="hs-identifier hs-type">BlockEventRollback'</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockEventRollback"><span class="hs-identifier hs-type">BlockEventRollback</span></a><span>
</span><a name="line-18"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#berInput"><span class="hs-identifier hs-var">berInput</span></a><span>
</span><a name="line-19"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#berOutValid"><span class="hs-identifier hs-var">berOutValid</span></a><span>
</span><a name="line-20"></a><span>       </span><span class="hs-comment">-- * Snapshot management</span><span>
</span><a name="line-21"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#SnapshotId"><span class="hs-identifier hs-type">SnapshotId</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#SnapshotOperation"><span class="hs-identifier hs-type">SnapshotOperation</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#enrichWithSnapshotChecking"><span class="hs-identifier hs-var">enrichWithSnapshotChecking</span></a><span>
</span><a name="line-24"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#CheckCount"><span class="hs-identifier hs-type">CheckCount</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>       </span><span class="hs-comment">-- * Block event sum</span><span>
</span><a name="line-26"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockEvent%27"><span class="hs-identifier hs-type">BlockEvent'</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockEvent"><span class="hs-identifier hs-type">BlockEvent</span></a><span>
</span><a name="line-28"></a><span>       </span><span class="hs-comment">-- * Block scenario</span><span>
</span><a name="line-29"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockScenario%27"><span class="hs-identifier hs-type">BlockScenario'</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockScenario"><span class="hs-identifier hs-type">BlockScenario</span></a><span>
</span><a name="line-31"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#_BlockScenario"><span class="hs-identifier hs-var">_BlockScenario</span></a><span>
</span><a name="line-32"></a><span>       </span><span class="hs-comment">-- * Path</span><span>
</span><a name="line-33"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#PathSegment"><span class="hs-identifier hs-type">PathSegment</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#pathSequence"><span class="hs-identifier hs-var">pathSequence</span></a><span>
</span><a name="line-36"></a><span>       </span><span class="hs-comment">-- * Chance</span><span>
</span><a name="line-37"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#Chance"><span class="hs-identifier hs-type">Chance</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#byChance"><span class="hs-identifier hs-var">byChance</span></a><span>
</span><a name="line-39"></a><span>       </span><span class="hs-comment">-- * Block description</span><span>
</span><a name="line-40"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockDesc"><span class="hs-identifier hs-type">BlockDesc</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>       </span><span class="hs-comment">-- * Generation</span><span>
</span><a name="line-42"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.Block.Mode.html#MonadBlockGen"><span class="hs-identifier hs-type">MonadBlockGen</span></a><span>
</span><a name="line-43"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockEventCount"><span class="hs-identifier hs-type">BlockEventCount</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#genBlocksInStructure"><span class="hs-identifier hs-var">genBlocksInStructure</span></a><span>
</span><a name="line-45"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">folded</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeLenses</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makePrisms</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">to</span><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span>                                                   </span><span class="hs-identifier hs-var">toListOf</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Random</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RandT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Random</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RandomGen</span><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>                                                   </span><span class="hs-identifier hs-var">mapRandT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">weighted</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Short</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SBS</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>                        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">List</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span>                         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Sequence</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Seq</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Buildable</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Formatting</span><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bprint</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">build</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sformat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">shown</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Prelude</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listJson</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.AllSecrets.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">AllSecrets</span></a><span>                   </span><span class="hs-special">(</span><a href="Pos.AllSecrets.html#AllSecrets"><span class="hs-identifier hs-type">AllSecrets</span></a><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Block.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>                  </span><span class="hs-special">(</span><a href="Pos.Block.Types.html#Blund"><span class="hs-identifier hs-type">Blund</span></a><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GenesisWStakeholders</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasConfiguration</span><span class="hs-special">,</span><span>
</span><a name="line-66"></a><span>                                                   </span><span class="hs-identifier hs-type">HeaderHash</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">headerHash</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">prevBlockL</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span><span class="hs-operator">.</span><span class="hs-identifier">Hashing</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hashHexF</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Generator.Block.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Generator</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span></a><span>              </span><span class="hs-special">(</span><a href="Pos.Generator.Block.Param.html#BlockGenParams"><span class="hs-identifier hs-type">BlockGenParams</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.Block.Mode.html#MonadBlockGen"><span class="hs-identifier hs-type">MonadBlockGen</span></a><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>                                                   </span><a href="Pos.Generator.Block.Param.html#TxGenParams"><span class="hs-identifier hs-type">TxGenParams</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.Block.Logic.html#genBlocks"><span class="hs-identifier hs-var">genBlocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.GState.Context.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">GState</span><span class="hs-operator">.</span><span class="hs-identifier">Context</span></a><span>               </span><span class="hs-special">(</span><a href="Pos.GState.Context.html#withClonedGState"><span class="hs-identifier hs-var">withClonedGState</span></a><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">GodTossing</span><span class="hs-operator">.</span><span class="hs-identifier">Configuration</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasGtConfiguration</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">GodTossing</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SscGodTossing</span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Chrono</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NE</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NewestFirst</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OldestFirst</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-74"></a><span>                                                   </span><span class="hs-identifier hs-var">toNewestFirst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toOldestFirst</span><span class="hs-special">,</span><span>
</span><a name="line-75"></a><span>                                                   </span><span class="hs-identifier hs-var">_OldestFirst</span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-keyword">type</span><span> </span><a name="BlundDefault"><a href="Pos.Generator.BlockEvent.html#BlundDefault"><span class="hs-identifier">BlundDefault</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Block.Types.html#Blund"><span class="hs-identifier hs-type">Blund</span></a><span> </span><span class="hs-identifier hs-type">SscGodTossing</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- Blockchain tree</span><span>
</span><a name="line-81"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-comment">-- NB. not a monoid, so the user can be sure that `(&lt;&gt;)` acts as expected</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- on string literals for paths (not path segments).</span><span>
</span><a name="line-85"></a><span class="hs-keyword">newtype</span><span> </span><a name="PathSegment"><a href="Pos.Generator.BlockEvent.html#PathSegment"><span class="hs-identifier">PathSegment</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PathSegment"><a href="Pos.Generator.BlockEvent.html#PathSegment"><span class="hs-identifier">PathSegment</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="pathSegmentByteString"><a href="Pos.Generator.BlockEvent.html#pathSegmentByteString"><span class="hs-identifier">pathSegmentByteString</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SBS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ShortByteString</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-86"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IsString</span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="Pos.Generator.BlockEvent.html#PathSegment"><span class="hs-identifier hs-type">PathSegment</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-89"></a><span>    </span><a name="local-8214565720323790721"><span class="hs-identifier">showsPrec</span></a><span> </span><a name="local-6989586621681879685"><a href="#local-6989586621681879685"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#PathSegment"><span class="hs-identifier hs-var">PathSegment</span></a><span> </span><a name="local-6989586621681879686"><a href="#local-6989586621681879686"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Prelude</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">showsPrec</span><span> </span><a href="#local-6989586621681879685"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681879686"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-comment">-- | Construct a path using string literals and monoidal/semigroupoidal</span><span>
</span><a name="line-92"></a><span class="hs-comment">--   operations: @&quot;first&quot; &lt;&gt; &quot;next&quot;@, @stimes 15 &quot;next&quot;@.</span><span>
</span><a name="line-93"></a><span class="hs-comment">--   An empty path does not point at any block, don't use it on its own! (but</span><span>
</span><a name="line-94"></a><span class="hs-comment">--   it's a valid 'mempty')</span><span>
</span><a name="line-95"></a><span class="hs-keyword">newtype</span><span> </span><a name="Path"><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier">Path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Path"><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier">Path</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Seq</span><span> </span><a href="Pos.Generator.BlockEvent.html#PathSegment"><span class="hs-identifier hs-type">PathSegment</span></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">IsString</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-99"></a><span>    </span><a name="local-3458764513820541114"><span class="hs-identifier">fromString</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-var">Path</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Seq</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">singleton</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromString</span><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-102"></a><span>    </span><a name="local-8214565720323814995"><span class="hs-identifier">build</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-var">Path</span></a><span> </span><a name="local-6989586621681879684"><a href="#local-6989586621681879684"><span class="hs-identifier">segs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-identifier hs-var">build</span><span>
</span><a name="line-103"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fold</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">intersperse</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-104"></a><span>            </span><span class="hs-identifier hs-var">decodeUtf8</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">SBS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromShort</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">pathSegmentByteString</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621681879684"><span class="hs-identifier hs-var">segs</span></a><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-comment">-- | Convert a sequence of relative paths into a sequence of absolute paths:</span><span>
</span><a name="line-107"></a><span class="hs-comment">--   @pathSequence &quot;base&quot; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;] = [&quot;base&quot; &lt;&gt; &quot;a&quot;, &quot;base&quot; &lt;&gt; &quot;a&quot; &lt;&gt; &quot;b&quot;, &quot;base&quot; &lt;&gt; &quot;a&quot; &lt;&gt; &quot;b&quot; &lt;&gt; &quot;c&quot;]</span><span>
</span><a name="line-108"></a><span class="hs-identifier">pathSequence</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-109"></a><span>       </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span> </span><span class="hs-comment">-- ^ base path</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OldestFirst</span><span> </span><span class="hs-identifier hs-type">NE</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span> </span><span class="hs-comment">-- ^ relative paths</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OldestFirst</span><span> </span><span class="hs-identifier hs-type">NE</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span> </span><span class="hs-comment">-- ^ absolute paths</span><span>
</span><a name="line-112"></a><a name="pathSequence"><a href="Pos.Generator.BlockEvent.html#pathSequence"><span class="hs-identifier">pathSequence</span></a></a><span> </span><a name="local-6989586621681879498"><a href="#local-6989586621681879498"><span class="hs-identifier">basePath</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">over</span><span> </span><span class="hs-identifier hs-var">_OldestFirst</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-113"></a><span>    </span><span class="hs-comment">-- 'NE.fromList' here is safe because `NE.inits` applied to `NonEmpty` has</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-comment">-- at least two elements (first is [], second is a singleton list), so even</span><span>
</span><a name="line-115"></a><span>    </span><span class="hs-comment">-- after `NE.tail` we've still got a non-empty sequence.</span><span>
</span><a name="line-116"></a><span>    </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mappend</span><span> </span><a href="#local-6989586621681879498"><span class="hs-identifier hs-var">basePath</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">NE</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">NE</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">tail</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">NE</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">inits</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-keyword">type</span><span> </span><a name="BlockchainForest"><a href="Pos.Generator.BlockEvent.html#BlockchainForest"><span class="hs-identifier">BlockchainForest</span></a></a><span> </span><a name="local-6989586621681879482"><a href="#local-6989586621681879482"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Pos.Generator.BlockEvent.html#PathSegment"><span class="hs-identifier hs-type">PathSegment</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#BlockchainTree"><span class="hs-identifier hs-type">BlockchainTree</span></a><span> </span><a href="#local-6989586621681879482"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-keyword">data</span><span> </span><a name="BlockchainTree"><a href="Pos.Generator.BlockEvent.html#BlockchainTree"><span class="hs-identifier">BlockchainTree</span></a></a><span> </span><a name="local-6989586621681879481"><a href="#local-6989586621681879481"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="BlockchainTree"><a href="Pos.Generator.BlockEvent.html#BlockchainTree"><span class="hs-identifier">BlockchainTree</span></a></a><span> </span><a href="#local-6989586621681879481"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#BlockchainForest"><span class="hs-identifier hs-type">BlockchainForest</span></a><span> </span><a href="#local-6989586621681879481"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-keyword">data</span><span> </span><a name="BlockDesc"><a href="Pos.Generator.BlockEvent.html#BlockDesc"><span class="hs-identifier">BlockDesc</span></a></a><span>
</span><a name="line-124"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="BlockDescDefault"><a href="Pos.Generator.BlockEvent.html#BlockDescDefault"><span class="hs-identifier">BlockDescDefault</span></a></a><span> </span><span class="hs-comment">-- a random valid block</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="BlockDescCustom"><a href="Pos.Generator.BlockEvent.html#BlockDescCustom"><span class="hs-identifier">BlockDescCustom</span></a></a><span> </span><a href="Pos.Generator.Block.Param.html#TxGenParams"><span class="hs-identifier hs-type">TxGenParams</span></a><span> </span><span class="hs-comment">-- a random valid block with custom gen params</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-comment">-- Empty input paths are ignored.</span><span>
</span><a name="line-129"></a><span class="hs-identifier">buildBlockchainForest</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621681879497"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681879497"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockchainForest"><span class="hs-identifier hs-type">BlockchainForest</span></a><span> </span><a href="#local-6989586621681879497"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-130"></a><a name="buildBlockchainForest"><a href="Pos.Generator.BlockEvent.html#buildBlockchainForest"><span class="hs-identifier">buildBlockchainForest</span></a></a><span> </span><a name="local-6989586621681879499"><a href="#local-6989586621681879499"><span class="hs-identifier">defElem</span></a></a><span> </span><a name="local-6989586621681879500"><a href="#local-6989586621681879500"><span class="hs-identifier">elements</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-131"></a><span>    </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#buildBlockchainTree"><span class="hs-identifier hs-var">buildBlockchainTree</span></a><span> </span><a href="#local-6989586621681879499"><span class="hs-identifier hs-var">defElem</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681879502"><span class="hs-identifier hs-var">getDList</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromListWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-132"></a><span>        </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-var">Path</span></a><span> </span><a name="local-6989586621681879505"><a href="#local-6989586621681879505"><span class="hs-identifier">path</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681879506"><a href="#local-6989586621681879506"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681879500"><span class="hs-identifier hs-var">elements</span></a><span>
</span><a name="line-133"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Seq</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">viewl</span><span> </span><a href="#local-6989586621681879505"><span class="hs-identifier hs-var">path</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-134"></a><span>            </span><span class="hs-identifier hs-var">Seq</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">EmptyL</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-135"></a><span>            </span><a name="local-6989586621681879507"><a href="#local-6989586621681879507"><span class="hs-identifier">pathSegment</span></a></a><span> </span><span class="hs-identifier hs-var">Seq</span><span class="hs-operator hs-var">.:&lt;</span><span> </span><a name="local-6989586621681879508"><a href="#local-6989586621681879508"><span class="hs-identifier">path'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-136"></a><span>                </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681879507"><span class="hs-identifier hs-var">pathSegment</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681879501"><span class="hs-identifier hs-var">dlistSingleton</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-var">Path</span></a><span> </span><a href="#local-6989586621681879508"><span class="hs-identifier hs-var">path'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681879506"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-137"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-138"></a><span>    </span><a name="local-6989586621681879501"><a href="#local-6989586621681879501"><span class="hs-identifier">dlistSingleton</span></a></a><span> </span><a name="local-6989586621681879503"><a href="#local-6989586621681879503"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Endo</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681879503"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>    </span><a name="local-6989586621681879502"><a href="#local-6989586621681879502"><span class="hs-identifier">getDList</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Endo</span><span> </span><a name="local-6989586621681879504"><a href="#local-6989586621681879504"><span class="hs-identifier">dl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681879504"><span class="hs-identifier hs-var">dl</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-identifier">buildBlockchainTree</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621681879496"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681879496"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockchainTree"><span class="hs-identifier hs-type">BlockchainTree</span></a><span> </span><a href="#local-6989586621681879496"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-142"></a><a name="buildBlockchainTree"><a href="Pos.Generator.BlockEvent.html#buildBlockchainTree"><span class="hs-identifier">buildBlockchainTree</span></a></a><span> </span><a name="local-6989586621681879509"><a href="#local-6989586621681879509"><span class="hs-identifier">defElem</span></a></a><span> </span><a name="local-6989586621681879510"><a href="#local-6989586621681879510"><span class="hs-identifier">elements</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-143"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681879511"><a href="#local-6989586621681879511"><span class="hs-identifier">topElement</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="#local-6989586621681879509"><span class="hs-identifier hs-var">defElem</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">List</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-var">Path</span></a><span> </span><span class="hs-identifier hs-var">Seq</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681879510"><span class="hs-identifier hs-var">elements</span></a><span>
</span><a name="line-144"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockchainTree"><span class="hs-identifier hs-var">BlockchainTree</span></a><span> </span><a href="#local-6989586621681879511"><span class="hs-identifier hs-var">topElement</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#buildBlockchainForest"><span class="hs-identifier hs-var">buildBlockchainForest</span></a><span> </span><a href="#local-6989586621681879509"><span class="hs-identifier hs-var">defElem</span></a><span> </span><a href="#local-6989586621681879510"><span class="hs-identifier hs-var">elements</span></a><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-comment">-- Inverse to 'buildBlockchainForest'.</span><span>
</span><a name="line-147"></a><span class="hs-identifier">flattenBlockchainForest'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockchainForest"><span class="hs-identifier hs-type">BlockchainForest</span></a><span> </span><a href="#local-6989586621681879495"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span> </span><a href="#local-6989586621681879495"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-148"></a><a name="flattenBlockchainForest%27"><a href="Pos.Generator.BlockEvent.html#flattenBlockchainForest%27"><span class="hs-identifier">flattenBlockchainForest'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-149"></a><span>    </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Pos.Generator.BlockEvent.html#flattenBlockchainForest"><span class="hs-identifier hs-var">flattenBlockchainForest</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-var">Path</span></a><span> </span><span class="hs-identifier hs-var">Seq</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span class="hs-special">)</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-identifier">flattenBlockchainForest</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockchainForest"><span class="hs-identifier hs-type">BlockchainForest</span></a><span> </span><a href="#local-6989586621681879494"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681879494"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-152"></a><a name="flattenBlockchainForest"><a href="Pos.Generator.BlockEvent.html#flattenBlockchainForest"><span class="hs-identifier">flattenBlockchainForest</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-var">Path</span></a><span> </span><a name="local-6989586621681879512"><a href="#local-6989586621681879512"><span class="hs-identifier">prePath</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681879513"><a href="#local-6989586621681879513"><span class="hs-identifier">forest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-153"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681879514"><a href="#local-6989586621681879514"><span class="hs-identifier">pathSegment</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681879515"><a href="#local-6989586621681879515"><span class="hs-identifier">subtree</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621681879513"><span class="hs-identifier hs-var">forest</span></a><span>
</span><a name="line-154"></a><span>    </span><a href="Pos.Generator.BlockEvent.html#flattenBlockchainTree"><span class="hs-identifier hs-var">flattenBlockchainTree</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-var">Path</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681879512"><span class="hs-identifier hs-var">prePath</span></a><span> </span><span class="hs-identifier hs-var">Seq</span><span class="hs-operator hs-var">.|&gt;</span><span> </span><a href="#local-6989586621681879514"><span class="hs-identifier hs-var">pathSegment</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681879515"><span class="hs-identifier hs-var">subtree</span></a><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-identifier">flattenBlockchainTree</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockchainTree"><span class="hs-identifier hs-type">BlockchainTree</span></a><span> </span><a href="#local-6989586621681879493"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681879493"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-157"></a><a name="flattenBlockchainTree"><a href="Pos.Generator.BlockEvent.html#flattenBlockchainTree"><span class="hs-identifier">flattenBlockchainTree</span></a></a><span> </span><a name="local-6989586621681879516"><a href="#local-6989586621681879516"><span class="hs-identifier">prePath</span></a></a><span> </span><a name="local-6989586621681879517"><a href="#local-6989586621681879517"><span class="hs-identifier">tree</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-158"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockchainTree"><span class="hs-identifier hs-var">BlockchainTree</span></a><span> </span><a name="local-6989586621681879518"><a href="#local-6989586621681879518"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621681879519"><a href="#local-6989586621681879519"><span class="hs-identifier">forest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681879517"><span class="hs-identifier hs-var">tree</span></a><span>
</span><a name="line-159"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621681879516"><span class="hs-identifier hs-var">prePath</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681879518"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="Pos.Generator.BlockEvent.html#flattenBlockchainForest"><span class="hs-identifier hs-var">flattenBlockchainForest</span></a><span> </span><a href="#local-6989586621681879516"><span class="hs-identifier hs-var">prePath</span></a><span> </span><a href="#local-6989586621681879519"><span class="hs-identifier hs-var">forest</span></a><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span class="hs-identifier">genBlocksInForest</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-162"></a><span>       </span><span class="hs-special">(</span><a href="Pos.Generator.Block.Mode.html#MonadBlockGen"><span class="hs-identifier hs-type">MonadBlockGen</span></a><span> </span><a href="#local-6989586621681879490"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681879491"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RandomGen</span><span> </span><a href="#local-6989586621681879492"><span class="hs-identifier hs-type">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Pos.AllSecrets.html#AllSecrets"><span class="hs-identifier hs-type">AllSecrets</span></a><span>
</span><a name="line-164"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GenesisWStakeholders</span><span>
</span><a name="line-165"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockchainForest"><span class="hs-identifier hs-type">BlockchainForest</span></a><span> </span><a href="Pos.Generator.BlockEvent.html#BlockDesc"><span class="hs-identifier hs-type">BlockDesc</span></a><span>
</span><a name="line-166"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RandT</span><span> </span><a href="#local-6989586621681879492"><span class="hs-identifier hs-type">g</span></a><span> </span><a href="#local-6989586621681879491"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#BlockchainForest"><span class="hs-identifier hs-type">BlockchainForest</span></a><span> </span><a href="Pos.Generator.BlockEvent.html#BlundDefault"><span class="hs-identifier hs-type">BlundDefault</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><a name="genBlocksInForest"><a href="Pos.Generator.BlockEvent.html#genBlocksInForest"><span class="hs-identifier">genBlocksInForest</span></a></a><span> </span><a name="local-6989586621681879520"><a href="#local-6989586621681879520"><span class="hs-identifier">secrets</span></a></a><span> </span><a name="local-6989586621681879521"><a href="#local-6989586621681879521"><span class="hs-identifier">bootStakeholders</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-168"></a><span>    </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapRandT</span><span> </span><a href="Pos.GState.Context.html#withClonedGState"><span class="hs-identifier hs-var">withClonedGState</span></a><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-169"></a><span>    </span><a href="Pos.Generator.BlockEvent.html#genBlocksInTree"><span class="hs-identifier hs-var">genBlocksInTree</span></a><span> </span><a href="#local-6989586621681879520"><span class="hs-identifier hs-var">secrets</span></a><span> </span><a href="#local-6989586621681879521"><span class="hs-identifier hs-var">bootStakeholders</span></a><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-identifier">genBlocksInTree</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-172"></a><span>       </span><span class="hs-special">(</span><a href="Pos.Generator.Block.Mode.html#MonadBlockGen"><span class="hs-identifier hs-type">MonadBlockGen</span></a><span> </span><a href="#local-6989586621681879487"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681879488"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RandomGen</span><span> </span><a href="#local-6989586621681879489"><span class="hs-identifier hs-type">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Pos.AllSecrets.html#AllSecrets"><span class="hs-identifier hs-type">AllSecrets</span></a><span>
</span><a name="line-174"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GenesisWStakeholders</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockchainTree"><span class="hs-identifier hs-type">BlockchainTree</span></a><span> </span><a href="Pos.Generator.BlockEvent.html#BlockDesc"><span class="hs-identifier hs-type">BlockDesc</span></a><span>
</span><a name="line-176"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RandT</span><span> </span><a href="#local-6989586621681879489"><span class="hs-identifier hs-type">g</span></a><span> </span><a href="#local-6989586621681879488"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#BlockchainTree"><span class="hs-identifier hs-type">BlockchainTree</span></a><span> </span><a href="Pos.Generator.BlockEvent.html#BlundDefault"><span class="hs-identifier hs-type">BlundDefault</span></a><span class="hs-special">)</span><span>
</span><a name="line-177"></a><a name="genBlocksInTree"><a href="Pos.Generator.BlockEvent.html#genBlocksInTree"><span class="hs-identifier">genBlocksInTree</span></a></a><span> </span><a name="local-6989586621681879522"><a href="#local-6989586621681879522"><span class="hs-identifier">secrets</span></a></a><span> </span><a name="local-6989586621681879523"><a href="#local-6989586621681879523"><span class="hs-identifier">bootStakeholders</span></a></a><span> </span><a name="local-6989586621681879524"><a href="#local-6989586621681879524"><span class="hs-identifier">blockchainTree</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-178"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-179"></a><span>        </span><a href="Pos.Generator.BlockEvent.html#BlockchainTree"><span class="hs-identifier hs-var">BlockchainTree</span></a><span> </span><a name="local-6989586621681879525"><a href="#local-6989586621681879525"><span class="hs-identifier">blockDesc</span></a></a><span> </span><a name="local-6989586621681879526"><a href="#local-6989586621681879526"><span class="hs-identifier">blockchainForest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681879524"><span class="hs-identifier hs-var">blockchainTree</span></a><span>
</span><a name="line-180"></a><span>        </span><a name="local-6989586621681879527"><a href="#local-6989586621681879527"><span class="hs-identifier">txGenParams</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681879525"><span class="hs-identifier hs-var">blockDesc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-181"></a><span>            </span><a href="Pos.Generator.BlockEvent.html#BlockDescDefault"><span class="hs-identifier hs-var">BlockDescDefault</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Generator.Block.Param.html#TxGenParams"><span class="hs-identifier hs-var">TxGenParams</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-182"></a><span>            </span><a href="Pos.Generator.BlockEvent.html#BlockDescCustom"><span class="hs-identifier hs-var">BlockDescCustom</span></a><span> </span><a name="local-6989586621681879529"><a href="#local-6989586621681879529"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681879529"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-183"></a><span>        </span><a name="local-6989586621681879528"><a href="#local-6989586621681879528"><span class="hs-identifier">blockGenParams</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Generator.Block.Param.html#BlockGenParams"><span class="hs-identifier hs-var">BlockGenParams</span></a><span>
</span><a name="line-184"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_bgpSecrets</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681879522"><span class="hs-identifier hs-var">secrets</span></a><span>
</span><a name="line-185"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_bgpGenStakeholders</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681879523"><span class="hs-identifier hs-var">bootStakeholders</span></a><span>
</span><a name="line-186"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_bgpBlockCount</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-187"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_bgpTxGenParams</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681879527"><span class="hs-identifier hs-var">txGenParams</span></a><span>
</span><a name="line-188"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_bgpInplaceDB</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-189"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_bgpSkipNoKey</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-190"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-comment">-- Partial pattern-matching is safe because we specify</span><span>
</span><a name="line-192"></a><span>    </span><span class="hs-comment">-- blockCount = 1 in the generation parameters.</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-identifier hs-var">OldestFirst</span><span> </span><span class="hs-special">[</span><a name="local-6989586621681879530"><a href="#local-6989586621681879530"><span class="hs-identifier">block</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Generator.Block.Logic.html#genBlocks"><span class="hs-identifier hs-var">genBlocks</span></a><span> </span><a href="#local-6989586621681879528"><span class="hs-identifier hs-var">blockGenParams</span></a><span>
</span><a name="line-194"></a><span>    </span><a name="local-6989586621681879531"><a href="#local-6989586621681879531"><span class="hs-identifier">forestBlocks</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Generator.BlockEvent.html#genBlocksInForest"><span class="hs-identifier hs-var">genBlocksInForest</span></a><span> </span><a href="#local-6989586621681879522"><span class="hs-identifier hs-var">secrets</span></a><span> </span><a href="#local-6989586621681879523"><span class="hs-identifier hs-var">bootStakeholders</span></a><span> </span><a href="#local-6989586621681879526"><span class="hs-identifier hs-var">blockchainForest</span></a><span>
</span><a name="line-195"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockchainTree"><span class="hs-identifier hs-var">BlockchainTree</span></a><span> </span><a href="#local-6989586621681879530"><span class="hs-identifier hs-var">block</span></a><span> </span><a href="#local-6989586621681879531"><span class="hs-identifier hs-var">forestBlocks</span></a><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-comment">-- Precondition: paths in the structure are non-empty.</span><span>
</span><a name="line-198"></a><span class="hs-identifier">genBlocksInStructure</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-199"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Pos.Generator.Block.Mode.html#MonadBlockGen"><span class="hs-identifier hs-type">MonadBlockGen</span></a><span> </span><a href="#local-6989586621681879483"><span class="hs-identifier hs-type">ctx</span></a><span> </span><a href="#local-6989586621681879484"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-200"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621681879485"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621681879485"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-201"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RandomGen</span><span> </span><a href="#local-6989586621681879486"><span class="hs-identifier hs-type">g</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Pos.AllSecrets.html#AllSecrets"><span class="hs-identifier hs-type">AllSecrets</span></a><span>
</span><a name="line-203"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GenesisWStakeholders</span><span>
</span><a name="line-204"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span> </span><a href="Pos.Generator.BlockEvent.html#BlockDesc"><span class="hs-identifier hs-type">BlockDesc</span></a><span>
</span><a name="line-205"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681879485"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span>
</span><a name="line-206"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RandT</span><span> </span><a href="#local-6989586621681879486"><span class="hs-identifier hs-type">g</span></a><span> </span><a href="#local-6989586621681879484"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681879485"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="Pos.Generator.BlockEvent.html#BlundDefault"><span class="hs-identifier hs-type">BlundDefault</span></a><span class="hs-special">)</span><span>
</span><a name="line-207"></a><a name="genBlocksInStructure"><a href="Pos.Generator.BlockEvent.html#genBlocksInStructure"><span class="hs-identifier">genBlocksInStructure</span></a></a><span> </span><a name="local-6989586621681879532"><a href="#local-6989586621681879532"><span class="hs-identifier">secrets</span></a></a><span> </span><a name="local-6989586621681879533"><a href="#local-6989586621681879533"><span class="hs-identifier">bootStakeholders</span></a></a><span> </span><a name="local-6989586621681879534"><a href="#local-6989586621681879534"><span class="hs-identifier">annotations</span></a></a><span> </span><a name="local-6989586621681879535"><a href="#local-6989586621681879535"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-208"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-209"></a><span>        </span><span class="hs-identifier">getAnnotation</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockDesc"><span class="hs-identifier hs-type">BlockDesc</span></a><span>
</span><a name="line-210"></a><span>        </span><a name="local-6989586621681879536"><a href="#local-6989586621681879536"><span class="hs-identifier">getAnnotation</span></a></a><span> </span><a name="local-6989586621681879539"><a href="#local-6989586621681879539"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-211"></a><span>            </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">findWithDefault</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockDescDefault"><span class="hs-identifier hs-var">BlockDescDefault</span></a><span> </span><a href="#local-6989586621681879539"><span class="hs-identifier hs-var">path</span></a><span> </span><a href="#local-6989586621681879534"><span class="hs-identifier hs-var">annotations</span></a><span>
</span><a name="line-212"></a><span>        </span><span class="hs-identifier">paths</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockDesc"><span class="hs-identifier hs-type">BlockDesc</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-213"></a><span>        </span><a name="local-6989586621681879537"><a href="#local-6989586621681879537"><span class="hs-identifier">paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toListOf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">folded</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">to</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681879680"><a href="#local-6989586621681879680"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681879680"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681879536"><span class="hs-identifier hs-var">getAnnotation</span></a><span> </span><a href="#local-6989586621681879680"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681879535"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-214"></a><span>        </span><span class="hs-identifier">descForest</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockchainForest"><span class="hs-identifier hs-type">BlockchainForest</span></a><span> </span><a href="Pos.Generator.BlockEvent.html#BlockDesc"><span class="hs-identifier hs-type">BlockDesc</span></a><span>
</span><a name="line-215"></a><span>        </span><a name="local-6989586621681879538"><a href="#local-6989586621681879538"><span class="hs-identifier">descForest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Generator.BlockEvent.html#buildBlockchainForest"><span class="hs-identifier hs-var">buildBlockchainForest</span></a><span> </span><a href="Pos.Generator.BlockEvent.html#BlockDescDefault"><span class="hs-identifier hs-var">BlockDescDefault</span></a><span> </span><a href="#local-6989586621681879537"><span class="hs-identifier hs-var">paths</span></a><span>
</span><a name="line-216"></a><span>    </span><a name="local-6989586621681879681"><a href="#local-6989586621681879681"><span class="hs-identifier">blockForest</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockchainForest"><span class="hs-identifier hs-type">BlockchainForest</span></a><span> </span><a href="Pos.Generator.BlockEvent.html#BlundDefault"><span class="hs-identifier hs-type">BlundDefault</span></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-217"></a><span>        </span><a href="Pos.Generator.BlockEvent.html#genBlocksInForest"><span class="hs-identifier hs-var">genBlocksInForest</span></a><span> </span><a href="#local-6989586621681879532"><span class="hs-identifier hs-var">secrets</span></a><span> </span><a href="#local-6989586621681879533"><span class="hs-identifier hs-var">bootStakeholders</span></a><span> </span><a href="#local-6989586621681879538"><span class="hs-identifier hs-var">descForest</span></a><span>
</span><a name="line-218"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-219"></a><span>        </span><span class="hs-identifier">getBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlundDefault"><span class="hs-identifier hs-type">BlundDefault</span></a><span>
</span><a name="line-220"></a><span>        </span><a name="local-6989586621681879682"><a href="#local-6989586621681879682"><span class="hs-identifier">getBlock</span></a></a><span> </span><a name="local-6989586621681879683"><a href="#local-6989586621681879683"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">findWithDefault</span><span>
</span><a name="line-221"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;genBlocksInStructure: impossible happened&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>            </span><a href="#local-6989586621681879683"><span class="hs-identifier hs-var">path</span></a><span>
</span><a name="line-223"></a><span>            </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#flattenBlockchainForest%27"><span class="hs-identifier hs-var">flattenBlockchainForest'</span></a><span> </span><a href="#local-6989586621681879681"><span class="hs-identifier hs-var">blockForest</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621681879682"><span class="hs-identifier hs-var">getBlock</span></a><span> </span><a href="#local-6989586621681879535"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-227"></a><span class="hs-comment">-- Block event types</span><span>
</span><a name="line-228"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span class="hs-keyword">data</span><span> </span><a name="BlockApplyResult"><a href="Pos.Generator.BlockEvent.html#BlockApplyResult"><span class="hs-identifier">BlockApplyResult</span></a></a><span>
</span><a name="line-231"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="BlockApplySuccess"><a href="Pos.Generator.BlockEvent.html#BlockApplySuccess"><span class="hs-identifier">BlockApplySuccess</span></a></a><span>
</span><a name="line-232"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="BlockApplyFailure"><a href="Pos.Generator.BlockEvent.html#BlockApplyFailure"><span class="hs-identifier">BlockApplyFailure</span></a></a><span> </span><span class="hs-comment">{- TODO: attach error info, such as:
                            * block is not a continuation of the chain
                            * block signature is invalid
                            * etc -}</span><span>
</span><a name="line-236"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span class="hs-keyword">data</span><span> </span><a name="BlockEventApply%27"><a href="Pos.Generator.BlockEvent.html#BlockEventApply%27"><span class="hs-identifier">BlockEventApply'</span></a></a><span> </span><a name="local-6989586621681879480"><a href="#local-6989586621681879480"><span class="hs-identifier">blund</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="BlockEventApply"><a href="Pos.Generator.BlockEvent.html#BlockEventApply"><span class="hs-identifier">BlockEventApply</span></a></a><span>
</span><a name="line-239"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="_beaInput"><a href="Pos.Generator.BlockEvent.html#_beaInput"><span class="hs-identifier">_beaInput</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">OldestFirst</span><span> </span><span class="hs-identifier hs-type">NE</span><span> </span><a href="#local-6989586621681879480"><span class="hs-identifier hs-type">blund</span></a><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="_beaOutValid"><a href="Pos.Generator.BlockEvent.html#_beaOutValid"><span class="hs-identifier">_beaOutValid</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Generator.BlockEvent.html#BlockApplyResult"><span class="hs-identifier hs-type">BlockApplyResult</span></a><span>
</span><a name="line-241"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-char">''BlockEventApply'

type BlockEventApply = BlockEventApply' BlundDefault

-- | The type of failure that we expect from a rollback.
-- Extend this data type as necessary if you need to check for
-- other types of failures.
data BlockRollbackFailure
    = BlkRbSecurityLimitExceeded
    deriving (Show)

data BlockRollbackResult
    = BlockRollbackSuccess
    | BlockRollbackFailure BlockRollbackFailure
    deriving (Show)

data BlockEventRollback' blund = BlockEventRollback
    { _berInput    :: !(NewestFirst NE blund)
    , _berOutValid :: !BlockRollbackResult
    } deriving (Show, Functor, Foldable)

makeLenses ''BlockEventRollback'

type BlockEventRollback = BlockEventRollback' BlundDefault

newtype SnapshotId = SnapshotId Text
    deriving (Eq, Ord, IsString)

instance Show SnapshotId where
    showsPrec p (SnapshotId s) = Prelude.showsPrec p s

data SnapshotOperation
    = SnapshotSave SnapshotId {- Save the current db state into a snapshot
    under the specified identifier. Overwrites an existing snapshot with the
    same name or creates a new one. -}
    | SnapshotLoad SnapshotId {- Set the current db state to a state saved in
    a snapshot earlier. -}
    | SnapshotEq SnapshotId {- Compare the current db state to a state saved
    in a snapshot earlier, checking for equivalence. If logical discrepancies
    are found, throw an error. -}
    deriving (Show)

instance Buildable SnapshotOperation where
    build = bprint shown

data BlockEvent' blund
    = BlkEvApply (BlockEventApply' blund)
    | BlkEvRollback (BlockEventRollback' blund)
    | BlkEvSnap SnapshotOperation
    deriving (Show, Functor, Foldable)

instance Buildable blund =&gt; Buildable (BlockEvent' blund) where
    build = \case
        BlkEvApply ev -&gt; bprint (&quot;Apply blocks: &quot;%listJson) (getOldestFirst $ ev ^. beaInput)
        BlkEvRollback ev -&gt; bprint (&quot;Rollback blocks: &quot;%listJson) (getNewestFirst $ ev ^. berInput)
        BlkEvSnap s -&gt; bprint build s

type BlockEvent = BlockEvent' BlundDefault

newtype BlockScenario' blund = BlockScenario [BlockEvent' blund]
    deriving (Show, Functor, Foldable)

instance Buildable blund =&gt; Buildable (BlockScenario' blund) where
    build (BlockScenario xs) = bprint listJson xs

type BlockScenario = BlockScenario' BlundDefault

makePrisms ''BlockScenario'

----------------------------------------------------------------------------
-- Block event generation
----------------------------------------------------------------------------

newtype BlockEventCount = BlockEventCount {getBlockEventCount :: Word64}
    deriving (Eq, Ord, Num, Real, Integral, Enum, Read, Show,
              Buildable, Generic, Typeable, NFData, Hashable, Random)

-- | A coefficient in the range [0,1]. Pass it to 'weighted' if you ever get
-- the chance.
newtype Chance = Chance {getChance :: Rational}
    deriving (Buildable, Num, Fractional)

-- | Generate a boolean that may happen to be of true value.
byChance :: (Monad m, RandomGen g) =&gt; Chance -&gt; RandT g m Bool
byChance (Chance c) = weighted [(False, 1 - c), (True, c)]

newtype CheckCount = CheckCount Word
    deriving (Eq, Ord, Show, Num)

-- The tip after the block event. 'Nothing' when the event doesn't affect the tip.
blkEvTip :: (HasConfiguration, HasGtConfiguration) =&gt; BlockEvent -&gt; Maybe HeaderHash
blkEvTip = \case
    BlkEvApply bea -&gt; Just $
        (headerHash . NE.head . getNewestFirst . toNewestFirst . view beaInput) bea
    BlkEvRollback ber -&gt; Just $
        (headerHash . view prevBlockL . NE.head . getOldestFirst . toOldestFirst . view berInput) ber
    _ -&gt; Nothing

-- | Empty: hash snapshot unavailable
--   Zero: hash snapshot available but unused
--   Other: hash snapshot was used N times
type HhStatusMap = Map HeaderHash CheckCount

hhSnapshotId :: HeaderHash -&gt; SnapshotId
hhSnapshotId = SnapshotId . sformat hashHexF

-- | Whenever the resulting tips of apply/rollback operations coincide,
-- add a snapshot equivalence comparison.
enrichWithSnapshotChecking :: (HasConfiguration, HasGtConfiguration) =&gt; BlockScenario -&gt; (BlockScenario, CheckCount)
enrichWithSnapshotChecking (BlockScenario bs) = (BlockScenario bs', checkCount)
  where
    checkCount = sum (hhStatusEnd :: HhStatusMap)
    (hhStatusEnd, revBs') = go Map.empty [] bs
    bs' = reverse revBs'
    -- NB. 'go' is tail-recursive.
    go hhStatusSoFar revNewBs = \case
        [] -&gt; (hhStatusSoFar, revNewBs)
        (ev:evs) -&gt; case blkEvTip ev of
            Nothing -&gt; go hhStatusSoFar (ev:revNewBs) evs
            Just tipHh -&gt; case Map.lookup tipHh hhStatusSoFar of
                Nothing -&gt;
                    let
                        snapSave = BlkEvSnap (SnapshotSave (hhSnapshotId tipHh))
                        needSnapSave =
                            -- We tie the knot here to determine whether to actually emit
                            -- the command to save the snapshot.
                            Map.findWithDefault 0 tipHh hhStatusEnd &gt; 0
                        appendSnapSave = if needSnapSave then (snapSave:) else identity
                    in
                        go (Map.insert tipHh 0 hhStatusSoFar) (appendSnapSave $ ev:revNewBs) evs
                Just k -&gt;
                    let snapEq = BlkEvSnap (SnapshotEq (hhSnapshotId tipHh))
                    in go (Map.insert tipHh (1+k) hhStatusSoFar) (snapEq:ev:revNewBs) evs
</span></pre></body></html>