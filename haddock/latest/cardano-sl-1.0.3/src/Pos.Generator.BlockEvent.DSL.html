<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Generator</span><span class="hs-operator">.</span><span class="hs-identifier">BlockEvent</span><span class="hs-operator">.</span><span class="hs-identifier">DSL</span><span>
</span><a name="line-2"></a><span>       </span><span class="hs-special">(</span><span>
</span><a name="line-3"></a><span>         </span><span class="hs-comment">-- * Core re-exports</span><span>
</span><a name="line-4"></a><span>         </span><a href="Pos.Generator.BlockEvent.html#BlockDesc"><span class="hs-identifier hs-type">BlockDesc</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-5"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#PathSegment"><span class="hs-identifier hs-type">PathSegment</span></a><span>
</span><a name="line-6"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span>
</span><a name="line-7"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#pathSequence"><span class="hs-identifier hs-var">pathSequence</span></a><span>
</span><a name="line-8"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockApplyResult"><span class="hs-identifier hs-type">BlockApplyResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-9"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockRollbackResult"><span class="hs-identifier hs-type">BlockRollbackResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockRollbackFailure"><span class="hs-identifier hs-type">BlockRollbackFailure</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockScenario"><span class="hs-identifier hs-type">BlockScenario</span></a><span>
</span><a name="line-12"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockScenario%27"><span class="hs-identifier hs-type">BlockScenario'</span></a><span>
</span><a name="line-13"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#CheckCount"><span class="hs-identifier hs-type">CheckCount</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#enrichWithSnapshotChecking"><span class="hs-identifier hs-var">enrichWithSnapshotChecking</span></a><span>
</span><a name="line-15"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#Chance"><span class="hs-identifier hs-type">Chance</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#byChance"><span class="hs-identifier hs-var">byChance</span></a><span>
</span><a name="line-17"></a><span>         </span><span class="hs-comment">-- * The monad</span><span>
</span><a name="line-18"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.DSL.html#BlockEventGenT"><span class="hs-identifier hs-type">BlockEventGenT</span></a><span>
</span><a name="line-19"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.DSL.html#runBlockEventGenT"><span class="hs-identifier hs-var">runBlockEventGenT</span></a><span>
</span><a name="line-20"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.DSL.html#runBlockEventGenT%27"><span class="hs-identifier hs-var">runBlockEventGenT'</span></a><span>
</span><a name="line-21"></a><span>         </span><span class="hs-comment">-- * The operations</span><span>
</span><a name="line-22"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.DSL.html#describeBlock"><span class="hs-identifier hs-var">describeBlock</span></a><span>
</span><a name="line-23"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.DSL.html#emitBlockApply"><span class="hs-identifier hs-var">emitBlockApply</span></a><span>
</span><a name="line-24"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.DSL.html#emitBlockRollback"><span class="hs-identifier hs-var">emitBlockRollback</span></a><span>
</span><a name="line-25"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.DSL.html#snapshotSave"><span class="hs-identifier hs-var">snapshotSave</span></a><span>
</span><a name="line-26"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.DSL.html#snapshotLoad"><span class="hs-identifier hs-var">snapshotLoad</span></a><span>
</span><a name="line-27"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.DSL.html#snapshotEq"><span class="hs-identifier hs-var">snapshotEq</span></a><span>
</span><a name="line-28"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeLenses</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%=</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.=</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Random</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RandT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RandomGen</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapRandT</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.AllSecrets.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">AllSecrets</span></a><span>              </span><span class="hs-special">(</span><a href="Pos.AllSecrets.html#AllSecrets"><span class="hs-identifier hs-type">AllSecrets</span></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GenesisWStakeholders</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Generator.Block.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Generator</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Generator.Block.Mode.html#MonadBlockGen"><span class="hs-identifier hs-type">MonadBlockGen</span></a><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Generator.BlockEvent.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Generator</span><span class="hs-operator">.</span><span class="hs-identifier">BlockEvent</span></a><span>    </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#BlockApplyResult"><span class="hs-identifier hs-type">BlockApplyResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockDesc"><span class="hs-identifier hs-type">BlockDesc</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>                                              </span><a href="Pos.Generator.BlockEvent.html#BlockEvent%27"><span class="hs-identifier hs-type">BlockEvent'</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockEventApply%27"><span class="hs-identifier hs-type">BlockEventApply'</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>                                              </span><a href="Pos.Generator.BlockEvent.html#BlockEventRollback%27"><span class="hs-identifier hs-type">BlockEventRollback'</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>                                              </span><a href="Pos.Generator.BlockEvent.html#BlockRollbackFailure"><span class="hs-identifier hs-type">BlockRollbackFailure</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>                                              </span><a href="Pos.Generator.BlockEvent.html#BlockRollbackResult"><span class="hs-identifier hs-type">BlockRollbackResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#BlockScenario"><span class="hs-identifier hs-type">BlockScenario</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>                                              </span><a href="Pos.Generator.BlockEvent.html#BlockScenario%27"><span class="hs-identifier hs-type">BlockScenario'</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#Chance"><span class="hs-identifier hs-type">Chance</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>                                              </span><a href="Pos.Generator.BlockEvent.html#CheckCount"><span class="hs-identifier hs-type">CheckCount</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#PathSegment"><span class="hs-identifier hs-type">PathSegment</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>                                              </span><a href="Pos.Generator.BlockEvent.html#SnapshotId"><span class="hs-identifier hs-type">SnapshotId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#SnapshotOperation"><span class="hs-identifier hs-type">SnapshotOperation</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>                                              </span><a href="Pos.Generator.BlockEvent.html#byChance"><span class="hs-identifier hs-var">byChance</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#enrichWithSnapshotChecking"><span class="hs-identifier hs-var">enrichWithSnapshotChecking</span></a><span class="hs-special">,</span><span>
</span><a name="line-48"></a><span>                                              </span><a href="Pos.Generator.BlockEvent.html#genBlocksInStructure"><span class="hs-identifier hs-var">genBlocksInStructure</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Generator.BlockEvent.html#pathSequence"><span class="hs-identifier hs-var">pathSequence</span></a><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Chrono</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NE</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NewestFirst</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OldestFirst</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span>                                              </span><span class="hs-identifier hs-var">toOldestFirst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">_NewestFirst</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-keyword">data</span><span> </span><a name="BlockEventGenState"><a href="Pos.Generator.BlockEvent.DSL.html#BlockEventGenState"><span class="hs-identifier">BlockEventGenState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="BlockEventGenState"><a href="Pos.Generator.BlockEvent.DSL.html#BlockEventGenState"><span class="hs-identifier">BlockEventGenState</span></a></a><span>
</span><a name="line-53"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="_begsEvents"><a href="Pos.Generator.BlockEvent.DSL.html#_begsEvents"><span class="hs-identifier">_begsEvents</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">NewestFirst</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="Pos.Generator.BlockEvent.html#BlockEvent%27"><span class="hs-identifier hs-type">BlockEvent'</span></a><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="_begsAnnotations"><a href="Pos.Generator.BlockEvent.DSL.html#_begsAnnotations"><span class="hs-identifier">_begsAnnotations</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Pos.Generator.BlockEvent.html#Path"><span class="hs-identifier hs-type">Path</span></a><span> </span><a href="Pos.Generator.BlockEvent.html#BlockDesc"><span class="hs-identifier hs-type">BlockDesc</span></a><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-char">'BlockEventGenState

type BlockEventGenT g m = RandT g (StateT BlockEventGenState m)

describeBlock ::
       MonadState BlockEventGenState m
    =&gt; Path -- ^ path to the block in the blockchain tree
    -&gt; BlockDesc -- ^ block description
    -&gt; m ()
describeBlock path blockDesc =
    begsAnnotations . at path .= Just blockDesc

emitEvent ::
       MonadState BlockEventGenState m
    =&gt; BlockEvent' Path
    -&gt; m ()
emitEvent ev = begsEvents . _NewestFirst %= (ev:)

emitBlockApply ::
       MonadState BlockEventGenState m
    =&gt; BlockApplyResult -- ^ expected result
    -&gt; OldestFirst NE Path -- ^ blocks to apply
    -&gt; m ()
emitBlockApply res blocks = emitEvent $
    BlkEvApply BlockEventApply
        { _beaInput = blocks
        , _beaOutValid = res
        }

emitBlockRollback ::
       MonadState BlockEventGenState m
    =&gt; BlockRollbackResult -- ^ expected result
    -&gt; NewestFirst NE Path -- ^ blocks to rollback
    -&gt; m ()
emitBlockRollback res blocks = emitEvent $
    BlkEvRollback BlockEventRollback
        { _berInput = blocks
        , _berOutValid = res
        }

snapshotSave ::
       MonadState BlockEventGenState m
    =&gt; SnapshotId
    -&gt; m ()
snapshotSave snapshotId = emitEvent $
    BlkEvSnap (SnapshotSave snapshotId)

snapshotLoad ::
       MonadState BlockEventGenState m
    =&gt; SnapshotId
    -&gt; m ()
snapshotLoad snapshotId = emitEvent $
    BlkEvSnap (SnapshotLoad snapshotId)

snapshotEq ::
       MonadState BlockEventGenState m
    =&gt; SnapshotId
    -&gt; m ()
snapshotEq snapshotId = emitEvent $
    BlkEvSnap (SnapshotEq snapshotId)

runBlockEventGenT ::
       (RandomGen g, MonadBlockGen ctx m)
    =&gt; AllSecrets
    -&gt; GenesisWStakeholders
    -&gt; BlockEventGenT g m ()
    -&gt; RandT g m BlockScenario
runBlockEventGenT secrets genStakeholders m = do
    (annotations, preBlockScenario) &lt;- runBlockEventGenT' m
    genBlocksInStructure secrets genStakeholders annotations preBlockScenario

runBlockEventGenT' ::
    (RandomGen g, MonadBlockGen ctx m) =&gt;
    BlockEventGenT g m () -&gt;
    RandT g m (Map Path BlockDesc, BlockScenario' Path)
runBlockEventGenT' m = do
    let
        initialBlockEventGenState = BlockEventGenState
            { _begsEvents = NewestFirst []
            , _begsAnnotations = Map.empty
            }
    begs &lt;-
        let reorder (((), g), begs) = (begs, g)
        in mapRandT (fmap reorder . flip runStateT initialBlockEventGenState) m
    let
        OldestFirst preBlockEvents = toOldestFirst (begs ^. begsEvents)
        annotations = begs ^. begsAnnotations
    return (annotations, BlockScenario preBlockEvents)
</span></pre></body></html>