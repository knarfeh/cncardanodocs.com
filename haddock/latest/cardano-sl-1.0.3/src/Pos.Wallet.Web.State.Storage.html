<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Rank2Types   #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">-- @jens: this document is inspired by https://github.com/input-output-hk/rscoin-haskell/blob/master/src/RSCoin/Explorer/Storage.hs</span><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span class="hs-operator">.</span><span class="hs-identifier">Storage</span><span>
</span><a name="line-6"></a><span>       </span><span class="hs-special">(</span><span>
</span><a name="line-7"></a><span>         </span><a href="Pos.Wallet.Web.State.Storage.html#WalletStorage"><span class="hs-identifier hs-type">WalletStorage</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-8"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#WalletInfo"><span class="hs-identifier hs-type">WalletInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-9"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#AccountInfo"><span class="hs-identifier hs-type">AccountInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#AddressInfo"><span class="hs-identifier hs-type">AddressInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#AddressLookupMode"><span class="hs-identifier hs-type">AddressLookupMode</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#CustomAddressType"><span class="hs-identifier hs-type">CustomAddressType</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#CurrentAndRemoved"><span class="hs-identifier hs-type">CurrentAndRemoved</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#WalletBalances"><span class="hs-identifier hs-type">WalletBalances</span></a><span>
</span><a name="line-15"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#WalBalancesAndUtxo"><span class="hs-identifier hs-type">WalBalancesAndUtxo</span></a><span>
</span><a name="line-16"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#WalletTip"><span class="hs-identifier hs-type">WalletTip</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#PtxMetaUpdate"><span class="hs-identifier hs-type">PtxMetaUpdate</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#Query"><span class="hs-identifier hs-type">Query</span></a><span>
</span><a name="line-19"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#Update"><span class="hs-identifier hs-type">Update</span></a><span>
</span><a name="line-20"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getWalletStorage"><span class="hs-identifier hs-var">getWalletStorage</span></a><span>
</span><a name="line-21"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#flushWalletStorage"><span class="hs-identifier hs-var">flushWalletStorage</span></a><span>
</span><a name="line-22"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getProfile"><span class="hs-identifier hs-var">getProfile</span></a><span>
</span><a name="line-23"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#setProfile"><span class="hs-identifier hs-var">setProfile</span></a><span>
</span><a name="line-24"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#doesAccountExist"><span class="hs-identifier hs-var">doesAccountExist</span></a><span>
</span><a name="line-25"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getAccountIds"><span class="hs-identifier hs-var">getAccountIds</span></a><span>
</span><a name="line-26"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getAccountMetas"><span class="hs-identifier hs-var">getAccountMetas</span></a><span>
</span><a name="line-27"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getAccountMeta"><span class="hs-identifier hs-var">getAccountMeta</span></a><span>
</span><a name="line-28"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getAccountAddrMaps"><span class="hs-identifier hs-var">getAccountAddrMaps</span></a><span>
</span><a name="line-29"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getWalletMetas"><span class="hs-identifier hs-var">getWalletMetas</span></a><span>
</span><a name="line-30"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getWalletMeta"><span class="hs-identifier hs-var">getWalletMeta</span></a><span>
</span><a name="line-31"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getWalletMetaIncludeUnready"><span class="hs-identifier hs-var">getWalletMetaIncludeUnready</span></a><span>
</span><a name="line-32"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getWalletPassLU"><span class="hs-identifier hs-var">getWalletPassLU</span></a><span>
</span><a name="line-33"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getWalletSyncTip"><span class="hs-identifier hs-var">getWalletSyncTip</span></a><span>
</span><a name="line-34"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getWalletAddresses"><span class="hs-identifier hs-var">getWalletAddresses</span></a><span>
</span><a name="line-35"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getAccountWAddresses"><span class="hs-identifier hs-var">getAccountWAddresses</span></a><span>
</span><a name="line-36"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#doesWAddressExist"><span class="hs-identifier hs-var">doesWAddressExist</span></a><span>
</span><a name="line-37"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getTxMeta"><span class="hs-identifier hs-var">getTxMeta</span></a><span>
</span><a name="line-38"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getUpdates"><span class="hs-identifier hs-var">getUpdates</span></a><span>
</span><a name="line-39"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getNextUpdate"><span class="hs-identifier hs-var">getNextUpdate</span></a><span>
</span><a name="line-40"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getHistoryCache"><span class="hs-identifier hs-var">getHistoryCache</span></a><span>
</span><a name="line-41"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getCustomAddresses"><span class="hs-identifier hs-var">getCustomAddresses</span></a><span>
</span><a name="line-42"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getCustomAddress"><span class="hs-identifier hs-var">getCustomAddress</span></a><span>
</span><a name="line-43"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getPendingTxs"><span class="hs-identifier hs-var">getPendingTxs</span></a><span>
</span><a name="line-44"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getWalletPendingTxs"><span class="hs-identifier hs-var">getWalletPendingTxs</span></a><span>
</span><a name="line-45"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getPendingTx"><span class="hs-identifier hs-var">getPendingTx</span></a><span>
</span><a name="line-46"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#addCustomAddress"><span class="hs-identifier hs-var">addCustomAddress</span></a><span>
</span><a name="line-47"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#removeCustomAddress"><span class="hs-identifier hs-var">removeCustomAddress</span></a><span>
</span><a name="line-48"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#createAccount"><span class="hs-identifier hs-var">createAccount</span></a><span>
</span><a name="line-49"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#createWallet"><span class="hs-identifier hs-var">createWallet</span></a><span>
</span><a name="line-50"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#addWAddress"><span class="hs-identifier hs-var">addWAddress</span></a><span>
</span><a name="line-51"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#addRemovedAccount"><span class="hs-identifier hs-var">addRemovedAccount</span></a><span>
</span><a name="line-52"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#setAccountMeta"><span class="hs-identifier hs-var">setAccountMeta</span></a><span>
</span><a name="line-53"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#setWalletMeta"><span class="hs-identifier hs-var">setWalletMeta</span></a><span>
</span><a name="line-54"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#setWalletReady"><span class="hs-identifier hs-var">setWalletReady</span></a><span>
</span><a name="line-55"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#setWalletPassLU"><span class="hs-identifier hs-var">setWalletPassLU</span></a><span>
</span><a name="line-56"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#setWalletSyncTip"><span class="hs-identifier hs-var">setWalletSyncTip</span></a><span>
</span><a name="line-57"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#setWalletTxHistory"><span class="hs-identifier hs-var">setWalletTxHistory</span></a><span>
</span><a name="line-58"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getWalletTxHistory"><span class="hs-identifier hs-var">getWalletTxHistory</span></a><span>
</span><a name="line-59"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getWalletUtxo"><span class="hs-identifier hs-var">getWalletUtxo</span></a><span>
</span><a name="line-60"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#getWalletBalancesAndUtxo"><span class="hs-identifier hs-var">getWalletBalancesAndUtxo</span></a><span>
</span><a name="line-61"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#updateWalletBalancesAndUtxo"><span class="hs-identifier hs-var">updateWalletBalancesAndUtxo</span></a><span>
</span><a name="line-62"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#setWalletUtxo"><span class="hs-identifier hs-var">setWalletUtxo</span></a><span>
</span><a name="line-63"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#addOnlyNewTxMeta"><span class="hs-identifier hs-var">addOnlyNewTxMeta</span></a><span>
</span><a name="line-64"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#setWalletTxMeta"><span class="hs-identifier hs-var">setWalletTxMeta</span></a><span>
</span><a name="line-65"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#addOnlyNewTxMetas"><span class="hs-identifier hs-var">addOnlyNewTxMetas</span></a><span>
</span><a name="line-66"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#removeWallet"><span class="hs-identifier hs-var">removeWallet</span></a><span>
</span><a name="line-67"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#removeWalletTxMetas"><span class="hs-identifier hs-var">removeWalletTxMetas</span></a><span>
</span><a name="line-68"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#removeTxMetas"><span class="hs-identifier hs-var">removeTxMetas</span></a><span>
</span><a name="line-69"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#removeHistoryCache"><span class="hs-identifier hs-var">removeHistoryCache</span></a><span>
</span><a name="line-70"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#removeAccount"><span class="hs-identifier hs-var">removeAccount</span></a><span>
</span><a name="line-71"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#removeWAddress"><span class="hs-identifier hs-var">removeWAddress</span></a><span>
</span><a name="line-72"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#totallyRemoveWAddress"><span class="hs-identifier hs-var">totallyRemoveWAddress</span></a><span>
</span><a name="line-73"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#addUpdate"><span class="hs-identifier hs-var">addUpdate</span></a><span>
</span><a name="line-74"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#removeNextUpdate"><span class="hs-identifier hs-var">removeNextUpdate</span></a><span>
</span><a name="line-75"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#testReset"><span class="hs-identifier hs-var">testReset</span></a><span>
</span><a name="line-76"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#updateHistoryCache"><span class="hs-identifier hs-var">updateHistoryCache</span></a><span>
</span><a name="line-77"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#insertIntoHistoryCache"><span class="hs-identifier hs-var">insertIntoHistoryCache</span></a><span>
</span><a name="line-78"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#removeFromHistoryCache"><span class="hs-identifier hs-var">removeFromHistoryCache</span></a><span>
</span><a name="line-79"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#setPtxCondition"><span class="hs-identifier hs-var">setPtxCondition</span></a><span>
</span><a name="line-80"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#casPtxCondition"><span class="hs-identifier hs-var">casPtxCondition</span></a><span>
</span><a name="line-81"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#ptxUpdateMeta"><span class="hs-identifier hs-var">ptxUpdateMeta</span></a><span>
</span><a name="line-82"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#addOnlyNewPendingTx"><span class="hs-identifier hs-var">addOnlyNewPendingTx</span></a><span>
</span><a name="line-83"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#cancelApplyingPtxs"><span class="hs-identifier hs-var">cancelApplyingPtxs</span></a><span>
</span><a name="line-84"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#cancelSpecificApplyingPtx"><span class="hs-identifier hs-var">cancelSpecificApplyingPtx</span></a><span>
</span><a name="line-85"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ix</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeClassy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeLenses</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">non'</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">to</span><span class="hs-special">,</span><span>
</span><a name="line-90"></a><span>                                                 </span><span class="hs-identifier hs-var">toListOf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">traversed</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%=</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+=</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.=</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-91"></a><span>                                                 </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&lt;.=</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">?=</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">_Empty</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">_head</span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">put</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Default</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Default</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">def</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashMap</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HM</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span>                       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">SafeCopy</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Migrate</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">base</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">deriveSafeCopySimple</span><span class="hs-special">,</span><span>
</span><a name="line-97"></a><span>                                                 </span><span class="hs-identifier hs-var">extension</span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Clock</span><span class="hs-operator">.</span><span class="hs-identifier">POSIX</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-type">POSIXTime</span><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Client.Txp.History.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Client</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span><span class="hs-operator">.</span><span class="hs-identifier">History</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Client.Txp.History.html#TxHistoryEntry"><span class="hs-identifier hs-type">TxHistoryEntry</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.History.html#txHistoryListToMap"><span class="hs-identifier hs-var">txHistoryListToMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span class="hs-operator">.</span><span class="hs-identifier">Configuration</span><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasConfiguration</span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SlotId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Timestamp</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Txp.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AddrCoinMap</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TxAux</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TxId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Utxo</span><span class="hs-special">,</span><span>
</span><a name="line-104"></a><span>                                                 </span><span class="hs-identifier hs-type">UtxoModifier</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">applyUtxoModToAddrCoinMap</span><span class="hs-special">,</span><span>
</span><a name="line-105"></a><span>                                                 </span><span class="hs-identifier hs-var">utxoToAddressCoinMap</span><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HeaderHash</span><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.BackupPhrase.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">BackupPhrase</span></a><span>          </span><span class="hs-special">(</span><a href="Pos.Util.BackupPhrase.html#BackupPhrase"><span class="hs-identifier hs-type">BackupPhrase</span></a><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Modifier</span><span>              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">MM</span><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.ClientTypes.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">ClientTypes</span></a><span>     </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.ClientTypes.Types.html#AccountId"><span class="hs-identifier hs-type">AccountId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#Addr"><span class="hs-identifier hs-type">Addr</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CAccountMeta"><span class="hs-identifier hs-type">CAccountMeta</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CCoin"><span class="hs-identifier hs-type">CCoin</span></a><span class="hs-special">,</span><span>
</span><a name="line-110"></a><span>                                                 </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CHash"><span class="hs-identifier hs-type">CHash</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CId"><span class="hs-identifier hs-type">CId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CProfile"><span class="hs-identifier hs-type">CProfile</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CTxId"><span class="hs-identifier hs-type">CTxId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CTxMeta"><span class="hs-identifier hs-type">CTxMeta</span></a><span class="hs-special">,</span><span>
</span><a name="line-111"></a><span>                                                 </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CUpdateInfo"><span class="hs-identifier hs-type">CUpdateInfo</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CWAddressMeta"><span class="hs-identifier hs-type">CWAddressMeta</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-112"></a><span>                                                 </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CWalletAssurance"><span class="hs-identifier hs-type">CWalletAssurance</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CWalletMeta"><span class="hs-identifier hs-type">CWalletMeta</span></a><span class="hs-special">,</span><span>
</span><a name="line-113"></a><span>                                                 </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#PassPhraseLU"><span class="hs-identifier hs-type">PassPhraseLU</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#Wal"><span class="hs-identifier hs-type">Wal</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.Functions.html#addrMetaToAccount"><span class="hs-identifier hs-var">addrMetaToAccount</span></a><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.Pending.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Pending</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>   </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.Pending.Types.html#PendingTx"><span class="hs-identifier hs-type">PendingTx</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Pending.Types.html#PtxCondition"><span class="hs-identifier hs-type">PtxCondition</span></a><span class="hs-special">,</span><span>
</span><a name="line-115"></a><span>                                                 </span><a href="Pos.Wallet.Web.Pending.Types.html#PtxSubmitTiming"><span class="hs-identifier hs-type">PtxSubmitTiming</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Pending.Types.html#ptxCond"><span class="hs-identifier hs-var">ptxCond</span></a><span class="hs-special">,</span><span>
</span><a name="line-116"></a><span>                                                 </span><a href="Pos.Wallet.Web.Pending.Types.html#ptxSubmitTiming"><span class="hs-identifier hs-var">ptxSubmitTiming</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.Pending.Updates.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Pending</span><span class="hs-operator">.</span><span class="hs-identifier">Updates</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.Pending.Updates.html#cancelApplyingPtx"><span class="hs-identifier hs-var">cancelApplyingPtx</span></a><span class="hs-special">,</span><span>
</span><a name="line-118"></a><span>                                                 </span><a href="Pos.Wallet.Web.Pending.Updates.html#incPtxSubmitTimingPure"><span class="hs-identifier hs-var">incPtxSubmitTimingPure</span></a><span class="hs-special">,</span><span>
</span><a name="line-119"></a><span>                                                 </span><a href="Pos.Wallet.Web.Pending.Updates.html#mkPtxSubmitTiming"><span class="hs-identifier hs-var">mkPtxSubmitTiming</span></a><span class="hs-special">,</span><span>
</span><a name="line-120"></a><span>                                                 </span><a href="Pos.Wallet.Web.Pending.Updates.html#ptxMarkAcknowledgedPure"><span class="hs-identifier hs-var">ptxMarkAcknowledgedPure</span></a><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-keyword">type</span><span> </span><a name="AddressSortingKey"><a href="Pos.Wallet.Web.State.Storage.html#AddressSortingKey"><span class="hs-identifier">AddressSortingKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-keyword">data</span><span> </span><a name="AddressInfo"><a href="Pos.Wallet.Web.State.Storage.html#AddressInfo"><span class="hs-identifier">AddressInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="AddressInfo"><a href="Pos.Wallet.Web.State.Storage.html#AddressInfo"><span class="hs-identifier">AddressInfo</span></a></a><span>
</span><a name="line-125"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="adiCWAddressMeta"><a href="Pos.Wallet.Web.State.Storage.html#adiCWAddressMeta"><span class="hs-identifier">adiCWAddressMeta</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CWAddressMeta"><span class="hs-identifier hs-type">CWAddressMeta</span></a><span>
</span><a name="line-126"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="adiSortingKey"><a href="Pos.Wallet.Web.State.Storage.html#adiSortingKey"><span class="hs-identifier">adiSortingKey</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Wallet.Web.State.Storage.html#AddressSortingKey"><span class="hs-identifier hs-type">AddressSortingKey</span></a><span>
</span><a name="line-127"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-keyword">type</span><span> </span><a name="CAddresses"><a href="Pos.Wallet.Web.State.Storage.html#CAddresses"><span class="hs-identifier">CAddresses</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">HashMap</span><span> </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CId"><span class="hs-identifier hs-type">CId</span></a><span> </span><a href="Pos.Wallet.Web.ClientTypes.Types.html#Addr"><span class="hs-identifier hs-type">Addr</span></a><span class="hs-special">)</span><span> </span><a href="Pos.Wallet.Web.State.Storage.html#AddressInfo"><span class="hs-identifier hs-type">AddressInfo</span></a><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-keyword">data</span><span> </span><a name="AccountInfo"><a href="Pos.Wallet.Web.State.Storage.html#AccountInfo"><span class="hs-identifier">AccountInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="AccountInfo"><a href="Pos.Wallet.Web.State.Storage.html#AccountInfo"><span class="hs-identifier">AccountInfo</span></a></a><span>
</span><a name="line-132"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="_aiMeta"><a href="Pos.Wallet.Web.State.Storage.html#_aiMeta"><span class="hs-identifier">_aiMeta</span></a></a><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Wallet.Web.ClientTypes.Types.html#CAccountMeta"><span class="hs-identifier hs-type">CAccountMeta</span></a><span>
</span><a name="line-133"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="_aiAddresses"><a href="Pos.Wallet.Web.State.Storage.html#_aiAddresses"><span class="hs-identifier">_aiAddresses</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Wallet.Web.State.Storage.html#CAddresses"><span class="hs-identifier hs-type">CAddresses</span></a><span>
</span><a name="line-134"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="_aiRemovedAddresses"><a href="Pos.Wallet.Web.State.Storage.html#_aiRemovedAddresses"><span class="hs-identifier">_aiRemovedAddresses</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Wallet.Web.State.Storage.html#CAddresses"><span class="hs-identifier hs-type">CAddresses</span></a><span>
</span><a name="line-135"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="_aiUnusedKey"><a href="Pos.Wallet.Web.State.Storage.html#_aiUnusedKey"><span class="hs-identifier">_aiUnusedKey</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Wallet.Web.State.Storage.html#AddressSortingKey"><span class="hs-identifier hs-type">AddressSortingKey</span></a><span>
</span><a name="line-136"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-char">''AccountInfo

data WalletTip
    = NotSynced
    | SyncedWith !HeaderHash

data WalletInfo = WalletInfo
    { _wiMeta         :: !CWalletMeta
    , _wiPassphraseLU :: !PassPhraseLU
    , _wiCreationTime :: !POSIXTime
    , _wiSyncTip      :: !WalletTip
    , _wsPendingTxs   :: !(HashMap TxId PendingTx)
    -- Wallets that are being synced are marked as not ready, and
    -- are excluded from api endpoints. This info should not be leaked
    -- into a client facing data structure (for example `CWalletMeta`)
    , _wiIsReady      :: !Bool
    }

makeLenses ''WalletInfo

-- | Maps addresses to their first occurrence in the blockchain
type CustomAddresses = HashMap (CId Addr) HeaderHash
type WalletBalances = AddrCoinMap
type WalBalancesAndUtxo = (WalletBalances, Utxo)

data WalletStorage = WalletStorage
    { _wsWalletInfos     :: !(HashMap (CId Wal) WalletInfo)
    , _wsAccountInfos    :: !(HashMap AccountId AccountInfo)
    , _wsProfile         :: !CProfile
    , _wsReadyUpdates    :: [CUpdateInfo]
    , _wsTxHistory       :: !(HashMap (CId Wal) (HashMap CTxId CTxMeta))
    , _wsHistoryCache    :: !(HashMap (CId Wal) (Map TxId TxHistoryEntry))
    , _wsUtxo            :: !Utxo
    -- @_wsBalances@ depends on @_wsUtxo@,
    -- it's forbidden to update @_wsBalances@ without @_wsUtxo@
    , _wsBalances        :: !WalletBalances
    , _wsUsedAddresses   :: !CustomAddresses
    , _wsChangeAddresses :: !CustomAddresses
    }

makeClassy ''WalletStorage

instance Default WalletStorage where
    def =
        WalletStorage
        { _wsWalletInfos     = mempty
        , _wsAccountInfos    = mempty
        , _wsProfile         = def
        , _wsReadyUpdates    = mempty
        , _wsTxHistory       = mempty
        , _wsHistoryCache    = mempty
        , _wsUsedAddresses   = mempty
        , _wsChangeAddresses = mempty
        , _wsUtxo            = mempty
        , _wsBalances        = mempty
        }

type Query a = forall m. (MonadReader WalletStorage m) =&gt; m a
type Update a = forall m. (HasConfiguration, MonadState WalletStorage m) =&gt; m a

-- | How to lookup addresses of account
data AddressLookupMode
    = Existing  -- ^ fetch only currently existing addresses
    | Deleted   -- ^ fetch only removed addresses
    | Ever      -- ^ fetch both existing and removed addresses

withAccLookupMode :: (Monad m, Monoid a) =&gt; AddressLookupMode -&gt; m a -&gt; m a -&gt; m a
withAccLookupMode Existing existing _       = existing
withAccLookupMode Deleted  _        deleted = deleted
withAccLookupMode Ever     existing deleted = mappend &lt;$&gt; existing &lt;*&gt; deleted

-- | Specifies special category of addresses which are stored in base.
data CustomAddressType
    = UsedAddr
    | ChangeAddr

customAddressL :: CustomAddressType -&gt; Lens' WalletStorage CustomAddresses
customAddressL UsedAddr   = wsUsedAddresses
customAddressL ChangeAddr = wsChangeAddresses

-- | Keeps existing and pseudo-removed entries, e.g. addresses.
data CurrentAndRemoved a = CurrentAndRemoved
    { getCurrent :: a
    , getRemoved :: a
    }

getProfile :: Query CProfile
getProfile = view wsProfile

setProfile :: CProfile -&gt; Update ()
setProfile cProfile = wsProfile .= cProfile

doesAccountExist :: AccountId -&gt; Query Bool
doesAccountExist accId = view $ wsAccountInfos . at accId . to isJust

getAccountIds :: Query [AccountId]
getAccountIds = HM.keys &lt;$&gt; view wsAccountInfos

getAccountMetas :: Query [CAccountMeta]
getAccountMetas = map (view aiMeta) . toList &lt;$&gt; view wsAccountInfos

getAccountMeta :: AccountId -&gt; Query (Maybe CAccountMeta)
getAccountMeta accId = preview (wsAccountInfos . ix accId . aiMeta)

getAccountAddrMaps :: AccountId -&gt; Query (CurrentAndRemoved CAddresses)
getAccountAddrMaps accId = do
    getCurrent &lt;- getMap aiAddresses
    getRemoved &lt;- getMap aiRemovedAddresses
    return CurrentAndRemoved{..}
  where
    getMap aiLens = fmap (fromMaybe mempty) $ preview $ wsAccountInfos . ix accId . aiLens

getWalletMetas :: Query [CWalletMeta]
getWalletMetas = toList . fmap _wiMeta . HM.filter _wiIsReady &lt;$&gt; view wsWalletInfos

getWalletMetaIncludeUnready :: Bool -&gt; CId Wal -&gt; Query (Maybe CWalletMeta)
getWalletMetaIncludeUnready includeUnready cWalId = fmap _wiMeta . applyFilter &lt;$&gt; preview (wsWalletInfos . ix cWalId)
  where
    applyFilter xs = if includeUnready then xs else filterMaybe _wiIsReady xs
    filterMaybe :: (a -&gt; Bool) -&gt; Maybe a -&gt; Maybe a
    filterMaybe p ma = ma &gt;&gt;= \a -&gt; guard (p a) &gt;&gt; return a

getWalletMeta :: CId Wal -&gt; Query (Maybe CWalletMeta)
getWalletMeta = getWalletMetaIncludeUnready False

getWalletPassLU :: CId Wal -&gt; Query (Maybe PassPhraseLU)
getWalletPassLU cWalId = preview (wsWalletInfos . ix cWalId . wiPassphraseLU)

getWalletSyncTip :: CId Wal -&gt; Query (Maybe WalletTip)
getWalletSyncTip cWalId = preview (wsWalletInfos . ix cWalId . wiSyncTip)

getWalletAddresses :: Query [CId Wal]
getWalletAddresses =
    map fst . sortOn (view wiCreationTime . snd) . filter (view wiIsReady . snd) . HM.toList &lt;$&gt;
    view wsWalletInfos

getAccountWAddresses :: AddressLookupMode
                     -&gt; AccountId
                     -&gt; Query (Maybe [AddressInfo])
getAccountWAddresses mode accId =
    withAccLookupMode mode (fetch aiAddresses) (fetch aiRemovedAddresses)
  where
    fetch :: MonadReader WalletStorage m =&gt; Lens' AccountInfo CAddresses -&gt; m (Maybe [AddressInfo])
    fetch which = fmap HM.elems &lt;$&gt; preview (wsAccountInfos . ix accId . which)

doesWAddressExist :: AddressLookupMode -&gt; CWAddressMeta -&gt; Query Bool
doesWAddressExist mode addrMeta@(addrMetaToAccount -&gt; wAddr) =
    getAny &lt;$&gt;
        withAccLookupMode mode (exists aiAddresses) (exists aiRemovedAddresses)
  where
    exists :: Lens' AccountInfo CAddresses -&gt; Query Any
    exists which =
        Any . isJust &lt;$&gt;
        preview (wsAccountInfos . ix wAddr . which . ix (cwamId addrMeta))

getTxMeta :: CId Wal -&gt; CTxId -&gt; Query (Maybe CTxMeta)
getTxMeta cid ctxId = preview $ wsTxHistory . ix cid . ix ctxId

getWalletTxHistory :: CId Wal -&gt; Query (Maybe [CTxMeta])
getWalletTxHistory cWalId = toList &lt;&lt;$&gt;&gt; preview (wsTxHistory . ix cWalId)

getWalletUtxo :: Query Utxo
getWalletUtxo = view wsUtxo

getWalletBalancesAndUtxo :: Query WalBalancesAndUtxo
getWalletBalancesAndUtxo = (,) &lt;$&gt; view wsBalances &lt;*&gt; view wsUtxo

updateWalletBalancesAndUtxo :: UtxoModifier -&gt; Update ()
updateWalletBalancesAndUtxo modifier = do
    balAndUtxo &lt;- (,) &lt;$&gt; use wsBalances &lt;*&gt; use wsUtxo
    wsBalances .= applyUtxoModToAddrCoinMap modifier balAndUtxo
    wsUtxo %= MM.modifyMap modifier

setWalletUtxo :: Utxo -&gt; Update ()
setWalletUtxo utxo = do
    wsUtxo .= utxo
    wsBalances .= utxoToAddressCoinMap utxo

getUpdates :: Query [CUpdateInfo]
getUpdates = view wsReadyUpdates

getNextUpdate :: Query (Maybe CUpdateInfo)
getNextUpdate = preview (wsReadyUpdates . _head)

getHistoryCache :: CId Wal -&gt; Query (Maybe (Map TxId TxHistoryEntry))
getHistoryCache cWalId = view $ wsHistoryCache . at cWalId

getCustomAddresses :: CustomAddressType -&gt; Query [CId Addr]
getCustomAddresses t = HM.keys &lt;$&gt; view (customAddressL t)

getCustomAddress :: CustomAddressType -&gt; CId Addr -&gt; Query (Maybe HeaderHash)
getCustomAddress t addr = view $ customAddressL t . at addr

getPendingTxs :: Query [PendingTx]
getPendingTxs = asks $ toListOf (wsWalletInfos . traversed . wsPendingTxs . traversed)

getWalletPendingTxs :: CId Wal -&gt; Query (Maybe [PendingTx])
getWalletPendingTxs wid =
    preview $ wsWalletInfos . ix wid . wsPendingTxs . to toList

getPendingTx :: CId Wal -&gt; TxId -&gt; Query (Maybe PendingTx)
getPendingTx wid txId = preview $ wsWalletInfos . ix wid . wsPendingTxs . ix txId

addCustomAddress :: CustomAddressType -&gt; (CId Addr, HeaderHash) -&gt; Update Bool
addCustomAddress t (addr, hh) = fmap isJust $ customAddressL t . at addr &lt;&lt;.= Just hh

removeCustomAddress :: CustomAddressType -&gt; (CId Addr, HeaderHash) -&gt; Update Bool
removeCustomAddress t (addr, hh) = do
    mhh' &lt;- use $ customAddressL t . at addr
    let exists = mhh' == Just hh
    when exists $
        customAddressL t . at addr .= Nothing
    return exists

createAccount :: AccountId -&gt; CAccountMeta -&gt; Update ()
createAccount accId cAccMeta =
    wsAccountInfos . at accId %= Just . fromMaybe (AccountInfo cAccMeta mempty mempty 0)

-- `isReady` is marked False when an additional step such as syncing is still needed.
createWallet :: CId Wal -&gt; CWalletMeta -&gt; Bool -&gt; POSIXTime -&gt; Update ()
createWallet cWalId cWalMeta isReady curTime = do
    let info = WalletInfo cWalMeta curTime curTime NotSynced mempty isReady
    wsWalletInfos . at cWalId %= (&lt;|&gt; Just info)

addWAddress :: CWAddressMeta -&gt; Update ()
addWAddress addrMeta@CWAddressMeta{..} = do
    let accInfo :: Traversal' WalletStorage AccountInfo
        accInfo = wsAccountInfos . ix (addrMetaToAccount addrMeta)
    whenJustM (preuse accInfo) $ \info -&gt; do
        let mAddr = info ^. aiAddresses . at cwamId
        when (isNothing mAddr) $ do
            accInfo . aiUnusedKey += 1
            let key = info ^. aiUnusedKey
            accInfo . aiAddresses . at cwamId ?= AddressInfo addrMeta key

-- see also 'removeWAddress'
addRemovedAccount :: CWAddressMeta -&gt; Update ()
addRemovedAccount addrMeta@CWAddressMeta{..} = do
    let accInfo :: Traversal' WalletStorage AccountInfo
        accInfo = wsAccountInfos . ix (addrMetaToAccount addrMeta)
    whenJustM (preuse (accInfo . aiUnusedKey)) $ \key -&gt; do
        accInfo . aiUnusedKey += 1
        accInfo . aiAddresses        . at cwamId .= Nothing
        accInfo . aiRemovedAddresses . at cwamId ?= AddressInfo addrMeta key

setAccountMeta :: AccountId -&gt; CAccountMeta -&gt; Update ()
setAccountMeta accId cAccMeta = wsAccountInfos . ix accId . aiMeta .= cAccMeta

setWalletMeta :: CId Wal -&gt; CWalletMeta -&gt; Update ()
setWalletMeta cWalId cWalMeta = wsWalletInfos . ix cWalId . wiMeta .= cWalMeta

setWalletReady :: CId Wal -&gt; Bool -&gt; Update ()
setWalletReady cWalId isReady = wsWalletInfos . ix cWalId . wiIsReady .= isReady

setWalletPassLU :: CId Wal -&gt; PassPhraseLU -&gt; Update ()
setWalletPassLU cWalId passLU = wsWalletInfos . ix cWalId . wiPassphraseLU .= passLU

setWalletSyncTip :: CId Wal -&gt; HeaderHash -&gt; Update ()
setWalletSyncTip cWalId hh = wsWalletInfos . ix cWalId . wiSyncTip .= SyncedWith hh

addWalletTxHistory :: CId Wal -&gt; CTxId -&gt; CTxMeta -&gt; Update ()
addWalletTxHistory cWalId cTxId cTxMeta =
    wsTxHistory . at cWalId . non' _Empty . at cTxId ?= cTxMeta

setWalletTxHistory :: CId Wal -&gt; [(CTxId, CTxMeta)] -&gt; Update ()
setWalletTxHistory cWalId cTxs = mapM_ (uncurry $ addWalletTxHistory cWalId) cTxs

-- FIXME: this will be removed later (temporary solution)
addOnlyNewTxMeta :: CId Wal -&gt; CTxId -&gt; CTxMeta -&gt; Update ()
addOnlyNewTxMeta cWalId cTxId cTxMeta =
    -- Double nested HashMap update (if either or both of cWalId, cTxId don't exist, they will be created)
    wsTxHistory . at cWalId . non' _Empty . at cTxId %= Just . fromMaybe cTxMeta

-- NOTE: sets transaction meta only for transactions ids that are already seen
setWalletTxMeta :: CId Wal -&gt; CTxId -&gt; CTxMeta -&gt; Update ()
setWalletTxMeta cWalId cTxId cTxMeta =
    wsTxHistory . ix cWalId . at cTxId %= ($&gt; cTxMeta)

removeTxMetas :: CId Wal -&gt; Update ()
removeTxMetas cWalId = wsTxHistory . at cWalId .= Nothing

addOnlyNewTxMetas :: CId Wal -&gt; [(CTxId, CTxMeta)] -&gt; Update ()
addOnlyNewTxMetas = mapM_ . uncurry . addOnlyNewTxMeta

removeWalletTxMetas :: CId Wal -&gt; [CTxId] -&gt; Update ()
removeWalletTxMetas cWalId cTxs =
    wsTxHistory . at cWalId . non' _Empty %= flip (foldr HM.delete) cTxs

removeWallet :: CId Wal -&gt; Update ()
removeWallet cWalId = wsWalletInfos . at cWalId .= Nothing

removeHistoryCache :: CId Wal -&gt; Update ()
removeHistoryCache cWalId = wsHistoryCache . at cWalId .= Nothing

removeAccount :: AccountId -&gt; Update ()
removeAccount accId = wsAccountInfos . at accId .= Nothing

-- see also 'addRemovedAccount'
removeWAddress :: CWAddressMeta -&gt; Update ()
removeWAddress addrMeta@(addrMetaToAccount -&gt; accId) = do
    let addrId = cwamId addrMeta
    -- If the address exists, move it to 'addressesRemoved'
    whenJustM (preuse (accAddresses accId . ix addrId)) $ \addressInfo -&gt; do
        accAddresses        accId . at addrId .= Nothing
        accRemovedAddresses accId . at addrId .= Just addressInfo
  where
    accAddresses        accId' = wsAccountInfos . ix accId' . aiAddresses
    accRemovedAddresses accId' = wsAccountInfos . ix accId' . aiRemovedAddresses

totallyRemoveWAddress :: CWAddressMeta -&gt; Update ()
totallyRemoveWAddress addrMeta@(addrMetaToAccount -&gt; accId) = do
    wsAccountInfos . ix accId . aiAddresses        . at (cwamId addrMeta) .= Nothing
    wsAccountInfos . ix accId . aiRemovedAddresses . at (cwamId addrMeta) .= Nothing

addUpdate :: CUpdateInfo -&gt; Update ()
addUpdate ui = wsReadyUpdates %= (++ [ui])

removeNextUpdate :: Update ()
removeNextUpdate = wsReadyUpdates %= drop 1

testReset :: Update ()
testReset = put def

-- Legacy transaction, no longer used. For existing Db tx logs only. Now use
-- 'removeHistoryCache', 'insertIntoHistoryCache' or 'removeFromHistoryCache'
updateHistoryCache :: CId Wal -&gt; [TxHistoryEntry] -&gt; Update ()
updateHistoryCache cWalId cTxs =
    wsHistoryCache . at cWalId ?= txHistoryListToMap cTxs

insertIntoHistoryCache :: CId Wal -&gt; Map TxId TxHistoryEntry -&gt; Update ()
insertIntoHistoryCache cWalId cTxs =
    wsHistoryCache . at cWalId . non' _Empty %= (cTxs `M.union`)

removeFromHistoryCache :: CId Wal -&gt; Map TxId () -&gt; Update ()
removeFromHistoryCache cWalId cTxs =
    wsHistoryCache . at cWalId . non' _Empty %= (`M.difference` cTxs)

-- This shouldn't be able to create new transaction.
-- NOTE: If you're going to use this function, make sure 'casPtxCondition'
-- doesn't fit your purposes better
setPtxCondition :: CId Wal -&gt; TxId -&gt; PtxCondition -&gt; Update ()
setPtxCondition wid txId cond =
    wsWalletInfos . ix wid . wsPendingTxs . ix txId . ptxCond .= cond

-- | Compare-and-set version of 'setPtxCondition'.
-- Returns 'True' if transaction existed and modification was applied.
casPtxCondition :: CId Wal -&gt; TxId -&gt; PtxCondition -&gt; PtxCondition -&gt; Update Bool
casPtxCondition wid txId expectedCond newCond = do
    oldCond &lt;- preuse $ wsWalletInfos . ix wid . wsPendingTxs . ix txId . ptxCond
    let success = oldCond == Just expectedCond
    when success $ setPtxCondition wid txId newCond
    return success

data PtxMetaUpdate
    = PtxIncSubmitTiming
    | PtxResetSubmitTiming SlotId
    | PtxMarkAcknowledged

-- | For simple atomic updates of meta info
ptxUpdateMeta :: CId Wal -&gt; TxId -&gt; PtxMetaUpdate -&gt; Update ()
ptxUpdateMeta wid txId updType =
    wsWalletInfos . ix wid . wsPendingTxs . ix txId %=
        case updType of
            PtxIncSubmitTiming -&gt;
                ptxSubmitTiming %~ incPtxSubmitTimingPure
            PtxResetSubmitTiming curSlot -&gt;
                ptxSubmitTiming .~ mkPtxSubmitTiming curSlot
            PtxMarkAcknowledged -&gt;
                ptxMarkAcknowledgedPure

cancelApplyingPtxs :: Update ()
cancelApplyingPtxs =
    wsWalletInfos . traversed .
    wsPendingTxs . traversed %= cancelApplyingPtx

cancelSpecificApplyingPtx :: TxId -&gt; Update ()
cancelSpecificApplyingPtx txId =
    wsWalletInfos . traversed .
    wsPendingTxs . ix txId %= cancelApplyingPtx

addOnlyNewPendingTx :: PendingTx -&gt; Update ()
addOnlyNewPendingTx ptx =
    wsWalletInfos . ix (_ptxWallet ptx) .
    wsPendingTxs . at (_ptxTxId ptx) %= (&lt;|&gt; Just ptx)


getWalletStorage :: Query WalletStorage
getWalletStorage = ask

-- | Flushes data in wallet storage
-- Preserves all metadata, wallets, accounts and addresses
-- Flushes all data that can be rebuild from blockchain (tx history and etc.)
flushWalletStorage :: Update ()
flushWalletStorage = modify flushDo
  where
    flushDo ws = ws
        { _wsWalletInfos = flushWalletInfo &lt;$&gt; _wsWalletInfos ws
        , _wsHistoryCache = HM.empty
        , _wsUtxo = M.empty
        , _wsUsedAddresses = HM.empty
        , _wsChangeAddresses = HM.empty
        }
    flushWalletInfo wi = wi { _wiSyncTip = NotSynced
                            , _wiIsReady = False
                            }

deriveSafeCopySimple 0 'base ''CCoin
deriveSafeCopySimple 0 'base ''CProfile
deriveSafeCopySimple 0 'base ''CHash
deriveSafeCopySimple 0 'base ''CId
deriveSafeCopySimple 0 'base ''Wal
deriveSafeCopySimple 0 'base ''Addr
deriveSafeCopySimple 0 'base ''BackupPhrase
deriveSafeCopySimple 0 'base ''AccountId
deriveSafeCopySimple 0 'base ''CWAddressMeta
deriveSafeCopySimple 0 'base ''CWalletAssurance
deriveSafeCopySimple 0 'base ''CAccountMeta
deriveSafeCopySimple 0 'base ''CWalletMeta
deriveSafeCopySimple 0 'base ''CTxId
deriveSafeCopySimple 0 'base ''Timestamp
deriveSafeCopySimple 0 'base ''TxHistoryEntry
deriveSafeCopySimple 0 'base ''CTxMeta
deriveSafeCopySimple 0 'base ''CUpdateInfo
deriveSafeCopySimple 0 'base ''AddressLookupMode
deriveSafeCopySimple 0 'base ''CustomAddressType
deriveSafeCopySimple 0 'base ''CurrentAndRemoved
deriveSafeCopySimple 0 'base ''TxAux
deriveSafeCopySimple 0 'base ''PtxCondition
deriveSafeCopySimple 0 'base ''PtxSubmitTiming
deriveSafeCopySimple 0 'base ''PtxMetaUpdate
deriveSafeCopySimple 0 'base ''PendingTx
deriveSafeCopySimple 0 'base ''AddressInfo
deriveSafeCopySimple 0 'base ''AccountInfo
deriveSafeCopySimple 0 'base ''WalletTip
deriveSafeCopySimple 0 'base ''WalletInfo

-- Legacy versions, for migrations

data WalletStorage_v0 = WalletStorage_v0
    { _v0_wsWalletInfos     :: !(HashMap (CId Wal) WalletInfo)
    , _v0_wsAccountInfos    :: !(HashMap AccountId AccountInfo)
    , _v0_wsProfile         :: !CProfile
    , _v0_wsReadyUpdates    :: [CUpdateInfo]
    , _v0_wsTxHistory       :: !(HashMap (CId Wal) (HashMap CTxId CTxMeta))
    , _v0_wsHistoryCache    :: !(HashMap (CId Wal) [TxHistoryEntry])
    , _v0_wsUtxo            :: !Utxo
    , _v0_wsUsedAddresses   :: !CustomAddresses
    , _v0_wsChangeAddresses :: !CustomAddresses
    }

data WalletStorage_v1 = WalletStorage_v1
    { _v1_wsWalletInfos     :: !(HashMap (CId Wal) WalletInfo)
    , _v1_wsAccountInfos    :: !(HashMap AccountId AccountInfo)
    , _v1_wsProfile         :: !CProfile
    , _v1_wsReadyUpdates    :: [CUpdateInfo]
    , _v1_wsTxHistory       :: !(HashMap (CId Wal) (HashMap CTxId CTxMeta))
    , _v1_wsHistoryCache    :: !(HashMap (CId Wal) (Map TxId TxHistoryEntry))
    , _v1_wsUtxo            :: !Utxo
    , _v1_wsUsedAddresses   :: !CustomAddresses
    , _v1_wsChangeAddresses :: !CustomAddresses
    }

deriveSafeCopySimple 0 'base ''WalletStorage_v0
deriveSafeCopySimple 1 'extension ''WalletStorage_v1
deriveSafeCopySimple 2 'extension ''WalletStorage

instance Migrate WalletStorage_v1 where
    type MigrateFrom WalletStorage_v1 = WalletStorage_v0
    migrate WalletStorage_v0{..} = WalletStorage_v1
        { _v1_wsWalletInfos     = _v0_wsWalletInfos
        , _v1_wsAccountInfos    = _v0_wsAccountInfos
        , _v1_wsProfile         = _v0_wsProfile
        , _v1_wsReadyUpdates    = _v0_wsReadyUpdates
        , _v1_wsTxHistory       = _v0_wsTxHistory
        , _v1_wsHistoryCache    = HM.map txHistoryListToMap _v0_wsHistoryCache
        , _v1_wsUtxo            = _v0_wsUtxo
        , _v1_wsUsedAddresses   = _v0_wsUsedAddresses
        , _v1_wsChangeAddresses = _v0_wsChangeAddresses
        }

instance Migrate WalletStorage where
    type MigrateFrom WalletStorage = WalletStorage_v1
    migrate WalletStorage_v1{..} = WalletStorage
        { _wsWalletInfos     = _v1_wsWalletInfos
        , _wsAccountInfos    = _v1_wsAccountInfos
        , _wsProfile         = _v1_wsProfile
        , _wsReadyUpdates    = _v1_wsReadyUpdates
        , _wsTxHistory       = _v1_wsTxHistory
        , _wsHistoryCache    = _v1_wsHistoryCache
        , _wsUtxo            = _v1_wsUtxo
        , _wsBalances        = utxoToAddressCoinMap _v1_wsUtxo
        , _wsUsedAddresses   = _v1_wsUsedAddresses
        , _wsChangeAddresses = _v1_wsChangeAddresses
        }
</span></pre></body></html>