<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">-- | Pure functions for operations with transactions</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Client</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>
</span><a name="line-8"></a><span>       </span><span class="hs-special">(</span><span>
</span><a name="line-9"></a><span>       </span><span class="hs-comment">-- * Tx creation params</span><span>
</span><a name="line-10"></a><span>         </span><a href="Pos.Client.Txp.Util.html#InputSelectionPolicy"><span class="hs-identifier hs-type">InputSelectionPolicy</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#PendingAddresses"><span class="hs-identifier hs-type">PendingAddresses</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span>       </span><span class="hs-comment">-- * Tx creation</span><span>
</span><a name="line-14"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#TxCreateMode"><span class="hs-identifier hs-type">TxCreateMode</span></a><span>
</span><a name="line-15"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#makeAbstractTx"><span class="hs-identifier hs-var">makeAbstractTx</span></a><span>
</span><a name="line-16"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#runTxCreator"><span class="hs-identifier hs-var">runTxCreator</span></a><span>
</span><a name="line-17"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#makePubKeyTx"><span class="hs-identifier hs-var">makePubKeyTx</span></a><span>
</span><a name="line-18"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#makeMPubKeyTx"><span class="hs-identifier hs-var">makeMPubKeyTx</span></a><span>
</span><a name="line-19"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#makeMPubKeyTxAddrs"><span class="hs-identifier hs-var">makeMPubKeyTxAddrs</span></a><span>
</span><a name="line-20"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#makeMOfNTx"><span class="hs-identifier hs-var">makeMOfNTx</span></a><span>
</span><a name="line-21"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#makeRedemptionTx"><span class="hs-identifier hs-var">makeRedemptionTx</span></a><span>
</span><a name="line-22"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#createGenericTx"><span class="hs-identifier hs-var">createGenericTx</span></a><span>
</span><a name="line-23"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#createTx"><span class="hs-identifier hs-var">createTx</span></a><span>
</span><a name="line-24"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#createMTx"><span class="hs-identifier hs-var">createMTx</span></a><span>
</span><a name="line-25"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#createMOfNTx"><span class="hs-identifier hs-var">createMOfNTx</span></a><span>
</span><a name="line-26"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#createRedemptionTx"><span class="hs-identifier hs-var">createRedemptionTx</span></a><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span>       </span><span class="hs-comment">-- * Fees logic</span><span>
</span><a name="line-29"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#txToLinearFee"><span class="hs-identifier hs-var">txToLinearFee</span></a><span>
</span><a name="line-30"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#computeTxFee"><span class="hs-identifier hs-var">computeTxFee</span></a><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span>       </span><span class="hs-comment">-- * Additional datatypes</span><span>
</span><a name="line-33"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#TxError"><span class="hs-identifier hs-type">TxError</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#isCheckedTxError"><span class="hs-identifier hs-var">isCheckedTxError</span></a><span>
</span><a name="line-35"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#isNotEnoughMoneyTxError"><span class="hs-identifier hs-var">isNotEnoughMoneyTxError</span></a><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#TxOutputs"><span class="hs-identifier hs-type">TxOutputs</span></a><span>
</span><a name="line-38"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Util.html#TxWithSpendings"><span class="hs-identifier hs-type">TxWithSpendings</span></a><span>
</span><a name="line-39"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">makeLenses</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%=</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.=</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Except</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExceptT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">throwError</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runExceptT</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Default</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Default</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Fixed</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Fixed</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasResolution</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashSet</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HS</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">partition</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tail</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span><span>       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Semigroup</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Set</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Buildable</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span>              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">V</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Formatting</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bprint</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">build</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sformat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stext</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listJson</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Binary.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">biSize</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Client.Txp.Addresses.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Client</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span><span class="hs-operator">.</span><span class="hs-identifier">Addresses</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Client.Txp.Addresses.html#MonadAddresses"><span class="hs-identifier hs-type">MonadAddresses</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TxFeePolicy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TxSizeLinear</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-61"></a><span>                                           </span><span class="hs-identifier hs-var">bvdTxFeePolicy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">calculateTxSizeLinear</span><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>                                           </span><span class="hs-identifier hs-var">coinToInteger</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">integerToCoin</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isRedeemAddress</span><span class="hs-special">,</span><span>
</span><a name="line-63"></a><span>                                           </span><span class="hs-identifier hs-var">txSizeLinearMinValue</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unsafeAddCoin</span><span class="hs-special">,</span><span>
</span><a name="line-64"></a><span>                                           </span><span class="hs-identifier hs-var">unsafeIntegerToCoin</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unsafeSubCoin</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span class="hs-operator">.</span><span class="hs-identifier">Configuration</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasConfiguration</span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RedeemSecretKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SafeSigner</span><span class="hs-special">,</span><span>
</span><a name="line-67"></a><span>                                           </span><span class="hs-identifier hs-type">SignTag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SignRedeemTx</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SignTx</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-68"></a><span>                                           </span><span class="hs-identifier hs-var">deterministicKeyGen</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fakeSigner</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hash</span><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>                                           </span><span class="hs-identifier hs-var">redeemSign</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">redeemToPublic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">safeSign</span><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>                                           </span><span class="hs-identifier hs-var">safeToPublic</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Attributes</span><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkAttributes</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadGState</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">gsAdoptedBVData</span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Script</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Script</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Script</span><span class="hs-operator">.</span><span class="hs-identifier">Examples</span><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">multisigRedeemer</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">multisigValidator</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Txp.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Tx</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TxAux</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TxFee</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TxIn</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-76"></a><span>                                           </span><span class="hs-identifier hs-type">TxInWitness</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TxOut</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TxOutAux</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-77"></a><span>                                           </span><span class="hs-identifier hs-type">TxSigData</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Utxo</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Address</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Coin</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">StakeholderId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkCoin</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sumCoins</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">LogSafe</span><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SecureLog</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">buildUnsecure</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-keyword">type</span><span> </span><a name="TxInputs"><a href="Pos.Client.Txp.Util.html#TxInputs"><span class="hs-identifier">TxInputs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-identifier hs-type">TxIn</span><span>
</span><a name="line-82"></a><span class="hs-keyword">type</span><span> </span><a name="TxOwnedInputs"><a href="Pos.Client.Txp.Util.html#TxOwnedInputs"><span class="hs-identifier">TxOwnedInputs</span></a></a><span> </span><a name="local-6989586621680736686"><a href="#local-6989586621680736686"><span class="hs-identifier">owner</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680736686"><span class="hs-identifier hs-type">owner</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TxIn</span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span class="hs-keyword">type</span><span> </span><a name="TxOutputs"><a href="Pos.Client.Txp.Util.html#TxOutputs"><span class="hs-identifier">TxOutputs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-identifier hs-type">TxOutAux</span><span>
</span><a name="line-84"></a><span class="hs-keyword">type</span><span> </span><a name="TxWithSpendings"><a href="Pos.Client.Txp.Util.html#TxWithSpendings"><span class="hs-identifier">TxWithSpendings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TxAux</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-identifier hs-type">TxOut</span><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-comment">-- | List of addresses which are refered by at least one output of transaction</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- which is not yet confirmed i.e. detected in block.</span><span>
</span><a name="line-88"></a><span class="hs-keyword">newtype</span><span> </span><a name="PendingAddresses"><a href="Pos.Client.Txp.Util.html#PendingAddresses"><span class="hs-identifier">PendingAddresses</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PendingAddresses"><a href="Pos.Client.Txp.Util.html#PendingAddresses"><span class="hs-identifier">PendingAddresses</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">Address</span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Client.Txp.Util.html#TxWithSpendings"><span class="hs-identifier hs-type">TxWithSpendings</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-92"></a><span>    </span><a name="local-8214565720323814995"><span class="hs-identifier">build</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680736701"><a href="#local-6989586621680736701"><span class="hs-identifier">txAux</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680736702"><a href="#local-6989586621680736702"><span class="hs-identifier">neTxOut</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-93"></a><span>        </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;(&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;, &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">listJson</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;)&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680736701"><span class="hs-identifier hs-var">txAux</span></a><span> </span><a href="#local-6989586621680736702"><span class="hs-identifier hs-var">neTxOut</span></a><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-comment">-- This datatype corresponds to raw transaction.</span><span>
</span><a name="line-96"></a><span class="hs-keyword">data</span><span> </span><a name="TxRaw"><a href="Pos.Client.Txp.Util.html#TxRaw"><span class="hs-identifier">TxRaw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TxRaw"><a href="Pos.Client.Txp.Util.html#TxRaw"><span class="hs-identifier">TxRaw</span></a></a><span>
</span><a name="line-97"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="trInputs"><a href="Pos.Client.Txp.Util.html#trInputs"><span class="hs-identifier">trInputs</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Pos.Client.Txp.Util.html#TxOwnedInputs"><span class="hs-identifier hs-type">TxOwnedInputs</span></a><span> </span><span class="hs-identifier hs-type">TxOut</span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>    </span><span class="hs-comment">-- ^ Selected inputs from Utxo</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="trOutputs"><a href="Pos.Client.Txp.Util.html#trOutputs"><span class="hs-identifier">trOutputs</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Client.Txp.Util.html#TxOutputs"><span class="hs-identifier hs-type">TxOutputs</span></a><span>
</span><a name="line-100"></a><span>    </span><span class="hs-comment">-- ^ Output addresses of tx (without remaining output)</span><span>
</span><a name="line-101"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="trRemainingMoney"><a href="Pos.Client.Txp.Util.html#trRemainingMoney"><span class="hs-identifier">trRemainingMoney</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Coin</span><span>
</span><a name="line-102"></a><span>    </span><span class="hs-comment">-- ^ Remaining money</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-keyword">data</span><span> </span><a name="TxError"><a href="Pos.Client.Txp.Util.html#TxError"><span class="hs-identifier">TxError</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-106"></a><span>      </span><a name="NotEnoughMoney"><a href="Pos.Client.Txp.Util.html#NotEnoughMoney"><span class="hs-identifier">NotEnoughMoney</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Coin</span><span>
</span><a name="line-107"></a><span>      </span><span class="hs-comment">-- ^ Parameter: how much more money is needed</span><span>
</span><a name="line-108"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="NotEnoughAllowedMoney"><a href="Pos.Client.Txp.Util.html#NotEnoughAllowedMoney"><span class="hs-identifier">NotEnoughAllowedMoney</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Coin</span><span>
</span><a name="line-109"></a><span>      </span><span class="hs-comment">-- ^ Parameter: how much more money is needed and which available input addresses</span><span>
</span><a name="line-110"></a><span>      </span><span class="hs-comment">-- are present in output addresses set</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="FailedToStabilize"><a href="Pos.Client.Txp.Util.html#FailedToStabilize"><span class="hs-identifier">FailedToStabilize</span></a></a><span>
</span><a name="line-112"></a><span>      </span><span class="hs-comment">-- ^ Parameter: how many attempts were performed</span><span>
</span><a name="line-113"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="OutputIsRedeem"><a href="Pos.Client.Txp.Util.html#OutputIsRedeem"><span class="hs-identifier">OutputIsRedeem</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Address</span><span>
</span><a name="line-114"></a><span>      </span><span class="hs-comment">-- ^ One of the tx outputs is a redemption address</span><span>
</span><a name="line-115"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="RedemptionDepleted"><a href="Pos.Client.Txp.Util.html#RedemptionDepleted"><span class="hs-identifier">RedemptionDepleted</span></a></a><span>
</span><a name="line-116"></a><span>      </span><span class="hs-comment">-- ^ Redemption address has already been used</span><span>
</span><a name="line-117"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="GeneralTxError"><a href="Pos.Client.Txp.Util.html#GeneralTxError"><span class="hs-identifier">GeneralTxError</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-118"></a><span>      </span><span class="hs-comment">-- ^ Parameter: description of the problem</span><span>
</span><a name="line-119"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-identifier">isNotEnoughMoneyTxError</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Client.Txp.Util.html#TxError"><span class="hs-identifier hs-type">TxError</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-122"></a><a name="isNotEnoughMoneyTxError"><a href="Pos.Client.Txp.Util.html#isNotEnoughMoneyTxError"><span class="hs-identifier">isNotEnoughMoneyTxError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-123"></a><span>    </span><a href="Pos.Client.Txp.Util.html#NotEnoughMoney"><span class="hs-identifier hs-var">NotEnoughMoney</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-124"></a><span>    </span><a href="Pos.Client.Txp.Util.html#NotEnoughAllowedMoney"><span class="hs-identifier hs-var">NotEnoughAllowedMoney</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-identifier">_</span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Pos.Client.Txp.Util.html#TxError"><span class="hs-identifier hs-type">TxError</span></a><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Client.Txp.Util.html#TxError"><span class="hs-identifier hs-type">TxError</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-130"></a><span>    </span><a name="local-8214565720323814995"><span class="hs-identifier">build</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Client.Txp.Util.html#NotEnoughMoney"><span class="hs-identifier hs-var">NotEnoughMoney</span></a><span> </span><a name="local-6989586621680736697"><a href="#local-6989586621680736697"><span class="hs-identifier">coin</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-131"></a><span>        </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Transaction creation error: not enough money, need &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; more&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680736697"><span class="hs-identifier hs-var">coin</span></a><span>
</span><a name="line-132"></a><span>    </span><span class="hs-identifier">build</span><span> </span><span class="hs-special">(</span><a href="Pos.Client.Txp.Util.html#NotEnoughAllowedMoney"><span class="hs-identifier hs-var">NotEnoughAllowedMoney</span></a><span> </span><a name="local-6989586621680736698"><a href="#local-6989586621680736698"><span class="hs-identifier">coin</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-133"></a><span>        </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Transaction creation error: not enough money on addresses which are not included \
                \in output addresses set, need &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; more&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680736698"><span class="hs-identifier hs-var">coin</span></a><span>
</span><a name="line-135"></a><span>    </span><span class="hs-identifier">build</span><span> </span><a href="Pos.Client.Txp.Util.html#FailedToStabilize"><span class="hs-identifier hs-var">FailedToStabilize</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-136"></a><span>        </span><span class="hs-string">&quot;Transaction creation error: failed to stabilize fee&quot;</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-identifier">build</span><span> </span><span class="hs-special">(</span><a href="Pos.Client.Txp.Util.html#OutputIsRedeem"><span class="hs-identifier hs-var">OutputIsRedeem</span></a><span> </span><a name="local-6989586621680736699"><a href="#local-6989586621680736699"><span class="hs-identifier">addr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-138"></a><span>        </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Output address &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; is a redemption address&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680736699"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-139"></a><span>    </span><span class="hs-identifier">build</span><span> </span><a href="Pos.Client.Txp.Util.html#RedemptionDepleted"><span class="hs-identifier hs-var">RedemptionDepleted</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-140"></a><span>        </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-string">&quot;Redemption address balance is 0&quot;</span><span>
</span><a name="line-141"></a><span>    </span><span class="hs-identifier">build</span><span> </span><span class="hs-special">(</span><a href="Pos.Client.Txp.Util.html#GeneralTxError"><span class="hs-identifier hs-var">GeneralTxError</span></a><span> </span><a name="local-6989586621680736700"><a href="#local-6989586621680736700"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-142"></a><span>        </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Transaction creation error: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">stext</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680736700"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-identifier">isCheckedTxError</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Client.Txp.Util.html#TxError"><span class="hs-identifier hs-type">TxError</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-145"></a><a name="isCheckedTxError"><a href="Pos.Client.Txp.Util.html#isCheckedTxError"><span class="hs-identifier">isCheckedTxError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-146"></a><span>    </span><a href="Pos.Client.Txp.Util.html#NotEnoughMoney"><span class="hs-identifier hs-var">NotEnoughMoney</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-147"></a><span>    </span><a href="Pos.Client.Txp.Util.html#NotEnoughAllowedMoney"><span class="hs-identifier hs-var">NotEnoughAllowedMoney</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-148"></a><span>    </span><a href="Pos.Client.Txp.Util.html#FailedToStabilize"><span class="hs-identifier hs-var">FailedToStabilize</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-149"></a><span>    </span><a href="Pos.Client.Txp.Util.html#OutputIsRedeem"><span class="hs-identifier hs-var">OutputIsRedeem</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-150"></a><span>    </span><a href="Pos.Client.Txp.Util.html#RedemptionDepleted"><span class="hs-identifier hs-var">RedemptionDepleted</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-151"></a><span>    </span><a href="Pos.Client.Txp.Util.html#GeneralTxError"><span class="hs-identifier hs-var">GeneralTxError</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- Tx creation</span><span>
</span><a name="line-155"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-comment">-- | Specifies the way Uxtos are going to be grouped.</span><span>
</span><a name="line-158"></a><span class="hs-keyword">data</span><span> </span><a name="InputSelectionPolicy"><a href="Pos.Client.Txp.Util.html#InputSelectionPolicy"><span class="hs-identifier">InputSelectionPolicy</span></a></a><span>
</span><a name="line-159"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="OptimizeForSecurity"><a href="Pos.Client.Txp.Util.html#OptimizeForSecurity"><span class="hs-identifier">OptimizeForSecurity</span></a></a><span>       </span><span class="hs-comment">-- ^ Spend everything from the address</span><span>
</span><a name="line-160"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="OptimizeForHighThroughput"><a href="Pos.Client.Txp.Util.html#OptimizeForHighThroughput"><span class="hs-identifier">OptimizeForHighThroughput</span></a></a><span> </span><span class="hs-comment">-- ^ No grouping, prefer confirmed addresses</span><span>
</span><a name="line-161"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Client.Txp.Util.html#InputSelectionPolicy"><span class="hs-identifier hs-type">InputSelectionPolicy</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-164"></a><span>    </span><a name="local-8214565720323814995"><span class="hs-identifier">build</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-165"></a><span>        </span><a href="Pos.Client.Txp.Util.html#OptimizeForSecurity"><span class="hs-identifier hs-var">OptimizeForSecurity</span></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;securely&quot;</span><span>
</span><a name="line-166"></a><span>        </span><a href="Pos.Client.Txp.Util.html#OptimizeForHighThroughput"><span class="hs-identifier hs-var">OptimizeForHighThroughput</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;high throughput&quot;</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SecureLog</span><span> </span><a href="Pos.Client.Txp.Util.html#InputSelectionPolicy"><span class="hs-identifier hs-type">InputSelectionPolicy</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-169"></a><span>    </span><a name="local-8214565720323814995"><span class="hs-identifier">build</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">buildUnsecure</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Default</span><span> </span><a href="Pos.Client.Txp.Util.html#InputSelectionPolicy"><span class="hs-identifier hs-type">InputSelectionPolicy</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-172"></a><span>    </span><a name="local-8214565720323928960"><span class="hs-identifier">def</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Client.Txp.Util.html#OptimizeForSecurity"><span class="hs-identifier hs-var">OptimizeForSecurity</span></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-comment">-- | Mode for creating transactions. We need to know fee policy.</span><span>
</span><a name="line-175"></a><span class="hs-keyword">type</span><span> </span><a name="TxDistrMode"><a href="Pos.Client.Txp.Util.html#TxDistrMode"><span class="hs-identifier">TxDistrMode</span></a></a><span> </span><a name="local-6989586621680736685"><a href="#local-6989586621680736685"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-176"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">MonadGState</span><span> </span><a href="#local-6989586621680736685"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-177"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasConfiguration</span><span>
</span><a name="line-178"></a><span>       </span><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-keyword">type</span><span> </span><a name="TxCreateMode"><a href="Pos.Client.Txp.Util.html#TxCreateMode"><span class="hs-identifier">TxCreateMode</span></a></a><span> </span><a name="local-6989586621680736684"><a href="#local-6989586621680736684"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-181"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="Pos.Client.Txp.Util.html#TxDistrMode"><span class="hs-identifier hs-type">TxDistrMode</span></a><span> </span><a href="#local-6989586621680736684"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-182"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.Addresses.html#MonadAddresses"><span class="hs-identifier hs-type">MonadAddresses</span></a><span> </span><a href="#local-6989586621680736684"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-183"></a><span>      </span><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-comment">-- | Generic function to create a transaction, given desired inputs,</span><span>
</span><a name="line-186"></a><span class="hs-comment">-- outputs and a way to construct witness from signature data</span><span>
</span><a name="line-187"></a><span class="hs-identifier">makeAbstractTx</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680736687"><span class="hs-identifier hs-type">owner</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TxSigData</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TxInWitness</span><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Client.Txp.Util.html#TxOwnedInputs"><span class="hs-identifier hs-type">TxOwnedInputs</span></a><span> </span><a href="#local-6989586621680736687"><span class="hs-identifier hs-type">owner</span></a><span>
</span><a name="line-189"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Client.Txp.Util.html#TxOutputs"><span class="hs-identifier hs-type">TxOutputs</span></a><span>
</span><a name="line-190"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TxAux</span><span>
</span><a name="line-191"></a><a name="makeAbstractTx"><a href="Pos.Client.Txp.Util.html#makeAbstractTx"><span class="hs-identifier">makeAbstractTx</span></a></a><span> </span><a name="local-6989586621680736688"><a href="#local-6989586621680736688"><span class="hs-identifier">mkWit</span></a></a><span> </span><a name="local-6989586621680736689"><a href="#local-6989586621680736689"><span class="hs-identifier">txInputs</span></a></a><span> </span><a name="local-6989586621680736690"><a href="#local-6989586621680736690"><span class="hs-identifier">outputs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TxAux</span><span> </span><a href="#local-6989586621680736691"><span class="hs-identifier hs-var">tx</span></a><span> </span><a href="#local-6989586621680736694"><span class="hs-identifier hs-var">txWitness</span></a><span>
</span><a name="line-192"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-193"></a><span>    </span><a name="local-6989586621680736691"><a href="#local-6989586621680736691"><span class="hs-identifier">tx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">UnsafeTx</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621680736689"><span class="hs-identifier hs-var">txInputs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680736692"><span class="hs-identifier hs-var">txOutputs</span></a><span> </span><a href="#local-6989586621680736693"><span class="hs-identifier hs-var">txAttributes</span></a><span>
</span><a name="line-194"></a><span>    </span><a name="local-6989586621680736692"><a href="#local-6989586621680736692"><span class="hs-identifier">txOutputs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">toaOut</span><span> </span><a href="#local-6989586621680736690"><span class="hs-identifier hs-var">outputs</span></a><span>
</span><a name="line-195"></a><span>    </span><a name="local-6989586621680736693"><a href="#local-6989586621680736693"><span class="hs-identifier">txAttributes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkAttributes</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>    </span><a name="local-6989586621680736694"><a href="#local-6989586621680736694"><span class="hs-identifier">txWitness</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">V</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680736689"><span class="hs-identifier hs-var">txInputs</span></a><span> </span><span class="hs-operator hs-var">&lt;&amp;&gt;</span><span>
</span><a name="line-197"></a><span>        </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621680736696"><a href="#local-6989586621680736696"><span class="hs-identifier">addr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680736688"><span class="hs-identifier hs-var">mkWit</span></a><span> </span><a href="#local-6989586621680736696"><span class="hs-identifier hs-var">addr</span></a><span> </span><a href="#local-6989586621680736695"><span class="hs-identifier hs-var">txSigData</span></a><span>
</span><a name="line-198"></a><span>    </span><a name="local-6989586621680736695"><a href="#local-6989586621680736695"><span class="hs-identifier">txSigData</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TxSigData</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">txSigTxHash</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hash</span><span> </span><a href="#local-6989586621680736691"><span class="hs-identifier hs-var">tx</span></a><span>
</span><a name="line-200"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-comment">-- | Datatype which contains all data from DB which is necessary</span><span>
</span><a name="line-203"></a><span class="hs-comment">-- to create transactions</span><span>
</span><a name="line-204"></a><span class="hs-keyword">data</span><span> </span><a name="TxCreatorData"><a href="Pos.Client.Txp.Util.html#TxCreatorData"><span class="hs-identifier">TxCreatorData</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TxCreatorData"><a href="Pos.Client.Txp.Util.html#TxCreatorData"><span class="hs-identifier">TxCreatorData</span></a></a><span>
</span><a name="line-205"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="_tcdFeePolicy"><a href="Pos.Client.Txp.Util.html#_tcdFeePolicy"><span class="hs-identifier">_tcdFeePolicy</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">TxFeePolicy</span><span>
</span><a name="line-206"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="_tcdInputSelectionPolicy"><a href="Pos.Client.Txp.Util.html#_tcdInputSelectionPolicy"><span class="hs-identifier">_tcdInputSelectionPolicy</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Client.Txp.Util.html#InputSelectionPolicy"><span class="hs-identifier hs-type">InputSelectionPolicy</span></a><span>
</span><a name="line-207"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-char">''TxCreatorData

-- | Transformer which holds data necessary for creating transactions
type TxCreator m = ReaderT TxCreatorData (ExceptT TxError m)

runTxCreator
    :: TxDistrMode m
    =&gt; InputSelectionPolicy
    -&gt; TxCreator m a
    -&gt; m (Either TxError a)
runTxCreator inputSelectionPolicy action = runExceptT $ do
    _tcdFeePolicy &lt;- bvdTxFeePolicy &lt;$&gt; gsAdoptedBVData
    let _tcdInputSelectionPolicy = inputSelectionPolicy
    runReaderT action TxCreatorData{..}

-- | Like 'makePubKeyTx', but allows usage of different signers
makeMPubKeyTx
    :: HasConfiguration
    =&gt; (owner -&gt; SafeSigner)
    -&gt; TxOwnedInputs owner
    -&gt; TxOutputs
    -&gt; TxAux
makeMPubKeyTx getSs = makeAbstractTx mkWit
  where mkWit addr sigData =
          let ss = getSs addr
          in PkWitness
              { twKey = safeToPublic ss
              , twSig = safeSign SignTx ss sigData
              }

-- | More specific version of 'makeMPubKeyTx' for convenience
makeMPubKeyTxAddrs
    :: HasConfiguration
    =&gt; (Address -&gt; SafeSigner)
    -&gt; TxOwnedInputs TxOut
    -&gt; TxOutputs
    -&gt; TxAux
makeMPubKeyTxAddrs hdwSigners = makeMPubKeyTx getSigner
  where
    getSigner (TxOut addr _) = hdwSigners addr

-- | Makes a transaction which use P2PKH addresses as a source
makePubKeyTx :: HasConfiguration =&gt; SafeSigner -&gt; TxInputs -&gt; TxOutputs -&gt; TxAux
makePubKeyTx ss txInputs =
    makeMPubKeyTx (const ss) (map ((), ) txInputs)

makeMOfNTx :: HasConfiguration =&gt; Script -&gt; [Maybe SafeSigner] -&gt; TxInputs -&gt; TxOutputs -&gt; TxAux
makeMOfNTx validator sks txInputs = makeAbstractTx mkWit (map ((), ) txInputs)
  where mkWit _ sigData = ScriptWitness
            { twValidator = validator
            , twRedeemer = multisigRedeemer sigData sks
            }

makeRedemptionTx :: HasConfiguration =&gt; RedeemSecretKey -&gt; TxInputs -&gt; TxOutputs -&gt; TxAux
makeRedemptionTx rsk txInputs = makeAbstractTx mkWit (map ((), ) txInputs)
  where rpk = redeemToPublic rsk
        mkWit _ sigData = RedeemWitness
            { twRedeemKey = rpk
            , twRedeemSig = redeemSign SignRedeemTx rsk sigData
            }

-- | Helper for summing values of `TxOutAux`s
sumTxOutCoins :: NonEmpty TxOutAux -&gt; Integer
sumTxOutCoins = sumCoins . map (txOutValue . toaOut)

integerToFee :: MonadError TxError m =&gt; Integer -&gt; m TxFee
integerToFee =
    either (throwError . invalidFee) (pure . TxFee) . integerToCoin
  where
    invalidFee reason = GeneralTxError (&quot;Invalid fee: &quot; &lt;&gt; reason)

fixedToFee :: (MonadError TxError m, HasResolution a) =&gt; Fixed a -&gt; m TxFee
fixedToFee = integerToFee . ceiling

type FlatUtxo = [(TxIn, TxOutAux)]
type InputPickingWay = Utxo -&gt; TxOutputs -&gt; Coin -&gt; Either TxError FlatUtxo

-- TODO [CSM-526] Scatter on submodules

-------------------------------------------------------------------------
-- Simple inputs picking
-------------------------------------------------------------------------

data InputPickerState = InputPickerState
    { _ipsMoneyLeft        :: !Coin
    , _ipsAvailableOutputs :: !FlatUtxo
    }

makeLenses ''InputPickerState

type InputPicker = StateT InputPickerState (Either TxError)

plainInputPicker :: PendingAddresses -&gt; InputPickingWay
plainInputPicker (PendingAddresses pendingAddrs) utxo _outputs moneyToSpent =
    evalStateT (pickInputs []) (InputPickerState moneyToSpent sortedUnspent)
  where
    onlyConfirmedInputs :: Set.Set Address -&gt; (TxIn, TxOutAux) -&gt; Bool
    onlyConfirmedInputs addrs (_, (TxOutAux (TxOut addr _))) = not (addr `Set.member` addrs)
    --
    -- NOTE (adinapoli, kantp) Under certain circumstances, it's still possible for the `confirmed` set
    -- to be exhausted and for the utxo to be picked from the `unconfirmed`, effectively allowing for the
    -- old &quot;slow&quot; behaviour which could create linear chains of dependent transactions which can then be
    -- submitted to relays and possibly fail to be accepted if they arrive in an out-of-order fashion,
    -- effectively piling up in the mempool of the edgenode and in need to be resubmitted.
    -- However, this policy significantly reduce the likelyhood of such edge case to happen, as for exchanges
    -- the `confirmed` set would tend to be quite big anyway.
    -- We should revisit such policy and its implications during a proper rewrite.
    --
    -- NOTE (adinapoli, kantp) There is another subtle corner case which involves such partitioning; it's now
    -- in theory (by absurd reasoning) for the `confirmed` set to contain only dust, which would yes involve a
    -- &quot;high throughput&quot; Tx but also a quite large one, bringing it closely to the &quot;Toil too large&quot; error
    -- (The same malady the @OptimiseForSecurity@ policy was affected by).
    sortedUnspent = confirmed ++ unconfirmed

    (confirmed, unconfirmed) =
      -- Give precedence to &quot;confirmed&quot; addresses.
      partition (onlyConfirmedInputs pendingAddrs)
                (sortOn (Down . txOutValue . toaOut . snd) (M.toList utxo))

    pickInputs :: FlatUtxo -&gt; InputPicker FlatUtxo
    pickInputs inps = do
        moneyLeft &lt;- use ipsMoneyLeft
        if moneyLeft == mkCoin 0
            then return inps
            else do
            mNextOut &lt;- head &lt;$&gt; use ipsAvailableOutputs
            case mNextOut of
                Nothing -&gt; throwError $ NotEnoughMoney moneyLeft
                Just inp@(_, (TxOutAux (TxOut {..}))) -&gt; do
                    ipsMoneyLeft .= unsafeSubCoin moneyLeft (min txOutValue moneyLeft)
                    ipsAvailableOutputs %= tail
                    pickInputs (inp : inps)

-------------------------------------------------------------------------
-- Grouped inputs picking
-------------------------------------------------------------------------

-- | Group of unspent transaction outputs which belongs
-- to one address
data UtxoGroup = UtxoGroup
    { ugAddr       :: !Address
    , ugTotalMoney :: !Coin
    , ugUtxo       :: !(NonEmpty (TxIn, TxOutAux))
    } deriving (Show)

-- | Group unspent outputs by addresses
groupUtxo :: Utxo -&gt; [UtxoGroup]
groupUtxo utxo =
    map mkUtxoGroup preUtxoGroups
  where
    futxo = M.toList utxo
    preUtxoGroups = NE.groupAllWith (txOutAddress . toaOut . snd) futxo
    mkUtxoGroup ugUtxo@(sample :| _) =
        let ugAddr = txOutAddress . toaOut . snd $ sample
            ugTotalMoney = unsafeIntegerToCoin . sumTxOutCoins $
                map snd ugUtxo
        in UtxoGroup {..}

data GroupedInputPickerState = GroupedInputPickerState
    { _gipsMoneyLeft             :: !Coin
    , _gipsAvailableOutputGroups :: ![UtxoGroup]
    }

makeLenses ''GroupedInputPickerState

type GroupedInputPicker = StateT GroupedInputPickerState (Either TxError)

groupedInputPicker :: InputPickingWay
groupedInputPicker utxo outputs moneyToSpent =
    evalStateT (pickInputs []) (GroupedInputPickerState moneyToSpent sortedGroups)
  where
    gUtxo = groupUtxo utxo
    outputAddrsSet = foldl' (flip HS.insert) mempty $
        map (txOutAddress . toaOut) outputs
    isOutputAddr = flip HS.member outputAddrsSet
    sortedGroups = sortOn (Down . ugTotalMoney) $
        filter (not . isOutputAddr . ugAddr) gUtxo
    disallowedInputGroups = filter (isOutputAddr . ugAddr) gUtxo
    disallowedMoney = sumCoins $ map ugTotalMoney disallowedInputGroups

    pickInputs :: FlatUtxo -&gt; GroupedInputPicker FlatUtxo
    pickInputs inps = do
        moneyLeft &lt;- use gipsMoneyLeft
        if moneyLeft == mkCoin 0
            then return inps
            else do
                mNextOutGroup &lt;- head &lt;$&gt; use gipsAvailableOutputGroups
                case mNextOutGroup of
                    Nothing -&gt; if disallowedMoney &gt;= coinToInteger moneyLeft
                        then throwError $ NotEnoughAllowedMoney moneyLeft
                        else throwError $ NotEnoughMoney moneyLeft
                    Just UtxoGroup {..} -&gt; do
                        gipsMoneyLeft .= unsafeSubCoin moneyLeft (min ugTotalMoney moneyLeft)
                        gipsAvailableOutputGroups %= tail
                        pickInputs (toList ugUtxo ++ inps)

-------------------------------------------------------------------------
-- Further logic
-------------------------------------------------------------------------

-- | Given filtered Utxo, desired outputs and fee size,
-- prepare correct inputs and outputs for transaction
-- (and tell how much to send to remaining address)
prepareTxRawWithPicker
    :: Monad m
    =&gt; InputPickingWay
    -&gt; Utxo
    -&gt; TxOutputs
    -&gt; TxFee
    -&gt; TxCreator m TxRaw
prepareTxRawWithPicker inputPicker utxo outputs (TxFee fee) = do
    mapM_ (checkIsNotRedeemAddr . txOutAddress . toaOut) outputs

    totalMoney &lt;- sumTxOuts outputs
    when (totalMoney == mkCoin 0) $
        throwError $ GeneralTxError &quot;Attempted to send 0 money&quot;

    let moneyToSpent = totalMoney `unsafeAddCoin` fee
    futxo &lt;- either throwError pure $ inputPicker utxo outputs moneyToSpent
    case nonEmpty futxo of
        Nothing       -&gt; throwError $ GeneralTxError &quot;Failed to prepare inputs!&quot;
        Just inputsNE -&gt; do
            totalTxAmount &lt;- sumTxOuts $ map snd inputsNE
            let trInputs = map formTxInputs inputsNE
                trRemainingMoney = totalTxAmount `unsafeSubCoin` moneyToSpent
            let trOutputs = outputs
            pure TxRaw {..}
  where
    sumTxOuts = either (throwError . GeneralTxError) pure .
        integerToCoin . sumTxOutCoins
    formTxInputs (inp, TxOutAux txOut) = (txOut, inp)
    checkIsNotRedeemAddr outAddr =
        when (isRedeemAddress outAddr) $
            throwError $ OutputIsRedeem outAddr

prepareTxRaw
    :: Monad m
    =&gt; PendingAddresses
    -&gt; Utxo
    -&gt; TxOutputs
    -&gt; TxFee
    -&gt; TxCreator m TxRaw
prepareTxRaw pendingTx utxo outputs fee = do
    inputSelectionPolicy &lt;- view tcdInputSelectionPolicy
    let inputPicker =
          case inputSelectionPolicy of
            OptimizeForHighThroughput -&gt; plainInputPicker pendingTx
            OptimizeForSecurity       -&gt; groupedInputPicker
    prepareTxRawWithPicker inputPicker utxo outputs fee

-- Returns set of tx outputs including change output (if it's necessary)
mkOutputsWithRem
    :: TxCreateMode m
    =&gt; AddrData m
    -&gt; TxRaw
    -&gt; TxCreator m TxOutputs
mkOutputsWithRem addrData TxRaw {..}
    | trRemainingMoney == mkCoin 0 = pure trOutputs
    | otherwise = do
        changeAddr &lt;- lift . lift $ getNewAddress addrData
        let txOut = TxOut changeAddr trRemainingMoney
        pure $ TxOutAux txOut :| toList trOutputs

prepareInpsOuts
    :: TxCreateMode m
    =&gt; PendingAddresses
    -&gt; Utxo
    -&gt; TxOutputs
    -&gt; AddrData m
    -&gt; TxCreator m (TxOwnedInputs TxOut, TxOutputs)
prepareInpsOuts pendingTx utxo outputs addrData = do
    txRaw@TxRaw {..} &lt;- prepareTxWithFee pendingTx utxo outputs
    outputsWithRem &lt;- mkOutputsWithRem addrData txRaw
    pure (trInputs, outputsWithRem)

createGenericTx
    :: TxCreateMode m
    =&gt; PendingAddresses
    -&gt; (TxOwnedInputs TxOut -&gt; TxOutputs -&gt; TxAux)
    -&gt; InputSelectionPolicy
    -&gt; Utxo
    -&gt; TxOutputs
    -&gt; AddrData m
    -&gt; m (Either TxError TxWithSpendings)
createGenericTx pendingTx creator inputSelectionPolicy utxo outputs addrData =
    runTxCreator inputSelectionPolicy $ do
        (inps, outs) &lt;- prepareInpsOuts pendingTx utxo outputs addrData
        pure (creator inps outs, map fst inps)

createGenericTxSingle
    :: TxCreateMode m
    =&gt; PendingAddresses
    -&gt; (TxInputs -&gt; TxOutputs -&gt; TxAux)
    -&gt; InputSelectionPolicy
    -&gt; Utxo
    -&gt; TxOutputs
    -&gt; AddrData m
    -&gt; m (Either TxError TxWithSpendings)
createGenericTxSingle pendingTx creator = createGenericTx pendingTx (creator . map snd)

-- | Make a multi-transaction using given secret key and info for outputs.
-- Currently used for HD wallets only, thus `HDAddressPayload` is required
createMTx
    :: TxCreateMode m
    =&gt; PendingAddresses
    -&gt; InputSelectionPolicy
    -&gt; Utxo
    -&gt; (Address -&gt; SafeSigner)
    -&gt; TxOutputs
    -&gt; AddrData m
    -&gt; m (Either TxError TxWithSpendings)
createMTx pendingTx groupInputs utxo hdwSigners outputs addrData =
    createGenericTx pendingTx (makeMPubKeyTxAddrs hdwSigners)
    groupInputs utxo outputs addrData

-- | Make a multi-transaction using given secret key and info for
-- outputs.
createTx
    :: TxCreateMode m
    =&gt; PendingAddresses
    -&gt; Utxo
    -&gt; SafeSigner
    -&gt; TxOutputs
    -&gt; AddrData m
    -&gt; m (Either TxError TxWithSpendings)
createTx pendingTx utxo ss outputs addrData =
    createGenericTxSingle pendingTx (makePubKeyTx ss)
    OptimizeForSecurity utxo outputs addrData

-- | Make a transaction, using M-of-N script as a source
createMOfNTx
    :: TxCreateMode m
    =&gt; PendingAddresses
    -&gt; Utxo
    -&gt; [(StakeholderId, Maybe SafeSigner)]
    -&gt; TxOutputs
    -&gt; AddrData m
    -&gt; m (Either TxError TxWithSpendings)
createMOfNTx pendingTx utxo keys outputs addrData =
    createGenericTxSingle pendingTx (makeMOfNTx validator sks)
    OptimizeForSecurity utxo outputs addrData
  where
    ids = map fst keys
    sks = map snd keys
    m = length $ filter isJust sks
    validator = multisigValidator m ids

-- | Make a transaction for retrieving money from redemption address
createRedemptionTx
    :: TxCreateMode m
    =&gt; Utxo
    -&gt; RedeemSecretKey
    -&gt; TxOutputs
    -&gt; m (Either TxError TxAux)
createRedemptionTx utxo rsk outputs =
    runTxCreator whetherGroupedInputs $ do
        TxRaw {..} &lt;- prepareTxRaw mempty utxo outputs (TxFee $ mkCoin 0)
        let bareInputs = snd &lt;$&gt; trInputs
        pure $ makeRedemptionTx rsk bareInputs trOutputs
  where
    -- always spend redeem address fully
    whetherGroupedInputs = OptimizeForSecurity

-----------------------------------------------------------------------------
-- Fees logic
-----------------------------------------------------------------------------

-- | Helper function to reduce code duplication
withLinearFeePolicy
    :: Monad m
    =&gt; (TxSizeLinear -&gt; TxCreator m a)
    -&gt; TxCreator m a
withLinearFeePolicy action = view tcdFeePolicy &gt;&gt;= \case
    TxFeePolicyUnknown w _ -&gt; throwError $ GeneralTxError $
        sformat (&quot;Unknown fee policy, tag: &quot;%build) w
    TxFeePolicyTxSizeLinear linearPolicy -&gt;
        action linearPolicy

-- | Prepare transaction considering fees
prepareTxWithFee
    :: (HasConfiguration, Monad m)
    =&gt; PendingAddresses
    -&gt; Utxo
    -&gt; TxOutputs
    -&gt; TxCreator m TxRaw
prepareTxWithFee pendingTx utxo outputs = withLinearFeePolicy $ \linearPolicy -&gt;
    stabilizeTxFee pendingTx linearPolicy utxo outputs

-- | Compute, how much fees we should pay to send money to given
-- outputs
computeTxFee
    :: (HasConfiguration, Monad m)
    =&gt; PendingAddresses
    -&gt; Utxo
    -&gt; TxOutputs
    -&gt; TxCreator m TxFee
computeTxFee pendingTx utxo outputs = do
    TxRaw {..} &lt;- prepareTxWithFee pendingTx utxo outputs
    let outAmount = sumTxOutCoins trOutputs
        inAmount = sumCoins $ map (txOutValue . fst) trInputs
        remaining = coinToInteger trRemainingMoney
    integerToFee $ inAmount - outAmount - remaining

-- | Search such spendings that transaction's fee would be stable.
--
-- Stabilisation is simple iterative algorithm which performs
-- @ fee &lt;- minFee( tx(fee) ) @ per iteration step.
-- It does *not* guarantee to find minimal possible fee, but is expected
-- to converge in O(|utxo|) steps, where @ utxo @ a set of addresses
-- encountered in utxo.
--
-- Alogrithm consists of two stages:
--
-- 1. Iterate until @ fee_{i+1} &lt;= fee_i @.
-- It can last for no more than @ ~2 * |utxo| @ iterations. Really, let's
-- consider following cases:
--
--     * Number of used input addresses increased at i-th iteration, i.e.
--       @ |inputs(tx(fee_i))| &gt; |inputs(tx(fee_{i-1}))| @,
--       which can happen no more than |utxo| times.
--
--     * Number of tx input addresses stayed the same, i.e.
--       @ |inputs(tx(fee_i))| = |inputs(tx(fee_{i-1}))| @.
--
--       If @ fee_i &lt;= fee_{i-1} @ then stage 1 has already finished. Otherwise,
--       since inputs and outputs are picked deterministically, inputs and
--       outputs for @ tx(fee_i) @ and @ tx(fee_{i-1}) @ are the same and they
--       differ only in remainder amount. Since we assume @ fee_i &gt; fee_{i-1} @,
--       then @ rem(tx(fee_i)) &lt; rem(tx(fee_{i-1})) @ by evaluation method.
--       It leads to @ size(tx(fee_i)) &lt;= size(tx(fee_{i-1})) @ and thus
--       @ minFee(tx(fee_i)) &lt;= minFee(tx(fee_{i-1})) @,
--       i.e. @ fee_{i+1} &lt;= fee_{i} @.
--
--     * Number if input addresses decreased.
--       Is may occur when fee increases more than on current remainder.
--       Is this case fee on next iteration would indeed decrease, because
--       size of single input is much greater than any fluctuations of
--       remainder size (in bytes).
--
-- In total, case (1) occurs no more than |utxo| times, case (2) is always
-- followed by case (1), and case (3) terminates current stage immediatelly,
-- thus stage 1 takes no more than, approximatelly, @ 2 * |utxo| @ iterations.
--
-- 2. Once we find such @ i @ for which @ fee_{i+1} &lt;= fee_i @, we can return
-- @ tx(fee_i) @ as answer, but it may contain overestimated fee (which is still
-- valid).
-- To possibly find better solutions we iterate for several times more.
stabilizeTxFee
    :: forall m. (HasConfiguration, Monad m)
    =&gt; PendingAddresses
    -&gt; TxSizeLinear
    -&gt; Utxo
    -&gt; TxOutputs
    -&gt; TxCreator m TxRaw
stabilizeTxFee pendingTx linearPolicy utxo outputs = do
    minFee &lt;- fixedToFee (txSizeLinearMinValue linearPolicy)
    mtx &lt;- stabilizeTxFeeDo (False, firstStageAttempts) minFee
    case mtx of
        Nothing -&gt; throwError FailedToStabilize
        Just tx -&gt; pure $ tx &amp; \(S.Min (S.Arg _ txRaw)) -&gt; txRaw
  where
    firstStageAttempts = 2 * length utxo + 5
    secondStageAttempts = 10

    stabilizeTxFeeDo :: (Bool, Int)
                     -&gt; TxFee
                     -&gt; TxCreator m $ Maybe (S.ArgMin TxFee TxRaw)
    stabilizeTxFeeDo (_, 0) _ = pure Nothing
    stabilizeTxFeeDo (isSecondStage, attempt) expectedFee = do
        txRaw &lt;- prepareTxRaw pendingTx utxo outputs expectedFee
        txMinFee &lt;- txToLinearFee linearPolicy $
                    createFakeTxFromRawTx txRaw

        let txRawWithFee = S.Min $ S.Arg expectedFee txRaw
        let iterateDo step = stabilizeTxFeeDo step txMinFee
        case expectedFee `compare` txMinFee of
            LT -&gt; iterateDo (isSecondStage, attempt - 1)
            EQ -&gt; pure (Just txRawWithFee)
            GT -&gt; do
                let nextStep = (True, if isSecondStage then attempt - 1 else secondStageAttempts)
                futureRes &lt;- iterateDo nextStep
                return $! Just txRawWithFee S.&lt;&gt; futureRes

-- | Calcucate linear fee from transaction's size
txToLinearFee
    :: MonadError TxError m
    =&gt; TxSizeLinear -&gt; TxAux -&gt; m TxFee
txToLinearFee linearPolicy =
    fixedToFee .
    calculateTxSizeLinear linearPolicy .
    biSize @TxAux

-- | Function is used to calculate intermediate fee amounts
-- when forming a transaction
createFakeTxFromRawTx :: HasConfiguration =&gt; TxRaw -&gt; TxAux
createFakeTxFromRawTx TxRaw{..} =
    let fakeAddr = txOutAddress . toaOut . NE.head $ trOutputs
        fakeOutMB
            | trRemainingMoney == mkCoin 0 = Nothing
            | otherwise =
                Just $
                TxOutAux (TxOut fakeAddr trRemainingMoney)
        txOutsWithRem = maybe trOutputs (\remTx -&gt; remTx :| toList trOutputs) fakeOutMB

        -- We create fake signers instead of safe signers,
        -- because safe signer requires passphrase
        -- but we don't want to reveal our passphrase to compute fee.
        -- Fee depends on size of tx in bytes, sign of a tx has the fixed size
        -- so we can use arbitrary signer.
        (_, fakeSK) = deterministicKeyGen &quot;patakbardaqskovoroda228pva1488kk&quot;
    in makeMPubKeyTxAddrs (const (fakeSigner fakeSK)) trInputs txOutsWithRem
</span></pre></body></html>