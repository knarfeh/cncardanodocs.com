<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ApplicativeDo  #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE CPP            #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">-- following Pos.Util.UserSecret</span><span>
</span><a name="line-6"></a><span class="hs-cpp">#if !defined(mingw32_HOST_OS)</span><span>
</span><a name="line-7"></a><span class="hs-cpp">#define POSIX</span><span>
</span><a name="line-8"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-comment">-- | Command line interface for specifying the network config</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">CLI</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>    </span><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier hs-type">NetworkConfigOpts</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigException"><span class="hs-identifier hs-type">NetworkConfigException</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Pos.Network.CLI.html#networkConfigOption"><span class="hs-identifier hs-var">networkConfigOption</span></a><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Pos.Network.CLI.html#ipv4ToNetworkAddress"><span class="hs-identifier hs-var">ipv4ToNetworkAddress</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Pos.Network.CLI.html#intNetworkConfigOpts"><span class="hs-identifier hs-var">intNetworkConfigOpts</span></a><span>
</span><a name="line-17"></a><span>    </span><span class="hs-comment">-- * Exported primilary for testing</span><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Pos.Network.CLI.html#readTopology"><span class="hs-identifier hs-var">readTopology</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Pos.Network.CLI.html#readPolicies"><span class="hs-identifier hs-var">readPolicies</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Pos.Network.CLI.html#fromPovOf"><span class="hs-identifier hs-var">fromPovOf</span></a><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exception</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Char8</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span class="hs-operator">.</span><span class="hs-identifier">C8</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IP</span><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IPv4</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromJust</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Yaml</span><span>                       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Yaml</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Formatting</span><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sformat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">shown</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Mockable</span><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Catch</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Mockable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Throw</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fork</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throw</span><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>                                                  </span><span class="hs-identifier hs-var">try</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Mockable</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Broadcast</span><span class="hs-operator">.</span><span class="hs-identifier">OutboundQueue</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Alts</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Peers</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">peersFromList</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">DNS</span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DNS</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Options</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Opt</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.DHT.Real.Param.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DHT</span><span class="hs-operator">.</span><span class="hs-identifier">Real</span><span class="hs-operator">.</span><span class="hs-identifier">Param</span></a><span>              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DHT</span><span> </span><span class="hs-special">(</span><a href="Pos.DHT.Real.Param.html#KademliaParams"><span class="hs-identifier hs-type">KademliaParams</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>                                                         </span><a href="Pos.DHT.Real.Param.html#MalformedDHTKey"><span class="hs-identifier hs-type">MalformedDHTKey</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>                                                         </span><a href="Pos.DHT.Real.Param.html#fromYamlConfig"><span class="hs-identifier hs-var">fromYamlConfig</span></a><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Network.DnsDomains.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">DnsDomains</span></a><span>          </span><span class="hs-special">(</span><a href="Pos.Network.DnsDomains.html#DnsDomains"><span class="hs-identifier hs-type">DnsDomains</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Network.DnsDomains.html#NodeAddr"><span class="hs-identifier hs-type">NodeAddr</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Network.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NodeId</span><span class="hs-special">,</span><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.Network.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Network.Yaml.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Yaml</span></a><span>                </span><span class="hs-special">(</span><a href="Pos.Network.Yaml.html#NodeMetadata"><span class="hs-identifier hs-type">NodeMetadata</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.Network.Yaml.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Yaml</span></a><span>                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Y</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.TimeWarp.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">TimeWarp</span></a><span>               </span><span class="hs-special">(</span><a href="Pos.Util.TimeWarp.html#NetworkAddress"><span class="hs-identifier hs-type">NetworkAddress</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Util.TimeWarp.html#addressToNodeId"><span class="hs-identifier hs-var">addressToNodeId</span></a><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Wlog</span><span class="hs-operator">.</span><span class="hs-identifier">CanLog</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WithLogger</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logError</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logNotice</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-cpp">#ifdef POSIX</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.SigHandler.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">SigHandler</span></a><span>             </span><span class="hs-special">(</span><a href="Pos.Util.SigHandler.html#Signal"><span class="hs-identifier hs-type">Signal</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Util.SigHandler.html#installHandler"><span class="hs-identifier hs-var">installHandler</span></a><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Command line arguments
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-keyword">data</span><span> </span><a name="NetworkConfigOpts"><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier">NetworkConfigOpts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NetworkConfigOpts"><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier">NetworkConfigOpts</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-58"></a><span>      </span><span class="hs-comment">-- | Filepath to .yaml file with the network topology</span><span>
</span><a name="line-59"></a><span>      </span><a name="networkConfigOptsTopology"><a href="Pos.Network.CLI.html#networkConfigOptsTopology"><span class="hs-identifier">networkConfigOptsTopology</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="networkConfigOptsKademlia"><a href="Pos.Network.CLI.html#networkConfigOptsKademlia"><span class="hs-identifier">networkConfigOptsKademlia</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span>      </span><span class="hs-comment">-- | Name of the current node</span><span>
</span><a name="line-64"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="networkConfigOptsSelf"><a href="Pos.Network.CLI.html#networkConfigOptsSelf"><span class="hs-identifier">networkConfigOptsSelf</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span>      </span><span class="hs-comment">-- | Port number to use when translating IP addresses to NodeIds</span><span>
</span><a name="line-67"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="networkConfigOptsPort"><a href="Pos.Network.CLI.html#networkConfigOptsPort"><span class="hs-identifier">networkConfigOptsPort</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="networkConfigOptsPolicies"><a href="Pos.Network.CLI.html#networkConfigOptsPolicies"><span class="hs-identifier">networkConfigOptsPolicies</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-70"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-71"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Parser
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-identifier">networkConfigOption</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Opt</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Parser</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier hs-type">NetworkConfigOpts</span></a><span>
</span><a name="line-78"></a><a name="networkConfigOption"><a href="Pos.Network.CLI.html#networkConfigOption"><span class="hs-identifier">networkConfigOption</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier hs-var">NetworkConfigOpts</span></a><span>
</span><a name="line-79"></a><span>    </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">optional</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">strOption</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-80"></a><span>            </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">long</span><span> </span><span class="hs-string">&quot;topology&quot;</span><span>
</span><a name="line-81"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">metavar</span><span> </span><span class="hs-string">&quot;FILEPATH&quot;</span><span>
</span><a name="line-82"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">help</span><span> </span><span class="hs-string">&quot;Path to a YAML file containing the network topology&quot;</span><span>
</span><a name="line-83"></a><span>          </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span>    </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">optional</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">strOption</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-85"></a><span>            </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">long</span><span> </span><span class="hs-string">&quot;kademlia&quot;</span><span>
</span><a name="line-86"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">metavar</span><span> </span><span class="hs-string">&quot;FILEPATH&quot;</span><span>
</span><a name="line-87"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">help</span><span> </span><span class="hs-string">&quot;Path to a YAML file containing the kademlia configuration&quot;</span><span>
</span><a name="line-88"></a><span>          </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>    </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">optional</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromString</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">str</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-90"></a><span>            </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">long</span><span> </span><span class="hs-string">&quot;node-id&quot;</span><span>
</span><a name="line-91"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">metavar</span><span> </span><span class="hs-string">&quot;NODE_ID&quot;</span><span>
</span><a name="line-92"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">help</span><span> </span><span class="hs-string">&quot;Identifier for this node within the network&quot;</span><span>
</span><a name="line-93"></a><span>          </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>    </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">option</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">auto</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-95"></a><span>            </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">long</span><span> </span><span class="hs-string">&quot;default-port&quot;</span><span>
</span><a name="line-96"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">metavar</span><span> </span><span class="hs-string">&quot;PORT&quot;</span><span>
</span><a name="line-97"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">help</span><span> </span><span class="hs-string">&quot;Port number for IP address to node ID translation&quot;</span><span>
</span><a name="line-98"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">value</span><span> </span><span class="hs-number">3000</span><span>
</span><a name="line-99"></a><span>          </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>    </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">optional</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">strOption</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-101"></a><span>            </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">long</span><span> </span><span class="hs-string">&quot;policies&quot;</span><span>
</span><a name="line-102"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">metavar</span><span> </span><span class="hs-string">&quot;FILEPATH&quot;</span><span>
</span><a name="line-103"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Opt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">help</span><span> </span><span class="hs-string">&quot;Path to a YAML file containing the network policies&quot;</span><span>
</span><a name="line-104"></a><span>          </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Defaults
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- | The topology we assume when no topology file is specified</span><span>
</span><a name="line-111"></a><span class="hs-identifier">defaultTopology</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Network.Yaml.html#Topology"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Topology</span></a><span>
</span><a name="line-112"></a><a name="defaultTopology"><a href="Pos.Network.CLI.html#defaultTopology"><span class="hs-identifier">defaultTopology</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Network.Yaml.html#TopologyBehindNAT"><span class="hs-identifier hs-var">Y</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TopologyBehindNAT</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-113"></a><span>      </span><span class="hs-identifier">topologyValency</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">topologyFallbacks</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-115"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">topologyDnsDomains</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Network.CLI.html#defaultDnsDomains"><span class="hs-identifier hs-var">defaultDnsDomains</span></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-comment">-- | The default DNS domains used for relay discovery</span><span>
</span><a name="line-119"></a><span class="hs-comment">--</span><span>
</span><a name="line-120"></a><span class="hs-comment">-- TODO: Give this a proper value</span><span>
</span><a name="line-121"></a><span class="hs-identifier">defaultDnsDomains</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Network.DnsDomains.html#DnsDomains"><span class="hs-identifier hs-type">DnsDomains</span></a><span> </span><span class="hs-identifier hs-type">DNS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Domain</span><span>
</span><a name="line-122"></a><a name="defaultDnsDomains"><a href="Pos.Network.CLI.html#defaultDnsDomains"><span class="hs-identifier">defaultDnsDomains</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Network.DnsDomains.html#DnsDomains"><span class="hs-identifier hs-var">DnsDomains</span></a><span> </span><span class="hs-special">[</span><span>
</span><a name="line-123"></a><span>      </span><span class="hs-special">[</span><a href="Pos.Network.DnsDomains.html#NodeAddrDNS"><span class="hs-identifier hs-var">NodeAddrDNS</span></a><span> </span><span class="hs-string">&quot;todo.defaultDnsDomain.com&quot;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">]</span><span>
</span><a name="line-124"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Monitor for static peers
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-keyword">data</span><span> </span><a name="MonitorEvent"><a href="Pos.Network.CLI.html#MonitorEvent"><span class="hs-identifier">MonitorEvent</span></a></a><span> </span><a name="local-6989586621679607871"><a href="#local-6989586621679607871"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-131"></a><span>    </span><a name="MonitorRegister"><a href="Pos.Network.CLI.html#MonitorRegister"><span class="hs-identifier">MonitorRegister</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Peers</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679607871"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="MonitorSIGHUP"><a href="Pos.Network.CLI.html#MonitorSIGHUP"><span class="hs-identifier">MonitorSIGHUP</span></a></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-comment">-- | Monitor for changes to the static config</span><span>
</span><a name="line-135"></a><span class="hs-identifier">monitorStaticConfig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679607873"><a href="#local-6989586621679607873"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-136"></a><span>                         </span><span class="hs-identifier hs-type">WithLogger</span><span>     </span><a href="#local-6989586621679607873"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-137"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span>        </span><a href="#local-6989586621679607873"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-138"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Mockable</span><span> </span><span class="hs-identifier hs-type">Fork</span><span>  </span><a href="#local-6989586621679607873"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-139"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Mockable</span><span> </span><span class="hs-identifier hs-type">Catch</span><span> </span><a href="#local-6989586621679607873"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-140"></a><span>                       </span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>                    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier hs-type">NetworkConfigOpts</span></a><span>
</span><a name="line-142"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Network.Yaml.html#NodeMetadata"><span class="hs-identifier hs-type">NodeMetadata</span></a><span>    </span><span class="hs-comment">-- ^ Original metadata (at startup)</span><span>
</span><a name="line-143"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Peers</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span>    </span><span class="hs-comment">-- ^ Initial value</span><span>
</span><a name="line-144"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679607873"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Pos.Network.Types.html#StaticPeers"><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">StaticPeers</span></a><span>
</span><a name="line-145"></a><a name="monitorStaticConfig"><a href="Pos.Network.CLI.html#monitorStaticConfig"><span class="hs-identifier">monitorStaticConfig</span></a></a><span> </span><a name="local-6989586621679607874"><a href="#local-6989586621679607874"><span class="hs-identifier">cfg</span></a></a><span class="hs-glyph">@</span><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier hs-var">NetworkConfigOpts</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679607880"><a href="#local-6989586621679607880"><span class="hs-identifier">origMetadata</span></a></a><span> </span><a name="local-6989586621679607881"><a href="#local-6989586621679607881"><span class="hs-identifier">initPeers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-146"></a><span>    </span><a name="local-6989586621679607964"><a href="#local-6989586621679607964"><span class="hs-identifier">events</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><span class="hs-special">(</span><a href="Pos.Network.CLI.html#MonitorEvent"><span class="hs-identifier hs-type">MonitorEvent</span></a><span> </span><a href="#local-6989586621679607873"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newChan</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">loop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Peers</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span>
</span><a name="line-149"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Peers</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679607873"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-150"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679607873"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>        </span><a name="local-6989586621679607965"><a href="#local-6989586621679607965"><span class="hs-identifier">loop</span></a></a><span> </span><a name="local-6989586621679607966"><a href="#local-6989586621679607966"><span class="hs-identifier">peers</span></a></a><span> </span><a name="local-6989586621679607967"><a href="#local-6989586621679607967"><span class="hs-identifier">handlers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-152"></a><span>          </span><a name="local-6989586621679607968"><a href="#local-6989586621679607968"><span class="hs-identifier">event</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readChan</span><span> </span><a href="#local-6989586621679607964"><span class="hs-identifier hs-var">events</span></a><span>
</span><a name="line-153"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679607968"><span class="hs-identifier hs-var">event</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-154"></a><span>            </span><a href="Pos.Network.CLI.html#MonitorRegister"><span class="hs-identifier hs-var">MonitorRegister</span></a><span> </span><a name="local-6989586621679607969"><a href="#local-6989586621679607969"><span class="hs-identifier">handler</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-155"></a><span>              </span><a href="#local-6989586621679607882"><span class="hs-identifier hs-var">runHandler</span></a><span> </span><a href="#local-6989586621679607966"><span class="hs-identifier hs-var">peers</span></a><span> </span><a href="#local-6989586621679607969"><span class="hs-identifier hs-var">handler</span></a><span> </span><span class="hs-comment">-- Call new handler with current value</span><span>
</span><a name="line-156"></a><span>              </span><a href="#local-6989586621679607965"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621679607966"><span class="hs-identifier hs-var">peers</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679607969"><span class="hs-identifier hs-var">handler</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679607967"><span class="hs-identifier hs-var">handlers</span></a><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>            </span><a href="Pos.Network.CLI.html#MonitorSIGHUP"><span class="hs-identifier hs-var">MonitorSIGHUP</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-158"></a><span>              </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679607970"><a href="#local-6989586621679607970"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromJust</span><span> </span><a href="#local-6989586621679607875"><span class="hs-identifier hs-var">networkConfigOptsTopology</span></a><span>
</span><a name="line-159"></a><span>              </span><a name="local-6989586621679607971"><a href="#local-6989586621679607971"><span class="hs-identifier">mParsedTopology</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">try</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#readTopology"><span class="hs-identifier hs-var">readTopology</span></a><span> </span><a href="#local-6989586621679607970"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-160"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679607971"><span class="hs-identifier hs-var">mParsedTopology</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-161"></a><span>                </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="Pos.Network.Yaml.html#TopologyStatic"><span class="hs-identifier hs-var">Y</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TopologyStatic</span></a><span> </span><a name="local-6989586621679607972"><a href="#local-6989586621679607972"><span class="hs-identifier">allPeers</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-162"></a><span>                  </span><span class="hs-special">(</span><a name="local-6989586621679607973"><a href="#local-6989586621679607973"><span class="hs-identifier">newMetadata</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679607974"><a href="#local-6989586621679607974"><span class="hs-identifier">newPeers</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-163"></a><span>                    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#fromPovOf"><span class="hs-identifier hs-var">fromPovOf</span></a><span> </span><a href="#local-6989586621679607874"><span class="hs-identifier hs-var">cfg</span></a><span> </span><a href="#local-6989586621679607972"><span class="hs-identifier hs-var">allPeers</span></a><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span>                  </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nmType</span><span> </span><a href="#local-6989586621679607973"><span class="hs-identifier hs-var">newMetadata</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">nmType</span><span> </span><a href="#local-6989586621679607880"><span class="hs-identifier hs-var">origMetadata</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-166"></a><span>                    </span><span class="hs-identifier hs-var">logError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679607884"><span class="hs-identifier hs-var">changedType</span></a><span> </span><a href="#local-6989586621679607970"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-167"></a><span>                  </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nmKademlia</span><span> </span><a href="#local-6989586621679607973"><span class="hs-identifier hs-var">newMetadata</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">nmKademlia</span><span> </span><a href="#local-6989586621679607880"><span class="hs-identifier hs-var">origMetadata</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-168"></a><span>                    </span><span class="hs-identifier hs-var">logError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679607885"><span class="hs-identifier hs-var">changedKademlia</span></a><span> </span><a href="#local-6989586621679607970"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-169"></a><span>                  </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nmMaxSubscrs</span><span> </span><a href="#local-6989586621679607973"><span class="hs-identifier hs-var">newMetadata</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">nmMaxSubscrs</span><span> </span><a href="#local-6989586621679607880"><span class="hs-identifier hs-var">origMetadata</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-170"></a><span>                    </span><span class="hs-identifier hs-var">logError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679607886"><span class="hs-identifier hs-var">changedMaxSubscrs</span></a><span> </span><a href="#local-6989586621679607970"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>                  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679607882"><span class="hs-identifier hs-var">runHandler</span></a><span> </span><a href="#local-6989586621679607974"><span class="hs-identifier hs-var">newPeers</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679607967"><span class="hs-identifier hs-var">handlers</span></a><span>
</span><a name="line-173"></a><span>                  </span><span class="hs-identifier hs-var">logNotice</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-string">&quot;SIGHUP: Re-read topology&quot;</span><span>
</span><a name="line-174"></a><span>                  </span><a href="#local-6989586621679607965"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621679607974"><span class="hs-identifier hs-var">newPeers</span></a><span> </span><a href="#local-6989586621679607967"><span class="hs-identifier hs-var">handlers</span></a><span>
</span><a name="line-175"></a><span>                </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679607975"><a href="#local-6989586621679607975"><span class="hs-identifier">_otherTopology</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-176"></a><span>                  </span><span class="hs-identifier hs-var">logError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679607883"><span class="hs-identifier hs-var">changedFormat</span></a><span> </span><a href="#local-6989586621679607970"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-177"></a><span>                  </span><a href="#local-6989586621679607965"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621679607966"><span class="hs-identifier hs-var">peers</span></a><span> </span><a href="#local-6989586621679607967"><span class="hs-identifier hs-var">handlers</span></a><span>
</span><a name="line-178"></a><span>                </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679607976"><a href="#local-6989586621679607976"><span class="hs-identifier">ex</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-179"></a><span>                  </span><span class="hs-identifier hs-var">logError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679607887"><span class="hs-identifier hs-var">readFailed</span></a><span> </span><a href="#local-6989586621679607970"><span class="hs-identifier hs-var">fp</span></a><span> </span><a href="#local-6989586621679607976"><span class="hs-identifier hs-var">ex</span></a><span>
</span><a name="line-180"></a><span>                  </span><a href="#local-6989586621679607965"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621679607966"><span class="hs-identifier hs-var">peers</span></a><span> </span><a href="#local-6989586621679607967"><span class="hs-identifier hs-var">handlers</span></a><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span class="hs-cpp">#ifdef POSIX</span><span>
</span><a name="line-183"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Util.SigHandler.html#installHandler"><span class="hs-identifier hs-var">installHandler</span></a><span> </span><a href="Pos.Util.SigHandler.html#SigHUP"><span class="hs-identifier hs-var">SigHUP</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679607964"><span class="hs-identifier hs-var">events</span></a><span> </span><a href="Pos.Network.CLI.html#MonitorSIGHUP"><span class="hs-identifier hs-var">MonitorSIGHUP</span></a><span>
</span><a name="line-184"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span>    </span><a name="local-6989586621679607977"><a href="#local-6989586621679607977"><span class="hs-identifier">_tid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fork</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679607965"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621679607881"><span class="hs-identifier hs-var">initPeers</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-187"></a><span>    </span><span class="hs-identifier">return</span><span> </span><a href="Pos.Network.Types.html#StaticPeers"><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">StaticPeers</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-188"></a><span>        </span><span class="hs-identifier">T</span><span class="hs-operator">.</span><span class="hs-identifier">staticPeersOnChange</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679607964"><span class="hs-identifier hs-var">events</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Pos.Network.CLI.html#MonitorRegister"><span class="hs-identifier hs-var">MonitorRegister</span></a><span>
</span><a name="line-189"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-identifier">runHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679607889"><a href="#local-6989586621679607889"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679607889"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679607889"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679607873"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679607873"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>    </span><a name="local-6989586621679607882"><a href="#local-6989586621679607882"><span class="hs-identifier">runHandler</span></a></a><span> </span><a name="local-6989586621679607890"><a href="#local-6989586621679607890"><span class="hs-identifier">it</span></a></a><span> </span><a name="local-6989586621679607891"><a href="#local-6989586621679607891"><span class="hs-identifier">handler</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-193"></a><span>        </span><a name="local-6989586621679607892"><a href="#local-6989586621679607892"><span class="hs-identifier">mu</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">try</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679607891"><span class="hs-identifier hs-var">handler</span></a><span> </span><a href="#local-6989586621679607890"><span class="hs-identifier hs-var">it</span></a><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679607892"><span class="hs-identifier hs-var">mu</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-195"></a><span>          </span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679607893"><a href="#local-6989586621679607893"><span class="hs-identifier">ex</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">logError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679607888"><span class="hs-identifier hs-var">handlerError</span></a><span> </span><a href="#local-6989586621679607893"><span class="hs-identifier hs-var">ex</span></a><span>
</span><a name="line-196"></a><span>          </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span>    </span><span class="hs-identifier">changedFormat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">changedType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">changedKademlia</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-199"></a><span>    </span><a name="local-6989586621679607883"><a href="#local-6989586621679607883"><span class="hs-identifier">changedFormat</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;SIGHUP (&quot;</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-identifier hs-var">shown</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-string">&quot;): Cannot dynamically change topology.&quot;</span><span>
</span><a name="line-200"></a><span>    </span><a name="local-6989586621679607884"><a href="#local-6989586621679607884"><span class="hs-identifier">changedType</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;SIGHUP (&quot;</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-identifier hs-var">shown</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-string">&quot;): Cannot dynamically change own node type.&quot;</span><span>
</span><a name="line-201"></a><span>    </span><a name="local-6989586621679607885"><a href="#local-6989586621679607885"><span class="hs-identifier">changedKademlia</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;SIGHUP (&quot;</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-identifier hs-var">shown</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-string">&quot;): Cannot dynamically start/stop Kademlia.&quot;</span><span>
</span><a name="line-202"></a><span>    </span><a name="local-6989586621679607886"><a href="#local-6989586621679607886"><span class="hs-identifier">changedMaxSubscrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;SIGHUP (&quot;</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-identifier hs-var">shown</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-string">&quot;): Cannot dynamically change maximum number of subscribers.&quot;</span><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span>    </span><span class="hs-identifier">readFailed</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-205"></a><span>    </span><a name="local-6989586621679607887"><a href="#local-6989586621679607887"><span class="hs-identifier">readFailed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;SIGHUP: Failed to read &quot;</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-identifier hs-var">shown</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-string">&quot;: &quot;</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-identifier hs-var">shown</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-string">&quot;. Ignored.&quot;</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span>    </span><span class="hs-identifier">handlerError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-208"></a><span>    </span><a name="local-6989586621679607888"><a href="#local-6989586621679607888"><span class="hs-identifier">handlerError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Exception thrown by staticPeersOnChange handler: &quot;</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-identifier hs-var">shown</span><span> </span><span class="hs-operator hs-var">%</span><span> </span><span class="hs-string">&quot;. Ignored.&quot;</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Interpreter
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-comment">-- | Interpreter for the network config opts</span><span>
</span><a name="line-215"></a><span class="hs-identifier">intNetworkConfigOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679607872"><a href="#local-6989586621679607872"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-216"></a><span>                         </span><span class="hs-identifier hs-type">WithLogger</span><span>     </span><a href="#local-6989586621679607872"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-217"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span>        </span><a href="#local-6989586621679607872"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-218"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Mockable</span><span> </span><span class="hs-identifier hs-type">Fork</span><span>  </span><a href="#local-6989586621679607872"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-219"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Mockable</span><span> </span><span class="hs-identifier hs-type">Catch</span><span> </span><a href="#local-6989586621679607872"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-220"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Mockable</span><span> </span><span class="hs-identifier hs-type">Throw</span><span> </span><a href="#local-6989586621679607872"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-221"></a><span>                       </span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>                     </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier hs-type">NetworkConfigOpts</span></a><span>
</span><a name="line-223"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679607872"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Network.Types.html#NetworkConfig"><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">NetworkConfig</span></a><span> </span><a href="Pos.DHT.Real.Param.html#KademliaParams"><span class="hs-identifier hs-type">DHT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KademliaParams</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><a name="intNetworkConfigOpts"><a href="Pos.Network.CLI.html#intNetworkConfigOpts"><span class="hs-identifier">intNetworkConfigOpts</span></a></a><span> </span><a name="local-6989586621679607978"><a href="#local-6989586621679607978"><span class="hs-identifier">cfg</span></a></a><span class="hs-glyph">@</span><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier hs-var">NetworkConfigOpts</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-225"></a><span>    </span><a name="local-6989586621679607985"><a href="#local-6989586621679607985"><span class="hs-identifier">parsedTopology</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679607979"><span class="hs-identifier hs-var">networkConfigOptsTopology</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-226"></a><span>                        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Pos.Network.CLI.html#defaultTopology"><span class="hs-identifier hs-var">defaultTopology</span></a><span>
</span><a name="line-227"></a><span>                        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679607984"><a href="#local-6989586621679607984"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#readTopology"><span class="hs-identifier hs-var">readTopology</span></a><span> </span><a href="#local-6989586621679607984"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-228"></a><span>    </span><a name="local-6989586621679608017"><a href="#local-6989586621679608017"><span class="hs-identifier">ourTopology</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679607985"><span class="hs-identifier hs-var">parsedTopology</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-229"></a><span>      </span><a href="Pos.Network.Yaml.html#TopologyStatic"><span class="hs-identifier hs-var">Y</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TopologyStatic</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-230"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679607987"><a href="#local-6989586621679607987"><span class="hs-identifier">md</span></a></a><span class="hs-glyph">@</span><a href="Pos.Network.Yaml.html#NodeMetadata"><span class="hs-identifier hs-var">NodeMetadata</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679607998"><a href="#local-6989586621679607998"><span class="hs-identifier">initPeers</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679607999"><a href="#local-6989586621679607999"><span class="hs-identifier">kademliaPeers</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#fromPovOf"><span class="hs-identifier hs-var">fromPovOf</span></a><span> </span><a href="#local-6989586621679607978"><span class="hs-identifier hs-var">cfg</span></a><span> </span><a href="#local-6989586621679607986"><span class="hs-identifier hs-var">topologyAllPeers</span></a><span>
</span><a name="line-231"></a><span>        </span><a name="local-6989586621679608000"><a href="#local-6989586621679608000"><span class="hs-identifier">topologyStaticPeers</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Network.CLI.html#monitorStaticConfig"><span class="hs-identifier hs-var">monitorStaticConfig</span></a><span> </span><a href="#local-6989586621679607978"><span class="hs-identifier hs-var">cfg</span></a><span> </span><a href="#local-6989586621679607987"><span class="hs-identifier hs-var">md</span></a><span> </span><a href="#local-6989586621679607998"><span class="hs-identifier hs-var">initPeers</span></a><span>
</span><a name="line-232"></a><span>        </span><span class="hs-comment">-- If kademlia is enabled here then we'll try to read the configuration</span><span>
</span><a name="line-233"></a><span>        </span><span class="hs-comment">-- file. However it's not necessary that the file exists. If it doesn't,</span><span>
</span><a name="line-234"></a><span>        </span><span class="hs-comment">-- we can fill in some sensible defaults using the static routing and</span><span>
</span><a name="line-235"></a><span>        </span><span class="hs-comment">-- kademlia flags for other nodes.</span><span>
</span><a name="line-236"></a><span>        </span><a name="local-6989586621679608005"><a href="#local-6989586621679608005"><span class="hs-identifier">topologyOptKademlia</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679607995"><span class="hs-identifier hs-var">nmKademlia</span></a><span>
</span><a name="line-237"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-238"></a><span>                </span><a name="local-6989586621679608001"><a href="#local-6989586621679608001"><span class="hs-identifier">ekparams</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#getKademliaParamsFromFile"><span class="hs-identifier hs-var">getKademliaParamsFromFile</span></a><span> </span><a href="#local-6989586621679607978"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-239"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679608001"><span class="hs-identifier hs-var">ekparams</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-240"></a><span>                    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679608002"><a href="#local-6989586621679608002"><span class="hs-identifier">kparams</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679608002"><span class="hs-identifier hs-var">kparams</span></a><span>
</span><a name="line-241"></a><span>                    </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="Pos.Network.CLI.html#MissingKademliaConfig"><span class="hs-identifier hs-var">MissingKademliaConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-242"></a><span>                        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679608003"><a href="#local-6989586621679608003"><span class="hs-identifier">ekparams'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Network.CLI.html#getKademliaParamsFromStatic"><span class="hs-identifier hs-var">getKademliaParamsFromStatic</span></a><span> </span><a href="#local-6989586621679607999"><span class="hs-identifier hs-var">kademliaPeers</span></a><span>
</span><a name="line-243"></a><span>                        </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">throw</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Pos.Network.CLI.html#CannotParseKademliaConfig"><span class="hs-identifier hs-var">CannotParseKademliaConfig</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Left</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Just</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679608003"><span class="hs-identifier hs-var">ekparams'</span></a><span>
</span><a name="line-244"></a><span>                    </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679608004"><a href="#local-6989586621679608004"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throw</span><span> </span><a href="#local-6989586621679608004"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-245"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-246"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679607988"><span class="hs-identifier hs-var">nmType</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-247"></a><span>          </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">NodeCore</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Pos.Network.Types.html#TopologyCore"><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TopologyCore</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-248"></a><span>          </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">NodeRelay</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Pos.Network.Types.html#TopologyRelay"><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TopologyRelay</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-249"></a><span>                           </span><a href="#local-6989586621679608000"><span class="hs-identifier hs-var">topologyStaticPeers</span></a><span class="hs-special">,</span><span>
</span><a name="line-250"></a><span>                           </span><span class="hs-identifier">topologyDnsDomains</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679607991"><span class="hs-identifier hs-var">nmSubscribe</span></a><span class="hs-special">,</span><span>
</span><a name="line-251"></a><span>                           </span><span class="hs-identifier">topologyValency</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679607992"><span class="hs-identifier hs-var">nmValency</span></a><span class="hs-special">,</span><span>
</span><a name="line-252"></a><span>                           </span><span class="hs-identifier">topologyFallbacks</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679607993"><span class="hs-identifier hs-var">nmFallbacks</span></a><span class="hs-special">,</span><span>
</span><a name="line-253"></a><span>                           </span><a href="#local-6989586621679608005"><span class="hs-identifier hs-var">topologyOptKademlia</span></a><span class="hs-special">,</span><span>
</span><a name="line-254"></a><span>                           </span><span class="hs-identifier">topologyMaxSubscrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679607997"><span class="hs-identifier hs-var">nmMaxSubscrs</span></a><span>
</span><a name="line-255"></a><span>                         </span><span class="hs-special">}</span><span>
</span><a name="line-256"></a><span>          </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">NodeEdge</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throw</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigSelfEdge"><span class="hs-identifier hs-var">NetworkConfigSelfEdge</span></a><span>
</span><a name="line-257"></a><span>      </span><a href="Pos.Network.Yaml.html#TopologyBehindNAT"><span class="hs-identifier hs-var">Y</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TopologyBehindNAT</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-258"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Pos.Network.Types.html#TopologyBehindNAT"><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TopologyBehindNAT</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-259"></a><span>      </span><a href="Pos.Network.Yaml.html#TopologyP2P"><span class="hs-identifier hs-var">Y</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TopologyP2P</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-260"></a><span>        </span><a name="local-6989586621679608012"><a href="#local-6989586621679608012"><span class="hs-identifier">kparams</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-identifier hs-var">throw</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="Pos.Network.CLI.html#getKademliaParamsFromFile"><span class="hs-identifier hs-var">getKademliaParamsFromFile</span></a><span> </span><a href="#local-6989586621679607978"><span class="hs-identifier hs-var">cfg</span></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>        </span><span class="hs-identifier">return</span><span> </span><a href="Pos.Network.Types.html#TopologyP2P"><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TopologyP2P</span></a><span class="hs-special">{</span><a href="#local-6989586621679608009"><span class="hs-identifier hs-var">topologyKademlia</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679608012"><span class="hs-identifier hs-var">kparams</span></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-262"></a><span>      </span><a href="Pos.Network.Yaml.html#TopologyTraditional"><span class="hs-identifier hs-var">Y</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TopologyTraditional</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-263"></a><span>        </span><a name="local-6989586621679608016"><a href="#local-6989586621679608016"><span class="hs-identifier">kparams</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-identifier hs-var">throw</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="Pos.Network.CLI.html#getKademliaParamsFromFile"><span class="hs-identifier hs-var">getKademliaParamsFromFile</span></a><span> </span><a href="#local-6989586621679607978"><span class="hs-identifier hs-var">cfg</span></a><span class="hs-special">)</span><span>
</span><a name="line-264"></a><span>        </span><span class="hs-identifier">return</span><span> </span><a href="Pos.Network.Types.html#TopologyTraditional"><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TopologyTraditional</span></a><span class="hs-special">{</span><a href="#local-6989586621679608013"><span class="hs-identifier hs-var">topologyKademlia</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679608016"><span class="hs-identifier hs-var">kparams</span></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-265"></a><span>
</span><a name="line-266"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679608019"><a href="#local-6989586621679608019"><span class="hs-identifier">enqueuePolicy</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679608020"><a href="#local-6989586621679608020"><span class="hs-identifier">dequeuePolicy</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679608021"><a href="#local-6989586621679608021"><span class="hs-identifier">failurePolicy</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679607983"><span class="hs-identifier hs-var">networkConfigOptsPolicies</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-267"></a><span>        </span><span class="hs-comment">-- If no policy file is given we just use the default derived from the</span><span>
</span><a name="line-268"></a><span>        </span><span class="hs-comment">-- topology.</span><span>
</span><a name="line-269"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-270"></a><span>            </span><span class="hs-special">(</span><span> </span><a href="Pos.Network.Types.html#topologyEnqueuePolicy"><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">topologyEnqueuePolicy</span></a><span> </span><a href="#local-6989586621679608017"><span class="hs-identifier hs-var">ourTopology</span></a><span>
</span><a name="line-271"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Pos.Network.Types.html#topologyDequeuePolicy"><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">topologyDequeuePolicy</span></a><span> </span><a href="#local-6989586621679608017"><span class="hs-identifier hs-var">ourTopology</span></a><span>
</span><a name="line-272"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Pos.Network.Types.html#topologyFailurePolicy"><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">topologyFailurePolicy</span></a><span> </span><a href="#local-6989586621679608017"><span class="hs-identifier hs-var">ourTopology</span></a><span>
</span><a name="line-273"></a><span>            </span><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>        </span><span class="hs-comment">-- A policy file is given: the topology-derived defaults are ignored</span><span>
</span><a name="line-275"></a><span>        </span><span class="hs-comment">-- and we take the complete policy description from the file.</span><span>
</span><a name="line-276"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679608018"><a href="#local-6989586621679608018"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.Yaml.html#fromStaticPolicies"><span class="hs-identifier hs-var">Y</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromStaticPolicies</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pos.Network.CLI.html#readPolicies"><span class="hs-identifier hs-var">readPolicies</span></a><span> </span><a href="#local-6989586621679608018"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span>    </span><span class="hs-identifier">return</span><span> </span><a href="Pos.Network.Types.html#NetworkConfig"><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">NetworkConfig</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-279"></a><span>        </span><span class="hs-identifier">ncTopology</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679608017"><span class="hs-identifier hs-var">ourTopology</span></a><span>
</span><a name="line-280"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ncDefaultPort</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679607982"><span class="hs-identifier hs-var">networkConfigOptsPort</span></a><span>
</span><a name="line-281"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ncSelfName</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679607981"><span class="hs-identifier hs-var">networkConfigOptsSelf</span></a><span>
</span><a name="line-282"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ncEnqueuePolicy</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679608019"><span class="hs-identifier hs-var">enqueuePolicy</span></a><span>
</span><a name="line-283"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ncDequeuePolicy</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679608020"><span class="hs-identifier hs-var">dequeuePolicy</span></a><span>
</span><a name="line-284"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ncFailurePolicy</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679608021"><span class="hs-identifier hs-var">failurePolicy</span></a><span>
</span><a name="line-285"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-comment">-- | Come up with kademlia parameters, possibly giving 'Left' in case</span><span>
</span><a name="line-288"></a><span class="hs-comment">-- there's no configuration file path given, or if it couldn't be parsed.</span><span>
</span><a name="line-289"></a><span class="hs-identifier">getKademliaParamsFromFile</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier hs-type">NetworkConfigOpts</span></a><span>
</span><a name="line-290"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigException"><span class="hs-identifier hs-type">NetworkConfigException</span></a><span> </span><a href="Pos.DHT.Real.Param.html#KademliaParams"><span class="hs-identifier hs-type">DHT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KademliaParams</span></a><span class="hs-special">)</span><span>
</span><a name="line-291"></a><a name="getKademliaParamsFromFile"><a href="Pos.Network.CLI.html#getKademliaParamsFromFile"><span class="hs-identifier">getKademliaParamsFromFile</span></a></a><span> </span><a name="local-6989586621679608022"><a href="#local-6989586621679608022"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">networkConfigOptsKademlia</span><span> </span><a href="#local-6989586621679608022"><span class="hs-identifier hs-var">cfg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-292"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="Pos.Network.CLI.html#MissingKademliaConfig"><span class="hs-identifier hs-var">MissingKademliaConfig</span></a><span>
</span><a name="line-293"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679608023"><a href="#local-6989586621679608023"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-294"></a><span>      </span><a name="local-6989586621679608024"><a href="#local-6989586621679608024"><span class="hs-identifier">kconf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Network.CLI.html#parseKademlia"><span class="hs-identifier hs-var">parseKademlia</span></a><span> </span><a href="#local-6989586621679608023"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-295"></a><span>      </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Pos.Network.CLI.html#CannotParseKademliaConfig"><span class="hs-identifier hs-var">CannotParseKademliaConfig</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Pos.DHT.Real.Param.html#MalformedDHTKey"><span class="hs-identifier hs-var">DHT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">MalformedDHTKey</span></a><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Right</span><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>             </span><span class="hs-special">(</span><a href="Pos.DHT.Real.Param.html#fromYamlConfig"><span class="hs-identifier hs-var">DHT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromYamlConfig</span></a><span> </span><a href="#local-6989586621679608024"><span class="hs-identifier hs-var">kconf</span></a><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-comment">-- | Derive kademlia parameters from the set of kademlia-enabled peers. They</span><span>
</span><a name="line-300"></a><span class="hs-comment">-- are used as the initial peers, and everything else is unspecified, and will</span><span>
</span><a name="line-301"></a><span class="hs-comment">-- be defaulted.</span><span>
</span><a name="line-302"></a><span class="hs-identifier">getKademliaParamsFromStatic</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Pos.Network.Yaml.html#KademliaAddress"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KademliaAddress</span></a><span class="hs-special">]</span><span>
</span><a name="line-303"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Pos.DHT.Real.Param.html#MalformedDHTKey"><span class="hs-identifier hs-type">DHT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">MalformedDHTKey</span></a><span> </span><a href="Pos.DHT.Real.Param.html#KademliaParams"><span class="hs-identifier hs-type">DHT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KademliaParams</span></a><span>
</span><a name="line-304"></a><span class="hs-comment">-- Since 'Nothing' is given for the kpId, it's impossible to get a 'Left'</span><span>
</span><a name="line-305"></a><a name="getKademliaParamsFromStatic"><a href="Pos.Network.CLI.html#getKademliaParamsFromStatic"><span class="hs-identifier">getKademliaParamsFromStatic</span></a></a><span> </span><a name="local-6989586621679608025"><a href="#local-6989586621679608025"><span class="hs-identifier">kpeers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Pos.DHT.Real.Param.html#MalformedDHTKey"><span class="hs-identifier hs-var">DHT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">MalformedDHTKey</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679608026"><span class="hs-identifier hs-var">kparams</span></a><span>
</span><a name="line-306"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-307"></a><span>    </span><a name="local-6989586621679608026"><a href="#local-6989586621679608026"><span class="hs-identifier">kparams</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.DHT.Real.Param.html#fromYamlConfig"><span class="hs-identifier hs-var">DHT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromYamlConfig</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.Yaml.html#KademliaParams"><span class="hs-identifier hs-var">Y</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">KademliaParams</span></a><span>
</span><a name="line-308"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">Y</span><span class="hs-operator">.</span><span class="hs-identifier">kpId</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-309"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Y</span><span class="hs-operator">.</span><span class="hs-identifier">kpPeers</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679608025"><span class="hs-identifier hs-var">kpeers</span></a><span>
</span><a name="line-310"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Y</span><span class="hs-operator">.</span><span class="hs-identifier">kpAddress</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-311"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Y</span><span class="hs-operator">.</span><span class="hs-identifier">kpBind</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-312"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Y</span><span class="hs-operator">.</span><span class="hs-identifier">kpExplicitInitial</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-313"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Y</span><span class="hs-operator">.</span><span class="hs-identifier">kpDumpFile</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-314"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span class="hs-comment">-- | Perspective on 'AllStaticallyKnownPeers' from the point of view of</span><span>
</span><a name="line-317"></a><span class="hs-comment">-- a single node.</span><span>
</span><a name="line-318"></a><span class="hs-comment">--</span><span>
</span><a name="line-319"></a><span class="hs-comment">-- First component is this node's metadata.</span><span>
</span><a name="line-320"></a><span class="hs-comment">-- Second component is the set of all known peers (routes included).</span><span>
</span><a name="line-321"></a><span class="hs-comment">-- Third component is the set of addresses of peers running kademlia.</span><span>
</span><a name="line-322"></a><span class="hs-comment">--   If this node runs kademlia, its address will appear as the last entry in</span><span>
</span><a name="line-323"></a><span class="hs-comment">--   the list.</span><span>
</span><a name="line-324"></a><span class="hs-identifier">fromPovOf</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier hs-type">NetworkConfigOpts</span></a><span>
</span><a name="line-325"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Network.Yaml.html#AllStaticallyKnownPeers"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">AllStaticallyKnownPeers</span></a><span>
</span><a name="line-326"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Pos.Network.Yaml.html#NodeMetadata"><span class="hs-identifier hs-type">NodeMetadata</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Peers</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Pos.Network.Yaml.html#KademliaAddress"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KademliaAddress</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-327"></a><a name="fromPovOf"><a href="Pos.Network.CLI.html#fromPovOf"><span class="hs-identifier">fromPovOf</span></a></a><span> </span><a name="local-6989586621679608027"><a href="#local-6989586621679608027"><span class="hs-identifier">cfg</span></a></a><span class="hs-glyph">@</span><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier hs-var">NetworkConfigOpts</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679608033"><a href="#local-6989586621679608033"><span class="hs-identifier">allPeers</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-328"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679608030"><span class="hs-identifier hs-var">networkConfigOptsSelf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-329"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigSelfUnknown"><span class="hs-identifier hs-var">NetworkConfigSelfUnknown</span></a><span>
</span><a name="line-330"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679608288"><a href="#local-6989586621679608288"><span class="hs-identifier">self</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Network.Types.html#initDnsOnUse"><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">initDnsOnUse</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679608289"><a href="#local-6989586621679608289"><span class="hs-identifier">resolve</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-331"></a><span>        </span><a name="local-6989586621679608290"><a href="#local-6989586621679608290"><span class="hs-identifier">selfMetadata</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Network.CLI.html#metadataFor"><span class="hs-identifier hs-var">metadataFor</span></a><span> </span><a href="#local-6989586621679608033"><span class="hs-identifier hs-var">allPeers</span></a><span> </span><a href="#local-6989586621679608288"><span class="hs-identifier hs-var">self</span></a><span>
</span><a name="line-332"></a><span>        </span><a name="local-6989586621679608291"><a href="#local-6989586621679608291"><span class="hs-identifier">resolved</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679608035"><span class="hs-identifier hs-var">resolvePeers</span></a><span> </span><a href="#local-6989586621679608289"><span class="hs-identifier hs-var">resolve</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">Y</span><span class="hs-operator">.</span><span class="hs-identifier">allStaticallyKnownPeers</span><span> </span><a href="#local-6989586621679608033"><span class="hs-identifier hs-var">allPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>        </span><a name="local-6989586621679608292"><a href="#local-6989586621679608292"><span class="hs-identifier">routes</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679608037"><span class="hs-identifier hs-var">mkRoutes</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">second</span><span> </span><a href="Pos.Util.TimeWarp.html#addressToNodeId"><span class="hs-identifier hs-var">addressToNodeId</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679608291"><span class="hs-identifier hs-var">resolved</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Y</span><span class="hs-operator">.</span><span class="hs-identifier">nmRoutes</span><span> </span><a href="#local-6989586621679608290"><span class="hs-identifier hs-var">selfMetadata</span></a><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679608293"><a href="#local-6989586621679608293"><span class="hs-identifier">directory</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679608299"><a href="#local-6989586621679608299"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679608300"><a href="#local-6989586621679608300"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Pos.Util.TimeWarp.html#addressToNodeId"><span class="hs-identifier hs-var">addressToNodeId</span></a><span> </span><a href="#local-6989586621679608300"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679608299"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">elems</span><span> </span><a href="#local-6989586621679608291"><span class="hs-identifier hs-var">resolved</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>            </span><a name="local-6989586621679608294"><a href="#local-6989586621679608294"><span class="hs-identifier">hasKademlia</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier">nmKademlia</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Y</span><span class="hs-operator">.</span><span class="hs-identifier">allStaticallyKnownPeers</span><span> </span><a href="#local-6989586621679608033"><span class="hs-identifier hs-var">allPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>            </span><a name="local-6989586621679608295"><a href="#local-6989586621679608295"><span class="hs-identifier">selfKademlia</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">member</span><span> </span><a href="#local-6989586621679608288"><span class="hs-identifier hs-var">self</span></a><span> </span><a href="#local-6989586621679608294"><span class="hs-identifier hs-var">hasKademlia</span></a><span>
</span><a name="line-337"></a><span>            </span><a name="local-6989586621679608296"><a href="#local-6989586621679608296"><span class="hs-identifier">otherKademlia</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">delete</span><span> </span><a href="#local-6989586621679608288"><span class="hs-identifier hs-var">self</span></a><span> </span><a href="#local-6989586621679608294"><span class="hs-identifier hs-var">hasKademlia</span></a><span>
</span><a name="line-338"></a><span>            </span><span class="hs-comment">-- Linter claims that</span><span>
</span><a name="line-339"></a><span>            </span><span class="hs-comment">--   [self | selfKademlia]</span><span>
</span><a name="line-340"></a><span>            </span><span class="hs-comment">-- is more readable than</span><span>
</span><a name="line-341"></a><span>            </span><span class="hs-comment">--   if selfKademlia then [self] else []</span><span>
</span><a name="line-342"></a><span>            </span><a name="local-6989586621679608297"><a href="#local-6989586621679608297"><span class="hs-identifier">allKademlia</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">keys</span><span> </span><a href="#local-6989586621679608296"><span class="hs-identifier hs-var">otherKademlia</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679608288"><span class="hs-identifier hs-var">self</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679608295"><span class="hs-identifier hs-var">selfKademlia</span></a><span class="hs-special">]</span><span>
</span><a name="line-343"></a><span>
</span><a name="line-344"></a><span>            </span><a name="local-6989586621679608298"><a href="#local-6989586621679608298"><span class="hs-identifier">kademliaPeers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679608034"><span class="hs-identifier hs-var">mkKademliaAddress</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679608301"><a href="#local-6989586621679608301"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679608301"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679608291"><span class="hs-identifier hs-var">resolved</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679608297"><span class="hs-identifier hs-var">allKademlia</span></a><span>
</span><a name="line-345"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679608290"><span class="hs-identifier hs-var">selfMetadata</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">peersFromList</span><span> </span><a href="#local-6989586621679608293"><span class="hs-identifier hs-var">directory</span></a><span> </span><a href="#local-6989586621679608292"><span class="hs-identifier hs-var">routes</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679608298"><span class="hs-identifier hs-var">kademliaPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span>    </span><span class="hs-identifier">mkKademliaAddress</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Util.TimeWarp.html#NetworkAddress"><span class="hs-identifier hs-type">NetworkAddress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Network.Yaml.html#KademliaAddress"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KademliaAddress</span></a><span>
</span><a name="line-349"></a><span>    </span><a name="local-6989586621679608034"><a href="#local-6989586621679608034"><span class="hs-identifier">mkKademliaAddress</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679608041"><a href="#local-6989586621679608041"><span class="hs-identifier">addr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679608042"><a href="#local-6989586621679608042"><span class="hs-identifier">port</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Network.Yaml.html#KademliaAddress"><span class="hs-identifier hs-var">Y</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">KademliaAddress</span></a><span>
</span><a name="line-350"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">Y</span><span class="hs-operator">.</span><span class="hs-identifier">kaHost</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">C8</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><a href="#local-6989586621679608041"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-351"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Y</span><span class="hs-operator">.</span><span class="hs-identifier">kaPort</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679608042"><span class="hs-identifier hs-var">port</span></a><span>
</span><a name="line-352"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span>    </span><span class="hs-comment">-- Use the name/metadata association to come up with types and</span><span>
</span><a name="line-355"></a><span>    </span><span class="hs-comment">-- addresses for each name.</span><span>
</span><a name="line-356"></a><span>    </span><span class="hs-identifier">resolvePeers</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Network.Types.html#Resolver"><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Resolver</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span> </span><a href="Pos.Network.Yaml.html#NodeMetadata"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">NodeMetadata</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">NodeType</span><span class="hs-special">,</span><span> </span><a href="Pos.Util.TimeWarp.html#NetworkAddress"><span class="hs-identifier hs-type">NetworkAddress</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>    </span><a name="local-6989586621679608035"><a href="#local-6989586621679608035"><span class="hs-identifier">resolvePeers</span></a></a><span> </span><a name="local-6989586621679608043"><a href="#local-6989586621679608043"><span class="hs-identifier">resolve</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">traverseWithKey</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679608036"><span class="hs-identifier hs-var">resolvePeer</span></a><span> </span><a href="#local-6989586621679608043"><span class="hs-identifier hs-var">resolve</span></a><span class="hs-special">)</span><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span>    </span><span class="hs-identifier">resolvePeer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Network.Types.html#Resolver"><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Resolver</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Network.Yaml.html#NodeMetadata"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">NodeMetadata</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">NodeType</span><span class="hs-special">,</span><span> </span><a href="Pos.Util.TimeWarp.html#NetworkAddress"><span class="hs-identifier hs-type">NetworkAddress</span></a><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>    </span><a name="local-6989586621679608036"><a href="#local-6989586621679608036"><span class="hs-identifier">resolvePeer</span></a></a><span> </span><a name="local-6989586621679608044"><a href="#local-6989586621679608044"><span class="hs-identifier">resolve</span></a></a><span> </span><a name="local-6989586621679608045"><a href="#local-6989586621679608045"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679608046"><a href="#local-6989586621679608046"><span class="hs-identifier">metadata</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-361"></a><span>      </span><span class="hs-special">(</span><a href="#local-6989586621679608047"><span class="hs-identifier hs-var">typ</span></a><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pos.Network.CLI.html#resolveNodeAddr"><span class="hs-identifier hs-var">resolveNodeAddr</span></a><span> </span><a href="#local-6989586621679608027"><span class="hs-identifier hs-var">cfg</span></a><span> </span><a href="#local-6989586621679608044"><span class="hs-identifier hs-var">resolve</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679608045"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679608048"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-363"></a><span>        </span><a name="local-6989586621679608047"><a href="#local-6989586621679608047"><span class="hs-identifier">typ</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nmType</span><span> </span><a href="#local-6989586621679608046"><span class="hs-identifier hs-var">metadata</span></a><span>
</span><a name="line-364"></a><span>        </span><a name="local-6989586621679608048"><a href="#local-6989586621679608048"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nmAddress</span><span> </span><a href="#local-6989586621679608046"><span class="hs-identifier hs-var">metadata</span></a><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span>    </span><span class="hs-comment">-- Given a NodeName directory (see 'resolvePeers'), fill in the NodeRoutes</span><span>
</span><a name="line-367"></a><span>    </span><span class="hs-comment">-- by looking up the relevant names.</span><span>
</span><a name="line-368"></a><span>    </span><span class="hs-comment">-- It's assumed that each name in a list of alternatives has the same</span><span>
</span><a name="line-369"></a><span>    </span><span class="hs-comment">-- type.</span><span>
</span><a name="line-370"></a><span>    </span><span class="hs-identifier">mkRoutes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">NodeType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Network.Yaml.html#NodeRoutes"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">NodeRoutes</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">NodeType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Alts</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-371"></a><span>    </span><a name="local-6989586621679608037"><a href="#local-6989586621679608037"><span class="hs-identifier">mkRoutes</span></a></a><span> </span><a name="local-6989586621679608049"><a href="#local-6989586621679608049"><span class="hs-identifier">directory</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Network.Yaml.html#NodeRoutes"><span class="hs-identifier hs-var">Y</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">NodeRoutes</span></a><span> </span><a name="local-6989586621679608050"><a href="#local-6989586621679608050"><span class="hs-identifier">routes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679608038"><span class="hs-identifier hs-var">mkAlts</span></a><span> </span><a href="#local-6989586621679608049"><span class="hs-identifier hs-var">directory</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679608050"><span class="hs-identifier hs-var">routes</span></a><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span>    </span><span class="hs-identifier">mkAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">NodeType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Alts</span><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">NodeType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Alts</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>    </span><a name="local-6989586621679608038"><a href="#local-6989586621679608038"><span class="hs-identifier">mkAlts</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#EmptyListOfAltsFor"><span class="hs-identifier hs-var">EmptyListOfAltsFor</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromJust</span><span> </span><a href="#local-6989586621679608030"><span class="hs-identifier hs-var">networkConfigOptsSelf</span></a><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>    </span><span class="hs-identifier">mkAlts</span><span> </span><a name="local-6989586621679608280"><a href="#local-6989586621679608280"><span class="hs-identifier">directory</span></a></a><span> </span><a name="local-6989586621679608281"><a href="#local-6989586621679608281"><span class="hs-identifier">names</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621679608282"><a href="#local-6989586621679608282"><span class="hs-identifier">name</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-376"></a><span>      </span><span class="hs-comment">-- Use the type associated to the first name, and assume all alts have</span><span>
</span><a name="line-377"></a><span>      </span><span class="hs-comment">-- same type.</span><span>
</span><a name="line-378"></a><span>      </span><span class="hs-comment">-- TODO we could easily check that using</span><span>
</span><a name="line-379"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-380"></a><span>      </span><span class="hs-comment">--   mapM (resolveName directory) names :: IO (NodeType, NodeId)</span><span>
</span><a name="line-381"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-382"></a><span>      </span><span class="hs-comment">-- and throw an exception if there's a mismatch.</span><span>
</span><a name="line-383"></a><span>      </span><a name="local-6989586621679608283"><a href="#local-6989586621679608283"><span class="hs-identifier">typ</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679608039"><span class="hs-identifier hs-var">resolveName</span></a><span> </span><a href="#local-6989586621679608280"><span class="hs-identifier hs-var">directory</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679608282"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-384"></a><span>      </span><a name="local-6989586621679608284"><a href="#local-6989586621679608284"><span class="hs-identifier">nids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679608039"><span class="hs-identifier hs-var">resolveName</span></a><span> </span><a href="#local-6989586621679608280"><span class="hs-identifier hs-var">directory</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679608281"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-385"></a><span>      </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679608283"><span class="hs-identifier hs-var">typ</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679608284"><span class="hs-identifier hs-var">nids</span></a><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span>    </span><span class="hs-identifier">resolveName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span> </span><a href="#local-6989586621679608040"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679608040"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-388"></a><span>    </span><a name="local-6989586621679608039"><a href="#local-6989586621679608039"><span class="hs-identifier">resolveName</span></a></a><span> </span><a name="local-6989586621679608285"><a href="#local-6989586621679608285"><span class="hs-identifier">directory</span></a></a><span> </span><a name="local-6989586621679608286"><a href="#local-6989586621679608286"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679608286"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679608285"><span class="hs-identifier hs-var">directory</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-389"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#UndefinedNodeName"><span class="hs-identifier hs-var">UndefinedNodeName</span></a><span> </span><a href="#local-6989586621679608286"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-390"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679608287"><a href="#local-6989586621679608287"><span class="hs-identifier">t</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679608287"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span class="hs-comment">-- | Resolve node name to IP address</span><span>
</span><a name="line-393"></a><span class="hs-comment">--</span><span>
</span><a name="line-394"></a><span class="hs-comment">-- We do this when reading the topology file so that we detect DNS problems</span><span>
</span><a name="line-395"></a><span class="hs-comment">-- early, and so that we are using canonical addresses (IP addresses) for</span><span>
</span><a name="line-396"></a><span class="hs-comment">-- node IDs.</span><span>
</span><a name="line-397"></a><span class="hs-comment">--</span><span>
</span><a name="line-398"></a><span class="hs-comment">-- NOTE: This is /only/ used for core or edge nodes (nodes with a statically</span><span>
</span><a name="line-399"></a><span class="hs-comment">-- configured set of peers). For such nodes it makes sense to detect DNS</span><span>
</span><a name="line-400"></a><span class="hs-comment">-- problems at startup. For behind NAT nodes we do not do any resolution at</span><span>
</span><a name="line-401"></a><span class="hs-comment">-- this point; instead, it happens dynamically in the subscription worker.</span><span>
</span><a name="line-402"></a><span class="hs-comment">-- This is important; in user applications we certainly don't want to prevent</span><span>
</span><a name="line-403"></a><span class="hs-comment">-- the application from starting up because of DNS problems at startup.</span><span>
</span><a name="line-404"></a><span class="hs-comment">--</span><span>
</span><a name="line-405"></a><span class="hs-comment">-- TODO: Support re-reading this file after SIGHUP.</span><span>
</span><a name="line-406"></a><span class="hs-identifier">resolveNodeAddr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigOpts"><span class="hs-identifier hs-type">NetworkConfigOpts</span></a><span>
</span><a name="line-407"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Network.Types.html#Resolver"><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Resolver</span></a><span>
</span><a name="line-408"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Network.DnsDomains.html#NodeAddr"><span class="hs-identifier hs-type">NodeAddr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DNS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Domain</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Pos.Util.TimeWarp.html#NetworkAddress"><span class="hs-identifier hs-type">NetworkAddress</span></a><span>
</span><a name="line-410"></a><a name="resolveNodeAddr"><a href="Pos.Network.CLI.html#resolveNodeAddr"><span class="hs-identifier">resolveNodeAddr</span></a></a><span> </span><a name="local-6989586621679608302"><a href="#local-6989586621679608302"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="Pos.Network.DnsDomains.html#NodeAddrExact"><span class="hs-identifier hs-var">NodeAddrExact</span></a><span> </span><a name="local-6989586621679608303"><a href="#local-6989586621679608303"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621679608304"><a href="#local-6989586621679608304"><span class="hs-identifier">mPort</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-411"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679608305"><a href="#local-6989586621679608305"><span class="hs-identifier">port</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">networkConfigOptsPort</span><span> </span><a href="#local-6989586621679608302"><span class="hs-identifier hs-var">cfg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679608304"><span class="hs-identifier hs-var">mPort</span></a><span>
</span><a name="line-412"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><span class="hs-glyph">@</span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679608303"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679608305"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span>
</span><a name="line-413"></a><span class="hs-identifier">resolveNodeAddr</span><span> </span><a name="local-6989586621679608306"><a href="#local-6989586621679608306"><span class="hs-identifier">cfg</span></a></a><span> </span><a name="local-6989586621679608307"><a href="#local-6989586621679608307"><span class="hs-identifier">resolve</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679608308"><a href="#local-6989586621679608308"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a href="Pos.Network.DnsDomains.html#NodeAddrDNS"><span class="hs-identifier hs-var">NodeAddrDNS</span></a><span> </span><a name="local-6989586621679608309"><a href="#local-6989586621679608309"><span class="hs-identifier">mHost</span></a></a><span> </span><a name="local-6989586621679608310"><a href="#local-6989586621679608310"><span class="hs-identifier">mPort</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-414"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679608313"><a href="#local-6989586621679608313"><span class="hs-identifier">host</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679608311"><span class="hs-identifier hs-var">nameToDomain</span></a><span> </span><a href="#local-6989586621679608308"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>         </span><a href="#local-6989586621679608309"><span class="hs-identifier hs-var">mHost</span></a><span>
</span><a name="line-415"></a><span>        </span><a name="local-6989586621679608314"><a href="#local-6989586621679608314"><span class="hs-identifier">port</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">networkConfigOptsPort</span><span> </span><a href="#local-6989586621679608306"><span class="hs-identifier hs-var">cfg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679608310"><span class="hs-identifier hs-var">mPort</span></a><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span>    </span><a name="local-6989586621679608315"><a href="#local-6989586621679608315"><span class="hs-identifier">mAddrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679608307"><span class="hs-identifier hs-var">resolve</span></a><span> </span><a href="#local-6989586621679608313"><span class="hs-identifier hs-var">host</span></a><span>
</span><a name="line-418"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679608315"><span class="hs-identifier hs-var">mAddrs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-419"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679608316"><a href="#local-6989586621679608316"><span class="hs-identifier">err</span></a></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigDnsError"><span class="hs-identifier hs-var">NetworkConfigDnsError</span></a><span> </span><a href="#local-6989586621679608313"><span class="hs-identifier hs-var">host</span></a><span> </span><a href="#local-6989586621679608316"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-420"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#CannotResolve"><span class="hs-identifier hs-var">CannotResolve</span></a><span> </span><a href="#local-6989586621679608308"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-421"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679608317"><a href="#local-6989586621679608317"><span class="hs-identifier">addrs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#NoUniqueResolution"><span class="hs-identifier hs-var">NoUniqueResolution</span></a><span> </span><a href="#local-6989586621679608308"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679608317"><span class="hs-identifier hs-var">addrs</span></a><span>
</span><a name="line-422"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">[</span><a name="local-6989586621679608318"><a href="#local-6989586621679608318"><span class="hs-identifier">addr</span></a></a><span class="hs-special">]</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#ipv4ToNetworkAddress"><span class="hs-identifier hs-var">ipv4ToNetworkAddress</span></a><span> </span><a href="#local-6989586621679608318"><span class="hs-identifier hs-var">addr</span></a><span> </span><a href="#local-6989586621679608314"><span class="hs-identifier hs-var">port</span></a><span>
</span><a name="line-423"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-424"></a><span>    </span><span class="hs-identifier">nameToDomain</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DNS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Domain</span><span>
</span><a name="line-425"></a><span>    </span><a name="local-6989586621679608311"><a href="#local-6989586621679608311"><span class="hs-identifier">nameToDomain</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-var">NodeName</span></a><span> </span><a name="local-6989586621679608312"><a href="#local-6989586621679608312"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">C8</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toString</span><span> </span><a href="#local-6989586621679608312"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span class="hs-identifier">ipv4ToNetworkAddress</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IPv4</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word16</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Util.TimeWarp.html#NetworkAddress"><span class="hs-identifier hs-type">NetworkAddress</span></a><span>
</span><a name="line-428"></a><a name="ipv4ToNetworkAddress"><a href="Pos.Network.CLI.html#ipv4ToNetworkAddress"><span class="hs-identifier">ipv4ToNetworkAddress</span></a></a><span> </span><a name="local-6989586621679608319"><a href="#local-6989586621679608319"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621679608320"><a href="#local-6989586621679608320"><span class="hs-identifier">port</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">C8</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679608319"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679608320"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span class="hs-identifier">metadataFor</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Network.Yaml.html#AllStaticallyKnownPeers"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">AllStaticallyKnownPeers</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Pos.Network.Yaml.html#NodeMetadata"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">NodeMetadata</span></a><span>
</span><a name="line-431"></a><a name="metadataFor"><a href="Pos.Network.CLI.html#metadataFor"><span class="hs-identifier">metadataFor</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Network.Yaml.html#AllStaticallyKnownPeers"><span class="hs-identifier hs-var">Y</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">AllStaticallyKnownPeers</span></a><span> </span><a name="local-6989586621679608321"><a href="#local-6989586621679608321"><span class="hs-identifier">allPeers</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679608322"><a href="#local-6989586621679608322"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-432"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679608322"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621679608321"><span class="hs-identifier hs-var">allPeers</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-433"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#UndefinedNodeName"><span class="hs-identifier hs-var">UndefinedNodeName</span></a><span> </span><a href="#local-6989586621679608322"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-434"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679608323"><a href="#local-6989586621679608323"><span class="hs-identifier">metadata</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679608323"><span class="hs-identifier hs-var">metadata</span></a><span>
</span><a name="line-435"></a><span>
</span><a name="line-436"></a><span class="hs-identifier">readTopology</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Pos.Network.Yaml.html#Topology"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Topology</span></a><span>
</span><a name="line-437"></a><a name="readTopology"><a href="Pos.Network.CLI.html#readTopology"><span class="hs-identifier">readTopology</span></a></a><span> </span><a name="local-6989586621679608324"><a href="#local-6989586621679608324"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-438"></a><span>    </span><a name="local-6989586621679608325"><a href="#local-6989586621679608325"><span class="hs-identifier">mTopology</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Yaml</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">decodeFileEither</span><span> </span><a href="#local-6989586621679608324"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-439"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679608325"><span class="hs-identifier hs-var">mTopology</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-440"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679608326"><a href="#local-6989586621679608326"><span class="hs-identifier">err</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#CannotParseNetworkConfig"><span class="hs-identifier hs-var">CannotParseNetworkConfig</span></a><span> </span><a href="#local-6989586621679608326"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-441"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679608327"><a href="#local-6989586621679608327"><span class="hs-identifier">topology</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679608327"><span class="hs-identifier hs-var">topology</span></a><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span class="hs-identifier">readPolicies</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Pos.Network.Yaml.html#StaticPolicies"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">StaticPolicies</span></a><span>
</span><a name="line-444"></a><a name="readPolicies"><a href="Pos.Network.CLI.html#readPolicies"><span class="hs-identifier">readPolicies</span></a></a><span> </span><a name="local-6989586621679608328"><a href="#local-6989586621679608328"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-445"></a><span>    </span><a name="local-6989586621679608329"><a href="#local-6989586621679608329"><span class="hs-identifier">mStaticPolicies</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Yaml</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">decodeFileEither</span><span> </span><a href="#local-6989586621679608328"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-446"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679608329"><span class="hs-identifier hs-var">mStaticPolicies</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-447"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679608330"><a href="#local-6989586621679608330"><span class="hs-identifier">err</span></a></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#CannotParsePolicies"><span class="hs-identifier hs-var">CannotParsePolicies</span></a><span> </span><a href="#local-6989586621679608330"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-448"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679608331"><a href="#local-6989586621679608331"><span class="hs-identifier">staticPolicies</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679608331"><span class="hs-identifier hs-var">staticPolicies</span></a><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span class="hs-identifier">parseKademlia</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Pos.Network.Yaml.html#KademliaParams"><span class="hs-identifier hs-type">Y</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">KademliaParams</span></a><span>
</span><a name="line-451"></a><a name="parseKademlia"><a href="Pos.Network.CLI.html#parseKademlia"><span class="hs-identifier">parseKademlia</span></a></a><span> </span><a name="local-6989586621679608332"><a href="#local-6989586621679608332"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-452"></a><span>    </span><a name="local-6989586621679608333"><a href="#local-6989586621679608333"><span class="hs-identifier">mKademlia</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Yaml</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">decodeFileEither</span><span> </span><a href="#local-6989586621679608332"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-453"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679608333"><span class="hs-identifier hs-var">mKademlia</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-454"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span>  </span><a name="local-6989586621679608334"><a href="#local-6989586621679608334"><span class="hs-identifier">err</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Network.CLI.html#CannotParseKademliaConfig"><span class="hs-identifier hs-var">CannotParseKademliaConfig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679608334"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679608335"><a href="#local-6989586621679608335"><span class="hs-identifier">kademlia</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679608335"><span class="hs-identifier hs-var">kademlia</span></a><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span class="hs-comment">{-------------------------------------------------------------------------------
  Errors
-------------------------------------------------------------------------------}</span><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span class="hs-comment">-- | Something is wrong with the network configuration</span><span>
</span><a name="line-462"></a><span class="hs-comment">--</span><span>
</span><a name="line-463"></a><span class="hs-comment">-- NOTE: Behind NAT nodes are not given an explicit network configuration file,</span><span>
</span><a name="line-464"></a><span class="hs-comment">-- but instead rely on the default topology. These exceptions should never be</span><span>
</span><a name="line-465"></a><span class="hs-comment">-- thrown for behind NAT nodes, as we don't want to prevent the user application</span><span>
</span><a name="line-466"></a><span class="hs-comment">-- from starting up.</span><span>
</span><a name="line-467"></a><span class="hs-keyword">data</span><span> </span><a name="NetworkConfigException"><a href="Pos.Network.CLI.html#NetworkConfigException"><span class="hs-identifier">NetworkConfigException</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-468"></a><span>    </span><span class="hs-comment">-- | We cannot parse the topology .yaml file</span><span>
</span><a name="line-469"></a><span>    </span><a name="CannotParseNetworkConfig"><a href="Pos.Network.CLI.html#CannotParseNetworkConfig"><span class="hs-identifier">CannotParseNetworkConfig</span></a></a><span> </span><span class="hs-identifier hs-type">Yaml</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ParseException</span><span>
</span><a name="line-470"></a><span>
</span><a name="line-471"></a><span>    </span><span class="hs-comment">-- | A Kademlia configuration file is expected but was not specified.</span><span>
</span><a name="line-472"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="MissingKademliaConfig"><a href="Pos.Network.CLI.html#MissingKademliaConfig"><span class="hs-identifier">MissingKademliaConfig</span></a></a><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span>    </span><span class="hs-comment">-- | We cannot parse the kademlia .yaml file</span><span>
</span><a name="line-475"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="CannotParseKademliaConfig"><a href="Pos.Network.CLI.html#CannotParseKademliaConfig"><span class="hs-identifier">CannotParseKademliaConfig</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Pos.DHT.Real.Param.html#MalformedDHTKey"><span class="hs-identifier hs-type">DHT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">MalformedDHTKey</span></a><span> </span><span class="hs-identifier hs-type">Yaml</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ParseException</span><span class="hs-special">)</span><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span>    </span><span class="hs-comment">-- | A policy description .yaml was specified but couldn't be parsed.</span><span>
</span><a name="line-478"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="CannotParsePolicies"><a href="Pos.Network.CLI.html#CannotParsePolicies"><span class="hs-identifier">CannotParsePolicies</span></a></a><span> </span><span class="hs-identifier hs-type">Yaml</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ParseException</span><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span>    </span><span class="hs-comment">-- | We use a set of statically known peers but we weren't given the</span><span>
</span><a name="line-481"></a><span>    </span><span class="hs-comment">-- name of the current node</span><span>
</span><a name="line-482"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NetworkConfigSelfUnknown"><a href="Pos.Network.CLI.html#NetworkConfigSelfUnknown"><span class="hs-identifier">NetworkConfigSelfUnknown</span></a></a><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span>    </span><span class="hs-comment">-- | We resolved our name under static configuration to be an edge node.</span><span>
</span><a name="line-485"></a><span>    </span><span class="hs-comment">-- This indicates a programmer error.</span><span>
</span><a name="line-486"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NetworkConfigSelfEdge"><a href="Pos.Network.CLI.html#NetworkConfigSelfEdge"><span class="hs-identifier">NetworkConfigSelfEdge</span></a></a><span>
</span><a name="line-487"></a><span>
</span><a name="line-488"></a><span>    </span><span class="hs-comment">-- | The .yaml file contains a node name which is undefined</span><span>
</span><a name="line-489"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="UndefinedNodeName"><a href="Pos.Network.CLI.html#UndefinedNodeName"><span class="hs-identifier">UndefinedNodeName</span></a></a><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span>    </span><span class="hs-comment">-- | The static routes for a node contains an empty list of alternatives</span><span>
</span><a name="line-492"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="EmptyListOfAltsFor"><a href="Pos.Network.CLI.html#EmptyListOfAltsFor"><span class="hs-identifier">EmptyListOfAltsFor</span></a></a><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span>
</span><a name="line-493"></a><span>
</span><a name="line-494"></a><span>    </span><span class="hs-comment">-- | Something went wrong during node name resolution</span><span>
</span><a name="line-495"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NetworkConfigDnsError"><a href="Pos.Network.CLI.html#NetworkConfigDnsError"><span class="hs-identifier">NetworkConfigDnsError</span></a></a><span> </span><span class="hs-identifier hs-type">DNS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Domain</span><span> </span><span class="hs-identifier hs-type">DNS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">DNSError</span><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span>    </span><span class="hs-comment">-- | Could not resolve a node name to an IP address</span><span>
</span><a name="line-498"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="CannotResolve"><a href="Pos.Network.CLI.html#CannotResolve"><span class="hs-identifier">CannotResolve</span></a></a><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span>
</span><a name="line-499"></a><span>
</span><a name="line-500"></a><span>    </span><span class="hs-comment">-- | DNS returned multiple IP addresses for the give node name</span><span>
</span><a name="line-501"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-502"></a><span>    </span><span class="hs-comment">-- This is no good because we need canonical node IDs.</span><span>
</span><a name="line-503"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NoUniqueResolution"><a href="Pos.Network.CLI.html#NoUniqueResolution"><span class="hs-identifier">NoUniqueResolution</span></a></a><span> </span><a href="Pos.Network.Types.html#NodeName"><span class="hs-identifier hs-type">NodeName</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">IPv4</span><span class="hs-special">]</span><span>
</span><a name="line-504"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Pos.Network.CLI.html#NetworkConfigException"><span class="hs-identifier hs-type">NetworkConfigException</span></a><span>
</span><a name="line-507"></a></pre></body></html>