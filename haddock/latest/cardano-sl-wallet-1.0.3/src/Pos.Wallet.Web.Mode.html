<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Mode</span><span>
</span><a name="line-6"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Pos.Wallet.Web.Mode.html#WalletWebMode"><span class="hs-identifier hs-type">WalletWebMode</span></a><span>
</span><a name="line-7"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Mode.html#WalletWebModeContextTag"><span class="hs-identifier hs-type">WalletWebModeContextTag</span></a><span>
</span><a name="line-8"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Mode.html#WalletWebModeContext"><span class="hs-identifier hs-type">WalletWebModeContext</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-9"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Mode.html#MonadWalletWebMode"><span class="hs-identifier hs-type">MonadWalletWebMode</span></a><span>
</span><a name="line-10"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Mode.html#convertCIdTOAddrs"><span class="hs-identifier hs-var">convertCIdTOAddrs</span></a><span>
</span><a name="line-11"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Mode.html#convertCIdTOAddr"><span class="hs-identifier hs-var">convertCIdTOAddr</span></a><span>
</span><a name="line-12"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Mode.html#AddrCIdHashes"><span class="hs-identifier hs-type">AddrCIdHashes</span></a><span class="hs-special">(</span><a href="Pos.Wallet.Web.Mode.html#AddrCIdHashes"><span class="hs-identifier hs-var">AddrCIdHashes</span></a><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">makeLensesWith</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Reader</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Mtl</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Foldable</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Foldable</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span>                         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Ether</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasLens</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Mockable</span><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Production</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Wlog</span><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasLoggerName</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Block</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">BlockHeader</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Slog</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasSlogContext</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>                                                   </span><span class="hs-identifier hs-type">HasSlogGState</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Undo</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Configuration</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasNodeConfiguration</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Context</span><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasNodeContext</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Address</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasConfiguration</span><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>                                                   </span><span class="hs-identifier hs-type">HasPrimaryKey</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IsHeader</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadGState</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dbGetBlockDefault</span><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>                                                   </span><span class="hs-identifier hs-var">dbGetBlockSscDefault</span><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>                                                   </span><span class="hs-identifier hs-var">dbGetHeaderDefault</span><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>                                                   </span><span class="hs-identifier hs-var">dbGetHeaderSscDefault</span><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>                                                   </span><span class="hs-identifier hs-var">dbGetUndoDefault</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">dbGetUndoSscDefault</span><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>                                                   </span><span class="hs-identifier hs-var">dbPutBlundDefault</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadBlockDBGeneric</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>                                                   </span><span class="hs-identifier hs-type">MonadBlockDBGenericWrite</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>                                                   </span><span class="hs-identifier hs-type">MonadDB</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadDBRead</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gsAdoptedBVDataDefault</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">Rocks</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dbDeleteDefault</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">dbGetDefault</span><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>                                                   </span><span class="hs-identifier hs-var">dbIterSourceDefault</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">dbPutDefault</span><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>                                                   </span><span class="hs-identifier hs-var">dbWriteBatchDefault</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Client</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span><span class="hs-operator">.</span><span class="hs-identifier">Balances</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadBalances</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getBalanceDefault</span><span class="hs-special">,</span><span>
</span><a name="line-49"></a><span>                                                   </span><span class="hs-identifier hs-var">getOwnUtxosDefault</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Client</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span><span class="hs-operator">.</span><span class="hs-identifier">History</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadTxHistory</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-51"></a><span>                                                   </span><span class="hs-identifier hs-var">getBlockHistoryDefault</span><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>                                                   </span><span class="hs-identifier hs-var">getLocalHistoryDefault</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">saveTxDefault</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Infra</span><span class="hs-operator">.</span><span class="hs-identifier">Configuration</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasInfraConfiguration</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">KnownPeers</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadFormatPeers</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>                                                   </span><span class="hs-identifier hs-type">MonadKnownPeers</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Reporting</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasReportingContext</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasNodeType</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Shutdown</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasShutdownContext</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Slotting</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadSlots</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Slotting</span><span class="hs-operator">.</span><span class="hs-identifier">Impl</span><span class="hs-operator">.</span><span class="hs-identifier">Sum</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">currentTimeSlottingSum</span><span class="hs-special">,</span><span>
</span><a name="line-61"></a><span>                                                   </span><span class="hs-identifier hs-var">getCurrentSlotBlockingSum</span><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>                                                   </span><span class="hs-identifier hs-var">getCurrentSlotInaccurateSum</span><span class="hs-special">,</span><span>
</span><a name="line-63"></a><span>                                                   </span><span class="hs-identifier hs-var">getCurrentSlotSum</span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Slotting</span><span class="hs-operator">.</span><span class="hs-identifier">MemState</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasSlottingVar</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadSlotsData</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasSscContext</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SscBlock</span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">GodTossing</span><span class="hs-operator">.</span><span class="hs-identifier">Configuration</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasGtConfiguration</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Update</span><span class="hs-operator">.</span><span class="hs-identifier">Configuration</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasUpdateConfiguration</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Some</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">JsonLog</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasJsonLogConfig</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">jsonLogDefault</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">LoggerName</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasLoggerName'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-71"></a><span>                                                 </span><span class="hs-identifier hs-var">getLoggerNameDefault</span><span class="hs-special">,</span><span>
</span><a name="line-72"></a><span>                                                 </span><span class="hs-identifier hs-var">modifyLoggerNameDefault</span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">OutboundQueue</span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">OQ</span><span class="hs-operator">.</span><span class="hs-identifier">Reader</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">TimeWarp</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CanJsonLog</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">UserSecret</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasUserSecret</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">postfixLFields</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Redirect.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Redirect</span></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadBlockchainInfo</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-78"></a><span>                                                 </span><span class="hs-identifier hs-type">MonadUpdates</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-79"></a><span>                                                 </span><a href="Pos.Wallet.Redirect.html#applyLastUpdateWebWallet"><span class="hs-identifier hs-var">applyLastUpdateWebWallet</span></a><span class="hs-special">,</span><span>
</span><a name="line-80"></a><span>                                                 </span><a href="Pos.Wallet.Redirect.html#blockchainSlotDurationWebWallet"><span class="hs-identifier hs-var">blockchainSlotDurationWebWallet</span></a><span class="hs-special">,</span><span>
</span><a name="line-81"></a><span>                                                 </span><a href="Pos.Wallet.Redirect.html#connectedPeersWebWallet"><span class="hs-identifier hs-var">connectedPeersWebWallet</span></a><span class="hs-special">,</span><span>
</span><a name="line-82"></a><span>                                                 </span><a href="Pos.Wallet.Redirect.html#localChainDifficultyWebWallet"><span class="hs-identifier hs-var">localChainDifficultyWebWallet</span></a><span class="hs-special">,</span><span>
</span><a name="line-83"></a><span>                                                 </span><a href="Pos.Wallet.Redirect.html#networkChainDifficultyWebWallet"><span class="hs-identifier hs-var">networkChainDifficultyWebWallet</span></a><span class="hs-special">,</span><span>
</span><a name="line-84"></a><span>                                                 </span><a href="Pos.Wallet.Redirect.html#waitForUpdateWebWallet"><span class="hs-identifier hs-var">waitForUpdateWebWallet</span></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">SscType</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WalletSscType</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">ClientTypes</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Addr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CHash</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">cIdToAddress</span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WalletError</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.Sockets.ConnSet.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Sockets</span><span class="hs-operator">.</span><span class="hs-identifier">ConnSet</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.Sockets.ConnSet.html#ConnectionsVar"><span class="hs-identifier hs-type">ConnectionsVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WalletState</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.Tracking.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Tracking</span></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadBListener</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Tracking.BListener.html#onApplyTracking"><span class="hs-identifier hs-var">onApplyTracking</span></a><span class="hs-special">,</span><span>
</span><a name="line-91"></a><span>                                                 </span><a href="Pos.Wallet.Web.Tracking.BListener.html#onRollbackTracking"><span class="hs-identifier hs-var">onRollbackTracking</span></a><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">WorkMode</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RealModeContext</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-keyword">data</span><span> </span><a name="WalletWebModeContext"><a href="Pos.Wallet.Web.Mode.html#WalletWebModeContext"><span class="hs-identifier">WalletWebModeContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="WalletWebModeContext"><a href="Pos.Wallet.Web.Mode.html#WalletWebModeContext"><span class="hs-identifier">WalletWebModeContext</span></a></a><span>
</span><a name="line-98"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="wwmcWalletState"><a href="Pos.Wallet.Web.Mode.html#wwmcWalletState"><span class="hs-identifier">wwmcWalletState</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">WalletState</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="wwmcConnectionsVar"><a href="Pos.Wallet.Web.Mode.html#wwmcConnectionsVar"><span class="hs-identifier">wwmcConnectionsVar</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Wallet.Web.Sockets.ConnSet.html#ConnectionsVar"><span class="hs-identifier hs-type">ConnectionsVar</span></a><span>
</span><a name="line-100"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="wwmcHashes"><a href="Pos.Wallet.Web.Mode.html#wwmcHashes"><span class="hs-identifier">wwmcHashes</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Wallet.Web.Mode.html#AddrCIdHashes"><span class="hs-identifier hs-type">AddrCIdHashes</span></a><span>
</span><a name="line-101"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="wwmcRealModeContext"><a href="Pos.Wallet.Web.Mode.html#wwmcRealModeContext"><span class="hs-identifier">wwmcRealModeContext</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RealModeContext</span><span> </span><span class="hs-identifier hs-type">WalletSscType</span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-keyword">newtype</span><span> </span><a name="AddrCIdHashes"><a href="Pos.Wallet.Web.Mode.html#AddrCIdHashes"><span class="hs-identifier">AddrCIdHashes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="AddrCIdHashes"><a href="Pos.Wallet.Web.Mode.html#AddrCIdHashes"><span class="hs-identifier">AddrCIdHashes</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="unAddrCIdHashes"><a href="Pos.Wallet.Web.Mode.html#unAddrCIdHashes"><span class="hs-identifier">unAddrCIdHashes</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">CHash</span><span> </span><span class="hs-identifier hs-type">Address</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-identifier hs-var">makeLensesWith</span><span> </span><span class="hs-identifier hs-var">postfixLFields</span><span> </span><span class="hs-char">''WalletWebModeContext

instance HasLens AddrCIdHashes WalletWebModeContext AddrCIdHashes where
    lensOf = wwmcHashes_L

convertCIdTOAddr :: (MonadWalletWebMode m) =&gt; CId Addr -&gt; m Address
convertCIdTOAddr i@(CId id) = do
    hmRef &lt;- unAddrCIdHashes &lt;$&gt; view (lensOf @AddrCIdHashes)
    maddr &lt;- atomicModifyIORef' hmRef $ \hm -&gt;
      case id `M.lookup` hm of
       Just addr -&gt; (hm, Right addr)
       _         -&gt; case cIdToAddress i of
                    -- decoding can fail, but we don't cache failures
                      Right addr -&gt; (M.insert id addr hm, Right addr)
                      Left  err  -&gt; (hm,                  Left err)
    either (throwM . DecodeError) pure maddr

convertCIdTOAddrs :: (MonadWalletWebMode m, Traversable t) =&gt; t (CId Addr) -&gt; m (t Address)
convertCIdTOAddrs cids = do
    hmRef &lt;- unAddrCIdHashes &lt;$&gt; view (lensOf @AddrCIdHashes)
    maddrs &lt;- atomicModifyIORef' hmRef $ \hm -&gt;
      let lookups = map (\cid@(CId h) -&gt; (h, M.lookup h hm, cIdToAddress cid)) cids
          hm'     = Foldable.foldl' accum hm lookups

          accum m (cid, Nothing, Right addr) = M.insert cid addr m
          accum m _                          = m

          result (_, Just addr, _)   = Right addr
          result (_, Nothing, maddr) = maddr

       in (hm', map result lookups)

    mapM (either (throwM . DecodeError) pure) maddrs

instance HasSscContext WalletSscType WalletWebModeContext where
    sscContext = wwmcRealModeContext_L . sscContext

instance HasPrimaryKey WalletWebModeContext where
    primaryKey = wwmcRealModeContext_L . primaryKey

instance HasReportingContext WalletWebModeContext  where
    reportingContext = wwmcRealModeContext_L . reportingContext

instance HasUserSecret WalletWebModeContext where
    userSecret = wwmcRealModeContext_L . userSecret

instance HasShutdownContext WalletWebModeContext where
    shutdownContext = wwmcRealModeContext_L . shutdownContext

instance HasNodeContext WalletSscType WalletWebModeContext where
    nodeContext = wwmcRealModeContext_L . nodeContext

instance HasSlottingVar WalletWebModeContext where
    slottingTimestamp = wwmcRealModeContext_L . slottingTimestamp
    slottingVar = wwmcRealModeContext_L . slottingVar

instance HasLens WalletState WalletWebModeContext WalletState where
    lensOf = wwmcWalletState_L

instance HasLens ConnectionsVar WalletWebModeContext ConnectionsVar where
    lensOf = wwmcConnectionsVar_L

instance {-# OVERLAPPABLE #-}
    HasLens tag (RealModeContext WalletSscType) r =&gt;
    HasLens tag WalletWebModeContext r
  where
    lensOf = wwmcRealModeContext_L . lensOf @tag

instance HasLoggerName' WalletWebModeContext where
    loggerName = wwmcRealModeContext_L . loggerName

instance HasSlogContext WalletWebModeContext where
    slogContext = wwmcRealModeContext_L . slogContext

instance HasSlogGState WalletWebModeContext where
    slogGState = wwmcRealModeContext_L . slogGState

instance HasJsonLogConfig WalletWebModeContext where
    jsonLogConfig = wwmcRealModeContext_L . jsonLogConfig

instance HasNodeType WalletWebModeContext where
    getNodeType = getNodeType . wwmcRealModeContext

data WalletWebModeContextTag

instance HasLens WalletWebModeContextTag WalletWebModeContext WalletWebModeContext where
    lensOf = identity

type WalletWebMode = Mtl.ReaderT WalletWebModeContext Production

-- This constraint used to be abstract (a list of classes), but specifying a
-- concrete monad is quite likely more performant.
type MonadWalletWebMode m =
    ( HasConfiguration
    , HasNodeConfiguration
    , HasInfraConfiguration
    , HasGtConfiguration
    , HasUpdateConfiguration
    , m ~ WalletWebMode
    )

instance (HasConfiguration, HasInfraConfiguration, MonadSlotsData ctx WalletWebMode)
      =&gt; MonadSlots ctx WalletWebMode
  where
    getCurrentSlot = getCurrentSlotSum
    getCurrentSlotBlocking = getCurrentSlotBlockingSum
    getCurrentSlotInaccurate = getCurrentSlotInaccurateSum
    currentTimeSlotting = currentTimeSlottingSum

instance {-# OVERLAPPING #-} HasLoggerName WalletWebMode where
    getLoggerName = getLoggerNameDefault
    modifyLoggerName = modifyLoggerNameDefault

instance {-# OVERLAPPING #-} CanJsonLog WalletWebMode where
    jsonLog = jsonLogDefault

instance HasConfiguration =&gt; MonadDBRead WalletWebMode where
    dbGet = dbGetDefault
    dbIterSource = dbIterSourceDefault

instance HasConfiguration =&gt; MonadDB WalletWebMode where
    dbPut = dbPutDefault
    dbWriteBatch = dbWriteBatchDefault
    dbDelete = dbDeleteDefault

instance (HasConfiguration, HasGtConfiguration) =&gt;
         MonadBlockDBGenericWrite (BlockHeader WalletSscType) (Block WalletSscType) Undo WalletWebMode where
    dbPutBlund = dbPutBlundDefault

instance (HasConfiguration, HasGtConfiguration) =&gt;
         MonadBlockDBGeneric (BlockHeader WalletSscType) (Block WalletSscType) Undo WalletWebMode
  where
    dbGetBlock  = dbGetBlockDefault @WalletSscType
    dbGetUndo   = dbGetUndoDefault @WalletSscType
    dbGetHeader = dbGetHeaderDefault @WalletSscType

instance (HasConfiguration, HasGtConfiguration) =&gt;
         MonadBlockDBGeneric (Some IsHeader) (SscBlock WalletSscType) () WalletWebMode
  where
    dbGetBlock  = dbGetBlockSscDefault @WalletSscType
    dbGetUndo   = dbGetUndoSscDefault @WalletSscType
    dbGetHeader = dbGetHeaderSscDefault @WalletSscType

instance HasConfiguration =&gt; MonadGState WalletWebMode where
    gsAdoptedBVData = gsAdoptedBVDataDefault

instance (HasConfiguration, HasInfraConfiguration) =&gt; MonadBListener WalletWebMode where
    onApplyBlocks = onApplyTracking
    onRollbackBlocks = onRollbackTracking

instance MonadUpdates WalletWebMode where
    waitForUpdate = waitForUpdateWebWallet
    applyLastUpdate = applyLastUpdateWebWallet

instance (HasConfiguration, HasGtConfiguration, HasInfraConfiguration) =&gt; MonadBlockchainInfo WalletWebMode where
    networkChainDifficulty = networkChainDifficultyWebWallet
    localChainDifficulty = localChainDifficultyWebWallet
    connectedPeers = connectedPeersWebWallet
    blockchainSlotDuration = blockchainSlotDurationWebWallet

instance HasConfiguration =&gt; MonadBalances WalletWebMode where
    getOwnUtxos = getOwnUtxosDefault
    getBalance = getBalanceDefault

instance (HasConfiguration, HasGtConfiguration, HasInfraConfiguration) =&gt; MonadTxHistory WalletSscType WalletWebMode where
    getBlockHistory = getBlockHistoryDefault @WalletSscType
    getLocalHistory = getLocalHistoryDefault
    saveTx = saveTxDefault

instance MonadKnownPeers WalletWebMode where
    updatePeersBucket = OQ.Reader.updatePeersBucketReader (rmcOutboundQ . wwmcRealModeContext)

instance MonadFormatPeers WalletWebMode where
    formatKnownPeers = OQ.Reader.formatKnownPeersReader (rmcOutboundQ . wwmcRealModeContext)
</span></pre></body></html>