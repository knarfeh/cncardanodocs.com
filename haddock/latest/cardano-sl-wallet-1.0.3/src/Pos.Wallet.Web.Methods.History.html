<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-- | Wallet history</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Methods</span><span class="hs-operator">.</span><span class="hs-identifier">History</span><span>
</span><a name="line-6"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Pos.Wallet.Web.Methods.History.html#getHistoryLimited"><span class="hs-identifier hs-var">getHistoryLimited</span></a><span>
</span><a name="line-7"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Methods.History.html#addHistoryTx"><span class="hs-identifier hs-var">addHistoryTx</span></a><span>
</span><a name="line-8"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Methods.History.html#constructCTx"><span class="hs-identifier hs-var">constructCTx</span></a><span>
</span><a name="line-9"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Methods.History.html#getCurChainDifficulty"><span class="hs-identifier hs-var">getCurChainDifficulty</span></a><span>
</span><a name="line-10"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Methods.History.html#updateTransaction"><span class="hs-identifier hs-var">updateTransaction</span></a><span>
</span><a name="line-11"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">throw</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Set</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Clock</span><span class="hs-operator">.</span><span class="hs-identifier">POSIX</span><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">POSIXTime</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getPOSIXTime</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Formatting</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">build</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sformat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stext</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listJson</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">listJsonIndent</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Wlog</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WithLogger</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logDebug</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logInfo</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logWarning</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Aeson.ClientTypes.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Aeson</span><span class="hs-operator">.</span><span class="hs-identifier">ClientTypes</span></a><span>      </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Aeson.WalletBackup.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Aeson</span><span class="hs-operator">.</span><span class="hs-identifier">WalletBackup</span></a><span>     </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Client</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span><span class="hs-operator">.</span><span class="hs-identifier">History</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TxHistoryEntry</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">txHistoryListToMap</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ChainDifficulty</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">timestampToPosix</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TxId</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">LogSafe</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">logInfoS</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Servant</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">encodeCType</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">WalletMode</span><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLocalHistory</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">localChainDifficulty</span><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>                                             </span><span class="hs-identifier hs-var">networkChainDifficulty</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">ClientTypes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AccountId</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Addr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CTx</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CTxId</span><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>                                             </span><span class="hs-identifier hs-type">CTxMeta</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CWAddressMeta</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>                                             </span><span class="hs-identifier hs-type">ScrollLimit</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ScrollOffset</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Wal</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkCTx</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WalletError</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.Mode.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Mode</span></a><span>        </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.Mode.html#MonadWalletWebMode"><span class="hs-identifier hs-type">MonadWalletWebMode</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Mode.html#convertCIdTOAddrs"><span class="hs-identifier hs-var">convertCIdTOAddrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.Pending.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Pending</span></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">PendingTx</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Pending.Util.html#ptxPoolInfo"><span class="hs-identifier hs-var">ptxPoolInfo</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">_PtxApplying</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AddressLookupMode</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ever</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AddressInfo</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>                                             </span><span class="hs-identifier hs-var">addOnlyNewTxMetas</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getHistoryCache</span><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>                                             </span><span class="hs-identifier hs-var">getPendingTx</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getTxMeta</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getWalletPendingTxs</span><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>                                             </span><span class="hs-identifier hs-var">setWalletTxMeta</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getAccountAddrsOrThrow</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getWalletAccountIds</span><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>                                             </span><span class="hs-identifier hs-var">getWalletAddrs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getWalletAddrsDetector</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-identifier">getFullWalletHistory</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Wallet.Web.Mode.html#MonadWalletWebMode"><span class="hs-identifier hs-type">MonadWalletWebMode</span></a><span> </span><a href="#local-6989586621680121615"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-identifier hs-type">Wal</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121615"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">TxId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CTx</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">POSIXTime</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Word</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><a name="getFullWalletHistory"><a href="Pos.Wallet.Web.Methods.History.html#getFullWalletHistory"><span class="hs-identifier">getFullWalletHistory</span></a></a><span> </span><a name="local-6989586621680121616"><a href="#local-6989586621680121616"><span class="hs-identifier">cWalId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-47"></a><span>    </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;getFullWalletHistory: start&quot;</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span>    </span><a name="local-6989586621680121617"><a href="#local-6989586621680121617"><span class="hs-identifier">cAddrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getWalletAddrs</span><span> </span><span class="hs-identifier hs-var">Ever</span><span> </span><a href="#local-6989586621680121616"><span class="hs-identifier hs-var">cWalId</span></a><span>
</span><a name="line-50"></a><span>    </span><a name="local-6989586621680121618"><a href="#local-6989586621680121618"><span class="hs-identifier">addrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Wallet.Web.Mode.html#convertCIdTOAddrs"><span class="hs-identifier hs-var">convertCIdTOAddrs</span></a><span> </span><a href="#local-6989586621680121617"><span class="hs-identifier hs-var">cAddrs</span></a><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span>    </span><a name="local-6989586621680121619"><a href="#local-6989586621680121619"><span class="hs-identifier">unfilteredLocalHistory</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getLocalHistory</span><span> </span><a href="#local-6989586621680121618"><span class="hs-identifier hs-var">addrs</span></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span>    </span><a name="local-6989586621680121621"><a href="#local-6989586621680121621"><span class="hs-identifier">blockHistory</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getHistoryCache</span><span> </span><a href="#local-6989586621680121616"><span class="hs-identifier hs-var">cWalId</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-55"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680121620"><a href="#local-6989586621680121620"><span class="hs-identifier">hist</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621680121620"><span class="hs-identifier hs-var">hist</span></a><span>
</span><a name="line-56"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-57"></a><span>            </span><span class="hs-identifier hs-var">logWarning</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-58"></a><span>                </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;getFullWalletHistory: history cache is empty for wallet #&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>                </span><a href="#local-6989586621680121616"><span class="hs-identifier hs-var">cWalId</span></a><span>
</span><a name="line-60"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span>    </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;getFullWalletHistory: fetched addresses and block/local histories&quot;</span><span>
</span><a name="line-63"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680121622"><a href="#local-6989586621680121622"><span class="hs-identifier">localHistory</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680121619"><span class="hs-identifier hs-var">unfilteredLocalHistory</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">difference</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680121621"><span class="hs-identifier hs-var">blockHistory</span></a><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span>    </span><a href="Pos.Wallet.Web.Methods.History.html#logTxHistory"><span class="hs-identifier hs-var">logTxHistory</span></a><span> </span><span class="hs-string">&quot;Mempool&quot;</span><span> </span><a href="#local-6989586621680121622"><span class="hs-identifier hs-var">localHistory</span></a><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span>    </span><a name="local-6989586621680121623"><a href="#local-6989586621680121623"><span class="hs-identifier">fullHistory</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Wallet.Web.Methods.History.html#addRecentPtxHistory"><span class="hs-identifier hs-var">addRecentPtxHistory</span></a><span> </span><a href="#local-6989586621680121616"><span class="hs-identifier hs-var">cWalId</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680121622"><span class="hs-identifier hs-var">localHistory</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680121621"><span class="hs-identifier hs-var">blockHistory</span></a><span>
</span><a name="line-68"></a><span>    </span><a name="local-6989586621680121624"><a href="#local-6989586621680121624"><span class="hs-identifier">walAddrsDetector</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getWalletAddrsDetector</span><span> </span><span class="hs-identifier hs-var">Ever</span><span> </span><a href="#local-6989586621680121616"><span class="hs-identifier hs-var">cWalId</span></a><span>
</span><a name="line-69"></a><span>    </span><a name="local-6989586621680121625"><a href="#local-6989586621680121625"><span class="hs-identifier">diff</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Wallet.Web.Methods.History.html#getCurChainDifficulty"><span class="hs-identifier hs-var">getCurChainDifficulty</span></a><span>
</span><a name="line-70"></a><span>    </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;getFullWalletHistory: fetched full history&quot;</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span>    </span><span class="hs-comment">-- TODO when we introduce some mechanism to react on new tx in mempool,</span><span>
</span><a name="line-73"></a><span>    </span><span class="hs-comment">-- we will set timestamp tx as current time and remove call of @addHistoryTxs@</span><span>
</span><a name="line-74"></a><span>    </span><span class="hs-comment">-- We call @addHistoryTxs@ only for mempool transactions because for</span><span>
</span><a name="line-75"></a><span>    </span><span class="hs-comment">-- transactions from block and resubmitting timestamp is already known.</span><span>
</span><a name="line-76"></a><span>    </span><a href="Pos.Wallet.Web.Methods.History.html#addHistoryTxs"><span class="hs-identifier hs-var">addHistoryTxs</span></a><span> </span><a href="#local-6989586621680121616"><span class="hs-identifier hs-var">cWalId</span></a><span> </span><a href="#local-6989586621680121622"><span class="hs-identifier hs-var">localHistory</span></a><span>
</span><a name="line-77"></a><span>    </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;getFullWalletHistory: invoked addHistoryTxs&quot;</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>    </span><span class="hs-glyph">!</span><a name="local-6989586621680121626"><a href="#local-6989586621680121626"><span class="hs-identifier">cHistory</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forM</span><span> </span><a href="#local-6989586621680121623"><span class="hs-identifier hs-var">fullHistory</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.Methods.History.html#constructCTx"><span class="hs-identifier hs-var">constructCTx</span></a><span> </span><a href="#local-6989586621680121616"><span class="hs-identifier hs-var">cWalId</span></a><span> </span><a href="#local-6989586621680121624"><span class="hs-identifier hs-var">walAddrsDetector</span></a><span> </span><a href="#local-6989586621680121625"><span class="hs-identifier hs-var">diff</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>    </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;getFullWalletHistory: formed cTxs&quot;</span><span>
</span><a name="line-81"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680121626"><span class="hs-identifier hs-var">cHistory</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">size</span><span> </span><a href="#local-6989586621680121626"><span class="hs-identifier hs-var">cHistory</span></a><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-identifier">getHistory</span><span>
</span><a name="line-84"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Wallet.Web.Mode.html#MonadWalletWebMode"><span class="hs-identifier hs-type">MonadWalletWebMode</span></a><span> </span><a href="#local-6989586621680121614"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-85"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-identifier hs-type">Wal</span><span>
</span><a name="line-86"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AccountId</span><span class="hs-special">]</span><span>
</span><a name="line-87"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-identifier hs-type">Addr</span><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121614"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">TxId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CTx</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">POSIXTime</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Word</span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><a name="getHistory"><a href="Pos.Wallet.Web.Methods.History.html#getHistory"><span class="hs-identifier">getHistory</span></a></a><span> </span><a name="local-6989586621680121627"><a href="#local-6989586621680121627"><span class="hs-identifier">cWalId</span></a></a><span> </span><a name="local-6989586621680121628"><a href="#local-6989586621680121628"><span class="hs-identifier">accIds</span></a></a><span> </span><a name="local-6989586621680121629"><a href="#local-6989586621680121629"><span class="hs-identifier">mAddrId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-comment">-- FIXME: searching when only AddrId is provided is not supported yet.</span><span>
</span><a name="line-91"></a><span>    </span><a name="local-6989586621680121682"><a href="#local-6989586621680121682"><span class="hs-identifier">accAddrs</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cwamId</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">adiCWAddressMeta</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">concatMapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getAccountAddrsOrThrow</span><span> </span><span class="hs-identifier hs-var">Ever</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680121628"><span class="hs-identifier hs-var">accIds</span></a><span>
</span><a name="line-92"></a><span>    </span><a name="local-6989586621680121683"><a href="#local-6989586621680121683"><span class="hs-identifier">allAccIds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getWalletAccountIds</span><span> </span><a href="#local-6989586621680121627"><span class="hs-identifier hs-var">cWalId</span></a><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">filterFn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">TxId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CTx</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">POSIXTime</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">TxId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CTx</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">POSIXTime</span><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621680121684"><a href="#local-6989586621680121684"><span class="hs-identifier">filterFn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680121629"><span class="hs-identifier hs-var">mAddrId</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-96"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-97"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><a href="#local-6989586621680121628"><span class="hs-identifier hs-var">accIds</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><a href="#local-6989586621680121683"><span class="hs-identifier hs-var">allAccIds</span></a><span>
</span><a name="line-98"></a><span>              </span><span class="hs-comment">-- can avoid doing any expensive filtering in this case</span><span>
</span><a name="line-99"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">identity</span><span>
</span><a name="line-100"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121630"><span class="hs-identifier hs-var">filterByAddrs</span></a><span> </span><a href="#local-6989586621680121682"><span class="hs-identifier hs-var">accAddrs</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680121685"><a href="#local-6989586621680121685"><span class="hs-identifier">addr</span></a></a><span>
</span><a name="line-103"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680121685"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680121682"><span class="hs-identifier hs-var">accAddrs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121630"><span class="hs-identifier hs-var">filterByAddrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">singleton</span><span> </span><a href="#local-6989586621680121685"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throw</span><span> </span><a href="#local-6989586621680121632"><span class="hs-identifier hs-var">errorBadAddress</span></a><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span>    </span><a name="local-6989586621680121686"><a href="#local-6989586621680121686"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><a href="#local-6989586621680121684"><span class="hs-identifier hs-var">filterFn</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pos.Wallet.Web.Methods.History.html#getFullWalletHistory"><span class="hs-identifier hs-var">getFullWalletHistory</span></a><span> </span><a href="#local-6989586621680121627"><span class="hs-identifier hs-var">cWalId</span></a><span>
</span><a name="line-107"></a><span>    </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;getHistory: filtered transactions&quot;</span><span>
</span><a name="line-108"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680121686"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-109"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-identifier">filterByAddrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-identifier hs-type">Addr</span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">TxId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CTx</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">POSIXTime</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">TxId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CTx</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">POSIXTime</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>    </span><a name="local-6989586621680121630"><a href="#local-6989586621680121630"><span class="hs-identifier">filterByAddrs</span></a></a><span> </span><a name="local-6989586621680121633"><a href="#local-6989586621680121633"><span class="hs-identifier">addrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680121631"><span class="hs-identifier hs-var">fits</span></a><span> </span><a href="#local-6989586621680121633"><span class="hs-identifier hs-var">addrs</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span>    </span><span class="hs-identifier">fits</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-identifier hs-type">Addr</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CTx</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-116"></a><span>    </span><a name="local-6989586621680121631"><a href="#local-6989586621680121631"><span class="hs-identifier">fits</span></a></a><span> </span><a name="local-6989586621680121634"><a href="#local-6989586621680121634"><span class="hs-identifier">addrs</span></a></a><span> </span><span class="hs-identifier hs-var">CTx</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-117"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680121644"><a href="#local-6989586621680121644"><span class="hs-identifier">inpsNOuts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680121639"><span class="hs-identifier hs-var">ctInputs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680121640"><span class="hs-identifier hs-var">ctOutputs</span></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>        </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680121634"><span class="hs-identifier hs-var">addrs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680121644"><span class="hs-identifier hs-var">inpsNOuts</span></a><span>
</span><a name="line-119"></a><span>    </span><a name="local-6989586621680121632"><a href="#local-6989586621680121632"><span class="hs-identifier">errorBadAddress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RequestError</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-120"></a><span>        </span><span class="hs-string">&quot;Specified wallet/account does not contain specified address&quot;</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-identifier">getHistoryLimited</span><span>
</span><a name="line-123"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Wallet.Web.Mode.html#MonadWalletWebMode"><span class="hs-identifier hs-type">MonadWalletWebMode</span></a><span> </span><a href="#local-6989586621680121613"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-124"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-identifier hs-type">Wal</span><span class="hs-special">)</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">AccountId</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-identifier hs-type">Addr</span><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ScrollOffset</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ScrollLimit</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121613"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">CTx</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Word</span><span class="hs-special">)</span><span>
</span><a name="line-130"></a><a name="getHistoryLimited"><a href="Pos.Wallet.Web.Methods.History.html#getHistoryLimited"><span class="hs-identifier">getHistoryLimited</span></a></a><span> </span><a name="local-6989586621680121687"><a href="#local-6989586621680121687"><span class="hs-identifier">mCWalId</span></a></a><span> </span><a name="local-6989586621680121688"><a href="#local-6989586621680121688"><span class="hs-identifier">mAccId</span></a></a><span> </span><a name="local-6989586621680121689"><a href="#local-6989586621680121689"><span class="hs-identifier">mAddrId</span></a></a><span> </span><a name="local-6989586621680121690"><a href="#local-6989586621680121690"><span class="hs-identifier">mSkip</span></a></a><span> </span><a name="local-6989586621680121691"><a href="#local-6989586621680121691"><span class="hs-identifier">mLimit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-131"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680121706"><a href="#local-6989586621680121706"><span class="hs-identifier">cWalId</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680121707"><a href="#local-6989586621680121707"><span class="hs-identifier">accIds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680121687"><span class="hs-identifier hs-var">mCWalId</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680121688"><span class="hs-identifier hs-var">mAccId</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-132"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><a href="#local-6989586621680121699"><span class="hs-identifier hs-var">errorSpecifySomething</span></a><span>
</span><a name="line-133"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><a href="#local-6989586621680121700"><span class="hs-identifier hs-var">errorDontSpecifyBoth</span></a><span>
</span><a name="line-134"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680121703"><a href="#local-6989586621680121703"><span class="hs-identifier">cWalId'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-135"></a><span>            </span><a name="local-6989586621680121704"><a href="#local-6989586621680121704"><span class="hs-identifier">accIds'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getWalletAccountIds</span><span> </span><a href="#local-6989586621680121703"><span class="hs-identifier hs-var">cWalId'</span></a><span>
</span><a name="line-136"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680121703"><span class="hs-identifier hs-var">cWalId'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680121704"><span class="hs-identifier hs-var">accIds'</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680121705"><a href="#local-6989586621680121705"><span class="hs-identifier">accId</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">aiWId</span><span> </span><a href="#local-6989586621680121705"><span class="hs-identifier hs-var">accId</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680121705"><span class="hs-identifier hs-var">accId</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680121708"><a href="#local-6989586621680121708"><span class="hs-identifier">unsortedThs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680121709"><a href="#local-6989586621680121709"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Wallet.Web.Methods.History.html#getHistory"><span class="hs-identifier hs-var">getHistory</span></a><span> </span><a href="#local-6989586621680121706"><span class="hs-identifier hs-var">cWalId</span></a><span> </span><a href="#local-6989586621680121707"><span class="hs-identifier hs-var">accIds</span></a><span> </span><a href="#local-6989586621680121689"><span class="hs-identifier hs-var">mAddrId</span></a><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680121710"><a href="#local-6989586621680121710"><span class="hs-identifier">sortedTxh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680121693"><span class="hs-identifier hs-var">forceList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680121692"><span class="hs-identifier hs-var">sortByTime</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">elems</span><span> </span><a href="#local-6989586621680121708"><span class="hs-identifier hs-var">unsortedThs</span></a><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>    </span><span class="hs-identifier hs-var">logDebug</span><span> </span><span class="hs-string">&quot;getHistoryLimited: sorted transactions&quot;</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span>    </span><a href="Pos.Wallet.Web.Methods.History.html#logCTxs"><span class="hs-identifier hs-var">logCTxs</span></a><span> </span><span class="hs-string">&quot;Total last 20&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><span class="hs-number">20</span><span> </span><a href="#local-6989586621680121710"><span class="hs-identifier hs-var">sortedTxh</span></a><span>
</span><a name="line-144"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680121694"><span class="hs-identifier hs-var">applySkipLimit</span></a><span> </span><a href="#local-6989586621680121710"><span class="hs-identifier hs-var">sortedTxh</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680121709"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-146"></a><span>    </span><span class="hs-identifier">sortByTime</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">CTx</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">POSIXTime</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CTx</span><span class="hs-special">]</span><span>
</span><a name="line-147"></a><span>    </span><a name="local-6989586621680121692"><a href="#local-6989586621680121692"><span class="hs-identifier">sortByTime</span></a></a><span> </span><a name="local-6989586621680121701"><a href="#local-6989586621680121701"><span class="hs-identifier">thsWTime</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-148"></a><span>        </span><span class="hs-comment">-- TODO: if we use a (lazy) heap sort here, we can get the</span><span>
</span><a name="line-149"></a><span>        </span><span class="hs-comment">-- first n values of the m sorted elements in O(m + n log m)</span><span>
</span><a name="line-150"></a><span>        </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sortWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Down</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680121701"><span class="hs-identifier hs-var">thsWTime</span></a><span>
</span><a name="line-151"></a><span>    </span><a name="local-6989586621680121693"><a href="#local-6989586621680121693"><span class="hs-identifier">forceList</span></a></a><span> </span><a name="local-6989586621680121702"><a href="#local-6989586621680121702"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680121702"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680121702"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-152"></a><span>    </span><a name="local-6989586621680121694"><a href="#local-6989586621680121694"><span class="hs-identifier">applySkipLimit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621680121695"><span class="hs-identifier hs-var">limit</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-6989586621680121696"><span class="hs-identifier hs-var">skip</span></a><span>
</span><a name="line-153"></a><span>    </span><a name="local-6989586621680121695"><a href="#local-6989586621680121695"><span class="hs-identifier">limit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="#local-6989586621680121697"><span class="hs-identifier hs-var">defaultLimit</span></a><span> </span><a href="#local-6989586621680121691"><span class="hs-identifier hs-var">mLimit</span></a><span class="hs-special">)</span><span>
</span><a name="line-154"></a><span>    </span><a name="local-6989586621680121696"><a href="#local-6989586621680121696"><span class="hs-identifier">skip</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="#local-6989586621680121698"><span class="hs-identifier hs-var">defaultSkip</span></a><span> </span><a href="#local-6989586621680121690"><span class="hs-identifier hs-var">mSkip</span></a><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>    </span><a name="local-6989586621680121697"><a href="#local-6989586621680121697"><span class="hs-identifier">defaultLimit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">100</span><span>
</span><a name="line-156"></a><span>    </span><a name="local-6989586621680121698"><a href="#local-6989586621680121698"><span class="hs-identifier">defaultSkip</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-157"></a><span>    </span><a name="local-6989586621680121699"><a href="#local-6989586621680121699"><span class="hs-identifier">errorSpecifySomething</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RequestError</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-158"></a><span>        </span><span class="hs-string">&quot;Please specify either walletId or accountId&quot;</span><span>
</span><a name="line-159"></a><span>    </span><a name="local-6989586621680121700"><a href="#local-6989586621680121700"><span class="hs-identifier">errorDontSpecifyBoth</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RequestError</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-160"></a><span>        </span><span class="hs-string">&quot;Please do not specify both walletId and accountId at the same time&quot;</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-identifier">addHistoryTx</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Wallet.Web.Mode.html#MonadWalletWebMode"><span class="hs-identifier hs-type">MonadWalletWebMode</span></a><span> </span><a href="#local-6989586621680121612"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-164"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-identifier hs-type">Wal</span><span>
</span><a name="line-165"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TxHistoryEntry</span><span>
</span><a name="line-166"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121612"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-167"></a><a name="addHistoryTx"><a href="Pos.Wallet.Web.Methods.History.html#addHistoryTx"><span class="hs-identifier">addHistoryTx</span></a></a><span> </span><a name="local-6989586621680121711"><a href="#local-6989586621680121711"><span class="hs-identifier">cWalId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Wallet.Web.Methods.History.html#addHistoryTxs"><span class="hs-identifier hs-var">addHistoryTxs</span></a><span> </span><a href="#local-6989586621680121711"><span class="hs-identifier hs-var">cWalId</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">txHistoryListToMap</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">one</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-comment">-- This functions is helper to do @addHistoryTx@ for</span><span>
</span><a name="line-170"></a><span class="hs-comment">-- all txs from mempool as one Acidic transaction.</span><span>
</span><a name="line-171"></a><span class="hs-identifier">addHistoryTxs</span><span>
</span><a name="line-172"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Wallet.Web.Mode.html#MonadWalletWebMode"><span class="hs-identifier hs-type">MonadWalletWebMode</span></a><span> </span><a href="#local-6989586621680121611"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-173"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-identifier hs-type">Wal</span><span>
</span><a name="line-174"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">TxId</span><span> </span><span class="hs-identifier hs-type">TxHistoryEntry</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121611"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-176"></a><a name="addHistoryTxs"><a href="Pos.Wallet.Web.Methods.History.html#addHistoryTxs"><span class="hs-identifier">addHistoryTxs</span></a></a><span> </span><a name="local-6989586621680121712"><a href="#local-6989586621680121712"><span class="hs-identifier">cWalId</span></a></a><span> </span><a name="local-6989586621680121713"><a href="#local-6989586621680121713"><span class="hs-identifier">historyEntries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-177"></a><span>    </span><a name="local-6989586621680121722"><a href="#local-6989586621680121722"><span class="hs-identifier">metas</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621680121714"><span class="hs-identifier hs-var">toMeta</span></a><span> </span><a href="#local-6989586621680121713"><span class="hs-identifier hs-var">historyEntries</span></a><span>
</span><a name="line-178"></a><span>    </span><span class="hs-identifier hs-var">addOnlyNewTxMetas</span><span> </span><a href="#local-6989586621680121712"><span class="hs-identifier hs-var">cWalId</span></a><span> </span><a href="#local-6989586621680121722"><span class="hs-identifier hs-var">metas</span></a><span>
</span><a name="line-179"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-180"></a><span>    </span><a name="local-6989586621680121714"><a href="#local-6989586621680121714"><span class="hs-identifier">toMeta</span></a></a><span> </span><span class="hs-identifier hs-var">THEntry</span><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CTxMeta</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680121720"><span class="hs-identifier hs-var">_thTimestamp</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-181"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-identifier hs-var">getPOSIXTime</span><span>
</span><a name="line-182"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680121721"><a href="#local-6989586621680121721"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">timestampToPosix</span><span> </span><a href="#local-6989586621680121721"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-identifier">constructCTx</span><span>
</span><a name="line-185"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Wallet.Web.Mode.html#MonadWalletWebMode"><span class="hs-identifier hs-type">MonadWalletWebMode</span></a><span> </span><a href="#local-6989586621680121610"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-186"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-identifier hs-type">Wal</span><span>
</span><a name="line-187"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-identifier hs-type">Addr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ChainDifficulty</span><span>
</span><a name="line-189"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TxHistoryEntry</span><span>
</span><a name="line-190"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121610"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CTx</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">POSIXTime</span><span class="hs-special">)</span><span>
</span><a name="line-191"></a><a name="constructCTx"><a href="Pos.Wallet.Web.Methods.History.html#constructCTx"><span class="hs-identifier">constructCTx</span></a></a><span> </span><a name="local-6989586621680121723"><a href="#local-6989586621680121723"><span class="hs-identifier">cWalId</span></a></a><span> </span><a name="local-6989586621680121724"><a href="#local-6989586621680121724"><span class="hs-identifier">addrBelongsToWallet</span></a></a><span> </span><a name="local-6989586621680121725"><a href="#local-6989586621680121725"><span class="hs-identifier">diff</span></a></a><span> </span><a name="local-6989586621680121726"><a href="#local-6989586621680121726"><span class="hs-identifier">wtx</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">THEntry</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-192"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680121733"><a href="#local-6989586621680121733"><span class="hs-identifier">cId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">encodeCType</span><span> </span><a href="#local-6989586621680121727"><span class="hs-identifier hs-var">_thTxId</span></a><span>
</span><a name="line-193"></a><span>    </span><a name="local-6989586621680121734"><a href="#local-6989586621680121734"><span class="hs-identifier">meta</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CTxMeta</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-identifier hs-var">getPOSIXTime</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- It's impossible case but just in case</span><span>
</span><a name="line-194"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">getTxMeta</span><span> </span><a href="#local-6989586621680121723"><span class="hs-identifier hs-var">cWalId</span></a><span> </span><a href="#local-6989586621680121733"><span class="hs-identifier hs-var">cId</span></a><span>
</span><a name="line-195"></a><span>    </span><a name="local-6989586621680121735"><a href="#local-6989586621680121735"><span class="hs-identifier">ptxCond</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">encodeCType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">_ptxCond</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getPendingTx</span><span> </span><a href="#local-6989586621680121723"><span class="hs-identifier hs-var">cWalId</span></a><span> </span><a href="#local-6989586621680121727"><span class="hs-identifier hs-var">_thTxId</span></a><span>
</span><a name="line-196"></a><span>    </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">InternalError</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctmDate</span><span> </span><a href="#local-6989586621680121734"><span class="hs-identifier hs-var">meta</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-197"></a><span>        </span><span class="hs-identifier hs-var">mkCTx</span><span> </span><a href="#local-6989586621680121725"><span class="hs-identifier hs-var">diff</span></a><span> </span><a href="#local-6989586621680121726"><span class="hs-identifier hs-var">wtx</span></a><span> </span><a href="#local-6989586621680121734"><span class="hs-identifier hs-var">meta</span></a><span> </span><a href="#local-6989586621680121735"><span class="hs-identifier hs-var">ptxCond</span></a><span> </span><a href="#local-6989586621680121724"><span class="hs-identifier hs-var">addrBelongsToWallet</span></a><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-identifier">getCurChainDifficulty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Wallet.Web.Mode.html#MonadWalletWebMode"><span class="hs-identifier hs-type">MonadWalletWebMode</span></a><span> </span><a href="#local-6989586621680121609"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621680121609"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">ChainDifficulty</span><span>
</span><a name="line-200"></a><a name="getCurChainDifficulty"><a href="Pos.Wallet.Web.Methods.History.html#getCurChainDifficulty"><span class="hs-identifier">getCurChainDifficulty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">localChainDifficulty</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">networkChainDifficulty</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-identifier">updateTransaction</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Wallet.Web.Mode.html#MonadWalletWebMode"><span class="hs-identifier hs-type">MonadWalletWebMode</span></a><span> </span><a href="#local-6989586621680121608"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">AccountId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CTxId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CTxMeta</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121608"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><a name="updateTransaction"><a href="Pos.Wallet.Web.Methods.History.html#updateTransaction"><span class="hs-identifier">updateTransaction</span></a></a><span> </span><a name="local-6989586621680121736"><a href="#local-6989586621680121736"><span class="hs-identifier">accId</span></a></a><span> </span><a name="local-6989586621680121737"><a href="#local-6989586621680121737"><span class="hs-identifier">txId</span></a></a><span> </span><a name="local-6989586621680121738"><a href="#local-6989586621680121738"><span class="hs-identifier">txMeta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-204"></a><span>    </span><span class="hs-identifier hs-var">setWalletTxMeta</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">aiWId</span><span> </span><a href="#local-6989586621680121736"><span class="hs-identifier hs-var">accId</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680121737"><span class="hs-identifier hs-var">txId</span></a><span> </span><a href="#local-6989586621680121738"><span class="hs-identifier hs-var">txMeta</span></a><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span class="hs-identifier">addRecentPtxHistory</span><span>
</span><a name="line-207"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Wallet.Web.Mode.html#MonadWalletWebMode"><span class="hs-identifier hs-type">MonadWalletWebMode</span></a><span> </span><a href="#local-6989586621680121607"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-208"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CId</span><span> </span><span class="hs-identifier hs-type">Wal</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">TxId</span><span> </span><span class="hs-identifier hs-type">TxHistoryEntry</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121607"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">TxId</span><span> </span><span class="hs-identifier hs-type">TxHistoryEntry</span><span class="hs-special">)</span><span>
</span><a name="line-209"></a><a name="addRecentPtxHistory"><a href="Pos.Wallet.Web.Methods.History.html#addRecentPtxHistory"><span class="hs-identifier">addRecentPtxHistory</span></a></a><span> </span><a name="local-6989586621680121739"><a href="#local-6989586621680121739"><span class="hs-identifier">wid</span></a></a><span> </span><a name="local-6989586621680121740"><a href="#local-6989586621680121740"><span class="hs-identifier">currentHistory</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-210"></a><span>    </span><a name="local-6989586621680121741"><a href="#local-6989586621680121741"><span class="hs-identifier">pendingTxs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getWalletPendingTxs</span><span> </span><a href="#local-6989586621680121739"><span class="hs-identifier hs-var">wid</span></a><span>
</span><a name="line-211"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680121742"><a href="#local-6989586621680121742"><span class="hs-identifier">conditions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">_ptxCond</span><span> </span><a href="#local-6989586621680121741"><span class="hs-identifier hs-var">pendingTxs</span></a><span>
</span><a name="line-212"></a><span>    </span><span class="hs-comment">-- show only actually pending transactions in logs</span><span>
</span><a name="line-213"></a><span>    </span><a href="Pos.Wallet.Web.Methods.History.html#logTxHistory"><span class="hs-identifier hs-var">logTxHistory</span></a><span> </span><span class="hs-string">&quot;Pending&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">preview</span><span> </span><span class="hs-identifier hs-var">_PtxApplying</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680121742"><span class="hs-identifier hs-var">conditions</span></a><span>
</span><a name="line-214"></a><span>    </span><span class="hs-comment">-- but return all transactions which are not yet in blocks</span><span>
</span><a name="line-215"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680121743"><a href="#local-6989586621680121743"><span class="hs-identifier">candidatesList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">txHistoryListToMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="Pos.Wallet.Web.Pending.Util.html#ptxPoolInfo"><span class="hs-identifier hs-var">ptxPoolInfo</span></a><span> </span><a href="#local-6989586621680121742"><span class="hs-identifier hs-var">conditions</span></a><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">union</span><span> </span><a href="#local-6989586621680121740"><span class="hs-identifier hs-var">currentHistory</span></a><span> </span><a href="#local-6989586621680121743"><span class="hs-identifier hs-var">candidatesList</span></a><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span class="hs-comment">-- FIXME: use @listChunkedJson k@ with appropriate @k@s, once available,</span><span>
</span><a name="line-219"></a><span class="hs-comment">-- in these 2 functions</span><span>
</span><a name="line-220"></a><span class="hs-identifier">logTxHistory</span><span>
</span><a name="line-221"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Container</span><span> </span><a href="#local-6989586621680121605"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Element</span><span> </span><a href="#local-6989586621680121605"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-identifier hs-type">TxHistoryEntry</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">WithLogger</span><span> </span><a href="#local-6989586621680121606"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621680121606"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121605"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121606"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-223"></a><a name="logTxHistory"><a href="Pos.Wallet.Web.Methods.History.html#logTxHistory"><span class="hs-identifier">logTxHistory</span></a></a><span> </span><a name="local-6989586621680121744"><a href="#local-6989586621680121744"><span class="hs-identifier">desc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-224"></a><span>    </span><span class="hs-identifier hs-var">logInfoS</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-225"></a><span>    </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stext</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; transactions history: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">listJson</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680121744"><span class="hs-identifier hs-var">desc</span></a><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-226"></a><span>    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">_thTxId</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-identifier">logCTxs</span><span>
</span><a name="line-229"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Container</span><span> </span><a href="#local-6989586621680121603"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Element</span><span> </span><a href="#local-6989586621680121603"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-identifier hs-type">CTx</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">WithLogger</span><span> </span><a href="#local-6989586621680121604"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121603"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680121604"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-231"></a><a name="logCTxs"><a href="Pos.Wallet.Web.Methods.History.html#logCTxs"><span class="hs-identifier">logCTxs</span></a></a><span> </span><a name="local-6989586621680121745"><a href="#local-6989586621680121745"><span class="hs-identifier">desc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-232"></a><span>    </span><span class="hs-identifier hs-var">logInfo</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-233"></a><span>    </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stext</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; transactions history: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">listJsonIndent</span><span> </span><span class="hs-number">4</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680121745"><span class="hs-identifier hs-var">desc</span></a><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-234"></a><span>    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">ctId</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toList</span><span>
</span><a name="line-235"></a></pre></body></html>