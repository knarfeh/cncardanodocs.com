<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span>
</span><a name="line-2"></a><span class="hs-comment">{-
TH helpers for Bi.

Suppose you have the following datatype:

data User
    = Login {
      login :: String
    , age   :: Int
    }
    | FullName {
      firstName  :: String
    , lastName   :: String
    , sex        :: Bool
    }

then the next deriveSimpleBi:

deriveSimpleBi ''User [
    Cons 'Login [
        Field [| login :: String |],
        Field [| age   :: Int    |],
    ],
    Cons 'FullName [
        Field [| firstName :: String |],
        Field [| lastName  :: String |],
        Field [| sex       :: Bool   |]
    ]]

will generate:

instance Bi User where
    encode = \x -&gt; case x of
        val@Login{} -&gt; encodeListLen 3 &lt;&gt; encode (0 :: Word8)
                                       &lt;&gt; encode (login val)
                                       &lt;&gt; encode (age val)
        val@FullName{} -&gt; encodeListLen 3 &lt;&gt; encode (1 :: Word8)
                                          &lt;&gt; encode (firstName val)
                                          &lt;&gt; encode (sex val)
    decode = do
        expectedLen &lt;- decodeListLen
        tag &lt;- decode @Word8
        case tag of
            0 -&gt; do
                matchSize 3 &quot;Login&quot; expectedLen
                login &lt;- decode
                age &lt;- decode
                pure $ Login {..}
            1 -&gt; do
                matchSize 3 &quot;FullName&quot; expectedLen
                firstName &lt;- decode
                lastName  &lt;- decode
                sex       &lt;- decode
                pure $ FullName {..}
            _ -&gt; fail (&quot;Found invalid tag while getting User&quot;)
-}</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span>
</span><a name="line-60"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Pos.Binary.Class.TH.html#deriveSimpleBi"><span class="hs-identifier hs-var">deriveSimpleBi</span></a><span>
</span><a name="line-61"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Binary.Class.TH.html#deriveSimpleBiCxt"><span class="hs-identifier hs-var">deriveSimpleBiCxt</span></a><span>
</span><a name="line-62"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier hs-type">Cons</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Binary.Class.TH.html#Field"><span class="hs-identifier hs-type">Field</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Binary.Class.TH.html#Field"><span class="hs-identifier hs-var">Field</span></a><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">imap</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nubBy</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Formatting</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sformat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">shown</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">TH</span><span class="hs-operator">.</span><span class="hs-identifier">ReifySimple</span><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DataType</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reifyDataType</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">TH</span><span class="hs-operator">.</span><span class="hs-identifier">Utilities</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">plainInstanceD</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Codec</span><span class="hs-operator">.</span><span class="hs-identifier">CBOR</span><span class="hs-operator">.</span><span class="hs-identifier">Decoding</span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Cbor</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Codec</span><span class="hs-operator">.</span><span class="hs-identifier">CBOR</span><span class="hs-operator">.</span><span class="hs-identifier">Encoding</span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Cbor</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.Binary.Class.Core.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Bi</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-keyword">data</span><span> </span><a name="Cons"><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier">Cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Cons"><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier">Cons</span></a></a><span>
</span><a name="line-81"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | Name of a constructor.</span><span>
</span><a name="line-82"></a><span>      </span><a name="cName"><a href="Pos.Binary.Class.TH.html#cName"><span class="hs-identifier">cName</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-83"></a><span>      </span><span class="hs-comment">-- | Field of a constructor.</span><span>
</span><a name="line-84"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="cFields"><a href="Pos.Binary.Class.TH.html#cFields"><span class="hs-identifier">cFields</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Pos.Binary.Class.TH.html#Field"><span class="hs-identifier hs-type">Field</span></a><span class="hs-special">]</span><span>
</span><a name="line-85"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-keyword">data</span><span> </span><a name="Field"><a href="Pos.Binary.Class.TH.html#Field"><span class="hs-identifier">Field</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Field"><a href="Pos.Binary.Class.TH.html#Field"><span class="hs-identifier">Field</span></a></a><span>
</span><a name="line-88"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | The constructor means that you want</span><span>
</span><a name="line-89"></a><span>      </span><span class="hs-comment">-- a field to participate in serialisation/deserialization</span><span>
</span><a name="line-90"></a><span>      </span><a name="fFieldAndType"><a href="Pos.Binary.Class.TH.html#fFieldAndType"><span class="hs-identifier">fFieldAndType</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExpQ</span><span>
</span><a name="line-91"></a><span>      </span><span class="hs-comment">-- ^ You're expected to write something like @[|foo :: Bar|]@ here</span><span>
</span><a name="line-92"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-comment">-- | Turn something like @[|foo :: Bar|]@ into @(foo, Bar)@.</span><span>
</span><a name="line-95"></a><span class="hs-identifier">expToNameAndType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExpQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><a name="expToNameAndType"><a href="Pos.Binary.Class.TH.html#expToNameAndType"><span class="hs-identifier">expToNameAndType</span></a></a><span> </span><a name="local-6989586621679676158"><a href="#local-6989586621679676158"><span class="hs-identifier">ex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679676158"><span class="hs-identifier hs-var">ex</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-97"></a><span>    </span><span class="hs-identifier hs-var">SigE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarE</span><span> </span><a name="local-6989586621679676159"><a href="#local-6989586621679676159"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679676160"><a href="#local-6989586621679676160"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679676159"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679676160"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>    </span><a name="local-6989586621679676161"><a href="#local-6989586621679676161"><span class="hs-identifier">other</span></a></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;expToNameAndType: the expression should look \
                              \like [|fname :: FType|], but it doesn't: &quot;</span><span>
</span><a name="line-100"></a><span>                              </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679676161"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-identifier">fieldToPair</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Binary.Class.TH.html#Field"><span class="hs-identifier hs-type">Field</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><a name="fieldToPair"><a href="Pos.Binary.Class.TH.html#fieldToPair"><span class="hs-identifier">fieldToPair</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Binary.Class.TH.html#Field"><span class="hs-identifier hs-var">Field</span></a><span> </span><a name="local-6989586621679676162"><a href="#local-6989586621679676162"><span class="hs-identifier">ex</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">over</span><span> </span><span class="hs-identifier hs-var">_2</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pos.Binary.Class.TH.html#expToNameAndType"><span class="hs-identifier hs-var">expToNameAndType</span></a><span> </span><a href="#local-6989586621679676162"><span class="hs-identifier hs-var">ex</span></a><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-comment">-- Some part of code copied from</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- https://hackage.haskell.org/package/store-0.4.3.1/docs/src/Data-Store-TH-Internal.html#makeStore</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-comment">-- | Takes the name of datatype and constructors of datatype and generates Bi instances.</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- You should pass all constructors explicitly. Also, you should pass all fields explicitly.</span><span>
</span><a name="line-110"></a><span class="hs-comment">-- and the real type of field and the passed (in the Field) type should be same.</span><span>
</span><a name="line-111"></a><span class="hs-comment">-- All field of datatype should be named explicitly.</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- The numbers of constructors must be at least one and at most 255.</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- The order of fields matter: it corresponds to order of put's and get's.</span><span>
</span><a name="line-114"></a><span class="hs-comment">-- If some of these statements is violated,</span><span>
</span><a name="line-115"></a><span class="hs-comment">-- you will get compile error with the corresponding message.</span><span>
</span><a name="line-116"></a><span class="hs-identifier">deriveSimpleBi</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier hs-type">Cons</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-117"></a><a name="deriveSimpleBi"><a href="Pos.Binary.Class.TH.html#deriveSimpleBi"><span class="hs-identifier">deriveSimpleBi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Binary.Class.TH.html#deriveSimpleBiInternal"><span class="hs-identifier hs-var">deriveSimpleBiInternal</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-identifier">deriveSimpleBiCxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TypeQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier hs-type">Cons</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-120"></a><a name="deriveSimpleBiCxt"><a href="Pos.Binary.Class.TH.html#deriveSimpleBiCxt"><span class="hs-identifier">deriveSimpleBiCxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Binary.Class.TH.html#deriveSimpleBiInternal"><span class="hs-identifier hs-var">deriveSimpleBiInternal</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Just</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-identifier">deriveSimpleBiInternal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TypeQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier hs-type">Cons</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-123"></a><a name="deriveSimpleBiInternal"><a href="Pos.Binary.Class.TH.html#deriveSimpleBiInternal"><span class="hs-identifier">deriveSimpleBiInternal</span></a></a><span> </span><a name="local-6989586621679676163"><a href="#local-6989586621679676163"><span class="hs-identifier">predsMB</span></a></a><span> </span><a name="local-6989586621679676164"><a href="#local-6989586621679676164"><span class="hs-identifier">headTy</span></a></a><span> </span><a name="local-6989586621679676165"><a href="#local-6989586621679676165"><span class="hs-identifier">constrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-124"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679676165"><span class="hs-identifier hs-var">constrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-125"></a><span>        </span><a href="#local-6989586621679676169"><span class="hs-identifier hs-var">failText</span></a><span> </span><span class="hs-string">&quot;You passed no constructors to deriveSimpleBi&quot;</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679676165"><span class="hs-identifier hs-var">constrs</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">255</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-127"></a><span>        </span><a href="#local-6989586621679676169"><span class="hs-identifier hs-var">failText</span></a><span> </span><span class="hs-string">&quot;You passed too many constructors to deriveSimpleBi&quot;</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nubBy</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">cName</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679676165"><span class="hs-identifier hs-var">constrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679676165"><span class="hs-identifier hs-var">constrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-129"></a><span>        </span><a href="#local-6989586621679676169"><span class="hs-identifier hs-var">failText</span></a><span> </span><span class="hs-string">&quot;You passed two constructors with the same name&quot;</span><span>
</span><a name="line-130"></a><span>    </span><a name="local-6989586621679677504"><a href="#local-6989586621679677504"><span class="hs-identifier">preds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">one</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679676163"><span class="hs-identifier hs-var">predsMB</span></a><span>
</span><a name="line-131"></a><span>    </span><a name="local-6989586621679677505"><a href="#local-6989586621679677505"><span class="hs-identifier">dt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">reifyDataType</span><span> </span><a href="#local-6989586621679676164"><span class="hs-identifier hs-var">headTy</span></a><span>
</span><a name="line-132"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="Pos.Binary.Class.TH.html#matchAllConstrs"><span class="hs-identifier hs-var">matchAllConstrs</span></a><span> </span><a href="#local-6989586621679676165"><span class="hs-identifier hs-var">constrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dtCons</span><span> </span><a href="#local-6989586621679677505"><span class="hs-identifier hs-var">dt</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-133"></a><span>        </span><a href="Pos.Binary.Class.TH.html#MissedCons"><span class="hs-identifier hs-var">MissedCons</span></a><span> </span><a name="local-6989586621679677506"><a href="#local-6989586621679677506"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-134"></a><span>            </span><a href="#local-6989586621679676169"><span class="hs-identifier hs-var">failText</span></a><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-135"></a><span>                </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Constructor '&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shown</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;' isn't passed to deriveSimpleBi&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-136"></a><span>                </span><a href="#local-6989586621679677506"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-137"></a><span>        </span><a href="Pos.Binary.Class.TH.html#UnknownCons"><span class="hs-identifier hs-var">UnknownCons</span></a><span> </span><a name="local-6989586621679677507"><a href="#local-6989586621679677507"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-138"></a><span>            </span><a href="#local-6989586621679676169"><span class="hs-identifier hs-var">failText</span></a><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-139"></a><span>                </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Unknown constructor '&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shown</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;' is passed to deriveSimpleBi&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-140"></a><span>                </span><a href="#local-6989586621679677507"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-141"></a><span>        </span><a href="Pos.Binary.Class.TH.html#MatchedCons"><span class="hs-identifier hs-var">MatchedCons</span></a><span> </span><a name="local-6989586621679677508"><a href="#local-6989586621679677508"><span class="hs-identifier">matchedConstrs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-142"></a><span>            </span><span class="hs-identifier hs-var">forM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679676165"><span class="hs-identifier hs-var">constrs</span></a><span> </span><a href="#local-6989586621679677508"><span class="hs-identifier hs-var">matchedConstrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier hs-var">Cons</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">DataCon</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-143"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679677515"><a href="#local-6989586621679677515"><span class="hs-identifier">realFields</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679677516"><a href="#local-6989586621679677516"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679677517"><a href="#local-6989586621679677517"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><a href="#local-6989586621679677517"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679677516"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679677514"><span class="hs-identifier hs-var">dcFields</span></a><span>
</span><a name="line-144"></a><span>                </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679677515"><span class="hs-identifier hs-var">realFields</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679677514"><span class="hs-identifier hs-var">dcFields</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-145"></a><span>                    </span><a href="#local-6989586621679676169"><span class="hs-identifier hs-var">failText</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Some field of &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shown</span><span>
</span><a name="line-146"></a><span>                                       </span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; constructor doesn't have an explicit name&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679677509"><span class="hs-identifier hs-var">cName</span></a><span>
</span><a name="line-147"></a><span>                </span><a name="local-6989586621679677518"><a href="#local-6989586621679677518"><span class="hs-identifier">cResolvedFields</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Pos.Binary.Class.TH.html#fieldToPair"><span class="hs-identifier hs-var">fieldToPair</span></a><span> </span><a href="#local-6989586621679677510"><span class="hs-identifier hs-var">cFields</span></a><span>
</span><a name="line-148"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="Pos.Binary.Class.TH.html#checkAllFields"><span class="hs-identifier hs-var">checkAllFields</span></a><span> </span><a href="#local-6989586621679677518"><span class="hs-identifier hs-var">cResolvedFields</span></a><span> </span><a href="#local-6989586621679677515"><span class="hs-identifier hs-var">realFields</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-149"></a><span>                    </span><a href="Pos.Binary.Class.TH.html#MissedField"><span class="hs-identifier hs-var">MissedField</span></a><span> </span><a name="local-6989586621679677519"><a href="#local-6989586621679677519"><span class="hs-identifier">field</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-150"></a><span>                        </span><a href="#local-6989586621679676169"><span class="hs-identifier hs-var">failText</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Field '&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shown</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;' of the constructor '&quot;</span><span>
</span><a name="line-151"></a><span>                                            </span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shown</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;' isn't passed to deriveSimpleBi&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>                                   </span><a href="#local-6989586621679677519"><span class="hs-identifier hs-var">field</span></a><span> </span><a href="#local-6989586621679677509"><span class="hs-identifier hs-var">cName</span></a><span>
</span><a name="line-153"></a><span>                    </span><a href="Pos.Binary.Class.TH.html#UnknownField"><span class="hs-identifier hs-var">UnknownField</span></a><span> </span><a name="local-6989586621679677520"><a href="#local-6989586621679677520"><span class="hs-identifier">field</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-154"></a><span>                        </span><a href="#local-6989586621679676169"><span class="hs-identifier hs-var">failText</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Unknown field '&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shown</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;' of the constructor '&quot;</span><span>
</span><a name="line-155"></a><span>                                            </span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shown</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;' is passed to deriveSimpleBi&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span>                                   </span><a href="#local-6989586621679677520"><span class="hs-identifier hs-var">field</span></a><span> </span><a href="#local-6989586621679677509"><span class="hs-identifier hs-var">cName</span></a><span>
</span><a name="line-157"></a><span>                    </span><a href="Pos.Binary.Class.TH.html#TypeMismatched"><span class="hs-identifier hs-var">TypeMismatched</span></a><span> </span><a name="local-6989586621679677521"><a href="#local-6989586621679677521"><span class="hs-identifier">field</span></a></a><span> </span><a name="local-6989586621679677522"><a href="#local-6989586621679677522"><span class="hs-identifier">realType</span></a></a><span> </span><a name="local-6989586621679677523"><a href="#local-6989586621679677523"><span class="hs-identifier">passedType</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-158"></a><span>                        </span><a href="#local-6989586621679676169"><span class="hs-identifier hs-var">failText</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;The type of '&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shown</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;' of the constructor '&quot;</span><span>
</span><a name="line-159"></a><span>                                            </span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shown</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;' is mismatched: real type '&quot;</span><span>
</span><a name="line-160"></a><span>                                            </span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shown</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;', passed type '&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shown</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;'&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>                                   </span><a href="#local-6989586621679677521"><span class="hs-identifier hs-var">field</span></a><span> </span><a href="#local-6989586621679677509"><span class="hs-identifier hs-var">cName</span></a><span> </span><a href="#local-6989586621679677522"><span class="hs-identifier hs-var">realType</span></a><span> </span><a href="#local-6989586621679677523"><span class="hs-identifier hs-var">passedType</span></a><span>
</span><a name="line-162"></a><span>                    </span><a href="Pos.Binary.Class.TH.html#MatchedFields"><span class="hs-identifier hs-var">MatchedFields</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pass</span><span>
</span><a name="line-163"></a><span>    </span><a name="local-6989586621679677531"><a href="#local-6989586621679677531"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">conT</span><span> </span><a href="#local-6989586621679676164"><span class="hs-identifier hs-var">headTy</span></a><span>
</span><a name="line-164"></a><span>    </span><a href="Pos.Binary.Class.TH.html#makeBiInstanceTH"><span class="hs-identifier hs-var">makeBiInstanceTH</span></a><span> </span><a href="#local-6989586621679677504"><span class="hs-identifier hs-var">preds</span></a><span> </span><a href="#local-6989586621679677531"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679676170"><span class="hs-identifier hs-var">biEncodeExpr</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679676176"><span class="hs-identifier hs-var">biDecodeExpr</span></a><span>
</span><a name="line-165"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-166"></a><span>    </span><span class="hs-identifier">shortNameTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-167"></a><span>    </span><a name="local-6989586621679676166"><a href="#local-6989586621679676166"><span class="hs-identifier">shortNameTy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toText</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-6989586621679676164"><span class="hs-identifier hs-var">headTy</span></a><span>
</span><a name="line-168"></a><span>    </span><span class="hs-comment">-- Meta information about constructors --</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span>    </span><span class="hs-comment">-- Constructor and its used fields.</span><span>
</span><a name="line-171"></a><span>    </span><span class="hs-identifier">filteredConstrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier hs-type">Cons</span></a><span class="hs-special">]</span><span>
</span><a name="line-172"></a><span>    </span><a name="local-6989586621679676167"><a href="#local-6989586621679676167"><span class="hs-identifier">filteredConstrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier hs-var">Cons</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier hs-var">Cons</span></a><span> </span><a href="#local-6989586621679676180"><span class="hs-identifier hs-var">cName</span></a><span> </span><a href="#local-6989586621679676181"><span class="hs-identifier hs-var">cFields</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679676165"><span class="hs-identifier hs-var">constrs</span></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span>    </span><span class="hs-comment">-- Useful variables for @size@, @put@, @get@ --</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-identifier">tagType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TypeQ</span><span>
</span><a name="line-176"></a><span>    </span><a name="local-6989586621679676168"><a href="#local-6989586621679676168"><span class="hs-identifier">tagType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">t</span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>    </span><span class="hs-comment">-- Helpers --</span><span>
</span><a name="line-179"></a><span>    </span><span class="hs-identifier">failText</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadFail</span><span> </span><a href="#local-6989586621679676178"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679676178"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679676179"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-180"></a><span>    </span><a name="local-6989586621679676169"><a href="#local-6989586621679676169"><span class="hs-identifier">failText</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toString</span><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span>    </span><span class="hs-comment">-- Decode definition --</span><span>
</span><a name="line-183"></a><span>    </span><span class="hs-identifier">biEncodeExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-184"></a><span>    </span><a name="local-6989586621679676170"><a href="#local-6989586621679676170"><span class="hs-identifier">biEncodeExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-185"></a><span>        </span><a name="local-6989586621679676182"><a href="#local-6989586621679676182"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-string">&quot;x&quot;</span><span>
</span><a name="line-186"></a><span>        </span><span class="hs-identifier hs-var">lam1E</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-6989586621679676182"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-187"></a><span>          </span><span class="hs-identifier hs-var">caseE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679676182"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-188"></a><span>              </span><span class="hs-identifier hs-var">imap</span><span> </span><a href="#local-6989586621679676171"><span class="hs-identifier hs-var">biEncodeConstr</span></a><span> </span><a href="#local-6989586621679676167"><span class="hs-identifier hs-var">filteredConstrs</span></a><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span>    </span><span class="hs-comment">-- Generate the following code:</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-comment">-- val@Constr{} -&gt; encodeListLen 4</span><span>
</span><a name="line-192"></a><span>    </span><span class="hs-comment">--              &lt;&gt; encode (3 :: Word8)</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-comment">--              &lt;&gt; encode (field1 val)</span><span>
</span><a name="line-194"></a><span>    </span><span class="hs-comment">--              &lt;&gt; encode (field2 val)</span><span>
</span><a name="line-195"></a><span>    </span><span class="hs-comment">--              &lt;&gt; encode (field3 val)</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-identifier">biEncodeConstr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier hs-type">Cons</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MatchQ</span><span>
</span><a name="line-197"></a><span>    </span><a name="local-6989586621679676171"><a href="#local-6989586621679676171"><span class="hs-identifier">biEncodeConstr</span></a></a><span> </span><a name="local-6989586621679677462"><a href="#local-6989586621679677462"><span class="hs-identifier">ix</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier hs-var">Cons</span></a><span> </span><a name="local-6989586621679677463"><a href="#local-6989586621679677463"><span class="hs-identifier">cName</span></a></a><span> </span><a name="local-6989586621679677464"><a href="#local-6989586621679677464"><span class="hs-identifier">cFields</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-198"></a><span>        </span><a name="local-6989586621679677467"><a href="#local-6989586621679677467"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679677464"><span class="hs-identifier hs-var">cFields</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;_&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;val&quot;</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-identifier hs-var">match</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">asP</span><span> </span><a href="#local-6989586621679677467"><span class="hs-identifier hs-var">val</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">recP</span><span> </span><a href="#local-6989586621679677463"><span class="hs-identifier hs-var">cName</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679677465"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679677467"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-200"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-201"></a><span>        </span><a name="local-6989586621679677465"><a href="#local-6989586621679677465"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621679677466"><a href="#local-6989586621679677466"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">normalB</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-202"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679676165"><span class="hs-identifier hs-var">constrs</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-203"></a><span>                </span><a href="Pos.Binary.Class.TH.html#mconcatE"><span class="hs-identifier hs-var">mconcatE</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679676172"><span class="hs-identifier hs-var">encodeFlat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679677464"><span class="hs-identifier hs-var">cFields</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679676173"><span class="hs-identifier hs-var">encodeTag</span></a><span> </span><a href="#local-6989586621679677462"><span class="hs-identifier hs-var">ix</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679676174"><span class="hs-identifier hs-var">encodeField</span></a><span> </span><a href="#local-6989586621679677466"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679677464"><span class="hs-identifier hs-var">cFields</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>            </span><span class="hs-keyword">else</span><span>
</span><a name="line-205"></a><span>                </span><a href="Pos.Binary.Class.TH.html#mconcatE"><span class="hs-identifier hs-var">mconcatE</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679676172"><span class="hs-identifier hs-var">encodeFlat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679677464"><span class="hs-identifier hs-var">cFields</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679676174"><span class="hs-identifier hs-var">encodeField</span></a><span> </span><a href="#local-6989586621679677466"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679677464"><span class="hs-identifier hs-var">cFields</span></a><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span>    </span><span class="hs-comment">-- Ensure the encoding of constructors with multiple arguments are encoded as a flat term.</span><span>
</span><a name="line-208"></a><span>    </span><span class="hs-identifier">encodeFlat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-209"></a><span>    </span><a name="local-6989586621679676172"><a href="#local-6989586621679676172"><span class="hs-identifier">encodeFlat</span></a></a><span> </span><a name="local-6989586621679677468"><a href="#local-6989586621679677468"><span class="hs-identifier">listLen</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Cbor</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encodeListLen</span><span> </span><a href="#local-6989586621679677468"><span class="hs-identifier hs-var">listLen</span></a><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span>    </span><span class="hs-identifier">encodeTag</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-212"></a><span>    </span><a name="local-6989586621679676173"><a href="#local-6989586621679676173"><span class="hs-identifier">encodeTag</span></a></a><span> </span><a name="local-6989586621679677469"><a href="#local-6989586621679677469"><span class="hs-identifier">ix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-glyph">|</span><span> </span><a href="Pos.Binary.Class.Core.html#encode"><span class="hs-identifier hs-var">Bi</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679677469"><span class="hs-identifier hs-var">ix</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679676168"><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">tagType</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span>    </span><span class="hs-identifier">encodeField</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExpQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Binary.Class.TH.html#Field"><span class="hs-identifier hs-type">Field</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-215"></a><span>    </span><a name="local-6989586621679676174"><a href="#local-6989586621679676174"><span class="hs-identifier">encodeField</span></a></a><span> </span><a name="local-6989586621679677471"><a href="#local-6989586621679677471"><span class="hs-identifier">val</span></a></a><span> </span><a href="Pos.Binary.Class.TH.html#Field"><span class="hs-identifier hs-var">Field</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-216"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679677473"><a href="#local-6989586621679677473"><span class="hs-identifier">fName</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Pos.Binary.Class.TH.html#expToNameAndType"><span class="hs-identifier hs-var">expToNameAndType</span></a><span> </span><a href="#local-6989586621679677472"><span class="hs-identifier hs-var">fFieldAndType</span></a><span>
</span><a name="line-217"></a><span>        </span><span class="hs-special">[</span><span class="hs-glyph">|</span><span> </span><a href="Pos.Binary.Class.Core.html#encode"><span class="hs-identifier hs-var">Bi</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator">$</span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679677473"><span class="hs-identifier hs-var">fName</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679677471"><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span>    </span><span class="hs-identifier">actualLen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-220"></a><span>    </span><a name="local-6989586621679676175"><a href="#local-6989586621679676175"><span class="hs-identifier">actualLen</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkName</span><span> </span><span class="hs-string">&quot;actualLen&quot;</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span>    </span><span class="hs-comment">-- Decode definition --</span><span>
</span><a name="line-223"></a><span>    </span><span class="hs-identifier">biDecodeExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-224"></a><span>    </span><a name="local-6989586621679676176"><a href="#local-6989586621679676176"><span class="hs-identifier">biDecodeExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679676165"><span class="hs-identifier hs-var">constrs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-225"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-226"></a><span>            </span><a href="#local-6989586621679676169"><span class="hs-identifier hs-var">failText</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sformat</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Attempting to decode type without constructors &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">shown</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679676164"><span class="hs-identifier hs-var">headTy</span></a><span>
</span><a name="line-227"></a><span>        </span><span class="hs-special">[</span><a name="local-6989586621679677476"><a href="#local-6989586621679677476"><span class="hs-identifier">cons</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-228"></a><span>          </span><span class="hs-identifier hs-var">doE</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">bindS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-6989586621679676175"><span class="hs-identifier hs-var">actualLen</span></a><span class="hs-special">)</span><span>  </span><span class="hs-special">[</span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Cbor</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">decodeListLen</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-229"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">noBindS</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679676177"><span class="hs-identifier hs-var">biDecodeConstr</span></a><span> </span><a href="#local-6989586621679677476"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- There is one constructor</span><span>
</span><a name="line-230"></a><span>              </span><span class="hs-special">]</span><span>
</span><a name="line-231"></a><span>        </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-232"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679677477"><a href="#local-6989586621679677477"><span class="hs-identifier">tagName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkName</span><span> </span><span class="hs-string">&quot;tag&quot;</span><span>
</span><a name="line-233"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679677478"><a href="#local-6989586621679677478"><span class="hs-identifier">getMatch</span></a></a><span> </span><a name="local-6989586621679677479"><a href="#local-6989586621679677479"><span class="hs-identifier">ix</span></a></a><span> </span><a name="local-6989586621679677480"><a href="#local-6989586621679677480"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">match</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">litP</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IntegerL</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679677479"><span class="hs-identifier hs-var">ix</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>                                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">normalB</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679676177"><span class="hs-identifier hs-var">biDecodeConstr</span></a><span> </span><a href="#local-6989586621679677480"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-235"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679677481"><a href="#local-6989586621679677481"><span class="hs-identifier">mismatchConstr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-236"></a><span>                    </span><span class="hs-identifier hs-var">match</span><span> </span><span class="hs-identifier hs-var">wildP</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">normalB</span><span>
</span><a name="line-237"></a><span>                        </span><span class="hs-special">[</span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toString</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Found invalid tag while decoding &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679676166"><span class="hs-identifier hs-var">shortNameTy</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-238"></a><span>            </span><span class="hs-identifier hs-var">doE</span><span>
</span><a name="line-239"></a><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">bindS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-6989586621679676175"><span class="hs-identifier hs-var">actualLen</span></a><span class="hs-special">)</span><span>  </span><span class="hs-special">[</span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Cbor</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">decodeListLen</span><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-240"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">bindS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varP</span><span> </span><a href="#local-6989586621679677477"><span class="hs-identifier hs-var">tagName</span></a><span class="hs-special">)</span><span>    </span><span class="hs-special">[</span><span class="hs-glyph">|</span><span> </span><a href="Pos.Binary.Class.Core.html#decode"><span class="hs-identifier hs-var">Bi</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">decode</span></a><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-241"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">noBindS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">caseE</span><span>
</span><a name="line-242"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sigE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679677477"><span class="hs-identifier hs-var">tagName</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679676168"><span class="hs-identifier hs-var">tagType</span></a><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">imap</span><span> </span><a href="#local-6989586621679677478"><span class="hs-identifier hs-var">getMatch</span></a><span> </span><a href="#local-6989586621679676165"><span class="hs-identifier hs-var">constrs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679677481"><span class="hs-identifier hs-var">mismatchConstr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>                </span><span class="hs-special">]</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span>    </span><span class="hs-identifier">biDecodeConstr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier hs-type">Cons</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-247"></a><span>    </span><a name="local-6989586621679676177"><a href="#local-6989586621679676177"><span class="hs-identifier">biDecodeConstr</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Binary.Class.TH.html#Cons"><span class="hs-identifier hs-var">Cons</span></a><span> </span><a name="local-6989586621679677482"><a href="#local-6989586621679677482"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-248"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679677483"><a href="#local-6989586621679677483"><span class="hs-identifier">expectedLen</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">varE</span><span> </span><a href="#local-6989586621679676175"><span class="hs-identifier hs-var">actualLen</span></a><span>
</span><a name="line-249"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679677484"><a href="#local-6989586621679677484"><span class="hs-identifier">prettyName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679677482"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-250"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679677485"><a href="#local-6989586621679677485"><span class="hs-identifier">tagsIfAny</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679676165"><span class="hs-identifier hs-var">constrs</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-251"></a><span>        </span><span class="hs-identifier hs-var">doE</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">noBindS</span><span> </span><span class="hs-special">[</span><span class="hs-glyph">|</span><span> </span><a href="Pos.Binary.Class.Core.html#matchSize"><span class="hs-identifier hs-var">Bi</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">matchSize</span></a><span> </span><a href="#local-6989586621679677485"><span class="hs-identifier hs-var">tagsIfAny</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;biDecodeConstr(no_fields)@&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679677484"><span class="hs-identifier hs-var">prettyName</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679677483"><span class="hs-operator hs-var">$</span><span class="hs-identifier hs-var">expectedLen</span></a><span> </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-252"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">noBindS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">appE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varE</span><span> </span><span class="hs-char">'pure) (conE name))
            ]
    biDecodeConstr Cons{..} = do
        let usedFieldsNum        = length cFields
        let prettyName :: String = show cName
        let expectedLen          = varE actualLen
        -- We need to take into account the possibility we are dealing
        -- with a &quot;tagged&quot; encoding or not.
        let tagsIfAny :: Int = if length constrs &gt;= 2 then 1 else 0

        fieldNames :: [Name] &lt;- mapM (fmap fst . fieldToPair) cFields
        varNames   :: [Name] &lt;- mapM (newName . nameBase) fieldNames
        varPs :: [Pat] &lt;- mapM varP varNames
        biGets :: [Exp] &lt;- replicateM (length varPs) [| Bi.decode |]
        bindExprs :: [Stmt] &lt;- mapM (uncurry bindS . bimap pure pure) (zip varPs biGets)
        let recWildUsedVars = map (\(f, ex) -&gt; (f,) &lt;$&gt; varE ex) $ zip fieldNames varNames
        -- The +1 is because we need to take into account the tag we used to discriminate on the
        -- different constructors in the encoding phase.
        let lenCheck =
                noBindS [| Bi.matchSize (usedFieldsNum + tagsIfAny) (&quot;biDecodeConstr@&quot; &lt;&gt; prettyName) $expectedLen |]
        recordWildCardReturn &lt;- noBindS $
                                appE (varE 'pure) $
                                recConE cName $
                                recWildUsedVars
        doE $ lenCheck : (map pure bindExprs ++ [pure recordWildCardReturn])

makeBiInstanceTH :: Cxt -&gt; Type -&gt; Exp -&gt; Exp -&gt; [Dec]
makeBiInstanceTH preds ty encodeE decodeE = one $
  plainInstanceD
        preds -- context
        (AppT (ConT ''Bi.Bi) ty)
        [ ValD (VarP 'Bi.encode) (NormalB encodeE) []
        , ValD (VarP 'Bi.decode) (NormalB decodeE) []
        ]

data MatchConstructors
    = MatchedCons [DataCon]
    -- ^ Constructors in matched order
    | MissedCons Name
    -- ^ Some constructor aren't passed
    | UnknownCons Name
    -- ^ Passed unknown constructor

matchAllConstrs :: [Cons] -&gt; [DataCon] -&gt; MatchConstructors
matchAllConstrs (map cName -&gt; passedNames) realCons@(map dcName -&gt; realNames)
    | Just nm &lt;- passedNames `inclusion` realNames = UnknownCons nm
    | Just nm &lt;- realNames `inclusion` passedNames = MissedCons nm
    | otherwise =
        let ret = mapMaybe (\x -&gt; find ((x==) . dcName) realCons) passedNames in
        if length ret /= length passedNames then
            error &quot;Something went wrong. Matched list of constructors has different length&quot;
        else
            MatchedCons ret
  where
    inclusion :: [Name] -&gt; [Name] -&gt; Maybe Name
    inclusion c1 c2 = find (`notElem` c2) c1

data MatchFields
    = MatchedFields
    -- ^ All fields are matched
    | MissedField Name
    -- ^ Some field aren't passed
    | UnknownField Name
    -- ^ Passed field with unknown name
    | TypeMismatched Name Type Type
    -- ^ Some field has mismatched type

checkAllFields :: [(Name, Maybe Type)] -&gt; [(Name, Type)] -&gt; MatchFields
checkAllFields passedFields realFields
    | Just nm &lt;- map fst passedFields `inclusion` map fst realFields = UnknownField nm
    | Just nm &lt;- map fst realFields `inclusion` map fst passedFields = MissedField nm
    | otherwise =
        let ret = mapMaybe (\x -&gt; find ((fst x ==) . fst) realFields) passedFields in
        if length ret /= length passedFields then
            error &quot;Something went wrong. Matched list of fields has different length&quot;
        else
            case dropWhile checkTypes (zip realFields passedFields) of
                []                                -&gt; MatchedFields
                (((n, real), (_, Just passed)):_) -&gt; TypeMismatched n real passed
                (((_, _), (_, Nothing)):_)        -&gt; error &quot;Something went wrong: illegal mismatch type&quot;
  where
    checkTypes :: ((Name, Type), (Name, Maybe Type)) -&gt; Bool
    checkTypes (_, (_, Nothing))       = True
    checkTypes ((_, t1), (_, Just t2)) = t1 == t2

    inclusion :: [Name] -&gt; [Name] -&gt; Maybe Name
    inclusion c1 c2 = find (`notElem` c2) c1

----------------------------------------------------------------------------
-- Utilities
----------------------------------------------------------------------------

-- | Put '(&lt;&gt;)' between expressions.
mconcatE :: [ExpQ] -&gt; ExpQ
mconcatE = foldr (\a b -&gt; infixApp a [| (&lt;&gt;) |] b) [| mempty |]
</span></pre></body></html>